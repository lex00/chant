name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  build-release:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            bin_name: chant
            asset_name: chant-linux-x86_64
          - os: macos-latest
            target: x86_64-apple-darwin
            bin_name: chant
            asset_name: chant-macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            bin_name: chant
            asset_name: chant-macos-aarch64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            bin_name: chant.exe
            asset_name: chant-windows-x86_64.exe
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Release (Linux only)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} --title "${{ github.ref_name }}" --generate-notes 2>/dev/null || true

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2

      - name: Install musl-tools (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Prepare artifact
        shell: bash
        run: |
          cp target/${{ matrix.target }}/release/${{ matrix.bin_name }} ${{ matrix.asset_name }}

      - name: Code sign (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          codesign -f -s - ${{ matrix.asset_name }}

      - name: Upload Release Asset
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.ref_name }} ${{ matrix.asset_name }}

  update-homebrew:
    needs: build-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p assets
          gh release download ${{ github.ref_name }} --dir assets

      - name: Compute SHA256 hashes
        id: hashes
        run: |
          cd assets
          SHA_LINUX=$(sha256sum chant-linux-x86_64 | awk '{print $1}')
          SHA_MACOS_X86=$(sha256sum chant-macos-x86_64 | awk '{print $1}')
          SHA_MACOS_ARM=$(sha256sum chant-macos-aarch64 | awk '{print $1}')

          echo "sha_linux=$SHA_LINUX" >> $GITHUB_OUTPUT
          echo "sha_macos_x86=$SHA_MACOS_X86" >> $GITHUB_OUTPUT
          echo "sha_macos_arm=$SHA_MACOS_ARM" >> $GITHUB_OUTPUT

      - name: Clone homebrew-tap
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          git clone https://x-access-token:${{ secrets.HOMEBREW_TAP_TOKEN }}@github.com/lex00/homebrew-tap.git /tmp/homebrew-tap

      - name: Update Formula/chant.rb
        run: |
          cat > /tmp/homebrew-tap/Formula/chant.rb << 'EOF'
          class Chant < Formula
            desc "Intent Driven Development tool with specification-driven execution"
            homepage "https://github.com/lex00/chant"
            version "${{ steps.version.outputs.version }}"

            on_macos do
              on_arm do
                url "https://github.com/lex00/chant/releases/download/v#{version}/chant-macos-aarch64"
                sha256 "${{ steps.hashes.outputs.sha_macos_arm }}"
              end
              on_intel do
                url "https://github.com/lex00/chant/releases/download/v#{version}/chant-macos-x86_64"
                sha256 "${{ steps.hashes.outputs.sha_macos_x86 }}"
              end
            end

            on_linux do
              url "https://github.com/lex00/chant/releases/download/v#{version}/chant-linux-x86_64"
              sha256 "${{ steps.hashes.outputs.sha_linux }}"
            end

            def install
              bin.install Dir["chant-*"].first => "chant"
              if OS.mac?
                system "codesign", "-f", "-s", "-", "#{bin}/chant"
              end
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/chant --version")
            end
          end
          EOF

      - name: Commit and push
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          cd /tmp/homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Formula/chant.rb
          git commit -m "Update chant to v${{ steps.version.outputs.version }}"
          git push origin main

  update-scoop:
    needs: build-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p assets
          gh release download ${{ github.ref_name }} --dir assets

      - name: Compute SHA256 hash for Windows
        id: hash
        run: |
          cd assets
          SHA_WINDOWS=$(sha256sum chant-windows-x86_64.exe | awk '{print $1}')
          echo "sha_windows=$SHA_WINDOWS" >> $GITHUB_OUTPUT

      - name: Clone scoop-bucket
        env:
          GH_TOKEN: ${{ secrets.SCOOP_BUCKET_TOKEN }}
        run: |
          git clone https://x-access-token:${{ secrets.SCOOP_BUCKET_TOKEN }}@github.com/lex00/scoop-bucket.git /tmp/scoop-bucket

      - name: Update chant.json
        run: |
          cat > /tmp/scoop-bucket/chant.json << 'EOF'
          {
              "version": "${{ steps.version.outputs.version }}",
              "description": "Intent Driven Development tool with specification-driven execution",
              "homepage": "https://github.com/lex00/chant",
              "license": "Apache-2.0",
              "url": "https://github.com/lex00/chant/releases/download/v${{ steps.version.outputs.version }}/chant-windows-x86_64.exe",
              "hash": "${{ steps.hash.outputs.sha_windows }}",
              "bin": "chant-windows-x86_64.exe",
              "checkver": {
                  "github": "https://github.com/lex00/chant"
              },
              "autoupdate": {
                  "url": "https://github.com/lex00/chant/releases/download/v$version/chant-windows-x86_64.exe"
              }
          }
          EOF

      - name: Commit and push
        env:
          GH_TOKEN: ${{ secrets.SCOOP_BUCKET_TOKEN }}
        run: |
          cd /tmp/scoop-bucket
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add chant.json
          git commit -m "Update chant to v${{ steps.version.outputs.version }}"
          git push origin main
