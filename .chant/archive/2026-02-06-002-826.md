---
type: code
status: cancelled
---
# Fix prefix consistency and namespace worktrees by project name

## Problem
Multiple hardcoded `"chant/"` prefixes and `/tmp/chant-{id}` paths prevent multi-project coexistence in the same repo.

## Changes Required

### 1. `src/worktree/git_ops.rs` — Namespace worktree paths
- Change `worktree_path_for_spec(spec_id: &str)` signature to `worktree_path_for_spec(spec_id: &str, project_name: Option<&str>)`
- When `project_name` is `Some(name)` (and non-empty), path becomes `/tmp/chant-{name}-{spec_id}` instead of `/tmp/chant-{spec_id}`
- Update `create_worktree` similarly: add `project_name: Option<&str>` parameter, use it in the worktree path
- Update `get_active_worktree` similarly

### 2. `src/cmd/work/single.rs:547` — Use config branch prefix
- Replace `format!("chant/{}", spec.id)` with `format!("{}{}", config.defaults.branch_prefix, spec.id)`
- Config is already in scope as `config`

### 3. All callers of `worktree_path_for_spec` and `create_worktree` — Thread project name
- `src/cmd/work/single.rs` — has `config`, pass `config.project.name` as `Option<&str>` (treat empty string as None)
- `src/cmd/work/parallel.rs` — has `config`, same
- `src/cmd/watch.rs` — loads config, same
- `src/cmd/cleanup.rs` — needs to handle both namespaced and non-namespaced paths when scanning `/tmp`

### 4. Watch/worktree/cleanup branch parsing — Use config prefix
- `src/cmd/watch.rs:133,134,156,157` — Replace hardcoded `starts_with("chant/")` and `strip_prefix("chant/")` with the branch prefix from config
- `src/cmd/worktree.rs:80,88` — Replace hardcoded `strip_prefix("chant/")` and `strip_prefix("chant-")` with config-derived values
- `src/mcp/tools/watch.rs:37,38,57,58` — Replace hardcoded `starts_with("chant/")` and `strip_prefix("chant/")` with config prefix
- `src/cmd/cleanup.rs` — Update `starts_with("chant-")` checks to also match `chant-{project}-` pattern

### 5. `src/worktree/git_ops.rs` merge error extraction
- Line ~512: `let spec_id = branch.trim_start_matches("chant/");` — should use the branch prefix from config or accept it as parameter

### 6. `src/cmd/work/parallel.rs:299` cleanup handler
- `let branch = format!("chant/{}", spec_id);` — should use config branch prefix

### 7. Tests
- Update `test_worktree_path_for_spec` to test both with and without project name
- Update `test_create_worktree_success` assertion for path format
- Add test: two different project names produce different worktree paths
- Add test: two different project names with branch prefix produce different branch names

## Acceptance Criteria
- [ ] `worktree_path_for_spec` accepts optional project name and namespaces the path
- [ ] `create_worktree` accepts optional project name and uses it for path
- [ ] `single.rs` uses `config.defaults.branch_prefix` instead of hardcoded `"chant/"`
- [ ] All `strip_prefix("chant/")` calls use config-derived prefix
- [ ] All `starts_with("chant-")` path checks handle namespaced pattern
- [ ] `parallel.rs` cleanup handler uses config prefix
- [ ] Existing tests updated and pass
- [ ] New test verifies different project names → different paths
- [ ] `cargo test` passes
- [ ] `cargo clippy -- -D warnings` passes