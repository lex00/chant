---
type: code
status: completed
labels:
- ux
- agent-compat
target_files:
- src/cmd/search.rs
- src/cmd/export.rs
- src/cmd/work.rs
commits:
- 960a05a
completed_at: 2026-01-27T10:45:57Z
model: haiku
---
# Improve non-TTY error messages to show usage instead of TTY requirement

When commands with interactive wizard modes are run without required arguments in a non-TTY context, they should show helpful usage information instead of errors about TTY requirements. This prevents AI agents from incorrectly concluding that chant requires interactive mode.

## Problem

Current behavior when agent runs `chant search` (no query, no TTY):
```
Error: Interactive wizard requires a TTY
```

Agent interprets this as "chant requires interactive mode" and tells users chant can't be used non-interactively. This is incorrect - chant works fine with explicit arguments.

## Solution

When a command would launch a wizard but stdin is not a TTY:
1. Detect the non-TTY condition
2. Instead of erroring about TTY, print helpful usage information
3. Exit with code 0 (not an error) or a distinct exit code

### Example: `chant search` (no args, no TTY)

**Before:**
```
Error: Interactive wizard requires a TTY
```

**After:**
```
Usage: chant search <QUERY>

Examples:
  chant search "authentication"
  chant search --status pending "api"
  chant search --label bugfix

Run 'chant search --help' for all options.
```

### Example: `chant export` (no format, no TTY)

**Before:**
```
Error: Interactive wizard requires a TTY
```

**After:**
```
Usage: chant export --format <FORMAT>

Formats: json, csv, markdown

Examples:
  chant export --format json
  chant export --format csv --output specs.csv
  chant export --format markdown --status completed

Run 'chant export --help' for all options.
```

### Example: `chant work` (no spec, no TTY)

**Before:**
```
Error: Interactive spec picker requires a TTY
```

**After:**
```
Usage: chant work <SPEC_ID>

Examples:
  chant work 001-abc
  chant work 2026-01-27-001-abc
  chant work --parallel

Run 'chant work --help' for all options.
```

## Commands to Update

| Command | Wizard Trigger | Non-TTY Behavior |
|---------|---------------|------------------|
| `search` | No query arg | Show search usage |
| `export` | No format arg | Show export usage |
| `work` | No spec ID (picker mode) | Show work usage |
| `merge` | Confirmation prompt | Already handled (auto-proceeds) |

## Implementation

1. Create a helper function `print_usage_hint(command, examples)` in a shared location
2. In each command's wizard trigger point, check `atty::is(atty::Stream::Stdin)`
3. If not TTY, call the usage hint function instead of launching wizard
4. Exit with code 0 (informational) not error code

## Acceptance Criteria

- [x] `chant search` (no args, no TTY) prints usage hint, not TTY error
- [x] `chant export` (no format, no TTY) prints usage hint, not TTY error
- [x] `chant work` (no spec, no TTY) prints usage hint, not TTY error
- [x] Usage hints include concrete examples
- [x] Exit code is 0 (not error) for usage hints
- [x] Interactive mode still works when TTY is available
- [x] `just lint` passes with no warnings

## Notes

- The `atty` crate is already used elsewhere in the codebase
- This is specifically for agent compatibility - humans with TTY get the wizard
- Consider adding a `--no-interactive` flag in future for explicit control

## Agent Output

2026-01-27T10:45:57Z

```
I'll help you implement this spec to improve non-TTY error messages in chant. Let me start by understanding the current codebase and then plan the implementation.
Let me start by exploring the codebase structure to understand the current implementation.
Let me continue reading the main.rs file to see the command definitions:
Now let me look at the cmd module structure to understand how commands are implemented:
Perfect! Let me examine the search, export, and work command implementations:
Let me continue reading the search and export implementations to understand the wizard trigger:
Now let me look at how these commands are called from the main.rs:
Let me read more of main.rs to see where commands are dispatched:
Let me continue reading the Export command dispatch:
Let me update my todos and explore the search command implementation more:
Let me look at the search command's cmd_search function to see where the wizard is triggered:
Now let me look at the work command to see where the wizard is triggered:
Perfect! I can see the structure. Now let me check if the `atty` crate is already used in the project:
Good! `atty` is already being used. Let me check how it's used:
Perfect! Let me check what the existing code does for non-TTY in spec.rs:
Perfect! Now I have a clear understanding. Let me finalize my plan:

## Plan Summary

Based on my exploration, here's what I need to do:

1. **Create a usage hint helper function** - This will print helpful usage info instead of TTY errors
2. **Update search command** - When `opts.is_none()` and not TTY, print usage hint instead of running wizard
3. **Update export command** - When `is_wizard_mode` and not TTY, print usage hint instead of running wizard  
4. **Update work command** - When `ids.is_empty()` and not TTY, print usage hint instead of running wizard

The pattern already exists in the codebase (see how `spec.rs` handles non-TTY contexts for confirmations). I'll follow the same pattern.

Let me update my todo and start implementing:
Now let me implement the usage hint functions in the search command first. Let me create a helper module or add it directly to each command. I'll add a utility function to each file that needs it. Let me start with the search command:
Now let me add the usage hint function to search.rs and update the cmd_search function:
Now update the cmd_search function to check for non-TTY:
Now I need to add the atty import to search.rs:
Now let me update the export command. First, let me look at how cmd_export is called from mod.rs:
Now let me check where cmd_export is defined. I see it's being called from main.rs as cmd::spec::cmd_export. Let me check spec.rs:
Let me check spec.rs to see how it wraps cmd_export:
Let me use -C instead:
Let me read the export function in spec.rs:
Good. Now let me update the export.rs file to add the usage hint and non-TTY check:
Now update the cmd_export function to check for non-TTY:
Now let me update the work command. Let me add the usage hint function and check for TTY:
Let me add the usage hint function and atty import to work.rs:
Now update the cmd_work function to check for non-TTY when ids.is_empty():
Now let me update my todos and run the build to check for compilation errors:
Now let me run cargo fmt:
Good! Now let me run clippy to check for lint errors:
Excellent! Now let me run the tests:
Great! Tests passed. Let me verify the output file to see if all tests passed:
Good! All tests passed. Now let me verify the changes work as expected by testing them manually. Let me test the commands to see if they produce the expected output. First, let me build the project:
Perfect! Now let me test the commands to make sure they work as expected. Let me test them in a non-TTY context to ensure the usage hints are shown:
Excellent! The search command is showing the usage hint correctly in non-TTY. Now let me test the export command:
Perfect! Now let me test the work command:
Excellent! All three commands now show helpful usage hints instead of TTY errors when run without arguments in a non-TTY context. Let me update my todos and verify the acceptance criteria:
Now let me verify all acceptance criteria and update the spec file:
Perfect! Now I'll update the frontmatter and check off the acceptance criteria. Let me verify each criteria:

1. ✅ `chant search` (no args, no TTY) prints usage hint - tested above, shows hint
2. ✅ `chant export` (no format, no TTY) prints usage hint - tested above, shows hint
3. ✅ `chant work` (no spec, no TTY) prints usage hint - tested above, shows hint
4. ✅ Usage hints include concrete examples - all three commands have examples
5. ✅ Exit code is 0 - all return `Ok(())` which is exit code 0
6. ✅ Interactive mode still works when TTY is available - code only skips wizard if NOT TTY
7. ✅ `just lint` passes with no warnings - confirmed above

Now let me update the spec frontmatter:
Now let me update the acceptance criteria checkboxes:
Perfect! Now let me update my todos and commit 

... (output truncated, 7103 chars total)```
