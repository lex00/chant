---
type: code
status: completed
labels:
- bug
- worktree
- agent
target_files:
- src/cmd/work/single.rs
- src/worktree/git_ops.rs
- src/agent.rs
- src/spec/lifecycle.rs
branch: chant/2026-02-07-008-coe
---
# Investigate agents dying silently during worktree execution

## Observed Behavior

When `chant work <spec-id>` runs with worktree branching enabled, the agent process:
1. Creates worktree and branch successfully (verified with `git worktree list`)
2. Writes exactly one log entry (the initial "I'll do X" message)
3. Dies silently — no error in log, no stack trace, no stderr
4. Spec status gets set to `failed`
5. `chant_work_list` sometimes still shows process as "running" (stale)

## Reproduction (from 2026-02-07 session)

Specs 002, 003, 005 all exhibited this behavior:
- Project config has `defaults.branch: false` but specs had `branch: chant/...` injected from prior failed runs
- Worktrees created at `/private/tmp/chant-chant-<spec-id>` on correct commit
- `ps -p <pid>` showed process alive briefly, then gone
- Not memory pressure: 24GB RAM, plenty free pages, only 10 claude processes
- Works perfectly with `branch: false` (spec 001 and 007 succeeded this way)

## Hypotheses

1. **Code signing**: claude binary may fail codesign check when CWD is a worktree path
2. **CLAUDE.md resolution**: agent may fail to find/load CLAUDE.md in worktree directory
3. **Config resolution**: `.chant/config.md` may not resolve correctly from worktree path
4. **Stale branch field**: `branch:` field left from prior failed run causes worktree setup to fail on retry even after manual cleanup
5. **Race condition**: chant sets spec to `in_progress`, spawns agent, agent dies, chant sets to `failed` — all before log is flushed

## Key Files to Investigate

- `src/cmd/work/single.rs` — agent spawn logic
- `src/worktree/git_ops.rs` — worktree creation
- `src/agent.rs` — agent invocation
- `src/spec/lifecycle.rs` — status transitions

## Acceptance Criteria

- [x] Root cause identified for why agents die silently in worktrees
- [x] Fix implemented so agents either work in worktrees or produce a clear error
- [x] Stale `branch:` field from prior failed runs does not prevent retry
- [x] Agent death produces a diagnostic message in the log (not silent failure)

## Root Cause

The agent was being spawned in the main repository directory instead of the worktree directory. In `single.rs`, the code created a worktree but didn't pass the worktree path to the agent invocation functions. This caused:

1. Claude CLI to start with CWD = main repo, not worktree
2. CLAUDE.md and config files to be read from wrong location
3. File operations to target wrong directory
4. Silent failures when expectations didn't match reality

## Fix

1. **Working directory**: Modified `invoke_agent_with_command_override` in `src/cmd/agent.rs` to accept an optional `cwd` parameter and set the working directory before spawning the agent process. Updated call sites in `single.rs` and `chain.rs` to pass the worktree path.

2. **Stderr capture**: Added stderr capture and reporting in both `invoke_agent_with_command_override` and `invoke_agent_with_command` functions. When an agent exits with non-zero status, stderr output is now included in the error message, making silent failures visible.

3. **Empty output detection**: Added special diagnostic when agent produces no output and dies, suggesting to check working directory and CLAUDE.md configuration.