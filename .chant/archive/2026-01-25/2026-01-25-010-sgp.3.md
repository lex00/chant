---
type: code
status: completed
model: claude-opus-4-5-20251101
depends_on:
- 2026-01-25-010-sgp.2
target_files:
- src/cmd/commits.rs
- src/cmd/work.rs
- src/cmd/mod.rs
---
# Extract Commit Tracking Module

Create `src/cmd/commits.rs` containing commit detection and tracking logic used for spec finalization.

### Acceptance Criteria

- [x] `src/cmd/commits.rs` created with the following:
  - `pub enum CommitError` with variants: `GitCommandFailed(String)`, `NoMatchingCommits`
  - `impl std::fmt::Display for CommitError`
  - `impl std::error::Error for CommitError`
  - `pub fn get_commits_for_spec(spec_id: &str) -> Result<Vec<String>>`
  - `pub fn get_commits_for_spec_allow_no_commits(spec_id: &str) -> Result<Vec<String>>`
- [x] All code moved intact (~118 lines total including error type)
- [x] Error handling preserved: git command failures return error, fallback to HEAD if no matching commits found
- [x] `src/cmd/work.rs` updated to import from commits module
- [x] `src/cmd/mod.rs` updated to include `pub mod commits;`
- [x] All usages in finalization code work correctly
- [x] `just check` passes

### Edge Cases

- Git log with `--grep` pattern may find zero commits - fallback to HEAD with warning
- Git rev-parse for HEAD fallback may also fail - must return proper error
- Commit hashes must be parsed correctly from git log output (first whitespace-delimited word)
- Empty hash strings must be filtered out
- Pattern matching for "chant(spec-id)" must be exact and use proper escaping

### Example Test Cases

For this extraction, verify:
- `get_commits_for_spec` returns matching commits for valid spec ID
- With zero matching commits, fallback to HEAD hash is used with warning
- Both git log and HEAD fallback failing returns `CommitError::NoMatchingCommits`
- Commit hashes are properly parsed from oneline output
- CommitError Display impl shows correct messages for both error variants
