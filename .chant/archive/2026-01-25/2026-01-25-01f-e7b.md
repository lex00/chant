---
type: code
status: completed
model: claude-opus-4-5-20251101
target_files:
- tests/integration_tests.rs
- src/cmd/work.rs
---

# Replace synthetic driver auto-completion tests with real integration test

## Problem

The current "integration test" `test_driver_auto_completion_integration` is synthetic - it manually writes spec files with status changes rather than testing the actual execution pipeline:

```
chant work → agent runs → agent commits → finalize_spec → auto_complete_driver_if_ready
```

This means the tests pass even though users report driver auto-completion doesn't work in practice. The real issue is:
1. Agent doesn't commit with `chant(SPEC-ID):` pattern
2. `finalize_spec` fails to find commits
3. `auto_complete_driver_if_ready` is never called
4. Driver stays in_progress

## Solution

1. Delete `test_driver_auto_completion_integration` (lines 1862-2093) - it validates nothing useful
2. Add a real integration test that:
   - Creates driver + member specs
   - Creates commits with proper `chant(SPEC-ID):` message pattern
   - Calls the actual `finalize_spec` function
   - Verifies `auto_complete_driver_if_ready` is triggered
   - Verifies driver status changes to completed

## Acceptance Criteria

- [x] Delete `test_driver_auto_completion_integration` from integration_tests.rs
- [x] Add new test `test_driver_auto_completes_with_real_commits` that:
  - Creates a test git repo with proper setup
  - Creates driver spec (status: in_progress) and member spec (status: in_progress)
  - Makes a real git commit with message `chant(MEMBER-ID): test commit`
  - Calls `finalize_spec` on the member
  - Verifies member status is now `completed`
  - Verifies `auto_complete_driver_if_ready` was triggered
  - Verifies driver status is now `completed`
- [x] Test passes with `cargo test test_driver_auto_completes_with_real_commits`
- [x] All existing tests pass
- [x] `just check` passes

## Bug Fix (discovered during testing)

Found that `--finalize` path in work.rs didn't call `auto_complete_driver_if_ready`.
Fixed by adding the call after re-finalization completes (line 122-130 in work.rs).

## Implementation Notes

The test should use the library functions directly (not shell out to binary) to test the specific flow:

```rust
use chant::{spec, cmd::work::finalize_spec};

// After making commit...
finalize_spec(&mut member_spec, &member_path, &config, &all_specs, false)?;
assert_eq!(member_spec.frontmatter.status, SpecStatus::Completed);

// Check driver was auto-completed
let driver = Spec::load(&driver_path)?;
assert_eq!(driver.frontmatter.status, SpecStatus::Completed);
```
