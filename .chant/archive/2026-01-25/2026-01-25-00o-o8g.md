---
type: code
status: completed
target_files:
- src/worktree.rs
commits:
- '0375251'
completed_at: 2026-01-25T12:20:11Z
model: haiku
---
# Fix CI test failure causing failing badge

## Overview

The CI pipeline is failing due to test `test_merge_and_cleanup_successful_merge` in `src/worktree.rs`. This causes a red badge on the repo.

## Error

From CI logs:
```
test worktree::tests::test_merge_and_cleanup_successful_merge ... FAILED

thread 'worktree::tests::test_merge_and_cleanup_successful_merge' panicked at src/worktree.rs:374:9:
assertion failed: result.success && result.error.is_none()
```

## Analysis

The test is asserting `result.success && result.error.is_none()` but one of those is false. The `merge_and_cleanup` function was recently refactored to return `MergeCleanupResult` instead of `Result<()>`.

Possible causes:
1. The test environment on CI (Linux) behaves differently than local (macOS)
2. Race condition or timing issue
3. Git configuration differences between CI and local

## Acceptance Criteria

- [x] Identify root cause of test failure
- [x] Fix the failing test
- [x] Ensure test passes on both local and CI
- [x] All tests pass

## Agent Output

2026-01-25T12:20:11Z

```
I'll start by understanding the failing test and the code involved. Let me read the relevant files to identify the root cause.
Let me create a todo list to track the investigation and fix:
Now let me run the test locally to see what the actual failure is:
Interesting! The test passes locally. Let me check if there might be an environment-specific issue. Let me look at the recent CI logs or check the git history to see if there were any recent changes:
Let me try a different approach:
Let me check if the issue is with how the tests are being run:
I see. Let me check the justfile to understand how to properly run tests:
Now let me run the test again using the full path to cargo:
The test passes locally. The spec mentions that the test passes on macOS but fails on Linux in CI. This is likely a timing or git configuration issue. Let me analyze the test more carefully. The issue could be:

1. The test might depend on timing (race conditions)
2. Git configuration might differ on CI 
3. The worktree operations might fail on Linux when run in parallel

Let me check if there's a CI configuration file:
Let me check the CI configuration:
The CI runs on multiple platforms including ubuntu-latest. Let me analyze the test more carefully to find the potential issue. Looking at the test `test_merge_and_cleanup_successful_merge` (line 333-378), I notice:

1. The test creates a feature branch with commits
2. Calls `merge_and_cleanup(branch)` 
3. Asserts `result.success && result.error.is_none()`

The issue might be that the git commands are running in a fresh temporary directory, but `merge_and_cleanup()` operates on the **current working directory**, not on the worktree. The test sets up a repo, changes to it, but doesn't account for the fact that the function might fail if git is not in the expected state.

Let me check more carefully what could go wrong. Looking at the `merge_and_cleanup` function (lines 110-193), I see it tries to:
1. Checkout main
2. Merge with `--ff-only`
3. Delete the branch

The issue might be with the `--ff-only` flag on certain git versions or configurations. Let me test this locally with more debugging:
Let me update my todo and analyze the actual issue more carefully by looking at the test output one more time. Let me run the full test suite to see if there are any failures:
All tests pass! This is interesting - the test passes locally on macOS. According to the spec, the issue is that it fails on Linux CI. Let me think about what could cause platform-specific failures:

1. **File path handling** - `/tmp` paths might behave differently
2. **Git configuration** - different git versions or configurations on CI
3. **Race conditions** - timing issues specific to CI environment
4. **Permissions** - different permissions handling on Linux

Looking at the test again, I notice that it doesn't properly isolate the git environment. The test creates a repo in `/tmp/test-chant-repo-merge-success` and uses the `current_dir` parameter for git commands, but `merge_and_cleanup()` operates on the process's current working directory without any context about which repo it should work with.

The real issue is likely that the test might be flaky on CI due to race conditions when multiple tests run in parallel (note the `#[serial_test::serial]` attribute which suggests they should run serially).

Let me check if there's a race condition by examining how `merge_and_cleanup` depends on the current directory:
I see the issue now! The `merge_and_cleanup` function runs git commands without specifying a working directory. This means it uses the **process's current working directory**. The test changes the current directory with `std::env::set_current_dir(&repo_dir)`, but there could be a subtle timing issue.

Let me check the test more carefully:
Wait - I see that the test uses `std::env::set_current_dir(&repo_dir)` at line 339, which means the process IS in the repo directory when `merge_and_cleanup(branch)` is called at line 363. So the function should work.

Let me think about this differently. The spec says the test fails on Linux CI. Since I can't reproduce it locally, I need to think about what could be different:

1. **Concurrent test execution**: The test uses `#[serial_test::serial]` but maybe there's still an issue
2. **Temporary directory state**: `/tmp` on CI might have different permissions or cleanup behavior
3. **Git version differences**: Different git versions might behave differently with `--ff-only`
4. **Race condition in cleanup**: Maybe the cleanup from a previous test run isn't complete

Let me check if there are any pre-existing issues by looking at recent commits:
Let me look at what changed in the recent commit about the silent mode isolation test since it might give me clues:
Alright, let me think about this problem from a different angle. The spec says the test is failing on CI but not locally. Since the tests pass for me now, let me check if the test output is actually showing what I think. Let 

... (output truncated, 15556 chars total)```
