---
type: code
status: completed
model: claude-opus-4-5-20251101
depends_on:
- 2026-01-25-010-sgp.1
target_files:
- src/cmd/model.rs
- src/cmd/work.rs
- src/cmd/mod.rs
---
# Extract Model Selection Module

Create `src/cmd/model.rs` containing all model name detection and selection logic used during finalization.

### Acceptance Criteria

- [x] `src/cmd/model.rs` created with the following functions:
  - `get_model_name(config: Option<&Config>) -> Option<String>`
  - `get_model_name_with_default(config_model: Option<&str>) -> Option<String>`
  - `parse_model_from_claude_version() -> Option<String>`
- [x] All functions moved with their implementations (~79 lines)
- [x] Functions remain public and callable from `work.rs`
- [x] Model detection priority is preserved: CHANT_MODEL -> ANTHROPIC_MODEL -> config.defaults.model -> claude --version parsing
- [x] `src/cmd/work.rs` updated to import: `use crate::cmd::model::{get_model_name, get_model_name_with_default};`
- [x] `src/cmd/mod.rs` updated to include `pub mod model;`
- [x] All usages in `work.rs` and `parallel` execution work correctly
- [x] `just check` passes

### Edge Cases

- `CHANT_MODEL` and `ANTHROPIC_MODEL` env vars may be empty strings - should be treated as not set
- `claude --version` command may fail (command not found, permission denied) - should gracefully return None
- Model parsing from version output must handle various formats: "X.Y.Z (model-name)", with or without parentheses
- Config model may be None or empty string - should not be returned
- All fallback paths must be attempted in order until a valid model is found

### Example Test Cases

For this extraction, verify:
- `get_model_name` returns CHANT_MODEL when set and non-empty
- `get_model_name_with_default` returns config model when env vars not set
- `parse_model_from_claude_version` extracts model name from parentheses correctly
- `parse_model_from_claude_version` returns None if claude command fails
- Fallback order is preserved: env vars checked before config before version parsing
