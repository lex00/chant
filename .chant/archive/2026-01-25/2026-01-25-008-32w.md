---
type: research
status: completed
target_files:
- src/main.rs
commits:
- 4bab3b7
completed_at: 2026-01-25T10:11:07Z
model: haiku
---
# Investigate why 006 was prematurely marked complete

## Problem

Spec 006 (archive folder organization) was marked as completed by the agent, but it appears the work may have been incomplete or premature.

## Investigation Questions

1. **What was the completion criteria?**
   - Review the acceptance criteria in the spec
   - Were all criteria actually met?

2. **What triggered the completion?**
   - Did the agent mark it complete manually?
   - Did finalize_spec() run?
   - Was there a commit with the spec ID?

3. **What was missing or incomplete?**
   - Review the git diff for the spec
   - Check if all acceptance criteria checkboxes were validated
   - Were there untested edge cases?

4. **Root cause analysis**
   - Is this a problem with the standard prompt?
   - Is this a problem with finalize_spec() validation?
   - Should acceptance criteria be automatically validated?

## Investigation Findings

### What was Incomplete about 006

Spec 006's acceptance criterion states: **"`chant show` finds specs in archive subfolders"**

This criterion was marked as complete, but the implementation is **broken**:
- Archived specs exist in `.chant/archive/YYYY-MM-DD/` subdirectories (e.g., `.chant/archive/2026-01-24/2026-01-24-001-cxn.md`)
- The `chant show` command CANNOT find these archived specs
- Testing: `just chant show 2026-01-24-001-cxn` returns `Error: Spec not found: 2026-01-24-001-cxn`

### Root Cause Analysis

The issue is in how `resolve_spec()` works:

1. `resolve_spec()` is called with `specs_dir` (the `.chant/specs/` directory)
2. It calls `load_all_specs(specs_dir)` to get all specs
3. `load_all_specs()` was updated to recursively load specs from subdirectories
4. **However**: The archive is in a different location (`.chant/archive/`) and `load_all_specs()` is only called with the specs directory

**The fix requires**: `resolve_spec()` should also search archived specs, not just specs in the specs directory.

### Why This Wasn't Caught

The agent that completed spec 006:
1. Created tests for nested archive structure but only for `load_all_specs()` called with the archive directory directly
2. Ran `just test` and saw all tests pass (tests were incomplete - they didn't test the actual use case)
3. Marked the acceptance criteria as complete without actually validating the `chant show` command works with archived specs

### Root Cause Category

**Insufficient Validation**: The spec was marked complete based on:
- Tests passing (but tests were incomplete)
- Architectural change implemented correctly (but integration was missing)
- Manual testing was incomplete (didn't test the actual user-facing functionality)

The standard prompt did not emphasize validating that acceptance criteria work from the **user's perspective** (using CLI commands), only from the code/test perspective.

## Acceptance Criteria

- [x] Document what was incomplete about 006
- [x] Identify root cause of premature completion
- [x] Recommend fix (prompt change, code change, or both)
- [x] Create follow-up spec if code changes needed

## Recommendations

### Code Fix Required
A code fix is needed (created spec 2026-01-25-00a-u8k to address this). The `resolve_spec()` function must also search the archive directory to find archived specs.

### Prompt Enhancement
The standard prompt should emphasize:
1. **Validate acceptance criteria from user perspective**: Not just "tests pass" but "the actual CLI command works as expected"
2. **Manual validation required**: Run the actual commands that users would use, not just unit tests
3. **End-to-end testing**: If a criterion says "command X works with feature Y", actually test that specific command

## Agent Output

2026-01-25T10:11:07Z

```
I'll help you investigate why spec 006 was prematurely marked complete. Let me start by understanding the project structure and then examining spec 006.
Now let me look at the spec list and find spec 006:
Good, I found spec 006. Let me examine it more closely:
Now let me check the git commit for spec 006 to see what was actually done:
Let me update my todo and check the actual code changes:
Let me examine the code changes more carefully:
Now let me check the spec.rs changes:
Now let me check the actual spec file to see the acceptance criteria status:
Now let me run the tests to verify everything actually works:
Let me verify the implementation by running tests:
Good! All tests pass. Now let me manually verify the archive structure works as expected:
Perfect! Let me verify spec loading works correctly with nested directories:
Now let me verify the `show` command works for archived specs:
Aha! Found the issue. The `show` command doesn't find archived specs. Let me investigate further:
Let me examine how the `show` command resolves spec IDs:
Now let me check the `resolve_spec` function implementation:
Perfect! I found the issue. Let me trace through the code:

1. `resolve_spec` calls `load_all_specs(specs_dir)` where `specs_dir` is the `.chant/specs/` directory
2. `load_all_specs` in spec.rs now recursively loads from subdirectories BUT it's only called with `specs_dir`, not with the archive directory
3. Archived specs are in `.chant/archive/YYYY-MM-DD/` not in the specs directory

Let me check how the specs_dir is passed to resolve_spec:
Let me check the actual acceptance criteria once more to understand what the spec was supposed to do:
Excellent! I've found the root cause. The acceptance criterion on line 71 states: **"`chant show` finds specs in archive subfolders"** - but this is NOT actually working. Let me verify this is truly broken:
Perfect! Now let me update my todo and document the findings:
Now let me document my findings. First, let me read the current spec file:
Now let me update the spec with my findings:
Now I need to create a follow-up spec to actually fix the issue. Let me mark that todo as in progress and create the spec:
Let me use quotes properly:
Let me check the justfile to understand the quoting issue:
I see, the issue is with shell escaping. Let me try a different approach:
Perfect! Now let me read and update the spec:
Now let me mark the last acceptance criterion and commit my investigation:
Now let me update the status and commit:
Now let me commit the investigation results:
Perfect! Now let me update my todo list:
## Summary

I've completed the investigation of spec 006. Here's what I found:

### Root Cause: Incomplete Validation

Spec 006 was marked as completed but **one of its acceptance criteria is broken**: 
- **Criterion**: "`chant show` finds specs in archive subfolders"  
- **Reality**: `chant show 2026-01-24-001-cxn` returns `Error: Spec not found` for archived specs

### Why This Happened

The issue stems from how `resolve_spec()` works:
1. It calls `load_all_specs(specs_dir)` where `specs_dir` is `.chant/specs/`
2. Archived specs live in `.chant/archive/YYYY-MM-DD/` (a different location)
3. The archive directory is never searched, so archived specs remain unfindable

The agent who completed spec 006:
- Implemented the date-based folder structure correctly
- Created tests that passed (but only tested `load_all_specs()` in isolation)
- **Did not** manually validate that the actual CLI commands work (e.g., `chant show` on archived specs)
- Marked the criterion complete without end-to-end testing

### Recommendations

**Code Change Required** (spec 2026-01-25-00a-u8k created to address):
- Modify `resolve_spec()` to search both specs and archive directories

**Prompt Enhancement**:
- Emphasize validating acceptance criteria from the **user's perspective** (actual CLI commands)
- Require manual testing of functionality, not just unit tests
- Stress end-to-end validation

I've committed the investigation findings and created a follow-up spec (2026-01-25-00a-u8k) to fix the `resolve_spec()` function.```
