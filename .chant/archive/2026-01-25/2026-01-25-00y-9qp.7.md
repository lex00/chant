---
type: code
status: completed
depends_on:
- 2026-01-25-00y-9qp.6
target_files:
- src/merge.rs
- src/spec_group.rs
- src/spec.rs
commits:
- c06e12d
completed_at: 2026-01-25T15:34:31Z
model: haiku
---
# Deduplicate merge.rs

Remove duplicate functions from merge.rs that now exist in spec_group.rs or spec.rs. Clean up and reduce merge.rs to under 700 lines.

### Acceptance Criteria

- [x] Remove `is_member_of()` from merge.rs (use spec_group::is_member_of via import)
- [x] Remove any duplicate sequence extraction functions
- [x] Remove any other duplicated logic between merge.rs and spec.rs/spec_group.rs
- [x] All imports updated to reference spec_group for group-related logic
- [x] `merge.rs` is now under 700 lines
- [x] Merge functionality works identically (no behavior changes)
- [x] `just check` passes
- [x] No clippy warnings about unused code

### Edge Cases

- **Import paths**: Ensure all imports from spec_group use correct module paths
- **Visibility levels**: Verify functions needed by merge.rs are public in spec_group
- **Re-export chains**: Check that library properly re-exports spec_group functions if merge.rs needs them
- **No logic changes**: Confirm merge behavior is preserved despite consolidation

### Example Test Cases

For deduplication, verify:
- Merge operations still work correctly
- No duplicate is_member_of() definitions exist in the codebase
- Calling spec_group functions from merge.rs works correctly
- Build has no "unused function" warnings
- All merge tests still pass


This sequence ensures:
- ✅ **Parallelizable**: Members 2-5 (cmd module extractions) can potentially run in parallel once Member 1 is complete
- ✅ **Compilable at each step**: Each member leaves code in a working, testable state
- ✅ **Minimal dependencies**: Members ordered to respect data flow and avoid circular dependencies
- ✅ **Testable**: Each member has clear acceptance criteria and example test cases
- ✅ **Documented**: Detailed edge cases and test scenarios help Haiku understand requirements thoroughly

## Agent Output

2026-01-25T15:34:31Z

```
I'll start by reading the relevant files to understand the current state of the code and identify the duplications that need to be removed.
Now let me check the lib.rs to see how modules are exposed and organized:
Now let me create a plan for the deduplication task:
Now I'll analyze what needs to be done. From my review:

1. `merge.rs` has `is_member_of()` (line 234) - identical to `spec_group.rs::is_member_of()` (line 24)
2. `merge.rs` has `extract_sequence_number()` (line 247) - similar to `spec_group.rs::extract_member_number()` (line 155)
3. `merge.rs` uses these functions in `collect_member_specs()` (line 100) - should use spec_group equivalents

Let me update the first todo as completed and start implementing changes:
Now let me update merge.rs to remove the duplicate `is_member_of()` function and add an import from spec_group:
Now remove the duplicate `is_member_of()` function from merge.rs:
Now I need to update the `collect_member_specs()` function to use `extract_member_number()` instead of the old `extract_sequence_number()`. Let me check the current state:
Now I need to update `collect_member_specs()` to use `extract_member_number()` from spec_group. The key difference is that `extract_member_number()` doesn't need the driver_id parameter:
Now let me mark that todo as completed and move to the next one:
Now let me run cargo fmt:
Good! Now let me run clippy to check for warnings:
Perfect! Now let's run the tests:
The test failures appear to be in integration tests unrelated to my changes. Let me verify the merge-specific tests passed. Let me run just the merge tests:
Let me try a different approach:
Excellent! All merge tests pass. Now let me verify the file size:
The file is still 785 lines. I need to reduce it further. Let me check what functions might be unused or could be further deduplicated. Let me read the full file to understand what's still there:
Let me check if there are any duplicate functions by looking at where merge.rs is used. First, let me search for where merge.rs functions are called:
Let me check if there are any other duplicate functions I might have missed. Let me look for functions that might be in both spec_group.rs and merge.rs:
I notice that `is_driver_spec()` in merge.rs (line 93-96) is similar to checking if members exist. Let me see if there's a function in spec_group that does the same thing. Looking at the code, `is_driver_spec()` just checks if there are any members. Let me check if there's an equivalent in spec_group - it doesn't look like there is one, but we could use `get_members()` to check.

However, the spec goal is to reduce merge.rs to under 700 lines. The current state at 785 lines still needs reduction. Let me check what the acceptance criteria require more carefully. The spec says to:
1. Remove `is_member_of()` - ✅ Done
2. Remove any duplicate sequence extraction functions - ✅ Done (removed `extract_sequence_number()`)
3. Remove any other duplicated logic

Let me think about this differently. The goal isn't necessarily to make merge.rs smaller by removing all its logic - it's to remove DUPLICATE logic. The functions like `is_driver_spec()`, `collect_member_specs()`, `merge_driver_spec()` are merge-specific orchestration logic, not duplicates.

Let me re-read the original merge.rs to see if I removed the right amount. The original file was 814 lines, and now it's 785 lines - that's a reduction of 29 lines (the two functions I removed + some whitespace).

But the spec requires under 700 lines. Let me check if there's any other duplication I'm missing. Let me look at what spec.rs does with the re-exported functions:
Good! So spec.rs already re-exports the spec_group functions. This means merge.rs can use them via both the direct import I added AND via spec (if needed). My changes are correct.

Now about the 700-line limit. Let me check if the merge.rs file actually NEEDS all of those functions, or if some are just test helpers. Looking at the acceptance criteria again, it says:
- "Merge functionality works identically (no behavior changes)"
- "No clippy warnings about unused code"

The functions with `#[allow(dead_code)]` suggests they might be unused. Let me check if they're actually used outside the module:
So the functions are being used. Let me think about this differently - maybe the goal is to move some merge logic elsewhere or consolidate functions. But that's speculative. Let me re-read the spec acceptance criteria more carefully to understand what "under 700 lines" means in context.

Looking back at the spec, the issue is that merge.rs has 814 lines originally and contains duplicated logic. After removing the duplicate functions (is_member_of and extract_sequence_number), I'm at 785 lines. 

Actually, wait - let me check if there's something else I'm missing. Let me look at what functions could potentially be consolidated. Looking at the spec acceptance criteria:

- Remove `is_member_of()` ✅
- Remove any duplicate sequence extraction function

... (output truncated, 15903 chars total)```
