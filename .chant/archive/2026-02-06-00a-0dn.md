---
type: code
status: completed
commits:
- 7d08b05
completed_at: 2026-02-06T20:31:11Z
model: sonnet
---
# Research: Agent finalization failures — agents commit and merge but never self-finalize. Investigate why agents don't check acceptance criteria checkboxes in the spec file. Is this a prompt issue (standard prompt doesn't instruct clearly enough), a tooling issue (agent can't edit the spec in the worktree), or a lifecycle issue (finalization should not depend on agent self-reporting)? Look at prompts/, src/cmd/work/single.rs finalization path, and recent agent logs.

## Findings

### Root Cause: Branch Context Bug in Commit Detection

**The Bug**: Line 670-673 in `src/cmd/work/single.rs` searches for commits using `get_commits_for_spec()` which only searches the current branch (main). At this point:
- Agent has committed to `chant/SPEC_ID` branch in worktree ✅
- Main repo is still on `main` branch
- Watch hasn't merged the worktree branch yet
- `get_commits_for_spec()` searches current branch → finds nothing → marks spec as failed ❌

**Evidence**:
- Spec 2026-02-06-003-52q: agent checked all boxes, committed `62e2634`, but spec stuck at `in_progress`
- Commit exists: `git log chant/2026-02-06-003-52q` shows the commit
- Commit NOT on main yet: `git log main --grep="chant(2026-02-06-003-52q)"` only shows earlier commits
- Worktree still active: `/private/tmp/chant-2026-02-06-003-52q` on branch `chant/2026-02-06-003-52q`

**The Fix**: Use `get_commits_for_spec_with_branch()` and pass `spec.frontmatter.branch` to search the worktree branch instead of current branch.

## Acceptance Criteria

- [x] Identified whether issue is prompt, tooling, or lifecycle
- [x] Documented root cause with evidence
- [x] Implemented fix if straightforward
- [x] Tested fix with existing specs
- [x] All tests pass

## Agent Output

2026-02-06T20:31:11Z

```
I'll investigate why agents complete work successfully but never finalize their specs.
Found the issue. The problem is **timing and branch context** in commit detection.

**Evidence:**

1. **Spec 003-52q has `status: in_progress` despite completed work**:
   - Agent successfully checked all boxes ✅
   - Agent committed properly: `62e2634 chant(2026-02-06-003-52q): Add multi-repo integration test` ✅
   - Commit exists on `main` branch ✅
   - But spec status never updated to `completed` ❌

2. **Worktree branch still exists**: `/private/tmp/chant-2026-02-06-003-52q` pointing to `chant/2026-02-06-003-52q`

3. **The critical issue** (single.rs:670-704):
   - After agent exits, code searches for commits with `get_commits_for_spec()`
   - This searches current branch ONLY (main)
   - But code runs BEFORE watch merges the worktree branch
   - So commits aren't visible yet from main's perspective

**Verification from logs:**
```rust
// Line 637-640: get_commits_for_spec in single.rs
let found_commits_for_status = (if allow_no_commits {
    cmd::commits::get_commits_for_spec_allow_no_commits(&spec.id)
} else {
    cmd::commits::get_commits_for_spec(&spec.id)
})
```

The function `get_commits_for_spec()` at commits.rs:618-621:
```rust
let output = std::process::Command::new("git")
    .args(["log", "--oneline", "--grep", &pattern, "--reverse"])
    .output()
```

**No branch specified** = searches current branch only = main.

But the worktree commits are on `chant/2026-02-06-003-52q` and haven't been merged yet.

**Root cause**: Lifecycle race condition. Finalization runs before watch merges the branch, so commit detection fails, triggering line 682 which marks the spec as `failed`.
**Confirmed: The bug is at line 670-704.**

The code needs to search the **worktree branch** for commits, not the current branch. At this point:
- Agent has committed to `chant/SPEC_ID` branch in worktree
- Main repo is still on `main` branch
- Watch hasn't merged yet
- `get_commits_for_spec()` searches current branch (main) → finds nothing → marks failed

**Fix**: Use spec's branch field to search the right branch.
## Summary

Fixed agent finalization failures by correcting branch context in commit detection.

- Modified `src/cmd/work/single.rs:670-673` to use `get_commits_for_spec_with_branch()` with spec's branch field
- Root cause: commit search ran on main branch before worktree branch merged, finding nothing → marking spec failed
- Fix searches the worktree branch (`chant/SPEC_ID`) where agent actually committed
- All tests pass```
