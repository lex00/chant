---
type: code
status: completed
target_files:
- src/cmd/lifecycle.rs
- tests/integration_tests.rs
commits:
- 1d8e4ce
completed_at: 2026-01-29T18:39:13Z
model: opus
informed_by:
- .chant/specs/2026-01-29-00g-w4m.md
---
# Add output schema validation to finalize command

## Problem

Output schema validation (implemented in spec 00g-w4m) is inconsistently applied:

**✓ Validates output:**
- `chant work <spec-id>` - Validates during execution (src/cmd/work.rs:711)
- `chant lint` - Batch validation for completed specs (src/cmd/spec.rs:2124)

**✗ Does not validate:**
- `chant finalize <spec-id>` - Manual finalization skips output schema validation

This creates an inconsistency where:
1. Auto-finalization (after `chant work`) validates output schemas
2. Manual finalization (explicit `chant finalize`) bypasses validation

**Example scenario:**
```bash
# Agent completes work but auto-finalize is disabled
chant work <spec-id> --no-finalize

# User manually finalizes later
chant finalize <spec-id>
# ← No output validation happens! Schema violations are missed.
```

This defeats the purpose of output schema enforcement.

## Root Cause

The `cmd_finalize()` function in `src/cmd/finalize.rs` doesn't import or call the validation module:

```rust
// src/cmd/finalize.rs - NO validation imports or calls
pub fn cmd_finalize(spec_id: &str) -> Result<()> {
    // ... loads spec
    // ... checks acceptance criteria
    // ... updates status to completed
    // ← Missing: validate output schema
    // ... saves spec
}
```

Meanwhile, `cmd_work()` does validate:

```rust
// src/cmd/work.rs:711
if let Some(schema_path) = &spec.frontmatter.output_schema {
    match validation::validate_agent_output(&spec.id, schema_path, &agent_output) {
        Ok(()) => println!("✓ Output validation passed"),
        Err(e) => {
            // Handle validation failure based on strict mode
        }
    }
}
```

## Solution

Add output schema validation to `cmd_finalize()` before finalizing the spec.

### Implementation

1. **Import validation module** in `src/cmd/finalize.rs`:
   ```rust
   use chant::validation;
   ```

2. **Add validation check** after loading spec, before finalizing:
   ```rust
   // After spec is loaded, before status update
   if let Some(schema_path) = &spec.frontmatter.output_schema {
       // Read agent output from log file
       let log_path = PathBuf::from(format!(".chant/logs/{}.log", spec_id));
       if log_path.exists() {
           let agent_output = std::fs::read_to_string(&log_path)
               .context("Failed to read agent log")?;

           match validation::validate_agent_output(&spec.id, schema_path, &agent_output) {
               Ok(()) => {
                   println!("✓ Output validation passed");
               }
               Err(e) => {
                   // Check strict mode
                   let config = Config::load().ok();
                   let strict = config
                       .and_then(|c| c.validation)
                       .map(|v| v.strict_output_validation)
                       .unwrap_or(false);

                   eprintln!("✗ Output validation failed: {}", e);
                   eprintln!("  → Agent output does not match required schema");
                   eprintln!("  → Schema: {}", schema_path.display());

                   if strict {
                       return Err(anyhow!(
                           "Cannot finalize: output validation failed (strict mode enabled)"
                       ));
                   } else {
                       eprintln!("  ⚠ Proceeding with finalization (strict mode disabled)");
                   }
               }
           }
       } else {
           eprintln!("⚠ No log file found at {}, skipping output validation", log_path.display());
       }
   }
   ```

3. **Respect strict mode** from config:
   - `strict_output_validation: true` → Fail finalization if validation fails
   - `strict_output_validation: false` → Warn but allow finalization (default)

### Behavior

**Before (current):**
```bash
chant finalize <spec-id>
✓ Spec finalized!
# ← No validation, schema violations missed
```

**After (with fix):**
```bash
chant finalize <spec-id>
✓ Output validation passed
✓ Spec finalized!
```

**With validation failure (strict mode):**
```bash
chant finalize <spec-id>
✗ Output validation failed: missing required field 'spec_id'
  → Agent output does not match required schema
  → Schema: .chant/schemas/research-report.json
Error: Cannot finalize: output validation failed (strict mode enabled)
```

**With validation failure (non-strict mode):**
```bash
chant finalize <spec-id>
✗ Output validation failed: missing required field 'spec_id'
  → Agent output does not match required schema
  → Schema: .chant/schemas/research-report.json
  ⚠ Proceeding with finalization (strict mode disabled)
✓ Spec finalized!
```

## Edge Cases

1. **No log file exists** - Skip validation with warning (spec might have been worked before output_schema was added)
2. **No output_schema defined** - Skip validation (not all specs need schema)
3. **Log file empty** - Validation will likely fail (expected behavior)
4. **Schema file doesn't exist** - validation module will return error (expected behavior)

## Acceptance Criteria

- [x] Import `chant::validation` module in `src/cmd/finalize.rs`
- [x] Add output schema validation before finalizing spec
- [x] Read agent output from `.chant/logs/<spec-id>.log`
- [x] Call `validation::validate_agent_output()` if `output_schema` is present
- [x] Respect `strict_output_validation` config setting
- [x] Fail finalization if validation fails in strict mode
- [x] Warn but allow finalization if validation fails in non-strict mode
- [x] Handle missing log file gracefully (warn and skip validation)
- [x] Print clear error messages showing what failed
- [x] All existing tests pass
- [x] Run `cargo fmt` and `cargo clippy`
- [x] Add integration test for finalize with output validation

## Files to Modify

- `src/cmd/finalize.rs` - Add validation check in `cmd_finalize()` and `finalize_spec()`
- `tests/integration_tests.rs` - Add test for finalize with output validation (optional but recommended)