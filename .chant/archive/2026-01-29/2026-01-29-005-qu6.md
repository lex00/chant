---
type: code
status: completed
target_files:
- src/main.rs
- src/config.rs
- .chant/config.md
- .chant/.gitignore
- CLAUDE.md
- docs/reference/config.md
commits:
- 10f9ee4
completed_at: 2026-01-29T01:17:40Z
model: opus
---
# Implement agent config separation (no migration needed)

## Problem

`.chant/config.md` mixes project settings (should be in git) with agent configs (should not be in git). Since chant has no external users yet, we can fix this properly without migration complexity.

## Solution

**Simple breaking change (pre-release, no users affected):**

### 1. Remove agents from project config template

Update `src/main.rs` init template:
- Remove `parallel:` section with agents from `.chant/config.md` template
- Add `agents.md` to `.chant/.gitignore` template
- Show message during init: "Add agents to ~/.config/chant/config.md or .chant/agents.md"

### 2. Fix Config::load() to use merge semantics

Currently `Config::load()` ignores global config. Fix it:
- Make `Config::load()` call `load_merged()` internally
- Remove `load()` vs `load_merged()` distinction - always merge
- Global config (`~/.config/chant/config.md`) becomes the user config source

### 3. Support optional .chant/agents.md

For project-specific agent overrides (rare case):
- Check for `.chant/agents.md` (gitignored)
- Merge priority: `.chant/agents.md` > global > project
- Only for `parallel.agents` section

### 4. Update this repo

Move our own agents config out:
- Remove `parallel:` section from `.chant/config.md`
- Keep it in `~/.config/chant/config.md` (user's global config)
- Commit clean project config

### 5. Update documentation

- **CLAUDE.md**: Show agent config goes in global config
- **docs/reference/config.md**: Document the split
- Remove parallel.agents examples from project config docs

## Why This Works

✅ No external users - no breaking change impact
✅ Simpler than migration path
✅ Correct from the start
✅ Security: agents with API keys stay out of git
✅ Portability: each developer configures their own agents globally

## Acceptance Criteria

- [x] Remove parallel.agents from src/main.rs config template
- [x] Add agents.md to .chant/.gitignore template in src/main.rs
- [x] Make Config::load() use load_merged() semantics
- [x] Update all Config::load() callers if needed
- [x] Support .chant/agents.md for project-specific overrides
- [x] Remove parallel section from .chant/config.md in this repo
- [x] Update CLAUDE.md to document global agent config
- [x] Update docs/reference/config.md
- [x] All tests passing
- [x] Code linted and formatted

## Agent Output

2026-01-29T01:17:40Z

```
I'll implement the agent config separation for chant. Let me start by reading the relevant code to understand the current implementation.
Now let me read the main.rs to find the config template and gitignore template.
Now let me check where `Config::load()` is used throughout the codebase.
Now I understand the structure. Let me implement the changes step by step:

1. First, update `src/main.rs` to remove the parallel config from the template and add `agents.md` to gitignore
Now let's update `Config::load()` to use `load_merged()` semantics. I need to modify the config.rs file.
Now I understand the structure. I need to:
1. Make `Config::load()` call `load_merged()` 
2. Add support for `.chant/agents.md` for agent-specific overrides
3. Update the merge logic to handle the 3-way merge (project config, agents.md, global config)

Let me update the config.rs file:
Now I need to add the `AgentsConfig` struct and update the `PartialConfig` to remove `#[allow(dead_code)]` since it's now used:
Now I need to add the `AgentsConfig` struct and remove the `#[allow(dead_code)]` annotations. Let me first add the AgentsConfig struct right after the global_config_path function:
Now I need to update the existing tests that use the old `load_merged_from` signature (they pass 2 arguments instead of 3). Let me check the test cases:
I need to update all the test cases that use `load_merged_from` to pass the third argument. Let me find all of them:
I need to update all the test cases to add `None` as the third argument (for agents_path). Let me update them all at once:
Now let me add a test for the agents.md functionality:
Now let me remove the parallel section from the .chant/config.md in this repository:
Now I need to add `agents.md` to the `.chant/.gitignore` file in this repo:
Now let me update CLAUDE.md to document global agent config:
Now I'll update the Configuration section in CLAUDE.md to document the agent config separation:
Now let me update docs/reference/config.md to document the agent config separation:
Now I also need to update the "Parallel Execution" section in the docs to mention that agents should be configured globally:
Now let's run cargo fmt, clippy, and tests:
There are only warnings in the test file (not related to my changes). Let me run the tests now:
All tests pass. Now let me run the full test suite using `just test`:
All tests pass. Now let me update the spec file to mark the acceptance criteria as completed:
Now let me commit the changes:
The changes look correct. Let me commit them:
The remaining modified files are in the archive and not related to this spec. The main implementation is complete and committed.
I have successfully implemented the agent config separation for chant. Here's a summary of what was done:

## Summary

### Changes Made

1. **Updated `src/main.rs`** (line 1159):
   - Added `agents.md` to the `.chant/.gitignore` template so new projects automatically gitignore agent config

2. **Updated `src/config.rs`**:
   - Changed `Config::load()` to use merged config semantics (now calls `load_merged_from` internally)
   - Added `AgentsConfig` struct for loading `.chant/agents.md`
   - Updated `load_merged_from` to accept a third parameter for agents config path
   - Added 4 new tests for agents config override behavior
   - Removed `#[allow(dead_code)]` annotations since the merge functions are now used

3. **Updated `.chant/config.md`** (this repo):
   - Removed the `parallel:` section with agents configuration
   - Agent configs should now be in `~/.config/chant/config.md` (global) or `.chant/agents.md` (project-specific, gitignored)

4. **Updated `.chant/.gitignore`** (this repo):
   - Added `agents.md` to the gitignore

5. **Updated `CLAUDE.md`**:
   - Documented the new configuration hierarchy (global → project → agents)
   - Explained that agent definitions should go in global config or `.chant/agents.md`

6. **Updated `docs/reference/config.md`**:
   - Added documentation for the config merge behavior with three sources
   - Added section explaining project agents override with `.chant/agents.md`
   - Updated the parallel execution section to recommend global config for agents

### Config Merge Order

The new merge order is:
1. **Global config** (`~/.config/chant/config.md`) - User-wide defaults including agent definitions
2. **Project config** (`.chant/config.md`) - Project-specific settings (committed to git)
3. **Agents config** (`.chant/agents.md`) - Optional agent overrides (gitignored, only for `parallel.agents`)

This keeps sensitive agent configuration (API keys, account settings) out of git while allowing project-specific settings to be shared with the team.```
