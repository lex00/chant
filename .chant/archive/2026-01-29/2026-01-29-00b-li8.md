---
type: code
status: completed
target_files:
- src/main.rs
- src/cmd/work.rs
commits:
- 9e26b21
completed_at: 2026-01-29T13:26:51Z
model: opus
---
# Fix: chant work --chain with spec IDs should chain only through specified specs

## Problem

When running `chant work --chain spec1 spec2 spec3`, the current behavior is:
1. Execute `spec1` (as starting spec)
2. Then chain through **ALL** ready specs (ignoring `spec2`, `spec3`)

**User expectation:**
Chain should execute ONLY the specified specs in the order provided:
1. Execute `spec1`
2. Then execute `spec2`
3. Then execute `spec3`
4. Stop (don't chain through other ready specs)

**Observed behavior:**
In wobble-typescript, running:
```bash
chant work --chain 039-sl6 03a-4ip 03b-cn3 03c-qyt 03d-kt0 03e-cl4
```

Executes `039-sl6` then continues to work on **other ready specs not in the list**.

## Root Cause

**Location:** `src/main.rs:309` and `src/cmd/work.rs:1113-1200`

```rust
// main.rs:309 - Only uses first ID
if chain {
    let chain_options = ChainOptions {
        // ...
        starting_spec_id: ids.first().map(String::as_str),  // ← Only first!
    };
    return cmd_work_chain(&specs_dir, &prompts_dir, &config, chain_options);
}

// work.rs:1113-1152 - Executes starting spec
if let Some(starting_id) = options.starting_spec_id {
    let spec = spec::resolve_spec(specs_dir, starting_id)?;
    // execute...
}

// work.rs:1154+ - Chains through ALL ready specs
while failed_spec.is_none() {
    let next = find_next_ready_spec(specs_dir, options.labels)?;
    // ← Doesn't check if spec was in original ID list!
}
```

## Solution: Chain Only Through Specified IDs

**Recommended approach:** Option B - If IDs provided, chain only through those IDs in order.

### Implementation Plan

1. **Pass all IDs to chain command**
   - Change `ChainOptions` to include `specific_ids: Vec<String>` instead of `starting_spec_id`
   - Pass all `ids` from command line, not just `ids.first()`

2. **Chain through specified IDs only**
   - If `specific_ids` is not empty, iterate through that list
   - If `specific_ids` is empty, use existing behavior (all ready specs)

3. **Validate IDs before chaining**
   - Resolve all IDs upfront to fail fast if any are invalid
   - Check if specs are ready (warn if not, skip them)

### Pseudocode

```rust
// In main.rs
if chain {
    let chain_options = ChainOptions {
        // ...
        specific_ids: ids.clone(),  // Pass ALL IDs
    };
    return cmd_work_chain(&specs_dir, &prompts_dir, &config, chain_options);
}

// In work.rs cmd_work_chain
pub fn cmd_work_chain(specs_dir: &Path, prompts_dir: &Path, config: &Config, options: ChainOptions) -> Result<()> {
    if !options.specific_ids.is_empty() {
        // Chain through specified IDs only
        for spec_id in &options.specific_ids {
            let spec = spec::resolve_spec(specs_dir, spec_id)?;

            // Check if spec is ready
            if !spec.is_ready(&all_specs) {
                println!("⚠ Skipping {}: not ready", spec_id);
                continue;
            }

            // Execute spec
            match execute_single_spec_in_chain(...) {
                Ok(()) => completed += 1,
                Err(e) => {
                    failed_spec = Some((spec_id.clone(), e.to_string()));
                    break;  // Stop chain on failure
                }
            }

            // Check max limit
            if options.max_specs > 0 && completed >= options.max_specs {
                break;
            }
        }
    } else {
        // No specific IDs - chain through all ready specs (existing behavior)
        while failed_spec.is_none() {
            let next = find_next_ready_spec(specs_dir, options.labels)?;
            // ...
        }
    }
}
```

## Acceptance Criteria

- [x] `chant work --chain spec1 spec2 spec3` chains through ONLY those 3 specs in order
- [x] `chant work --chain` (no IDs) chains through all ready specs (existing behavior)
- [x] Invalid spec IDs fail fast with clear error before execution starts
- [x] Non-ready specs in the list are skipped with warning, chain continues
- [x] Chain stops on first failure (don't continue to next spec)
- [x] `--chain-max` limit applies to specified IDs (stop after N specs even if more IDs provided)
- [x] `--label` filter is ignored when specific IDs are provided (IDs take precedence)
- [x] All existing tests pass
- [x] Add test: chain with specific IDs executes only those specs
- [x] Add test: chain with no IDs chains through all ready specs
- [x] Add test: chain stops on first failure
- [x] Documentation updated to clarify behavior

## Files to Modify

- `src/main.rs`: Pass all `ids` to chain options, not just `first()`
- `src/cmd/work.rs`: Add `specific_ids` to `ChainOptions`, implement ID-based chaining logic
- Tests for chain behavior with specific IDs