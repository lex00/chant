---
type: code
status: completed
target_files:
- src/main.rs
- src/merge_driver.rs
- CLAUDE.md
commits:
- a90c619
completed_at: 2026-01-29T01:55:00Z
model: opus
---
# Make chant init automatically set up merge driver

## Problem

The custom merge driver (for resolving spec file conflicts) must be manually activated with `chant merge-driver-setup`. This is bad UX because:

**Why users need it:**
- Specs with `branch: true` create merge conflicts (status, commits fields)
- The merge driver automatically resolves these conflicts
- Without it, users manually edit frontmatter or get stuck

**Why manual setup fails:**
- Not mentioned during `chant init`
- Users don't know merge driver exists
- They hit conflicts and don't know the fix
- Only power users read docs and find `chant merge-driver-setup`

**Result:** Core workflow (branch mode) is broken by default

## Solution

Make `chant init` set up the merge driver automatically (or prompt):

### Option A: Automatic (recommended)
```bash
chant init
# Automatically runs merge-driver-setup
# No prompt, just works
```

**Pros:**
- Just works, no friction
- Users never hit spec conflicts
- Core workflow works out of the box

**Cons:**
- Modifies .git/config without asking (but so does `git init`)
- Modifies .gitattributes (but that's checked in anyway)

### Option B: Prompt
```bash
chant init
# Prompt: "Set up custom merge driver for spec files? [Y/n]"
# Default: Yes
```

**Pros:**
- User has control
- More transparent

**Cons:**
- Extra friction
- Users might say no without understanding impact
- Still breaks by default if they skip it

### Recommendation: Option A (automatic)

Just set it up during init. It's core infrastructure, not optional.

## Implementation

Update `src/main.rs` init command:
```rust
Commands::Init { force, silent, agent } => {
    // ... existing init logic
    
    // Set up merge driver automatically
    if let Err(e) = cmd_merge_driver_setup() {
        eprintln!("Warning: Failed to set up merge driver: {}", e);
        eprintln!("Run 'chant merge-driver-setup' manually later");
    }
    
    Ok(())
}
```

Alternatively, for Option B (prompt):
```rust
if !silent {
    let setup_merge_driver = dialoguer::Confirm::new()
        .with_prompt("Set up custom merge driver for spec files?")
        .default(true)
        .interact()?;
    
    if setup_merge_driver {
        cmd_merge_driver_setup()?;
    }
}
```

## What the merge driver does

When git merges branches with spec conflicts:
- **Status field:** Prefers more advanced (completed > in_progress > pending)
- **Commits list:** Merges without duplicates
- **completed_at:** Takes latest timestamp
- **Labels, target_files:** Deduplicates lists

Without it: Git shows conflict markers, user manually edits.

## Acceptance Criteria

- [x] Decide Option A (automatic) or Option B (prompt)
- [x] Update `chant init` to call merge-driver-setup
- [x] Handle errors gracefully (warn but don't fail init)
- [x] Test init in new repo (merge driver should be active)
- [x] Update docs to mention merge driver is automatic
- [x] All tests passing
- [x] Code linted and formatted

## Agent Output

2026-01-29T01:55:00Z

```
I'll start by reading the relevant code to understand how `chant init` works and how `merge-driver-setup` is implemented.
Now let me look at the merge driver implementation to understand how it works and what setup instructions are shown:
Now I understand the current implementation. The `merge-driver-setup` command just prints instructions - it doesn't actually set up the merge driver. The `.gitattributes` file is already created during `chant init` (line 1173-1184), but the git config for the merge driver (Step 2 in the instructions) is NOT automatically set up.

Let me read the spec to understand the acceptance criteria better:
Now I have a clear understanding. Let me create a todo list to track my work:
Based on the spec's recommendation and analysis:

**Decision: Option A (automatic)**

Reasons:
1. The spec explicitly recommends Option A
2. The merge driver is core infrastructure for branch mode to work properly
3. It's similar to how `git init` modifies `.git/config` without asking
4. `.gitattributes` is already created automatically by `chant init`
5. Less friction = better UX
6. Users who don't understand the prompt might say "no" and break the workflow
Now I need to implement a function that actually sets up the merge driver (not just prints instructions). I'll add this to `merge_driver.rs`:
Now I need to update `chant init` to call the `setup_merge_driver` function. I'll also need to update the `cmd_merge_driver_setup` function to use the new setup function and provide feedback. Looking at the code, I see that `chant init` already creates the `.gitattributes` file (lines 1173-1184), so I need to:

1. Remove the duplicate `.gitattributes` creation from `cmd_init` (since `setup_merge_driver` now handles it)
2. Call `setup_merge_driver` at the end of init
3. Handle errors gracefully
Now I'll make the changes to `cmd_init`:

1. Replace the `.gitattributes` creation block with a call to `setup_merge_driver`
2. Update the `cmd_merge_driver_setup` function to use the new setup function
Now I need to update the output section to show the merge driver status. Let me find the right place to add the feedback:
Now let me add the merge driver status message after the agent configuration section:
Now I need to update the `cmd_merge_driver_setup` function to actually perform the setup (not just print instructions). This way both `chant init` and `chant merge-driver-setup` use the same underlying function:
I need to update `cmd_merge_driver_setup` to actually run the setup AND show instructions:
Now I need to update the documentation in CLAUDE.md to mention that the merge driver is set up automatically. Let me find the relevant section:
I need to update the documentation to reflect that the merge driver is now set up automatically by `chant init` (not with a special flag):
Now let me run cargo fmt and cargo clippy:
The clippy warnings are all from pre-existing code, not from my changes. There are no errors in my new code. Let me run the tests now:
Let me see the complete test results:
All tests pass. Now let me verify that the implementation works as expected by testing the init command in a new temp directory:
Let me verify the git config was actually set:
The merge driver is properly configured. Now let me also test the `chant merge-driver-setup` command:
Now let me test what happens when init is run outside a git repo:
Errors are handled gracefully - init still succeeds but shows a warning. Let me also check that the `.gitattributes` was still created:
Excellent! The `.gitattributes` file is created even outside a git repo, so it'll be ready when git init is run later.
Now let me update the spec file to check off the acceptance criteria:
Now I need to add the `model` field to the spec frontmatter since all acceptance criteria are met:
Now let me commit the changes:
The changes look good. Now let me commit them:
The implementation is complete. Here's a summary of what was done:

## Summary

**Decision: Option A (Automatic)**

I implemented automatic merge driver setup during `chant init`. This ensures that the branch mode workflow works correctly out of the box.

### Changes Made

1. **`src/merge_driver.rs`**:
   - Added `MergeDriverSetupResult` struct to track what was set up
   - Added `setup_merge_driver()` function that:
     - Configures git with merge driver settings (name and driver command)
     - Creates/updates `.gitattributes` with the merge pattern
     - Works gracefully outside git repos (just creates .gitattributes)
     - Returns detailed result for status reporting

2. **`src/main.rs`**:
   - Updated `cmd_init()` to call `setup_merge_driver()` instead of manually creating `.gitattributes`
   - Added status messages showing merge driver configuration result
   - Shows warnings gracefully if not in a git repo (doesn't fail init)
   - Updated `cmd_merge_driver_setup()` to use the same function and provide better feedback

3. **`CLAUDE.md`**:
   - Updated documentation to reflect that merge driver i

... (output truncated, 5488 chars total)```
