---
type: code
status: completed
commits:
- d9deb7d
completed_at: 2026-01-29T20:48:52Z
model: opus
---
# Add approval requirements to blocking logic and merge/cancel/delete guards

## Problem

Specs that require approval are not integrated into the blocking/ready workflow:

1. **Blocking logic gap**: `is_blocked()` only checks dependencies, not approval requirements
   - A pending spec with `approval.required: true` and `approval.status: pending` doesn't show up in `chant list --status blocked`
   - This makes it hard to find specs waiting for approval before work can begin

2. **Missing merge/cancel/delete guards**: Commands that should respect approval requirements may not have clear error messages
   - Need to verify `chant merge` blocks unapproved specs with clear error
   - Need to verify `chant cancel` has appropriate behavior for unapproved specs
   - Need to verify `chant delete` has appropriate behavior for unapproved specs

## Solution

### Part 1: Add approval to blocking logic (Approach A - narrow scope)

Update `is_blocked()` to return true if:
- The spec is **pending** AND
- The spec requires approval (`approval.required: true`) AND
- The approval status is not approved (`approval.status != approved`)

This keeps "blocked" semantically focused on "can't start work yet" rather than mixing in "can't merge" states for completed specs.

**Implementation:**
```rust
// In src/spec.rs, update is_blocked()
pub fn is_blocked(&self, all_specs: &[Spec]) -> bool {
    // Check dependencies are all completed
    if let Some(deps) = &self.frontmatter.depends_on {
        for dep_id in deps {
            let dep = all_specs.iter().find(|s| s.id == *dep_id);
            match dep {
                Some(d) if d.frontmatter.status == SpecStatus::Completed => continue,
                _ => return true, // Found an unmet dependency
            }
        }
    }

    // Check approval requirements (only for pending specs - Approach A)
    if self.frontmatter.status == SpecStatus::Pending && self.requires_approval() {
        return true;
    }

    false
}
```

### Part 2: Verify/add merge/cancel/delete guards

Audit and ensure these commands have clear error messages:

**Merge command** (`chant merge`):
- Should block merge if `approval.required: true` and `approval.status != approved`
- Error message: "Cannot merge spec {id}: approval required but not yet approved. Use 'chant approve {id} --by <name>' first."
- Consider `--skip-approval` flag for emergency bypass (should warn loudly)

**Cancel command** (`chant cancel`):
- Probably should allow cancellation regardless of approval status (cancelling doesn't need approval)
- No guard needed, but document the behavior

**Delete command** (`chant delete`):
- Probably should allow deletion regardless of approval status (cleanup operation)
- No guard needed, but document the behavior

## Acceptance Criteria

### Part 1: Blocking logic
- [x] Update `is_blocked()` in src/spec.rs to check approval requirements for pending specs
- [x] Pending specs with `approval.required: true` and `approval.status: pending` show up in `chant list --status blocked`
- [x] Completed specs with required approval do NOT show as blocked (Approach A)
- [x] Add tests for blocked filter with approval requirements
- [x] All existing tests pass

### Part 2: Command guards
- [x] Audit `chant merge` for approval guards - ensure clear error when merging unapproved spec
- [x] Add tests for merge blocking unapproved specs
- [x] Audit `chant cancel` - verify behavior is appropriate (likely: allow cancellation)
- [x] Audit `chant delete` - verify behavior is appropriate (likely: allow deletion)
- [x] Document the behavior in code comments or error messages

### General
- [x] Run `cargo fmt` and `cargo clippy`
- [x] All tests pass

## Files to Modify

- `src/spec.rs` - Update `is_blocked()` method
- `src/cmd/merge.rs` or `src/cmd/lifecycle.rs` - Verify/add merge guards
- `src/cmd/spec.rs` - Verify cancel/delete behavior
- `tests/integration_tests.rs` - Add tests for approval blocking

## Agent Output

2026-01-29T20:48:52Z

```
I'll implement this spec to add approval requirements to the blocking logic and verify merge/cancel/delete guards. Let me start by reading the relevant files.
Let me read the files in sections.
Now I understand the `is_blocked()` and `requires_approval()` methods. Let me read the merge command to understand the current guards.
Let me search for the merge function:
The merge command is in `src/cmd/lifecycle.rs`. Let me read it:
Let me read the `execute_merge` function to see if there's already approval handling:
The merge command already has approval guards (lines 1321-1348). Now let me check the cancel and delete commands:
Now I have a clear picture:
1. **`is_blocked()`** needs to be updated to check approval requirements for pending specs
2. **Merge command** already has approval guards (lines 1321-1348) - it blocks unapproved specs
3. **Cancel command** doesn't have special approval handling - it allows cancellation regardless of approval status (which is appropriate as per the spec)
4. **Delete command** doesn't have special approval handling - it allows deletion regardless of approval status (which is appropriate as per the spec)

Now let me update `is_blocked()` in `src/spec.rs`:
Now let me verify the merge command already has proper approval guards and document the cancel/delete behavior:
The merge command already has approval guards (lines 1321-1348 in `src/cmd/lifecycle.rs`). The error message is clear:
- It lists all unapproved specs
- It suggests running `chant approve <spec-id> --by <approver>` 
- It bails with a clear error message

This is already compliant with the spec requirements. Now let me add comments to the cancel and delete commands to document the behavior:
Now let me update the delete command comment:
Now I need to add tests for approval blocking. Let me first find existing tests related to blocking:
Let me find how to create a spec with approval settings:
Let me look at the helper function to understand the test setup pattern:
Now let me find where the last blocked filter tests end so I can add new tests for approval blocking:
Good, the file ends at line 5907. Now I need to add tests for approval blocking. Let me add two tests:
1. Test that pending specs with approval.required=true and approval.status=pending show up in blocked list
2. Test that completed specs with required approval do NOT show as blocked (Approach A)

I also need to check if there's an existing test for merge blocking with unapproved specs:
Let me add the tests:
Let me use a more specific search to find the exact location:
Now let's run cargo fmt, clippy, and tests:
Let me fix the doc comment warning:
The remaining warning is not related to my changes. Now let's run the tests:
Let's run the other new tests:
All three new tests pass. Now let's run the full test suite to make sure we haven't broken anything:
All 61 tests pass. Let me also run the unit tests to make sure the spec.rs change works:
Excellent! All 312 unit tests pass. Now let me update the acceptance criteria in the spec file and commit:
Now let me add the model to the frontmatter:
Now let me check git status and commit:
The changes related to this spec are committed. The remaining modified files are other specs that are not part of this work.
I have completed the spec implementation. Here's a summary of what was done:

## Summary

### Part 1: Blocking Logic
- Updated `is_blocked()` in `src/spec.rs` to check approval requirements for pending specs
- A pending spec with `approval.required: true` and `approval.status: pending` now shows up in `chant list --status blocked`
- Completed specs with required approval do NOT show as blocked (Approach A - keeping "blocked" semantically focused on "can't start work yet")

### Part 2: Command Guards
- **Merge command**: Already had approval guards in place (lines 1321-1348 in `src/cmd/lifecycle.rs`). It blocks unapproved specs with a clear error message listing all unapproved specs and suggesting `chant approve <spec-id> --by <approver>`
- **Cancel command**: Added documentation that cancellation is allowed regardless of approval status (intentional design - cancelling doesn't need approval)
- **Delete command**: Added documentation that deletion is allowed regardless of approval status (intentional design - cleanup operation)

### Tests Added
1. `test_status_blocked_filter_with_approval_requirements` - Tests that pending specs requiring unapproved approval show as blocked
2. `test_completed_specs_with_approval_not_blocked` - Tests that completed specs with required approval do NOT show as blocked (Approach A)
3. `test_merge_blocks_unapproved_specs` - Tests that merge fails for specs requiring unapproved approval

All 312 unit tests and 61 integration tests pass.```
