---
type: code
status: completed
target_files:
- src/cmd/work.rs
- src/cmd/lifecycle.rs
- src/cmd/commits.rs
- src/cmd/finalize.rs
- src/git.rs
- src/main.rs
commits:
- 92bdb8f
- c7de518
- d176906
completed_at: 2026-01-29T01:49:15Z
model: opus
---
# Fix parallel + branch workflow: auto-merge and finalization issues

## Problem

Multiple issues with `chant work --parallel` + `branch: true` workflow:

### Issue 1: Finalization looks in wrong place
**What happened:**
- Agents committed correctly with `chant(SPEC-ID):` format
- But commits were on feature branches (due to `branch: true`)
- Finalization searched main only, found nothing, marked specs "failed"
- Work was actually complete, just on branches

**Fix:** Finalization should check the spec's branch field, not just main

### Issue 2: Merge tries to checkout deleted branches
**What happened:**
```bash
$ chant merge --rebase false
✓ Merged successfully
✗ Failed to return to original branch 'chant/...'
error: pathspec '...' did not match any file(s) known to git
```
- The merge succeeded (branch deleted after merge)
- Then it tried to checkout the deleted branch → error
- Every merge reported "failed" but actually worked

**Fix:** Don't try to return to branch after deleting it

### Issue 3: Merge resets spec status to pending
**What happened:**
- Branches had `status: completed` in spec files
- Merge overwrote main's spec with branch version
- All specs went back to `status: pending` after successful merge
- `chant finalize` then refused: "must be in_progress, completed, or failed"
- Had to manually edit status with sed

**Fix:** Merge should preserve/update status intelligently

### Issue 4: No atomic parallel → completed path
**Expected workflow:**
```bash
chant work --parallel
# → work done → specs completed ✓
```

**Actual workflow:**
```bash
chant work --parallel
# → work done → branches created → manual merge → manual status fix → finally "completed"
```

**Fix:** Add `chant merge --finalize` to mark specs completed after merge

### Issue 5: Error messages lack context
**What happened:**
```
✗ No matching commits found
```

**What would help:**
```
✗ No matching commits found on main
  Found 1 commit on branch chant/2026-01-29-001-abc
  Run 'chant merge 2026-01-29-001-abc' to merge the branch first
```

**Fix:** Suggest checking branches when finalization fails

## Solution

### Part 1: Auto-merge completed branches in parallel mode

**Default behavior:**
- `chant work --parallel` with `branch: true` → auto-merge on completion
- Completed spec → merge to main automatically
- Failed spec → leave branch for debugging
- Add `--no-merge` flag to disable auto-merge

**Implementation:**
- After agent completes successfully, auto-merge the branch
- Use existing merge logic, just call it automatically
- Only for parallel mode (single spec keeps manual merge)

### Part 2: Fix finalization to check branches

**Current:** Only looks for commits on main
**New:** Check spec's `branch` field first, fall back to main

```rust
fn get_commits_for_spec(spec_id: &str, spec: &Spec) -> Result<Vec<String>> {
    // If spec has a branch, check that branch first
    if let Some(branch) = &spec.frontmatter.branch {
        if let Ok(commits) = find_commits_on_branch(branch, spec_id) {
            if !commits.is_empty() {
                return Ok(commits);
            }
        }
    }

    // Fall back to checking main
    find_commits_on_branch("main", spec_id)
}
```

### Part 3: Fix merge branch cleanup

**Current:** Deletes branch then tries to checkout it
**New:** Don't checkout after successful delete

```rust
// After merge and delete
if delete_succeeded {
    // Don't try to checkout deleted branch
    // Stay on main or original branch
} else {
    // Only checkout if delete failed
}
```

### Part 4: Fix merge status handling

**Options:**

**Option A:** Merge status intelligently
- If branch has `status: completed` → keep it
- If main has `status: pending` → use branch's status
- Prefer more advanced status

**Option B:** Add `--finalize` flag to merge
```bash
chant merge --finalize
# Merge + mark as completed atomically
```

**Recommendation:** Both - do A (smart merge) + B (explicit flag)

### Part 5: Improve error messages

Add helpful context when finalization fails:

```rust
if commits_on_main.is_empty() {
    if let Some(branch) = &spec.frontmatter.branch {
        if let Ok(branch_commits) = find_commits_on_branch(branch, spec_id) {
            if !branch_commits.is_empty() {
                return Err(anyhow!(
                    "No matching commits found on main\n\
                     Found {} commit(s) on branch {}\n\
                     Run 'chant merge {}' to merge the branch first",
                    branch_commits.len(), branch, spec_id
                ));
            }
        }
    }
    return Err(anyhow!("No matching commits found"));
}
```

## Acceptance Criteria

- [x] Auto-merge completed branches in parallel mode by default
- [x] Add `--no-merge` flag to disable auto-merge in parallel
- [x] Fix finalization to check spec's branch field before main
- [x] Fix merge to not checkout deleted branches
- [x] Fix merge to preserve completed status from branch (via custom merge driver)
- [x] Add `chant merge --finalize` flag to mark specs completed after merge
- [x] Improve finalization error messages to suggest checking branches
- [x] Add tests for parallel + branch workflow
- [x] Update documentation for parallel + branch interaction
- [x] All tests passing
- [x] Code linted and formatted

## Agent Output

2026-01-29T01:49:15Z

```
I'll start by reading the relevant code to understand the current implementation before making changes.
Excellent! This is very helpful. Now let me read the specific files to understand the current implementation in detail.
Now let me read more of the parallel work code to see the auto-merge phase and understand the current implementation better.
Let me continue reading the merge execution and see how the finalize flag is handled.
Now let me look at the rest of the `get_commits_for_spec_internal` function to understand the error handling and how I should improve the error messages.
Now I have a good understanding. Looking at what I've read:

1. **Auto-merge**: Already implemented in parallel mode (lines 2035-2119 in work.rs) with `--no-merge` flag support ✓
2. **Finalization branch checking**: Already implemented in finalize.rs (lines 47-62) ✓
3. **Improved error messages**: Already implemented in commits.rs (lines 503-521) ✓
4. **`--finalize` flag in merge**: Already implemented in lifecycle.rs (lines 1515-1558) ✓
5. **Merge not checking out deleted branches**: The logic exists in git.rs but needs to be verified

Let me check what's still needed and check the CLI argument parsing to ensure --no-merge and --finalize are properly wired up.
The `--no-merge` flag exists and is being used properly. Let me check the CLI definition to see how it's wired up.
Looking at what I've found so far, many items are already implemented. Let me update the todo list and verify what still needs to be done by examining the spec file and the actual implementation status.
Most of the implementation is already done. The only remaining acceptance criteria are:
1. Add tests for parallel + branch workflow
2. Update documentation for parallel + branch interaction

Let me update my todo list and verify the tests pass first, then add the new tests and documentation.
All tests pass. Now let me look at the existing tests for parallel work to understand the testing patterns, then add tests for the parallel + branch workflow.
Let me see more of the parallel workflow test and understand how it works.
Now I understand the testing patterns. I need to add tests for:
1. Finalization checking spec's branch field before main
2. Merge with --finalize flag
3. Auto-merge in parallel mode
4. --no-merge flag behavior

Let me see how many lines are in the integration tests file and find a good place to add my tests.
Now let me look at some helper functions in the integration tests to understand the patterns better.
Now I'll add tests for the parallel + branch workflow. I'll add:
1. `test_merge_finalize_flag` - Tests that `--finalize` flag marks specs as completed after merge
2. `test_finalization_checks_branch_field` - Tests that finalization properly checks the spec's branch field
3. `test_merge_no_checkout_deleted_branch` - Tests that merge doesn't try to checkout a deleted branch
Now let me run the new tests to ensure they pass.
All three new tests pass. Let me remove the unused import warning and update the todo list.
Now I need to look at that function to see if it uses anything from the import.
I see that in `test_merge_no_checkout_deleted_branch`, neither `Spec` nor `SpecStatus` are actually used. Let me remove that import entirely.
Now let me update the todo list and move to updating the documentation.
Now let me check the CLAUDE.md file to see where I should add documentation about the parallel + branch interaction.
Let me find the section on parallel execution and add documentation about the `--no-merge` flag and the branch interaction workflow.
I see the parallel execution section. Let me update it to include the `--no-merge` flag and clarify the branch behavior.
Now let me add the `--finalize` flag to the merge command documentation.
Now let me also update the templates/agent-claude.md file since it should stay in sync per the instructions.
Now let me update the todo list and run the final tests, lint, and format.
The clippy warnings are all pre-existing in the test file and not related to my changes. The lib warnings (`unnecessary_unwrap` and `useless_vec`) are also pre-existing. Let me run the full test suite to make sure everything passes.
All tests pass including my three new tests. Now let me update the acceptance criteria in the spec file and commit.
Now let me check if there's more content at the end of the spec file that I need to be aware of.
The spec is fully updated. Now let me check git status and commit the changes.
All the changes look good. Let me stage and commit the changes.
The spec files are committed. The remaining uncommitted changes are in archive files which are unrelated to this spec. Let me update my todo list to mark everything as complete.
I have completed the remaining acceptance criteria for the spec:

## Summary

I completed the two remaining acceptance criteria for the parallel + branch workflow spec (2026-01-29-006-96p):

### 1. Added Tests for Parallel + Branch Workflow
Added three new integration te

... (output truncated, 6270 chars total)```
