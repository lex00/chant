---
type: code
status: completed
target_files:
- src/main.rs
- Cargo.toml
commits:
- efe2458
completed_at: 2026-01-24T21:53:30Z
model: haiku
---
# Fix broken model name env tests

## Problem

Two tests fail intermittently when run with `cargo test` but pass individually:
- `test_get_model_name_from_chant_model`
- `test_get_model_name_env_takes_precedence_over_config`

This is because Rust runs tests in parallel by default, and these tests modify environment variables (`CHANT_MODEL`, `ANTHROPIC_MODEL`) which pollutes other tests.

## Solution

Use the `serial_test` crate to ensure tests that modify env vars run sequentially.

```rust
use serial_test::serial;

#[test]
#[serial]
fn test_get_model_name_from_chant_model() {
    // ...
}
```

## Acceptance Criteria

- [x] Add `serial_test` to dev-dependencies in Cargo.toml
- [x] Add `#[serial]` attribute to all tests that modify env vars
- [x] All tests pass when run with `cargo test`
- [x] All tests pass when run with `cargo test -- --test-threads=1` (sanity check)
- [x] Identify all tests that set/modify environment variables

## Agent Output

2026-01-24T21:53:30Z

```
I'll help you fix the broken model name env tests. Let me start by understanding the problem and then implementing the solution.
Now let me find the exact test file:
Let me read the test section to understand which tests modify environment variables:
Perfect! I can see all the tests that modify environment variables. Now let me create a plan and implement the fix:
Now let me add the `serial_test` dependency to Cargo.toml:
Now I need to add the `use serial_test::serial;` import and the `#[serial]` attributes to all tests that modify environment variables. Let me first find where the tests module starts:
Let me check the tests module at line 2239 which is closest to our tests:
Good, I found the tests module. Now I need to add the serial_test import and add `#[serial]` attributes to all the tests that modify env vars. Let me update the import section first:
Now let me add the `#[serial]` attribute to `test_get_model_name_from_chant_model`:
Now add `#[serial]` to `test_get_model_name_from_anthropic_model`:
Now add `#[serial]` to `test_get_model_name_chant_takes_precedence`:
Now add `#[serial]` to `test_get_model_name_from_config_default`:
Now add `#[serial]` to `test_get_model_name_env_takes_precedence_over_config`:
Now add `#[serial]` to `test_get_model_name_none_when_unset`:
Now add `#[serial]` to `test_get_model_name_empty_string_returns_none`:
Now add `#[serial]` to `test_get_model_name_empty_config_model_skipped`:
Now let's run the tests to verify everything works:
Let me check if we should use the just command instead:
Good, let me check if there's a justfile with test commands:
Perfect! Let me run the tests using just:
Excellent! All tests pass. Now let me run the sanity check with `--test-threads=1`:
Let me use the correct path for cargo:
Perfect! All tests pass with both single-threaded and multi-threaded execution. Now let me update the spec file to check off the acceptance criteria:
Now let me update the acceptance criteria to mark them as complete:
Now I need to also add the model to the spec frontmatter. Let me update it:
Now let me commit the changes:
Let me add only the relevant files for this commit:
Perfect! Let me verify the commit and run a final test to ensure everything is working:
Let me also run the linter to make sure there are no warnings:
Excellent! Let me also run the full check command to be thorough:
There's a formatting issue with the import order. Let me fix that:
Let me read the file first:
Now let me fix the import order:
Now let me run the check again:
Perfect! All checks pass. Now let me update the commit with this formatting fix:
Let me verify the binary builds correctly:
Perfect! Let me update the todo list to mark everything complete:
Perfect! I have successfully completed the spec. Here's a summary of what was done:

## Summary

I've fixed the broken model name env tests by implementing the serial test solution:

### Changes Made:

1. **Added `serial_test` dependency** to `Cargo.toml` (version 3.0)

2. **Added `#[serial]` attributes** to all 8 tests that modify environment variables:
   - `test_get_model_name_from_chant_model`
   - `test_get_model_name_from_anthropic_model`
   - `test_get_model_name_chant_takes_precedence`
   - `test_get_model_name_from_config_default`
   - `test_get_model_name_env_takes_precedence_over_config`
   - `test_get_model_name_none_when_unset`
   - `test_get_model_name_empty_string_returns_none`
   - `test_get_model_name_empty_config_model_skipped`

3. **Added import** for `serial_test::serial` in the tests module

### Verification:

✅ All 122 tests pass with default parallel execution  
✅ All 122 tests pass with single-threaded execution (`--test-threads=1`)  
✅ Code lints cleanly with no warnings  
✅ Binary builds successfully  

The spec file has been updated with all acceptance criteria checked off, and the changes have been committed with the proper commit message.```
