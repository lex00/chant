---
type: group
status: completed
target_files:
- src/main.rs
commits:
- 510c33b
- f995aec
- 5d8135d
- 9392e79
completed_at: 2026-01-24T22:30:00Z
model: claude-opus-4-5-20251101
---
# Fix spec finalization bug - ensure status, commits, completed_at are set after work

## Problem

Spec `01a-75r` was left in `status: in_progress` even though:
- The agent completed all work
- All acceptance criteria were checked
- A commit was created with the spec ID

The spec was missing `commits`, `completed_at`, and correct `status`.

## Root Cause

In `cmd_work()`, the spec finalization happens after `invoke_agent()` returns. If something goes wrong between agent completion and spec save, the spec stays in_progress.

Possible causes:
1. Agent output parsing failed
2. Commit detection failed but didn't error
3. Spec save was skipped due to early return
4. Race condition in parallel mode

## Acceptance Criteria

- [x] Investigate the code path in cmd_work after invoke_agent returns
- [x] Ensure spec.save() is always called after successful agent completion
- [x] Add error handling that doesn't silently skip finalization
- [x] Add test that verifies spec is marked completed after work
- [x] Consider adding a "finalize" step that's idempotent (can be re-run)

## Completed by Member Specs

- **01e.1**: Improved error handling in `get_commits_for_spec()` with `CommitError` enum
- **01e.2**: Added validation checks to `finalize_spec()` with persistence verification
- **01e.3**: Ensured `cmd_work()` calls `finalize_spec()` on all success paths
- **01e.4**: Added `--finalize` flag for idempotent re-finalization
- **01e.5**: Added 7 comprehensive tests for finalization edge cases (140 total tests)
