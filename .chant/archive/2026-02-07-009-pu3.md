---
type: code
status: completed
labels:
- bug
- finalization
- lifecycle
target_files:
- src/cmd/finalize.rs
- src/spec/lifecycle.rs
- src/spec/state_machine.rs
- src/cmd/work/single.rs
branch: chant/2026-02-07-009-pu3
---
# Investigate specs not finalizing after agent completes work

## Observed Behavior

Agent successfully completes all work:
1. Reads files, makes changes, checks off all acceptance criteria
2. Commits with proper `chant(<spec-id>): ...` message
3. Writes summary to log
4. Merge to main succeeds (commit visible in `git log`)

But finalization fails:
- Spec status remains `pending` or gets set to `failed`
- No error message about why finalization failed
- `completed_at` never set
- Required manual `chant_spec_update` to mark completed

## Reproduction (from 2026-02-07 session)

Every single spec (001-007) exhibited this:
- 001: work committed (405091d), status stayed `pending`, manually set to `completed`
- 002: all AC checked, committed (b4d2aa8), status `failed`, manually completed
- 003: work done by parallel run, status `failed`, manually completed
- 005: committed (7f758a7), status `failed`, manually completed
- 004: committed (ecccad6), status not updated, manually completed
- 006: committed (c85e3d4), status not updated, manually completed
- 007: committed (b5e064f), chant process exited 1, manually completed

## Hypotheses

1. **Worktree merge succeeds but spec reload fails**: After merging worktree branch to main, chant reloads the spec from main but the spec file on main still has old status (the updated spec was in the worktree)
2. **Finalization race**: Spec status written in worktree, merge happens, but status field not carried over during merge
3. **AC validation fails silently**: Finalization checks acceptance criteria but fails validation without reporting why
4. **Exit code propagation**: Agent exits 0 but chant interprets something in the output as failure
5. **branch: false path different**: Specs without worktrees (001, 007) had the same issue, suggesting it's in the finalization logic itself, not worktree-specific

## Key Files to Investigate

- `src/cmd/finalize.rs` — finalization logic
- `src/spec/lifecycle.rs` — status transitions during finalize
- `src/spec/state_machine.rs` — SpecStateMachine validation
- `src/cmd/work/single.rs` — post-agent-exit finalization flow
- `src/worktree/git_ops.rs` — merge_and_cleanup (spec reload after merge)

## Acceptance Criteria

- [x] Root cause identified for why finalization silently fails
- [x] Fix ensures spec status is set to `completed` when agent succeeds and AC are checked
- [x] If finalization fails, a clear error message is written to the log explaining why
- [x] Works for both worktree and non-worktree (branch: false) execution modes

## Root Cause

In `single.rs`, `copy_spec_to_worktree` was called at line 550 BEFORE `spec.frontmatter.status = SpecStatus::InProgress` at line 569. This meant the worktree received a spec with `status: pending`. After the agent completed work, `single.rs` reloaded the spec from the worktree (line 665) and got `status: pending`. Then `finalize_spec` called `TransitionBuilder::new(spec).to(SpecStatus::Completed)`, but the state machine (`state_machine.rs` line 317) rejects `Pending → Completed` as an invalid transition. The error propagated silently because the Ok(agent_output) arm had no catch for finalization errors — the spec was never set to Failed, and no diagnostic was logged.

## Fix

1. **Primary fix** (`single.rs`): Moved `spec.frontmatter.status = SpecStatus::InProgress` and `spec.save()` BEFORE `copy_spec_to_worktree`, so the worktree gets the correct `in_progress` status. Also set `branch` before save so the full state is captured.

2. **Defense in depth** (`single.rs`): After reloading spec from worktree, check if status is still `pending` and correct to `in_progress` with a warning.

3. **Error handling** (`single.rs`): When `finalize_spec` fails inside the Ok(agent_output) arm, now sets spec to Failed with a clear error message instead of silently propagating.

Note: Chain mode (chain.rs) already had the correct ordering. Parallel mode (parallel.rs) also already set in_progress before copy.

## Takeover Analysis


Log contains 11 lines of output.

No errors detected, but work appears incomplete.

### Recent Log Activity

```
# Agent Log: 2026-02-07-009-pu3
# Started: 2026-02-07T10:38:03Z
# Prompt: standard


================================================================================
# New Run: 2026-02-07T10:38:03Z
# Prompt: standard
================================================================================

I'll investigate why specs aren't finalizing after agent completes work. Let me start by reading the key files involved in the finalization process.
```


### Worktree Location

Work should be done in the isolated worktree:
```
cd /tmp/chant-chant-2026-02-07-009-pu3
```

### Recommendation

Review the errors in the log and address them before resuming.
3 acceptance criteria remain unchecked.
Continue working on this spec manually or adjust the approach.
When ready to resume automated work, use `chant work <spec-id>`.