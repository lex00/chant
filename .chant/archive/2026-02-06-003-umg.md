---
type: code
status: completed
commits:
- d727b1f
completed_at: 2026-02-06T11:05:03Z
model: sonnet
---
# Set provider in config when --agent implies a provider

When running `chant init --agent kiro`, the `.kiro/rules.md` agent file is created but `provider: kiro` is not written to `.chant/config.md`. The provider only gets set if the user explicitly passes `--provider kiro`. When `--agent` is specified and no explicit `--provider` is given, init should infer the provider from the agent and include it in the config.

## Agent Output

2026-02-06T11:05:03Z

```
I'll implement this spec by making `chant init` infer the provider from the `--agent` flag when no explicit `--provider` is given.
Now I understand the codebase structure. When `--agent` is provided without `--provider`, the agent file is created but the provider is not written to config. I need to infer the provider from the agent name when it matches a known provider (like "kiro").
Now I understand the issue. When `--agent kiro` is specified, the agent configuration is created but the provider isn't inferred. I need to add logic to infer the provider from the agent name when no explicit provider is given. Let me trace through where this needs to happen:
I need to add logic to infer the provider from agents when provider is None. Let me check what `parse_provider_string` does first:
Perfect. I need to create a function that infers the provider from the agent list when no explicit provider is given. The logic should be:
- If `--agent kiro` is provided and no `--provider` is given, set `provider: kiro` (which maps to "kirocli") in the config.

Let me implement the fix:
Now I need to add the `infer_provider_from_agents` function:
Now let me test the implementation:
The provider was not added. Let me check if there's an issue with the logic. The issue is that the config is only written if it doesn't exist, but in the direct mode path, we're not updating the config after creation. Let me trace through the config creation logic:
Good, the config creation logic at line 2328 should include the provider if `final_provider` is set. The issue is that my `infer_provider_from_agents` function is being called, but maybe it's not returning the right value. Let me rebuild the binary:
Great! Now I see "Default provider: kirocli" in the output. Let me verify it's actually in the config:
Perfect! The provider is now set to "kirocli" in the config. Let me test a few more scenarios to ensure the fix is complete:
Excellent! Let me test with a non-provider agent to ensure we don't set a provider when it shouldn't be set:
Perfect! Generic agent doesn't set a provider, which is correct. Let me test when an explicit provider is given along with an agent to ensure the explicit provider takes precedence:
Perfect! The explicit provider (ollama) takes precedence over the inferred provider (kiro). Now let me run cargo fmt and clippy:
Great! Now let me check off the acceptance criteria in the spec:
The spec doesn't have acceptance criteria defined. Let me commit the changes:
Perfect! The spec was already automatically marked as completed. Let me verify git status is clean:
## Summary

Modified `src/main.rs` to infer provider from agent when `--agent` is specified without explicit `--provider`.

- Added `infer_provider_from_agents()` function that maps agent names to providers (kiro→kirocli, claude→claude)
- Updated direct mode initialization to call this function when no explicit provider is given
- Provider inference respects explicit `--provider` flag (takes precedence)
- Tested with kiro, claude, generic agents and explicit provider override```
