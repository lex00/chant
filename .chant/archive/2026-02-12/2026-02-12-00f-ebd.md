---
type: code
status: completed
depends_on:
- 2026-02-12-00c-hkq
target_files:
- src/cmd/finalize.rs
- src/operations/finalize.rs
- src/operations/verify.rs
commits:
- 47932c9
- b87435c
completed_at: 2026-02-13T03:59:20Z
model: sonnet
---
# Finalization safety: atomicity and locking



## Problem

- Watch + manual `chant finalize` can race — both load spec, write different frontmatter, last write wins (`watch.rs:849`)
- Partial finalization corruption — status set `Completed` in memory, save fails midway, corrupted state on disk (`finalize.rs:88-184`)
- Verify writes spec without locking — agent and verifier can write concurrently (`verify.rs:251`)
- Operations-layer finalize uses `.force()` bypass with no criteria validation (`operations/finalize.rs:100`)

## Solution

- Acquire spec-level lock (via `lock::create_lock`) during finalization — both watch and manual paths
- Write spec to temp file, atomic rename on success
- Acquire lock during verify write
- Add criteria check to operations-layer finalize path

## Acceptance Criteria

- [x] Finalization acquires spec lock before writing — concurrent finalize calls are serialized
- [x] Spec save uses atomic write (temp file + rename) to prevent partial corruption
- [x] Verify acquires spec lock before writing results
- [x] Operations-layer `finalize_spec()` validates unchecked criteria before completing
- [x] `cargo test` and `cargo clippy` pass

## Agent Output

2026-02-13T03:59:20Z

```
I'll implement the finalization safety improvements by adding locking and atomic writes.
Now I understand the structure. The `Spec::save` method already implements atomic writes (lines 162-170 in parse.rs). I need to:

1. Add locking to `finalize_spec` in `src/cmd/finalize.rs` (and operations layer)
2. Add locking to `verify` spec write in `src/operations/verify.rs`  
3. Add criteria validation to operations layer finalize
4. The atomic write is already implemented in `Spec::save`

Let me check the criteria validation logic:
Now let me implement the changes:
Now let's run the tests and clippy:
Good, clippy passes (only warnings). Now let's run the tests:
Excellent! All tests pass. Now let's update the spec file to check off the acceptance criteria:
Now let's run cargo fmt and create the commit:
## Summary

Added finalization safety through locking and criteria validation.

- **Locking**: Acquired spec-level locks in `finalize_spec()`, `re_finalize_spec()`, and `update_spec_with_verification_results()` using `LockGuard` RAII wrapper to prevent concurrent writes
- **Criteria validation**: Added unchecked criteria check in `operations/finalize.rs` before allowing transition to Completed status
- **Atomic writes**: Already implemented in `Spec::save()` via temp file + rename pattern (lines 163-170 in `spec/parse.rs`)

All tests and clippy checks pass.```
