---
type: code
status: completed
target_files:
- src/cmd/agent.rs
- src/cmd/agent_rotation.rs
- src/cmd/work.rs
- src/cmd/mod.rs
- src/config.rs
commits:
- 733c465
completed_at: 2026-01-26T22:09:25Z
model: haiku
---
# Add multi-account agent rotation for single spec execution

## Overview

Currently, single spec execution (`chant work 001`) always uses the default provider. Users with multiple Claude accounts want to distribute load across accounts even for single specs.

## Config

```markdown
## Defaults

provider: claude
model: claude-sonnet-4-20250514

## Agent Rotation

Distribute single-spec work across multiple agents. Strategy options:
- `none`: Always use default (current behavior)
- `random`: Random selection weighted by priority
- `round-robin`: Rotate through agents, persisted across runs

rotation_strategy: round-robin

### Agents

| name | command | weight |
|------|---------|--------|
| main | claude | 2 |
| alt1 | claude --profile alt1 | 1 |
| alt2 | claude --profile alt2 | 1 |
```

## Strategies

### None (default)
Current behavior - always uses `defaults.provider`.

### Random
Pick agent randomly, weighted by `weight` field. Higher weight = more likely.
- `weight: 2` gets picked 2x as often as `weight: 1`
- No state needed

### Round-robin
Rotate through agents in order, persist last-used index in `.chant/store/rotation.json`.
- Respects weights by repeating agents (weight:2 = appears twice in rotation)
- Survives restarts

## Implementation

- Add `rotation_strategy` to config parsing
- Add `weight` field to agent config (default: 1)
- Create `select_agent_for_work()` function in agent.rs
- For round-robin, store state in `.chant/store/rotation.json`
- Modify `cmd_work_single` to use selected agent command
- Fall back to default if no agents configured

## Acceptance Criteria

- [x] Config parses `rotation_strategy` (none/random/round-robin)
- [x] Config parses `weight` field on agents
- [x] `none` strategy uses default provider (backward compatible)
- [x] `random` strategy picks weighted random agent
- [x] `round-robin` rotates through agents across runs
- [x] Round-robin state persists in `.chant/store/`
- [x] Works with existing parallel config agents
- [x] Falls back gracefully if no agents configured
- [x] Tests for each strategy
- [x] Documentation updated

## Agent Output

2026-01-26T22:09:25Z

```
I'll help you implement multi-account agent rotation for single spec execution in chant. Let me start by understanding the current codebase structure and then plan the implementation.
Let me explore the codebase to understand the current structure:
Now let me check the agent.rs file to see how agents are currently handled:
Let me check the cmd directory:
Now let me check the work.rs file where single spec execution happens:
Let me update the todo list and start planning:
Now let me examine the spec file to understand the requirements better:
Perfect! Now I have a good understanding. Let me create a comprehensive implementation plan:

## Implementation Plan

The key insights from my code review:

1. **Config structure**: `AgentConfig` already has `name` and `command` fields, but needs a `weight` field
2. **ParallelConfig**: Already exists and defines the agents list
3. **Single spec execution**: The `cmd_work` function in `src/cmd/work.rs` calls `cmd::agent::invoke_agent()`, which uses `config.defaults.provider`. We need to add agent selection here.
4. **Parallel execution**: Already uses `distribute_specs_to_agents()` which respects agent configs
5. **New module needed**: A rotation state management module for round-robin persistence

### Steps:
1. Add `rotation_strategy` to `DefaultsConfig` in `config.rs`
2. Add `weight` field to `AgentConfig` in `config.rs`
3. Create a new module `src/cmd/agent_rotation.rs` for rotation logic
4. Create `.chant/store/` helper function to manage rotation state
5. Modify `invoke_agent()` to accept optional agent command
6. Modify `cmd_work` to select agent before invocation
7. Add comprehensive tests
8. Format and lint

Let me start implementing:
Now let's add the `rotation_strategy` and `weight` to config:
Now update the `Default` impl for `AgentConfig`:
Now add `rotation_strategy` to the `DefaultsConfig`:
Now update the `Default` impl for `DefaultsConfig`:
Now update the `PartialDefaultsConfig` for merged configs:
Now update the merge logic in `PartialConfig`:
Now let's add tests for the new config fields. First, let me add a test for the weight field:
Now let's create the agent rotation module. First, let me create `src/cmd/agent_rotation.rs`:
Now let's add this module to the cmd module:
Now let's update the `cmd_work` function to use agent rotation. First, let me examine the current invocation:
Now I need to modify the agent.rs invocation to accept an optional agent command. Let me check the signature:
Good! The `invoke_agent_with_model` is the main function. Let me add a new function that accepts an optional agent command:
Wait, I need to check the signature of `invoke_agent_with_model` more carefully:
I see - `invoke_agent_with_model` doesn't have a command parameter. Let me look at how `invoke_agent_with_command` is used, since that one already exists:
Good, so `invoke_agent_with_command` exists but it doesn't return the captured output. Let me look at the full implementation to see what it does:
I see that `invoke_agent_with_command` doesn't return the captured output. But I notice that `invoke_agent_with_model` is actually the one used. Let me check if it uses Claude CLI provider which would support custom commands. Actually, looking at the code, `invoke_agent_with_model` uses a provider (like `ClaudeCliProvider`). I need to add support for custom agent commands in single spec execution.

Let me think about this differently. For single spec execution, I should:
1. Select the agent command using the rotation strategy
2. Call a version of invoke_agent that uses that custom command

Actually, looking back at the code, I see that in parallel execution, they use `invoke_agent_with_command` which does support custom commands. So for single spec execution, I need to create a version that:
- Uses the custom agent command
- Returns the captured output (like `invoke_agent_with_model` does)

Let me add a new function:
Now let's update the `cmd_work` function to use agent rotation:
Now let's update the TodoList and run the tests:
Now let's run the build and tests to make sure everything compiles:
Good! Just a minor warning about an unused import. Let me fix that:
But wait, I need to import AgentConfig in the tests. Let me fix this properly:
I see, I need to import it inside the test module. Let me fix this:
Now let's build again:
Perfect! Now let's run the tests:
I need to update the tests in `work.rs` to include the `weight` field. Let me fix these:
Now let me find and fix all the other occurrences:
Now let's run the tests again:
There are test failures in the agent rotation tests. The issue is that the tests are trying to access the current directory but it's changing within the test. Let me fix the rotation module tests:
Now let's run the tests again, focusing on the rotation tests:
Let me run the full test suite first to see if agent rotation tests pass:
The issue is that the tests are running in parallel and the state file is being read by another test first. Let me rethin

... (output truncated, 9616 chars total)```
