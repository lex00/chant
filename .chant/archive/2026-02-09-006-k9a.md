---
type: code
status: completed
target_files:
- src/mcp/handlers.rs
branch: chant/2026-02-09-006-k9a
commits:
- 38e6fd9
completed_at: 2026-02-10T07:13:54Z
model: sonnet
---
# Fix chant_spec_update output field: replace instead of append
## Problem
`chant_spec_update` with an `output` parameter appends to the spec body instead of replacing content. When an agent uses it to enrich a stub spec, the result has duplicate content â€” the original stub text plus the new enriched text. Users have to edit on disk to fix.

## Solution
In `src/mcp/handlers.rs` (`tool_chant_spec_update`), change the `output` field behavior:
- Currently appends output text to the spec body
- Should replace the spec body with the new output (or provide a `replace` boolean option to control behavior)
- Consider adding a `replace_body: bool` parameter (default false for backwards compat) that replaces instead of appends
- Or rename/add a `body` parameter that replaces, keeping `output` as append-only for backward compat

## Acceptance Criteria
- [x] `chant_spec_update` has a way to replace spec body content (not just append)
- [x] Default behavior preserved for backward compatibility (append still works)
- [x] Existing tests pass (`cargo test`)
- [x] `cargo clippy -- -D warnings` passes

## Agent Output

2026-02-10T07:13:54Z

```
I'll start by reading the relevant code to understand the current implementation.
Now I need to check the operations/update.rs file to understand how the output field is currently handled:
Now I understand the issue. The `output` field appends content. I need to add a `replace_body` boolean option to allow replacing the body instead of appending. Let me check the test file to understand existing behavior:
Now let me implement the solution. I'll add a `replace_body` boolean parameter to `UpdateOptions` and update both `update_spec` and the MCP handler:
Now I need to update the MCP handler to expose the `replace_body` parameter:
Now I need to update the `tool_chant_spec_update` function to parse and use the `replace_body` parameter:
Now let me check if there are other places in the codebase that use `UpdateOptions`:
Good. The `UpdateOptions` is used with `Default::default()` so the new field will default to `false`. Let me check if there's a CLI command that uses this:
Now let me run the tests to ensure everything still works:
Great! All tests pass. Now let me run clippy:
Perfect! All tests pass and clippy produces no warnings. Now let me run cargo fmt to ensure the code is properly formatted:
Now let me check off the acceptance criteria:
Now let me commit the changes:
## Summary

Added `replace_body` boolean parameter to `chant_spec_update` allowing spec body replacement instead of appending.

- Modified `src/operations/update.rs` to add `replace_body` field to `UpdateOptions` (default: false)
- Updated `update_spec()` function to replace body content when `replace_body` is true, otherwise append (backward compatible)
- Exposed `replace_body` parameter in MCP tool schema and handler in `src/mcp/handlers.rs`
- All tests pass, clippy clean, code formatted```
