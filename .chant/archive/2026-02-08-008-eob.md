---
type: research
status: completed
labels:
- research
- lint
- dx
target_files:
- src/cmd/work/executor.rs
- src/cmd/spec/lint.rs
- src/cmd/spec/add.rs
commits:
- 62aad7b
completed_at: 2026-02-08T10:38:57Z
model: sonnet
---
# Research: graceful pre-work lint validation

## Problem

`chant work` runs lint validation before executing and outputs warnings/errors that confuse agents or break the flow. This has been partially improved (worktree handling) but agents still get confused by lint output during execution.

## Questions to answer

1. What does `chant work` currently output when lint finds issues? Trace the exact code path in executor.rs.
2. What prior fixes were made for this? Check git history for lint/validation changes in the work command.
3. What specifically confuses agents? Is it the warning format, the fact that execution continues despite warnings, or the interleaving with agent output?
4. Would a tiered gate work? (red = block, yellow = advise, green = pass silently)
5. Should lint be enforced earlier â€” at `chant add` time (spec 007-wkl covers this) or at spec edit time?
6. Could the lint output be restructured to be unambiguous to agents? (e.g., clear "PROCEEDING DESPITE WARNINGS" separator)
7. What happens in the worktree context specifically that still causes confusion?

## Deliverable

A written recommendation in the output section with:
- Analysis of current behavior and what breaks
- Recommended approach (with tradeoffs)
- Whether spec 007-wkl (auto-lint at add time) is sufficient or if work-time changes are also needed

## Acceptance criteria

- [x] Current lint-during-work code path documented with line references
- [x] Prior fix attempts identified from git history
- [x] Root cause of agent confusion identified
- [x] Recommendation written with specific approach and tradeoffs

## Output

### 1. Current lint-during-work code path

The lint validation happens in **`src/cmd/work/executor.rs`** at lines 38-59 in the `validate_spec` function:

1. **Line 39**: Prints `"â†’ Validating spec {id}..."` to stderr
2. **Lines 40-41**: Runs `lint_specific_specs()` which performs full lint validation
3. **Lines 43-50**: If errors found (failed > 0), **BLOCKS execution** with actionable error message
4. **Lines 52-59**: If warnings found (warned > 0), **CONTINUES execution** but prints warning count

This validation is called from **three entry points**:
- `prepare_spec_for_execution()` (executor.rs:422) - used by refactored work modes
- Legacy direct calls in single.rs, chain.rs, parallel.rs (pre-refactor paths still exist)

### 2. Prior fix attempts

**Commit 69761db (2026-02-05)**: "Add lint validation before worktree creation"
- Added lint validation immediately after spec resolution in single/chain/parallel modes
- **Goal**: Fail fast before spawning agent or creating worktree
- **Result**: Partially successful - prevents invalid specs from executing
- Added warning output: `"âš  Spec {id} has {n} warning(s) but is valid for execution"`

**Commit 62aad7b (2026-02-08)**: "implement auto-lint after spec creation"
- Added lint feedback to `chant add` CLI and MCP response
- **Goal**: Give agents immediate feedback at spec creation time
- **Result**: Addresses upstream issue - agents now see quality feedback earlier

**Commit 8cad723 (2026-02-08)**: "wire up validation framework"
- Unified validation output format across lint/verify/finalize commands
- **Goal**: Consistent validation messaging
- **Result**: Standardized output but didn't change work-time behavior

### 3. Root cause of agent confusion

The current warning output during `chant work` confuses agents because:

**A. Ambiguous execution state**: The warning message says "has N warning(s) **but is valid for execution**" (line 55-57 in executor.rs). This creates ambiguity:
   - Warning appears BEFORE agent starts working
   - Agent doesn't know if it should proceed or fix warnings first
   - The word "but" implies a conflict between warnings and validity

**B. Interleaving with other output**: The validation output appears between:
   - Pre-work status messages ("Validating spec...", "Set to InProgress")
   - Agent invocation output ("Working {id} with prompt...")
   - This makes it unclear whether warnings are actionable NOW or informational

**C. No clear gate semantics**: Unlike errors (which block), warnings allow execution to proceed. Agents interpret this inconsistently:
   - Some agents try to fix warnings before starting work
   - Some agents ignore warnings and proceed
   - Some agents get confused and ask for clarification

**D. Worktree context confusion**: In worktree mode, the validation runs in the main repo context but the agent works in a worktree. This temporal/spatial separation makes it unclear:
   - Should the agent fix the spec file in the worktree?
   - Should validation re-run after work completes?
   - Are warnings about the original spec or the work to be done?

### 4. Recommendation

**Recommended approach: Tiered gate with unambiguous messaging**

Implement a three-tier quality gate:

**ðŸ”´ RED (Block)**: Errors - spec is invalid, cannot execute
- Current behavior: Already blocks with clear error (lines 43-50)
- No change needed

**ðŸŸ¡ YELLOW (Advise)**: Warnings - spec is valid but suboptimal
- **Change messaging** to remove ambiguity:
  ```
  âš  Quality advisory for spec {id}:
    â€¢ {warning message 1}
    â€¢ {warning message 2}

  âœ“ Proceeding with execution (warnings are advisory)
  ```
- Key improvements:
  - Title clearly says "advisory" not "but is valid"
  - Explicit affirmation "Proceeding with execution"
  - Warnings listed as bullets, not counts
  - Clear separation from subsequent agent output

**ðŸŸ¢ GREEN (Pass)**: No issues
- Current behavior: Silent pass
- No change needed

**Alternative considered**: Move lint enforcement to `chant add` time (spec 007-wkl)
- **Tradeoff**: Spec 007-wkl already implemented auto-lint at add time, giving agents immediate feedback
- **Gap**: This doesn't prevent agents from committing low-quality specs to the repo
- **Conclusion**: 007-wkl is necessary but not sufficient - work-time messaging still needs clarification

**Implementation location**: `src/cmd/work/executor.rs` lines 52-59

**Risk**: Minimal - this is purely a messaging change, no behavioral change to validation logic

**Follow-up**: Consider adding a config option `validation.block_on_warnings` (default: false) for teams that want stricter enforcement