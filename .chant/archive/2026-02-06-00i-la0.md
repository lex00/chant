---
type: code
status: completed
depends_on:
- 2026-02-06-00h-oxg
commits:
- 90eece7
completed_at: 2026-02-06T23:27:37Z
model: sonnet
---
# Fix MCP quality gate status race in src/mcp/handlers.rs. Per research 009-1tj: status update to InProgress happens at line 1956 BEFORE quality validation runs (lines 1874-1952). Move status update to after validation passes, matching CLI behavior in src/cmd/work/single.rs line 569. Use SpecStateMachine for the pending→in_progress transition.

## Agent Output

2026-02-06T23:27:37Z

```
I'll fix the MCP quality gate status race by moving the status update to after validation passes.
Now I understand. The `SpecStateMachine` is actually the `TransitionBuilder` in `src/spec/state_machine.rs`. I need to:

1. Move the status update from line 2022-2026 to after the quality validation passes (line 2020)
2. Use the `TransitionBuilder` for the pending→in_progress transition
The `state_machine` module is private. I need to check how it's exposed.
Perfect! The `TransitionBuilder` is already re-exported from the spec module. I should use `crate::spec::TransitionBuilder` instead.
Good! Now let me verify the acceptance criteria and mark them as complete.
There are no acceptance criteria in this spec. Let me verify the implementation by reading the updated code to ensure it's correct.
Perfect! The implementation is correct:
1. ✓ Status update now happens at line 2027-2029 AFTER quality validation (lines 1944-2020)
2. ✓ Uses `TransitionBuilder` for the pending→in_progress transition
3. ✓ Matches the CLI behavior pattern

Now let me commit the changes.
## Summary

Fixed MCP quality gate status race in `src/mcp/handlers.rs`.

- Moved status update to InProgress from line 2024 to after quality validation (line 2027-2029)
- Replaced direct status assignment with `TransitionBuilder` for proper state machine validation
- Now matches CLI behavior where validation happens before status transition

Committed as `chant(2026-02-06-00i-la0)`.```
