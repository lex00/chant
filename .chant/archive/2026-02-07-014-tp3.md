---
type: code
status: completed
depends_on:
- 2026-02-07-00y-qqd
labels:
- operations
- architecture
target_files:
- src/operations/cancel.rs
- src/operations/archive.rs
- src/mcp/handlers.rs
branch: chant/2026-02-07-014-tp3
commits:
- 236b63e
- c65eaf2
completed_at: 2026-02-07T21:57:57Z
model: sonnet
---
# Add cancel and archive operations to operations layer

## Context

Cancel and archive are implemented inline in both MCP handlers and CLI commands with divergent behavior:

- **MCP archive** (`handlers.rs:1685-1747`): uses `std::fs::rename` — no git staging, no date subdirectories
- **CLI archive** (`cmd/lifecycle/archive.rs`): uses `git mv`, date-based subdirectories, target file verification, auto-commit
- **MCP cancel** (`handlers.rs:1624-1683`): calls `spec.set_status()` + `spec.save()` inline
- **CLI cancel** (`cmd/spec/delete.rs`): same pattern in a separate file

## Task

Create `src/operations/cancel.rs` (with `CancelOptions` and `cancel_spec()`) and `src/operations/archive.rs` (with `ArchiveOptions` and `archive_spec()`). Extract the logic from the CLI implementations — archive must use git-aware archiving with date subdirectories, not bare `fs::rename`. Update both MCP handlers (`tool_chant_cancel`, `tool_chant_archive`) and CLI commands to call the new operations, then re-export from `src/operations/mod.rs`.

## Acceptance Criteria

- [x] `src/operations/cancel.rs` exists with `cancel_spec()` used by both MCP and CLI
- [x] `src/operations/archive.rs` exists with `archive_spec()` used by both MCP and CLI
- [x] MCP archive produces same result as CLI archive (date subdirectories, git staging)
- [x] No inline cancel/archive logic remains in MCP handlers
- [x] `cargo test` passes
- [x] `cargo clippy -- -D warnings` passes

## Agent Output

2026-02-07T21:57:57Z

```
I'll implement the cancel and archive operations in the operations layer.
## Summary

Created `src/operations/cancel.rs` and `src/operations/archive.rs` to centralize cancel/archive logic.

- Both MCP handlers and CLI commands now use the same operations layer functions
- Archive operation uses git mv with date subdirectories (matching CLI behavior)
- Cancel operation uses state machine transition (matching both implementations)
- Removed 111 lines of duplicate inline logic from MCP handlers

All tests pass, clippy clean, git status clean.```
