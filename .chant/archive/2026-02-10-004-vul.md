---
type: code
status: completed
target_files:
- src/worktree/mod.rs
- src/cmd/work/executor.rs
branch: chant/2026-02-10-004-vul
commits:
- f4af582
completed_at: 2026-02-10T21:47:07Z
model: sonnet
---
# Isolate agent worktree: remove all specs except the working spec
## Problem
When an agent runs in a worktree, it has access to the full `.chant/specs/` and `.chant/archive/` directories. The agent could read sibling specs and get confused about what it should be working on, especially in group scenarios where many related specs exist.

## Solution
After creating the worktree and before invoking the agent, clean the spec environment:
1. Delete the entire `.chant/specs/` directory in the worktree
2. Delete the entire `.chant/archive/` directory in the worktree
3. Recreate `.chant/specs/`
4. Copy only the working spec file back into `.chant/specs/`

This ensures the agent can only see its own spec. The `CHANT_SPEC_FILE` env var still works since the spec is at the same path.

Do this in the worktree setup code — after `copy_spec_to_worktree` or equivalent, before agent invocation.

Key files:
- `src/worktree/` — worktree creation and setup
- `src/cmd/work/executor.rs` — agent invocation (where worktree path is known)
- `src/cmd/work/single.rs` — single spec execution

## Acceptance Criteria
- [x] After worktree creation, `.chant/specs/` contains only the working spec
- [x] `.chant/archive/` is removed from the worktree
- [x] Agent's `CHANT_SPEC_FILE` env var still resolves correctly
- [x] Prompts directory (`.chant/prompts/`) is preserved (agent needs it)
- [x] Config file (`.chant/config.md`) is preserved
- [x] Existing tests pass (`cargo test`)
- [x] `cargo clippy -- -D warnings` passes

## Agent Output

2026-02-10T21:47:07Z

```
I'll implement the worktree isolation feature by reading the relevant code first, then making the necessary changes.
Now I need to understand where the worktree is created and where I should add the isolation logic. Looking at the code:

1. `copy_spec_to_worktree` is called after worktree creation in both `single.rs` and `parallel.rs`
2. The function currently copies just the spec file
3. I need to add a new function to isolate the worktree after `copy_spec_to_worktree`

Let me check the parallel.rs file as well:
Now I understand the code structure. I need to create a function that isolates the worktree by removing all specs except the working one. Let me implement this:
Now I need to call this function in both `single.rs` and `parallel.rs` after `copy_spec_to_worktree`:
Now I need to export the new function in the module:
Good, the function is already re-exported via `pub use git_ops::*`. Now let's run the tests and linter:
Great! Now let's run the tests:
Perfect! All tests pass. Now let's update the acceptance criteria in the spec:
Now let's commit the changes:
## Summary

Added worktree isolation to prevent agents from seeing sibling specs in group scenarios.

- Created `isolate_worktree_specs()` in `src/worktree/git_ops.rs`
- Removes `.chant/archive/` directory entirely
- Removes all spec files except the working spec from `.chant/specs/`
- Called after `copy_spec_to_worktree()` in both single and parallel execution modes
- All tests pass, clippy clean```
