---
type: code
status: completed
commits:
- 7e18c42
completed_at: 2026-02-07T00:13:53Z
model: sonnet
---
# Bug: merge_and_cleanup in src/worktree/git_ops.rs hardcodes "main" instead of using config.defaults.main_branch. When the user's configured main branch differs (e.g. investigate/38109-fs-out-of-sync), this causes unnecessary branch-switch storms: git checkout main → failed merge → git checkout back. With N parallel specs, this produces N×3 branch switches, rewriting hundreds of files each time. Fix: thread config.defaults.main_branch through merge_and_cleanup and all callers. Key locations: git_ops.rs line 422 (git checkout main), line 342 (git rebase main), line 354 (git checkout main after rebase), lines 440/522 (ensure_on_main_branch("main")). Callers in parallel.rs and single.rs already have config in scope. Also fix ensure_on_main_branch calls in the merge path to use the configured branch.

## Agent Output

2026-02-07T00:13:53Z

```
I'll fix the hardcoded "main" branch references in the merge_and_cleanup flow to use the configured main branch instead.
Now I understand the structure. I need to:
1. Add `main_branch` parameter to `merge_and_cleanup` and its internal variant
2. Update all callers to pass `config.defaults.main_branch`
3. Replace hardcoded "main" with the parameter throughout the function
Now update all callers in parallel.rs and single.rs:
Now check for any other callers of merge_and_cleanup:
Need to update the test calls in git_ops.rs and check the lifecycle test:
Good, the test doesn't directly call the function. Now check for other callers in src/cmd/lifecycle/merge.rs:
This file doesn't call merge_and_cleanup. Now check src/merge.rs:
Now run cargo fmt and clippy:
Good! Now let's check if there are any tests I should run:
Perfect! Now let's check off the acceptance criteria and commit:
The spec doesn't have acceptance criteria, so I'll just commit the changes:
## Summary

Fixed hardcoded "main" branch references in merge_and_cleanup to use config.defaults.main_branch.

- Updated merge_and_cleanup signature to accept main_branch parameter
- Threaded main_branch through all internal helpers: branch_is_behind_main, rebase_branch_onto_main, abort_rebase, merge_and_cleanup_in_dir
- Updated both callers in src/cmd/work/parallel.rs (lines 946 and 1039) to pass config.defaults.main_branch
- Updated test calls in git_ops.rs to pass "main" explicitly
- Replaced hardcoded "main" strings in git commands and error messages throughout the merge flow

All tests pass (14 worktree::git_ops tests).```
