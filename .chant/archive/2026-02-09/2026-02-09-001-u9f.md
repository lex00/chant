---
type: code
status: completed
target_files:
- src/mcp/handlers.rs
- src/score/traffic_light.rs
branch: chant/2026-02-09-001-u9f
commits:
- 6acffa4
completed_at: 2026-02-09T20:33:38Z
model: sonnet
---
# Fix linter scoring loop: agents cannot achieve passing scores, causing infinite refinement cycles
## Problem

The linter's quality scoring system creates unwinnable loops for orchestrating agents:

1. **`chant_work_start` gates on quality** — returns an error for Red/Refine specs, making agents think they must fix the spec before work can start. This turns advisory feedback into a hard blocker.

2. **Suggestions don't match scorers** — AC Quality suggestions say "Rewrite acceptance criteria to be imperative, valuable, and testable" but the scorer is purely count-based (4+ criteria = Grade A). Agents rewrite text endlessly trying to improve "quality" when only quantity matters.

3. **Confidence scorer is too aggressive** — requires >80% bullet-to-prose ratio for Grade A, but specs naturally contain headings, section markers, and context paragraphs. The vague pattern detector flags legitimate technical language ("improve", "similar"). Bullet ratio <20% = automatic Grade D regardless of actual clarity.

4. **Splittability scorer penalizes good structure** — well-focused specs (1 file, 1 concern) and member specs (already split) score Grade C at best, which can push the traffic light to Yellow/Review.

## Solution

### Phase 1: Stop the bleeding (critical)

- Make `chant_work_start` quality check **advisory-only**: remove the `isError: true` gate for Refine status. Quality info should be included in the **success** response as a `quality_warning` field, not block execution.
- MCP response design for graceful degradation:
  - Currently: Refine → `isError: true` with quality scores. Agent sees failure, retries endlessly.
  - New: Refine → success response with `"started": true` plus `"quality_warning": { scores, suggestions }`. Agent sees work started, notes the advisory.
  - The `skip_criteria` parameter stays but becomes opt-in for suppressing the warning entirely (not for unblocking work).
- Same pattern for `chant_lint` MCP: scores are informational, never `isError`. (Already correct today — no change needed.)

### Phase 2: Fix suggestion/scorer mismatch

- AC Quality suggestions: change to "Add at least 4 acceptance criteria checkboxes" (what the scorer actually measures)
- Confidence suggestions: change to "Use bullet points instead of prose paragraphs; avoid words like 'improve', 'as needed', 'etc', 'similar'" (what the scorer actually checks)
- Splittability suggestions: change to "Add target_files and organize with ## section headers" (what the scorer actually checks)

### Phase 3: Fix Splittability for focused specs

- Grade A should remain for complex splittable specs (3+ headers, 3+ files)
- Grade B for moderate structure
- Grade C for focused specs (this is fine — single concern is not a problem)
- But: Splittability C should NOT contribute to Yellow/Review traffic light. A focused spec is good, not a problem.
- Update `determine_status` to exclude Splittability from Ready/Review gate (only Complexity, Confidence, AC Quality matter for traffic light)

## Target Files

- src/mcp/handlers.rs (remove work_start quality gate)
- src/score/traffic_light.rs (fix suggestions text, exclude splittability from traffic light)
- src/score/splittability.rs (no code changes needed, just traffic light exclusion)

## Acceptance Criteria

- [x] `chant_work_start` no longer returns isError for Refine/Red quality scores — returns success with `quality_warning` field containing scores and suggestions
- [x] AC Quality suggestions reference criteria count thresholds (not content quality)
- [x] Confidence suggestions reference bullet ratio and vague pattern avoidance (not abstract "clarity")
- [x] Splittability grade C does not push traffic light to Review — only Complexity, Confidence, and AC Quality affect traffic light status
- [x] Existing tests updated to reflect new traffic light logic (splittability excluded)
- [x] `cargo test` passes
- [x] `cargo clippy -- -D warnings` passes

## Agent Output

2026-02-09T20:07:26Z

```
I'll implement the fix for the linter scoring loop. Let me start by reading the relevant files.
Now I'll read the scoring module to understand the SpecScore struct and traffic light logic:
Now I understand the architecture. Let me check the confidence scorer to understand its implementation:
Now I understand the codebase. Let me implement the fixes:

## Changes needed:

1. **handlers.rs (lines 1856-1972)**: Remove quality gate from `tool_chant_work_start`, make it advisory-only
2. **traffic_light.rs (lines 19-42)**: Exclude Splittability from traffic light status determination
3. **traffic_light.rs (lines 64-98)**: Update suggestion text to match what scorers actually measure

Let me start with the changes:
Now update the traffic_light.rs to exclude Splittability from status determination and fix suggestions:
Now fix the suggestion text to match what the scorers actually measure:
Now we need to update the tests to reflect the new traffic light logic that excludes Splittability and Isolation:
Now add a test for splittability D not affecting traffic light:
Now run the tests:
Need to update the tests to match new suggestion text:
Great! Now run all tests:
Perfect! All tests pass. Now run cargo fmt and clippy:
Need to fix the clippy warning:
Perfect! Now let's update the spec acceptance criteria and commit:
Now commit the changes:
## Summary

Fixed the linter scoring loop that caused agents to enter infinite refinement cycles.

**Key changes:**
- handlers.rs:1894-1973 — Removed quality gate from `chant_work_start`, changed to advisory-only with `quality_warning` field in success response
- traffic_light.rs:11-42 — Excluded Splittability and Isolation from traffic light determination (only Complexity, Confidence, AC Quality contribute)
- traffic_light.rs:64-103 — Fixed suggestion text to match actual scorer implementations (count-based for AC Quality, bullet ratio for Confidence, target_files for Splittability)
- Added tests to verify Splittability/Isolation D grades don't affect traffic light status

All acceptance criteria met, tests pass, code formatted and linted.```