---
type: code
status: completed
branch: chant/2026-02-06-00e-lkc
---
# Research: Agent log doesn't clearly distinguish between runs â€” log appends with # Continued header but old content stays, making it hard to tell fresh output from stale attempts. Investigate options: separate log files per run, clearer delimiters, a --since flag for log reading, or log rotation on spec reset. Look at src/log.rs and how the log writer handles re-runs.

## Findings

### Current Log Handling

**Log Creation (src/cmd/agent.rs:396-461)**
- `StreamingLogWriter::new()` creates/appends to `.chant/logs/<spec-id>.log`
- New files get header: `# Agent Log: <id>`, `# Started: <timestamp>`, `# Prompt: <name>`
- Existing files get continuation marker: `# Continued: <timestamp>`, `# Prompt: <name>`
- All content appends to the same file - old runs remain visible

**Log Reading**
- CLI: `chant log <id>` uses `tail -n <lines>` (src/cmd/lifecycle/mod.rs:125-173)
- MCP: `chant_log` tool reads file, applies offset/since filters (src/mcp/handlers.rs:965-1091)
- Both show last N lines by default (100 for MCP, customizable for CLI)

**Log Reset**
- `chant reset` does NOT clear logs (src/cmd/lifecycle/reset.rs:10-71)
- Logs persist across all resets and re-runs
- No log rotation or cleanup mechanism exists

### Problem

When a spec is reset and re-run multiple times:
1. All previous attempts remain in the log file
2. The `# Continued` marker is minimal - just timestamp and prompt name
3. Hard to distinguish where fresh output starts vs stale failures
4. Reading recent logs requires manual scrolling or knowing timestamps

### Options Investigated

#### Option 1: Separate log files per run
- Create `<spec-id>-001.log`, `<spec-id>-002.log`, etc.
- **Pros:** Clean separation, easy to find specific runs
- **Cons:** File proliferation, harder to see full history, need run counter tracking

#### Option 2: Clearer delimiters
- Enhance `# Continued` marker with more context
- Add run number, status at start, outcome at end
- **Pros:** Simple, backward compatible, low implementation cost
- **Cons:** Still requires manual parsing to find run boundaries

#### Option 3: Add `--since` flag for log reading
- MCP already supports `since` parameter for timestamp filtering
- CLI could add `--since` flag to `chant log`
- **Pros:** Already partially implemented in MCP, useful for incremental reads
- **Cons:** Requires knowing timestamps, doesn't solve visual clarity

#### Option 4: Log rotation on reset
- `chant reset` archives old log to `<spec-id>.log.old` and starts fresh
- **Pros:** Clean slate for each reset, preserves one previous attempt
- **Cons:** Loses full history, requires user to opt-in via reset

#### Option 5: Add run metadata to logs
- Track run number in spec frontmatter
- Add `# Run: <number>` to continuation header
- Show run separators clearly
- **Pros:** Easy to scan, maintains full history, minimal changes
- **Cons:** Requires spec frontmatter updates

### Recommendation

**Implement Option 2 + Option 5 hybrid:**

1. **Enhanced continuation markers** (src/cmd/agent.rs:440-447)
   - Track run counter in spec frontmatter (`run_count` field)
   - Write clearer delimiter:
     ```
     ================================================================================
     # Run <number> - Started: <timestamp>
     # Prompt: <name>
     # Previous status: <status>
     ================================================================================
     ```

2. **Add run outcome footer** when agent completes/fails
   - Append outcome marker at end of run:
     ```
     ================================================================================
     # Run <number> - Ended: <timestamp>
     # Outcome: <completed|failed>
     ================================================================================
     ```

3. **Add `--run` flag to `chant log`**
   - `chant log <id> --run 3` shows only Run 3's output
   - `chant log <id> --run latest` shows latest run only
   - Default behavior: show all runs (backward compatible)

4. **Optional: Add `--clear-log` flag to `chant reset`**
   - `chant reset <id> --clear-log` archives old log before starting fresh
   - Default: preserve logs (backward compatible)

### Implementation Impact

- **Low risk:** All changes are additive and backward compatible
- **Files to modify:**
  - `src/cmd/agent.rs` - StreamingLogWriter delimiter enhancement
  - `src/spec.rs` - Add `run_count` to frontmatter
  - `src/cmd/lifecycle/mod.rs` - Add `--run` flag to `cmd_log`
  - `src/cmd/lifecycle/reset.rs` - Add `--clear-log` flag
- **Testing:** Need log parsing tests for run boundaries

### Alternative: Quick Fix

If full implementation is too complex, **minimal fix:**
- Just enhance the continuation marker formatting (Option 2 only)
- Change from:
  ```
  # Continued: 2026-02-06T21:54:07Z
  # Prompt: standard
  ```
- To:
  ```

  ================================================================================
  CONTINUED RUN - 2026-02-06T21:54:07Z
  Prompt: standard
  ================================================================================

  ```

This provides visual separation with zero architectural changes.