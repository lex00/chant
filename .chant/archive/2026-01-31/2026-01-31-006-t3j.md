---
type: code
status: completed
target_files:
- src/cmd/merge.rs
- src/main.rs
commits:
- 7e6f9cc
completed_at: 2026-01-31T10:54:16Z
model: sonnet
---
# Selective merge command - merge specific completed branches from parallel work

## Problem

After parallel execution, some specs complete successfully while others fail or need attention. Currently:
- `chant merge` merges ALL pending branches
- No way to merge just specific completed specs
- No visibility into which branches are ready vs stuck

Users want to:
1. See which branches are ready to merge
2. Selectively merge specific specs
3. Leave problematic branches for later

## Solution

Enhance `chant merge` with:
1. List mode showing branch status
2. Selective merge by spec ID
3. Interactive mode to choose which to merge

## Implementation

### List mode

```bash
$ chant merge --list

Ready to merge:
  chant/2026-01-31-001-abc  (3 commits, all criteria met)
  chant/2026-01-31-002-def  (1 commit, all criteria met)

Not ready:
  chant/2026-01-31-003-ghi  (behind main, needs rebase)
  chant/2026-01-31-004-jkl  (2/5 criteria checked)
```

### Selective merge

```bash
# Merge specific specs
chant merge abc def

# Merge all ready branches
chant merge --ready
```

### Interactive mode

```bash
$ chant merge -i

Select branches to merge:
  [x] 2026-01-31-001-abc - Implement feature (ready)
  [x] 2026-01-31-002-def - Fix bug (ready)
  [ ] 2026-01-31-003-ghi - Add tests (needs rebase)
  [ ] 2026-01-31-004-jkl - Update docs (incomplete)

Merge 2 selected branches? (y/n)
```

### Branch status detection

For each chant/* branch, determine:
- **ready**: All criteria checked, can ff-merge
- **needs-rebase**: Behind main, auto-rebase possible
- **has-conflicts**: Rebase would conflict
- **incomplete**: Criteria not all checked
- **no-commits**: Branch exists but no work done

## Acceptance Criteria

- [x] Add `--list` flag to show branch status
- [x] Detect branch readiness (criteria, ff-ability, divergence)
- [x] Allow spec IDs as positional args for selective merge
- [x] Add `--ready` flag to merge all ready branches
- [x] Add `-i` interactive mode with checkbox selection
- [x] Show clear status for each branch
- [x] Skip branches that aren't ready (with explanation)
- [x] Report results: merged, skipped, failed

## Agent Output

2026-01-31T10:54:16Z

```
I'll implement the selective merge command for chant. Let me start by understanding the current merge implementation and then build out the new functionality.
Now let me check the CLI command structure to understand how merge is currently invoked.
Now let me check the cmd_merge implementation.
Let me check the git module to understand branch operations.
Now let me read more of the lifecycle.rs to understand the execute_merge function.
Let me also check what information we can get from git about branch status.
Let me look at what functions already exist in git.rs for checking branch status.
Now let me check if there are any criteria checking functions.
Good, now I have enough context. Let me plan the implementation.
Now let me start implementing. First, I'll add branch status detection logic to the merge module.
Now let me add the functions to detect branch status in the git module. I need to add functions to check if a branch can fast-forward merge and if it's behind main.
Now let me add the necessary helper functions at the end of the git module. First let me check where the file ends.
Now I'll add helper functions to git.rs for checking branch status. Let me add them before the tests section.
Now let me add the branch status detection logic to the merge module. First I'll add the BranchStatus enum and related functions.
Now let me add helper functions to count criteria and detect branch status.
Now let me add the --list, --ready, and -i flags to the main.rs command structure.
Now update the command invocation to pass the new flags.
Now I need to update the cmd_merge function signature and implementation. Let me read more of it.
Now let me update the cmd_merge function signature and add the new logic.
Now I need to add the logic for --list, --ready, and -i flags. Let me insert this right after loading specs.
Now I need to implement the three new functions. Let me add them before the cmd_merge function. First, let me check what imports are needed.
Now let me find a good location to add the three helper functions. Let me look for where other merge-related helper functions are defined.
Good, I'll add the three new functions right before run_merge_wizard. Let me do that now.
Now let me run cargo fmt to format the code.
Now let me run cargo clippy to check for issues.
I need to fix these clippy issues. First, remove the unused import, and then I'll add allow attributes for the too many arguments warnings.
Now let me run clippy again to check if there are any remaining issues.
I need to add the BranchInfo import back. Let me check the show_branch_status function and others to add the necessary imports.
I see - the merge_ready_branches function also needs the BranchInfo import. Let me add it back.
Now I also need to check the merge_interactive function. Let me verify it uses BranchInfo.
The merge_interactive function doesn't explicitly use BranchInfo type, it just iterates over branch_infos, so it doesn't need the import. Let me run clippy again.
Great! Now let me run the tests.
Excellent! All tests pass. Now let me update the acceptance criteria in the spec file.
Now I'll update all the acceptance criteria to checked.
Now let me commit the changes.
Perfect! The git status is clean. Let me mark the final task as completed.
Excellent! I have successfully implemented the selective merge command for chant. Here's a summary of what was accomplished:

## Implementation Summary

### New Features Added

1. **`--list` flag**: Display branch status for all completed specs
   - Shows "Ready to merge" branches (can fast-forward, all criteria met)
   - Shows "Not ready" branches with reasons (needs rebase, incomplete criteria, etc.)

2. **`--ready` flag**: Automatically merge all ready branches
   - Identifies branches that can be fast-forward merged with all criteria met
   - Provides a quick way to merge successful parallel work

3. **`-i/--interactive` flag**: Interactive selection mode
   - Displays all completed spec branches with status indicators
   - Pre-selects ready branches
   - Allows manual selection of which branches to merge

### Technical Implementation

**New Git Helper Functions** (in `src/git.rs`):
- `can_fast_forward_merge()`: Check if a branch can be fast-forward merged
- `is_branch_behind()`: Check if a branch is behind the target branch
- `count_commits()`: Count commits in a branch

**Branch Status Detection** (in `src/merge.rs`):
- `BranchStatus` enum with states: Ready, NeedsRebase, HasConflicts, Incomplete, NoCommits, NoBranch
- `BranchInfo` struct to hold branch metadata
- `count_criteria()`: Count checked vs total acceptance criteria
- `detect_branch_status()`: Determine branch status
- `get_branch_info_for_specs()`: Gather info for all completed specs

**New Command Functions** (in `src/cmd/lifecycle.rs`):
- `show_branch_status()`: Display branch status list
- `merge_ready_branches()`: Merge all ready branches
- `merge_interactive()`: Interactive branch selection

### All Acceptance Criteria Met

... (output truncated, 5819 chars total)```
