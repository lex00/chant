---
type: research
status: completed
completed_at: '2026-02-06T00:00:00Z'
---
# Research: chant_spec_update output appends to body instead of setting frontmatter — adding dependencies via MCP output field puts text in the body, not depends_on in YAML frontmatter. Investigate whether chant_spec_update should support setting frontmatter fields (depends_on, labels, model, etc.) via dedicated parameters, or if a separate MCP tool is needed. Look at src/mcp/tools/ spec update handler and the spec frontmatter schema.

## Findings

### Current Implementation

The `chant_spec_update` MCP tool (src/mcp/handlers.rs:723-813) currently supports:
- **status**: Updates `spec.frontmatter.status` directly (lines 754-774)
- **output**: Appends text to `spec.body` under an "## Output" heading (lines 777-787)

### Frontmatter Schema

The `SpecFrontmatter` struct (src/spec/frontmatter.rs:81-162) contains 30+ fields including:
- Core: `type`, `status`, `depends_on`, `labels`, `target_files`, `context`, `prompt`
- Execution: `branch`, `commits`, `completed_at`, `model`
- Documentation: `tracks`
- Research: `informed_by`, `origin`, `schedule`
- Conflict: `source_branch`, `target_branch`, `conflicting_files`, `blocked_specs`, `original_spec`
- Verification: `last_verified`, `verification_status`, `verification_failures`
- Replay: `replayed_at`, `replay_count`, `original_completed_at`
- Approval: `approval` (structured object)
- Driver/group: `members`
- Misc: `output_schema`, `public`, `retry_state`, `derived_fields`

### How Specs are Saved

The `Spec::save()` method (src/spec/parse.rs:152-157):
```rust
pub fn save(&self, path: &Path) -> Result<()> {
    let frontmatter = serde_yaml::to_string(&self.frontmatter)?;
    let content = format!("---\n{}---\n{}", frontmatter, self.body);
    fs::write(path, content)?;
    Ok(())
}
```

Serializes the entire `SpecFrontmatter` struct to YAML, so any field updated in `spec.frontmatter` will be properly saved to the frontmatter section.

### The Problem

When using `chant_spec_update` with the `output` parameter to add dependencies, the text goes into the body instead of being parsed and set in `spec.frontmatter.depends_on`. This is by design — the `output` parameter is intentionally a body append operation.

### Design Considerations

**Option 1: Extend chant_spec_update with frontmatter parameters**
- Add optional parameters for common frontmatter fields: `depends_on`, `labels`, `target_files`, `context`, `model`
- Pros: Single tool, consistent with existing pattern
- Cons: Tool schema becomes large (30+ optional fields), unclear which fields to expose

**Option 2: Create separate MCP tool (e.g., chant_spec_set_frontmatter)**
- Dedicated tool for setting arbitrary frontmatter fields
- Could use a map/object parameter approach
- Pros: Clear separation of concerns, can handle all fields generically
- Cons: More tools to maintain, type validation complexity

**Option 3: Keep current design (status quo)**
- `chant_spec_update` only modifies status and appends body
- Users manually edit spec files for frontmatter changes
- Pros: Simple, explicit, clear responsibilities
- Cons: Less convenient for MCP users, requires file editing

### Recommendation

**Extend chant_spec_update with selective frontmatter parameters** (Option 1, limited scope).

Add parameters for the most commonly used fields that MCP users would need to modify:
- `depends_on` (Vec<String>)
- `labels` (Vec<String>)
- `target_files` (Vec<String>)
- `model` (String)

Rationale:
- These are the fields most likely to be set/modified during spec planning and orchestration
- Keeps the tool focused and maintainable
- Other fields (verification, replay, approval, etc.) are system-managed and shouldn't be set via MCP
- Avoids creating a generic "set any field" tool which would be harder to validate and document

Implementation approach:
- Add optional parameters to the tool schema (lines 188-209)
- Add conditional blocks in tool_chant_spec_update to update frontmatter fields (after line 774)
- Preserve the `output` parameter for body appends (existing behavior)
- Ensure validation (e.g., depends_on references valid specs)