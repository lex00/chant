---
type: research
status: completed
branch: chant/2026-02-04-00h-o7m
commits:
- 1681a05
completed_at: 2026-02-04T21:20:10Z
model: sonnet
---
# Research: Analyze chant codebase testability and propose refactoring strategies

## Context

Chant has ~500 tests and 50% coverage. We need to understand:
- Is the codebase structured in a way that's hard to test?
- Are the existing tests effective or just numerous?
- What refactoring would improve testability?

## Research Questions

### 1. Current Test Quality
- What's the unit vs integration test ratio?
- Are tests testing behavior or implementation details?
- Do tests rely heavily on filesystem/git (hard to mock)?

### 2. Architectural Barriers
- Are there functions doing too much (IO + logic mixed)?
- Can core logic be tested without spawning processes/git repos?
- What dependencies are hardcoded vs injectable?

### 3. Specific Areas to Analyze
- `src/cmd/work/` - Does work execution logic depend on real worktrees?
- `src/mcp/` - Can MCP handlers be unit tested without real specs?
- `src/git.rs` - Is git logic separated from business logic?
- `src/main.rs` - How much logic lives in main vs library code?

### 4. Refactoring Proposals
For each problem area, propose:
- What abstraction would help (traits, dependency injection, etc.)
- Concrete refactoring steps as potential follow-up specs

## Deliverable

Write findings to `docs/architecture/testability-analysis.md`:
- Summary of current state
- Top 3-5 testability issues
- Proposed refactoring strategies with priority

## Acceptance Criteria

- [x] Created `docs/architecture/testability-analysis.md`
- [x] Analyzed unit vs integration test ratio
- [x] Identified architectural barriers to testability
- [x] Examined `src/cmd/work/`, `src/mcp/`, `src/git.rs`, and `src/main.rs`
- [x] Proposed concrete refactoring strategies with priorities
- [x] Documented success metrics and implementation phases

## Agent Output

2026-02-04T21:20:10Z

```
I'll analyze the chant codebase testability and create a comprehensive report.
## Summary

Created comprehensive testability analysis at `docs/architecture/testability-analysis.md`.

**Key Findings:**
- 8:1 unit-to-integration ratio masks poor test isolation
- Three critical barriers: hard I/O coupling, zero dependency injection, 900-line functions
- Tests validate behavior but are slow (26.5s) and brittle

**Top Issues:**
1. Git operations hardcoded throughout - no abstraction layer
2. Business logic embedded in command handlers (`cmd_work`: 758 lines)
3. Domain logic inseparable from filesystem operations

**Refactoring Strategy:**
Five phases targeting 75%+ coverage, <5s test runtime:
1. Repository pattern (traits for specs/git)
2. Extract domain logic to pure functions
3. Break up large functions
4. Add test utilities (builders, fixtures)
5. Service facades for high-level operations```
