---
type: code
status: cancelled
depends_on:
- 2026-02-07-00z-4mv
labels:
- state-machine
- safety
target_files:
- src/spec/parse.rs
- src/operations/update.rs
- src/cmd/finalize.rs
- src/cmd/watch.rs
- src/cmd/work/executor.rs
- src/cmd/work/parallel.rs
- src/cmd/lifecycle/merge.rs
- src/spec_group.rs
- src/spec/lifecycle.rs
---
# Enforce state machine — reduce force_status bypass to justified cases only

## Context

The codebase has a well-designed `TransitionBuilder` state machine in `src/spec/state_machine.rs` that validates transitions and checks preconditions. But `force_status` is called in **19 locations** (excluding tests and .bak files), while the validated `set_status` path is rarely used. Critically, `operations/update.rs:36` — the shared update operation used by both CLI and MCP — calls `force_status` directly, meaning every status update from MCP clients bypasses the state machine.

Current `force_status` callsites (non-test, non-.bak):

1. `src/operations/update.rs:36` — the shared update operation (CRITICAL)
2. `src/cmd/finalize.rs:257` — re_finalize_spec
3. `src/cmd/finalize.rs:505` — auto_complete_parent_group
4. `src/cmd/watch.rs:446` — marking failed specs
5. `src/cmd/watch.rs:760` — marking failed specs
6. `src/cmd/work/executor.rs:373` — marking failed specs
7. `src/cmd/work/executor.rs:484` — marking needs_attention
8. `src/cmd/work/executor.rs:502` — marking needs_attention
9. `src/cmd/work/parallel.rs:439` — marking needs_attention
10. `src/cmd/work/parallel.rs:530` — marking failed
11. `src/cmd/work/parallel.rs:677` — marking failed
12. `src/cmd/work/parallel.rs:1105` — marking failed
13. `src/cmd/lifecycle/merge.rs:743` — inline finalization
14. `src/spec_group.rs:392` — driver to InProgress
15. `src/spec_group.rs:465` — driver to Completed
16. `src/spec/lifecycle.rs:45` — blocked status
17. `src/spec/lifecycle.rs:48` — unblocked status

## Task

1. **`operations/update.rs`**: Replace `force_status` with `TransitionBuilder::new(spec).to(new_status)`, with a fallback to `.force().to()` only when the transition is a self-transition or the caller explicitly opts in via an `UpdateOptions.force` field
2. **Error recovery paths** (executor, parallel, watch marking specs as Failed/NeedsAttention): These are justified uses of force — agent may have left spec in unexpected state. Add `TransitionBuilder::new(spec).force().to()` instead of raw `force_status` to at least log that the state machine was bypassed
3. **`spec/lifecycle.rs`** (blocked/unblocked): These are computed status updates. Use `TransitionBuilder` with appropriate transitions (Pending→Blocked, Blocked→Pending are valid)
4. **`spec_group.rs`** (driver status): Use `TransitionBuilder` — InProgress and Completed transitions for drivers should be validated
5. **`cmd/finalize.rs:257` (re_finalize)**: Use `TransitionBuilder::new(spec).force().to(Completed)` — re-finalize is an explicit recovery operation
6. **`cmd/lifecycle/merge.rs:743`**: This is a complete bypass — should call `operations::finalize_spec` instead of inline finalization

After this change, `force_status` should only be called via `TransitionBuilder::force()`, never directly. Consider making `force_status` private or removing it entirely and routing all force paths through the builder.

## Acceptance Criteria

- [ ] `operations/update.rs` uses `TransitionBuilder` (not raw `force_status`) for status changes
- [ ] `operations/update.rs` `UpdateOptions` has a `force: bool` field for explicit opt-in
- [ ] `spec/lifecycle.rs` blocked/unblocked transitions use `TransitionBuilder` or `set_status`
- [ ] `spec_group.rs` driver status changes use `TransitionBuilder`
- [ ] `cmd/lifecycle/merge.rs` `--finalize` calls operations layer instead of inline finalization
- [ ] Direct `force_status` calls reduced to error-recovery paths only (executor, parallel, watch)
- [ ] Error-recovery `force_status` calls use `TransitionBuilder::force()` instead of raw `force_status`
- [ ] `Spec::force_status` is either removed or made `pub(crate)` (not public API)
- [ ] `cargo test` passes
- [ ] `cargo clippy -- -D warnings` passes