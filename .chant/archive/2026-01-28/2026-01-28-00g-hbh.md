---
type: code
status: completed
commits:
- 8bdad85
completed_at: 2026-01-28T16:59:13Z
model: opus
---
# Fix test_parallel_work_and_merge_workflow integration test failure

## Problem

After fixing the unit test git repo issues in spec 2026-01-28-00f-vyo, a new integration test failure appeared in CI:

**Test:** `test_parallel_work_and_merge_workflow` (line 4361 in `tests/integration_tests.rs`)

**Error in CI:**
```
Error: Main branch 'main' does not exist

Context:
  - Expected main branch: main
  - This is typically 'main' or 'master'

thread 'test_parallel_work_and_merge_workflow' panicked at tests/integration_tests.rs:4361:5:
Merge of spec1 should succeed
```

**Root cause:** The test creates a temporary git repository using `setup_test_repo()` and then tries to merge a spec branch back to `main`. However, the git repository setup might not be creating the `main` branch correctly, or the merge logic expects `main` to exist but it doesn't in the test environment.

This test was passing before the changes in spec 00f-vyo, suggesting either:
1. A race condition revealed by marking other tests `#[serial]`
2. The test setup doesn't properly initialize the `main` branch
3. The merge logic has a pre-existing bug that's now surfacing

## Solution

Investigate and fix the test:

1. Read the `test_parallel_work_and_merge_workflow` test code
2. Read the `setup_test_repo()` helper to understand git repo initialization
3. Check if `main` branch is created during setup
4. Ensure the merge operation can find the `main` branch
5. Fix the test or the helper function to ensure `main` branch exists

Options:
- **A)** Fix `setup_test_repo()` to explicitly create and checkout `main` branch
- **B)** Fix the test to create `main` branch before merge
- **C)** Mark this test with `#[serial]` if it's a race condition

## Acceptance Criteria

- [x] Read `test_parallel_work_and_merge_workflow` test code
- [x] Read `setup_test_repo()` helper implementation
- [x] Identify why `main` branch doesn't exist during merge
- [x] Implement fix (A, B, or C)
- [x] Run the specific test locally and verify it passes
- [x] Run full integration test suite and verify all pass
- [x] Commit with spec ID reference
- [x] All tests passing
- [x] Code linted and formatted

## Agent Output

2026-01-28T16:59:13Z

```


I'll start by reading the relevant test code and helper functions to understand the issue.
Now I understand the code. The `setup_test_repo()` function at line 18 calls `git init` but doesn't explicitly set the branch name to `main`. On some systems/configurations, `git init` creates a default branch called `master` instead of `main`. The merge command then looks for `main` and fails.

Let me check how the merge logic determines the main branch name, and look at what other tests do for setup.
Now let me look at the merge logic to understand how it finds the main branch.
Now I understand the full picture. The `setup_test_repo()` function uses `git init` without specifying `-b main`, so the default branch name depends on the system's `git` configuration. In CI or certain environments, the default branch might not be `main`. The merge logic defaults to `main` (via `load_main_branch`), and when the repo's default branch is something else (like `master`), it fails.

The fix should be in `setup_test_repo()` to explicitly use `git init -b main` so the initial branch is always named `main`. Let me also check if there's a `setup_test_repo_in_temp` or similar function that was introduced by spec 00f.
The CHANGELOG even documents this exact fix pattern. Now I have a clear understanding of the issue and the fix. The `setup_test_repo()` function calls `git init` without `-b main`, so the default branch name depends on the system/CI environment configuration. The merge command defaults to looking for `main`, which may not exist if the default branch is `master`.

The fix is straightforward: change `git init` to `git init -b main` in `setup_test_repo()`.
Now let me also check if there are other places in the test file where `git init` is called without `-b main`, which could cause similar issues.
There are other `git init` calls without `-b main`. Let me check the context of these to see if any of them are in tests that rely on the branch being named `main`.
These other `git init` calls don't use `setup_test_repo()` and also lack `-b main`. While these could potentially cause similar issues in other tests, the spec scope is focused on `test_parallel_work_and_merge_workflow`. However, since all these tests could potentially fail for the same reason, and the `setup_test_repo()` helper is the shared function used by many tests, fixing it there is the most impactful change.

Let me also check if those standalone `git init` calls are in tests that reference `main` branch.
The inline `git init` calls (lines 1965, 2062, 2147, 3208, 3369) are in tests that don't deal with merge operations (they test lint, env derivation, etc.), so they don't need the `-b main` fix for the current issue. The `setup_test_repo()` fix is sufficient since it's the function used by the merge-related tests.

Now let me run the specific test to verify the fix works.
The test passes. Now let me run the full integration test suite and lint/format in parallel.
Formatting is clean, clippy has only pre-existing warnings (none introduced by my change), and all 308 unit tests + 37 integration tests pass (3 ignored). The 2 doc-test failures are pre-existing issues in `merge_driver.rs` doc comments (not related to my change).

Now let me update the acceptance criteria in the spec file and commit.
Now add the model to the frontmatter since all criteria are met.
Now commit the changes.
The remaining changes are pre-existing (they were shown in the initial git status). My commit is clean.
All done. Here's a summary of what was done:

**Root cause:** The `setup_test_repo()` helper function in `tests/integration_tests.rs:18` used `git init` without specifying a branch name. The default branch name depends on the system's git configuration (`init.defaultBranch`). In CI environments where the default is `master` instead of `main`, the chant merge command would fail with "Main branch 'main' does not exist" because it defaults to looking for `main`.

**Fix (Option A):** Changed `git init` to `git init -b main` in `setup_test_repo()` at `tests/integration_tests.rs:23`, ensuring the initial branch is always named `main` regardless of system configuration.

**Results:**
- `test_parallel_work_and_merge_workflow` passes
- All 308 unit tests pass
- All 37 integration tests pass (3 ignored, as expected)
- Code is formatted and linted (no new warnings)
- Committed as `8bdad85````
