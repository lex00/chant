---
type: code
status: completed
branch: chant/2026-02-05-00d-val
commits:
- b0a7e0a
completed_at: 2026-02-05T20:04:28Z
model: sonnet
---
# Fix process tracking: `chant work --parallel` spawns workers but `chant_work_list` shows 0 running processes. Process files in `.chant/processes/` not being created or cleaned up prematurely. Workers are running (visible in `ps aux`) but invisible to chant tooling.

## Summary

Fixed `chant_work_list` MCP tool to use PID files for process tracking instead of unreliable log file modification time heuristics.

### Root Cause
The `tool_chant_work_list` function was using log file modification time (< 5 minutes) to determine if a process was running, which was unreliable.

### Solution
Changed to use `crate::pid::list_active_pids()` which:
- Reads PID files from `.chant/pids/`
- Checks if processes are actually running using `kill -0`
- Returns accurate list of running/stale processes

### Files Changed
- `src/mcp/handlers.rs`: Rewrote `tool_chant_work_list` to use PID-based tracking

Commit: b0a7e0a

## Agent Output

2026-02-05T20:04:28Z

```
I'll investigate the process tracking issue and fix it.
Process tracking is broken. The issue is in `tool_chant_work_start` - it creates process files but `tool_chant_work_list` uses a different mechanism (checking spec status + logs). I need to find where process files should be created/cleaned.
The issue is clear: `chant work --parallel` uses threads (not separate processes) and doesn't create process files. Only the MCP `tool_chant_work_start` creates process files. I need to add process file creation to the parallel execution path.
The spec has no acceptance criteria. Let me understand the actual problem by looking at what `chant_work_list` should be tracking:
Now I understand the architecture:
1. `chant work --parallel` spawns worker threads (not separate processes)
2. These threads call `invoke_agent_with_command` which spawns `claude` subprocesses
3. Process files should track these `claude` subprocesses
4. The issue is that process files aren't being created when threads spawn workers

Let me check where process files should be created:
I see! The code writes PID files (lines 79, 186) but not process files in `.chant/processes/`. The MCP handler creates process files, but the CLI doesn't. The `chant_work_list` tool was rewritten (lines 1884-1987) to check spec status + logs instead of process files, which is why it's not finding the workers.

The problem is that `chant_work_list` now uses a heuristic (log file modification time within 5 minutes) instead of actual process tracking. This is unreliable. I need to add proper process file creation to the parallel worker threads.
Wait, the real issue is that `invoke_agent_with_command` writes PID files but not process files. Let me fix the actual root cause - we need to write process files in addition to PID files:
Now I understand the full picture. There are TWO separate tracking mechanisms:
1. **PID files** (`.chant/pids/`) - track claude process PIDs, created/removed by `invoke_agent_with_command`
2. **Process files** (`.chant/processes/`) - track work sessions with metadata, only created by MCP handlers

The `chant_work_list` MCP tool was changed to use spec status + log files instead of process files. The issue is that it's unreliable.

The fix is to make `chant_work_list` use PID files instead of the log file heuristic:
Let me try a different approach - write the full function:
I see cargo fmt renamed the function. Let me check the full context again:
The file is over 2000 lines. Let me take a focused approach by only editing the specific function:
Let me create a patch file instead:
Let me manually edit using sed:
Great! Now let's test the fix:
Perfect! Now let me verify the fix works and also check the parallel.rs file I modified earlier:
Great! The parallel.rs file wasn't actually changed (I reverted it). Now let me commit the fix:
Perfect! The fix is committed. Now let me update the spec status:
The spec file is gitignored. That's fine - the actual code changes are committed.

## Summary

Changed `src/mcp/handlers.rs` to fix process tracking reliability.

**Root cause**: `chant_work_list` used log file modification time (< 5 minutes) to determine if workers were running - unreliable heuristic.

**Fix**: Rewrote `tool_chant_work_list` to use `crate::pid::list_active_pids()` which:
- Reads PID files from `.chant/pids/` (created by `invoke_agent_with_command`)
- Checks if PIDs are actually running using `kill -0`
- Returns accurate running/stale status

Now `chant work --parallel` workers are properly tracked by `chant_work_list` MCP tool.```
