---
type: code
status: completed
depends_on:
- 2026-02-06-00g-9b4
commits:
- d88352d
completed_at: 2026-02-06T23:25:45Z
model: sonnet
---
# Fix failure cleanup path in src/cmd/work/single.rs. Per research 00b-yap: line 888 returns early bypassing ensure_on_main_branch at line 893. Move cleanup before error return in the Err(e) block (lines 862-888). Use SpecStateMachine for the in_progress→failed transition. This is the first real consumer of the state machine module.

## Agent Output

2026-02-06T23:25:45Z

```
I'll read the relevant code and implement the fix.
Now I understand the task. I need to:

1. Move cleanup (ensure_on_main_branch) before the error return in the Err(e) block (lines 862-888)
2. Use SpecStateMachine for the in_progress→failed transition instead of directly setting the status
Now I need to check if the state_machine module is properly exported:
Good! The state_machine module is already exported. Now I need to format and run clippy:
I need to use the public export. Let me fix the import:
Good! Now let me check off the acceptance criteria and commit:
There are no acceptance criteria to check off. Let me commit the work:
## Summary

Fixed failure cleanup path in src/cmd/work/single.rs:

- Moved `ensure_on_main_branch` call before the error return in the Err(e) block (lines 862-888)
- Replaced direct status assignment with `spec::TransitionBuilder::new(&mut spec).to(SpecStatus::Failed)`
- Added fallback to direct status update if state machine transition fails
- First real consumer of the SpecStateMachine module introduced in 00g-9b4```
