---
type: code
status: completed
labels:
- ux
- bug
target_files:
- src/commands/archive.rs
- src/commands/finalize.rs
commits:
- dbf42c0
completed_at: 2026-01-30T21:46:13Z
model: sonnet
---
# Improve target_files mismatch warning clarity

## Problem

When archiving a spec, this warning appears:

```
Warning: Spec 2026-01-29-00a-qza lists target_files but no changes found
Target files:
  - src/cmd/finalize.rs

Files with changes: 1 (net additions: 128)

This may indicate:
  - Merge conflict resolved incorrectly
  - Implementation was lost during merge
  - Spec manually marked completed without implementation
```

This is confusing because:
1. "no changes found" contradicts "Files with changes: 1"
2. The actual issue is a **mismatch** - changes exist but not in declared files
3. The warning sounds alarming when it might just be outdated `target_files`

## Solution

Reword the warning to be clearer about what actually happened:

```
Warning: Spec 2026-01-29-00a-qza has target_files that don't match actual changes

Declared target_files (no changes detected):
  - src/cmd/finalize.rs

Actual files changed:
  - src/commands/finalize.rs (+128 lines)

This may indicate:
  - target_files was not updated after implementation
  - File was renamed or moved
  - Implementation went to different files than planned

To fix: Update target_files in the spec, or ignore if intentional.
```

## Improvements

1. **Clear headline**: "don't match actual changes" vs "no changes found"
2. **Show both sides**: What was declared AND what actually changed
3. **Benign first**: Lead with "target_files not updated" (common, harmless)
4. **Actionable**: Tell user how to fix it
5. **Less alarming**: Remove scary options like "implementation was lost"

## Acceptance Criteria

- [x] Warning headline changed to indicate mismatch, not missing changes
- [x] Show declared target_files that had no changes
- [x] Show actual files that were changed (with line counts if available)
- [x] Reorder "may indicate" list: benign causes first, serious causes last
- [x] Add "To fix" suggestion
- [x] Unit test for warning message formatting

## Agent Output

2026-01-30T21:46:13Z

```
I'll help you implement this spec to improve the target_files mismatch warning clarity. Let me start by reading the relevant code and planning my approach.
Let me search for the code that generates this warning message.
Good! I found the function that needs to be modified. Let me read more context to understand the full structure.
Let me check the TargetFilesVerification structure to understand what data is available.
Now let me check how this warning is used and look for where we have access to actual file changes:
Now I need to see where the all_file_stats information is available. Let me check what data we have access to when calling format_target_files_warning:
I can see the structure now. The issue is that we need to track not just which files have changes but also show the actual files that were changed (even if they weren't in target_files). Let me look at how we can get that information:
Perfect! I can see that we have `all_file_stats` available, but we're not passing it to the warning function. I need to modify the `TargetFilesVerification` struct to include information about all files that were actually changed, along with their line counts. Let me update my todo list and plan this out:
Now let me plan the approach:

**Plan:**

1. **Modify `TargetFilesVerification` struct** to include a new field `actual_files_changed: Vec<(String, i64)>` that stores all files that were actually changed with their net line additions.

2. **Update `verify_target_files` function** to populate this new field with all files from `all_file_stats` (not just target_files).

3. **Rewrite `format_target_files_warning` function** to:
   - Change headline from "no changes found" to "has target_files that don't match actual changes"
   - Show declared target_files that had no changes
   - Show actual files that were changed with line counts
   - Reorder "may indicate" list with benign causes first
   - Add "To fix" suggestion

4. **Update the existing unit test** to match the new warning format.

5. **Add a new unit test** that specifically tests the case where there's a mismatch (changes exist but not in declared files).
Now let's implement the changes. First, I'll modify the TargetFilesVerification struct:
Now I need to update the verify_target_files function to populate this new field. Let me first read the full function to understand it better:
Now I'll update the verify_target_files function to populate the actual_files_changed field. I need to update all the return statements:
Now let's rewrite the format_target_files_warning function with the improved message:
Now let's read the existing unit test to update it:
Now I need to update the test to include the actual_files_changed field and update the assertion:
Now I need to update the other test that creates a TargetFilesVerification struct:
Now let me add a new unit test for the mismatch case. I'll add it after the existing test:
Now let's run cargo fmt:
Now let's run cargo clippy:
The clippy error indicates that `files_with_changes` and `net_additions` are no longer being used. Let me check if they're actually used anywhere else:
I see - these fields are used in tests but not in the main code anymore. Actually, looking back at the warning format function, I removed the usage but these fields might still be useful to keep for other purposes. Let me check the actual usage more carefully. The issue is that we're populating them but not using them in production code. Let me check if we should keep them or remove them:

Looking at the code, `files_with_changes` and `net_additions` were previously used in the old warning format. In the new format, we're using `actual_files_changed` instead. However, these fields might still be useful metadata, and they're used in tests. 

I think the best approach is to keep using them. Let me check the archive command to see if they're used there:
They're only used for the warning message. Since the fields are still conceptually useful (tracking which target files DID have changes vs which didn't), I think we should keep them. However, since clippy is complaining, I can add `#[allow(dead_code)]` or actually use them. Let me think about whether they should be used in the warning message...

Actually, I think it makes sense to show both:
1. Which declared target_files had NO changes (files_without_changes) - already shown
2. Which declared target_files DID have changes (files_with_changes) - not currently shown but could be useful

Let me update the warning format to show target files that DID have changes too, so these fields are actually used:
Wait, I realize the issue now. The warning is only shown when there ARE files_without_changes (files in target_files that have no changes). So `files_with_changes` might be populated but is only used to compute `net_additions` which is now shown. Let me reconsider this.

Actually, looking at the logic in the archive command:

```rust
if !verification.files_without_changes.is_empty() {
    specs_with_mi

... (output truncated, 11797 chars total)```
