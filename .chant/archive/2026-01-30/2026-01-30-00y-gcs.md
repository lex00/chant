---
type: code
status: completed
depends_on:
- 2026-01-30-00t-48u
target_files:
- src/cmd/spec/lint.rs
commits:
- ee8db2d
completed_at: 2026-01-30T21:25:38Z
model: sonnet
---
# Add unit tests for validate_model_waste: no model set, haiku ok, opus on simple spec, sonnet on simple spec, research excluded, driver excluded, complex spec ok.

## Acceptance Criteria

- [x] Add test for no model set
- [x] Add test for haiku ok
- [x] Add test for opus on simple spec
- [x] Add test for sonnet on simple spec
- [x] Add test for research excluded
- [x] Add test for driver excluded
- [x] Add test for complex spec ok

## Agent Output

2026-01-30T21:25:38Z

```
I'll implement unit tests for `validate_model_waste` following the spec requirements. Let me start by reading the relevant code and planning my approach.
Let me first read the spec file to see the acceptance criteria, then find the validate_model_waste function.
Now I'll plan the test cases based on the `validate_model_waste` function (lines 457-512) and the spec requirements:

**Test cases needed:**
1. **No model set** - should return empty diagnostics
2. **Haiku ok** - haiku model should never trigger warning (not expensive)
3. **Opus on simple spec** - should trigger warning
4. **Sonnet on simple spec** - should trigger warning
5. **Research excluded** - research type with opus/sonnet should not trigger warning
6. **Driver excluded** - driver type with opus/sonnet should not trigger warning
7. **Complex spec ok** - opus/sonnet on complex spec should not trigger warning

Let me implement these tests:
I see the issue. The tests are failing because the specs I'm creating don't meet the "simple" criteria according to the default thresholds. Let me check what the default thresholds are:
I see. The default simple thresholds are: criteria<=1, files<=1, words<=3. The issue is that the `create_test_spec` helper is adding the "Acceptance Criteria" section header text, which adds extra words. Let me check the word count more carefully:

Looking at the `validate_model_waste` function again (lines 481-492), I need to ensure my test specs meet ALL three conditions to be considered "simple":
- criteria_count <= 1
- file_count <= 1  
- word_count <= 3

The problem is that `create_test_spec("2026-01-30-022-ghi", 1, 1, 3)` is creating:
- 3 words of filler text: "word word word "
- Then it adds "\n## Acceptance Criteria\n\n" which adds 2 more words
- Then "- [ ] Criterion 1\n" which adds 2 more words

So the total is actually 7 words, not 3! I need to account for this. Let me fix the tests:
Wait, I also need to fix the other tests that use similar patterns:
Now let me run the tests again:
The tests aren't running. Let me try a different approach:
Still failing. Let me debug by checking what the actual word count is when I create the spec with 1 criterion and 0 body words:
Ah! The spec with 1 criterion and 0 body words still has 8 words total (from the "Acceptance Criteria" section). The default simple threshold is 3 words, so this doesn't qualify as simple. I need to create specs with NO acceptance criteria section to keep the word count at 0:
Now let's run the tests again:
Great! All the model waste tests pass. Now let's run the full test suite:
Perfect! All tests pass. Now let me check off the acceptance criteria and commit the changes:
I see the spec file doesn't have the acceptance criteria section yet. Let me check if there's more content:
The spec file only has 8 lines and no acceptance criteria. I need to add the acceptance criteria based on the spec title. Let me add them:
Perfect! I've successfully completed the spec. Let me verify the implementation one more time by running the specific tests:
Excellent! All tests pass. Let me provide a summary of what was accomplished:

## Summary

I have successfully implemented unit tests for the `validate_model_waste` function in `src/cmd/spec/lint.rs:1520`. The implementation includes 7 comprehensive test cases:

### Test Cases Added

1. **test_validate_model_waste_no_model_set** - Verifies that no diagnostics are returned when no model is explicitly set
2. **test_validate_model_waste_haiku_ok** - Confirms that haiku model never triggers warnings (not considered expensive)
3. **test_validate_model_waste_opus_on_simple_spec** - Tests that opus on a simple spec generates a warning
4. **test_validate_model_waste_sonnet_on_simple_spec** - Tests that sonnet on a simple spec generates a warning
5. **test_validate_model_waste_research_excluded** - Verifies that research specs are excluded from model waste checks
6. **test_validate_model_waste_driver_excluded** - Verifies that driver specs are excluded from model waste checks
7. **test_validate_model_waste_complex_spec_ok** - Confirms that complex specs can use expensive models without warnings

### Key Implementation Details

- All tests use the existing `create_test_spec` helper function for consistency
- Tests correctly account for the default simple thresholds (criteria<=1, files<=1, words<=3)
- Simple specs are created with 0 criteria, 0 files, and 0 words to ensure they qualify as "simple"
- Complex specs exceed the simple thresholds to ensure they're not flagged

### Verification

- All 7 new tests pass
- `cargo fmt` completed successfully
- `cargo clippy` passed with no warnings
- Full test suite (350 tests) passes
- Changes committed with proper message format
- Git status is clean

The implementation is complete and meets all acceptance criteria specified in the spec.```
