---
type: code
status: completed
depends_on:
- 2026-01-30-00h-f77.1
- 2026-01-30-00h-f77.2
- 2026-01-30-00h-f77.4
- 2026-01-30-00h-f77.6
target_files:
- src/cmd/watch.rs
- src/main.rs
commits:
- b239aa2
completed_at: 2026-01-31T15:39:25Z
model: sonnet
---
# Event loop with polling and graceful shutdown

Implement the main watch loop that polls in-progress specs, calls lifecycle operations, and handles SIGINT/SIGTERM for graceful shutdown.

### Inherited Context

- Watch is monitor-only: loop must not spawn agents or create specs
- Only allowed operations: finalize, merge, resume (via lifecycle module)

### Acceptance Criteria

- [x] `run_watch(config, flags)` starts event loop with configurable poll interval
- [x] Each iteration: query in-progress specs, check state, call lifecycle ops
- [x] `--dry-run` flag logs actions without executing
- [x] `--once` flag runs single pass then exits
- [x] SIGINT/SIGTERM handler sets shutdown flag, breaks loop gracefully

### Edge Cases

- No in-progress specs: Log "waiting...", sleep, continue loop
- Poll interval very short (< 1s): Allow but warn in logs
- Multiple specs complete simultaneously: Handle sequentially (finalize each before merging)
- Shutdown signal during subprocess (finalize/merge): Let subprocess finish, then exit

### Example Test Cases

- Start with 3 specs, 1 completes → finalize/merge, continue watching 2
- Start with 0 specs → log waiting, sleep, loop
- `--once` with 0 specs → log waiting, exit immediately
- `--dry-run` with completed spec → log "would finalize X", no actual subprocess call

---

## Agent Output

2026-01-31T15:39:25Z

```
I'll implement the event loop with polling and graceful shutdown for watch mode.
## Summary

Implemented watch command event loop in src/cmd/watch.rs and src/main.rs:

- `run_watch(once, dry_run, poll_interval)` - Main event loop with configurable polling
- Queries in-progress specs each iteration, checks for completion/failure
- Calls `handle_completed()` and `handle_failed()` from lifecycle module
- `--dry-run` logs actions without executing subprocess calls
- `--once` runs single iteration then exits
- SIGINT/SIGTERM handler with ctrlc crate for graceful shutdown
- WatchLogger for timestamped output to stdout and `.chant/logs/watch.log`

All acceptance criteria met, tests passing, changes committed.```
