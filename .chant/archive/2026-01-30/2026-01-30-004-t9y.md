---
type: code
status: completed
commits:
- cb05c3e
completed_at: 2026-01-30T08:43:36Z
model: opus
---
# Add worktree environment variables (CHANT_WORKTREE, CHANT_WORKTREE_PATH, CHANT_BRANCH) when invoking agents in worktree mode

## Problem

When agents run in worktree mode (during parallel execution), they need to be aware of their execution context. Currently, agents only have access to `CHANT_SPEC_ID` and `CHANT_SPEC_FILE`, but don't know if they're running in a worktree or what branch they're on.

## Solution

Add three new environment variables when invoking agents in worktree mode:
- `CHANT_WORKTREE=1` - Set to "1" when running in a worktree
- `CHANT_WORKTREE_PATH=<path>` - The absolute path to the worktree
- `CHANT_BRANCH=<branch_name>` - The name of the git branch

## Acceptance Criteria

- [x] `CHANT_WORKTREE` environment variable set to "1" when agent runs in worktree mode
- [x] `CHANT_WORKTREE_PATH` environment variable set to worktree path when agent runs in worktree mode
- [x] `CHANT_BRANCH` environment variable set to branch name when agent runs in worktree mode
- [x] Environment variables only set when actually in worktree mode (not in normal execution)
- [x] Build passes (`cargo build`)
- [x] Tests pass (`just test`)
- [x] Code formatted (`cargo fmt`)
- [x] Clippy passes (`cargo clippy`)

## Agent Output

2026-01-30T08:43:36Z

```
I'll start by reading the spec file to understand what needs to be implemented.
The spec file is minimal. Let me search for more context on how agents are invoked and where worktree handling occurs.
Let me look at the key files: `src/worktree.rs`, `src/cmd/work.rs`, and `src/agent.rs`.
Let me read the work.rs file in chunks and search for where agents are invoked.
Let me read the provider.rs file which seems to be where the Command invocation happens.
Now I see that the `ClaudeCliProvider::invoke` method at line 98 spawns the Claude CLI. The environment variables need to be set on the `Command` when the provider is invoked from a worktree context.

Let me now look at the cmd/work.rs file to understand how the provider is called and where the worktree context is available.
Now I need to understand where worktree execution happens and how the context flows. Let me search for where worktrees are created and agents invoked in worktree mode.
Let me read the full output to understand parallel/worktree execution.
Now I have a clear picture. The key function is around line 1870 in `work.rs` where `invoke_agent_with_command` is called with the `worktree_path`. Let me look at that specific area.
Now I understand the architecture. The `invoke_agent_with_command` function in `src/cmd/agent.rs` is called with the `worktree_path` passed to `cwd`. The environment variables need to be set on the Command object there.

Let me update my todo list and make the changes:
Now I need to understand the signature change required for passing branch information. Looking at the code:

1. `invoke_agent_with_command` is called at line 1870 with `worktree_path_clone.as_deref()` 
2. The branch name is available in `branch_for_cleanup_clone`

I need to:
1. Modify `invoke_agent_with_command` to accept a branch name parameter
2. Set environment variables: `CHANT_WORKTREE=1`, `CHANT_WORKTREE_PATH=<path>`, `CHANT_BRANCH=<branch_name>`

Let me also check if there's an existing pattern for adding branch info:
Now I have all the context I need. I'll modify `invoke_agent_with_command` in `src/cmd/agent.rs` to:
1. Accept a branch name parameter
2. Set `CHANT_WORKTREE=1` when in worktree mode
3. Set `CHANT_WORKTREE_PATH=<path>` with the worktree path
4. Set `CHANT_BRANCH=<branch_name>` with the branch name

Let me make these changes:
Now I need to update the call site in `work.rs` to pass the branch name. Let me find the exact call:
Now let me run cargo build to check if there are any compilation errors:
I need to fix the `invoke_agent_with_prefix` function that calls `invoke_agent_with_command`. Let me look at it:
I need to update `invoke_agent_with_prefix` to also accept and pass the branch_name parameter:
The build succeeds. Now let me run `cargo fmt` and `cargo clippy`:
Both `cargo fmt` and `cargo clippy` pass. Now let me run the tests:
All tests pass. Now let me read the spec file again to understand the acceptance criteria and update it:
The spec file doesn't have acceptance criteria defined. Let me add appropriate acceptance criteria and then check them off:
Now let me commit the changes:
Let me add the files and commit:
The commit is complete. Git status shows clean for the files I modified - the other modified files are unrelated to this spec.
## Summary

I've successfully implemented the spec to add worktree environment variables when invoking agents in worktree mode. The changes made:

### Files Modified

1. **`src/cmd/agent.rs`**:
   - Added `branch_name: Option<&str>` parameter to `invoke_agent_with_prefix` and `invoke_agent_with_command` functions
   - When a working directory (`cwd`) is provided (indicating worktree mode), set:
     - `CHANT_WORKTREE=1`
     - `CHANT_WORKTREE_PATH=<path>`
     - `CHANT_BRANCH=<branch_name>` (if branch name is available)

2. **`src/cmd/work.rs`**:
   - Updated the call to `invoke_agent_with_command` in the parallel execution path to pass the branch name

3. **`.chant/specs/2026-01-30-004-t9y.md`**:
   - Added problem description, solution, and acceptance criteria
   - All acceptance criteria checked off

### Environment Variables Added

| Variable | Value | Description |
|----------|-------|-------------|
| `CHANT_WORKTREE` | `"1"` | Indicates agent is running in worktree mode |
| `CHANT_WORKTREE_PATH` | path | Absolute path to the worktree |
| `CHANT_BRANCH` | branch name | Git branch name (e.g., `chant/2026-01-30-004-t9y`) |

These variables are only set when the agent is invoked with a working directory parameter, which occurs during parallel execution in worktrees.```
