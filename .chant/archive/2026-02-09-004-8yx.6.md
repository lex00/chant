---
type: code
status: completed
depends_on:
- 2026-02-09-004-8yx.3
- 2026-02-09-004-8yx.4
target_files:
- src/cmd/work/chain.rs
- src/spec_group.rs
branch: chant/2026-02-09-004-8yx.6
commits:
- a7c8ce0
completed_at: 2026-02-10T20:53:09Z
model: sonnet
---
# Auto-topological ordering of groups in chain mode

Chain should topologically sort groups by driver `depends_on` instead of relying on ID order alone.

Modify chain execution in `src/cmd/work/chain.rs`:
- At startup, load all specs and build a DAG of groups from driver `depends_on` fields
- Topologically sort the groups (use Kahn's algorithm or DFS-based topo sort)
- Execute groups in topological order
- When multiple groups are ready (no unmet deps), fall back to spec ID order as tiebreaker (IDs are date-based so this gives chronological ordering)
- Detect cycles in driver `depends_on` and bail with a clear error listing the cycle
- Standalone specs slot into the order based on their own `depends_on`

## Acceptance Criteria
- [x] Chain executes groups in topological order based on driver `depends_on`
- [x] Standalone specs execute in correct dependency order between groups
- [x] When multiple groups are ready, ID order is used as tiebreaker
- [x] Circular dependencies in driver `depends_on` produce a clear error message
- [x] Existing tests pass (`cargo test`)
- [x] `cargo clippy -- -D warnings` passes

## Agent Output

2026-02-10T20:53:09Z

```
I'll implement auto-topological ordering of groups in chain mode. Let me start by reading the relevant code.
Now I'll implement topological ordering for groups. I need to:
1. Build a dependency graph from driver specs' `depends_on` fields
2. Topologically sort the groups 
3. Detect cycles
4. Use the sorted order in chain execution with ID order as tiebreaker
Now I need to modify `find_next_ready_spec` to use the topologically sorted group order:
Now I need to update `cmd_work_chain` to compute the topological order at startup and pass it to `find_next_ready_spec`:
Now let me run the tests and clippy to ensure everything works:
Excellent! All tests pass. Now let me update the spec file to check off the acceptance criteria:
Now let me commit the changes:
## Summary

Modified `src/cmd/work/chain.rs` to implement topological ordering of groups in chain mode.

- Added `topological_sort_groups()` using Kahn's algorithm to build dependency graph from driver `depends_on` fields
- Modified `find_next_ready_spec()` to accept group order and use it for sorting ready specs
- Group order computed at chain startup in `cmd_work_chain()`
- Cycle detection produces clear error message listing the problematic specs
- ID order used as tiebreaker when multiple groups have no unmet dependencies
- Standalone specs interleave correctly based on their own dependencies```
