---
type: code
status: completed
depends_on:
- 2026-02-03-02p-ydf.1
- 2026-02-03-02p-ydf.2
target_files:
- src/cmd/watch.rs
commits:
- 9f32247
completed_at: 2026-02-03T23:40:01Z
model: sonnet
---
# Implement startup recovery for crashed agents

Add recovery logic to watch startup: detect stale worktrees, orphaned branches, and unfinished merges.

### Inherited Context

- System must recover from any crash (agent or watch)
- Stale state should not block new work
- Prefer cleanup over leaving inconsistent state

### Acceptance Criteria

- [x] On startup, scan for worktrees with status files
- [x] Status "done" but branch not merged: Queue for merge
- [x] Status "working" with timestamp >1 hour old: Mark spec failed, cleanup
- [x] Orphaned worktrees (no status file, >1 day old): Cleanup
- [x] Integration test simulating crash + restart verifies recovery

### Edge Cases

- Watch crashed during merge: Detect partial merge, retry or rollback
- Agent wrote "done" but watch never started: Startup recovery completes the work
- Multiple crashes: Should converge to clean state after recovery

### Example Test Cases

- Create worktree with "done" status, restart watch, verify merge completes
- Create worktree with stale "working" status, restart watch, verify spec marked failed
- Create old worktree with no status file, verify cleaned up

---

## Agent Output

2026-02-03T23:40:01Z

```
I'll implement startup recovery for crashed agents in the chant watch system.
Now I understand the codebase structure. I need to add recovery logic to the watch startup that detects stale worktrees, orphaned branches, and unfinished merges. Let me check for timestamp utilities:
Now I'll implement the recovery logic. I need to:
1. Add a recovery function that runs on watch startup
2. Scan for worktrees with status files
3. Handle different recovery scenarios
4. Add tests for crash recovery
Now let me create an integration test for the recovery functionality:
Now let me format the code and run tests:
I see there are some test-related lint errors. Let me check the common module structure:
Now let me update my test to use the correct function signature:
Let me update the remaining test functions similarly:
Now run clippy again:
Good! Now let's run the tests for the watch recovery:
Let me check how integration tests are set up:
I need to create a test runner file. Let me check the structure of one:
Now build and run the tests:
The tests are filtered out. Let me run without the filter:
The tests are failing. Let me check the issue with the worktree creation:
Now let me also check if the chant binary exists and add the necessary test setup:
The tests need to init chant first. Let me fix this:
Now rebuild and run the tests:
One test is still failing. Let me check what's happening with it:
The issue is we're trying to create a branch that already exists. Let me fix this:
Excellent! All tests are passing. Now let's update the spec to check off the acceptance criteria:
Now let's commit the changes:
Good, everything is committed. Let me verify the build and run a final test:
Perfect! All tests pass. Let me verify the implementation one more time:
## Summary

Implemented startup recovery for crashed agents in the watch system.

Changed src/cmd/watch.rs to add `run_startup_recovery()` function that runs on watch startup and handles three recovery scenarios:

- **Done status worktrees**: Detects worktrees with "done" status files that haven't been merged yet, calls `handle_completed()` to finalize and merge them
- **Stale working worktrees**: Identifies worktrees with "working" status older than 1 hour, marks the spec as failed and cleans up the worktree
- **Orphaned worktrees**: Finds worktrees without status files that are older than 24 hours and removes them

Created comprehensive integration tests in tests/integration/watch_recovery_test.rs covering all recovery scenarios including edge cases.```
