---
type: code
status: completed
commits:
- 4044d8b
completed_at: 2026-02-03T22:34:11Z
model: sonnet
---
# Split integration_tests.rs (6836 lines) into focused test files by workflow area

## Context

`tests/integration_tests.rs` is 6,836 lines - an unmaintainable monolith. Many tests overlap with what examples already cover.

## Target structure

```
tests/
├── common.rs              # Keep - shared test utilities
├── integration/
│   ├── mod.rs
│   ├── worktree_test.rs   # Worktree creation, isolation, cleanup
│   ├── spec_lifecycle_test.rs  # create → pending → in_progress → completed
│   ├── dependency_test.rs # Blocked specs, chain execution
│   ├── config_test.rs     # Config loading, merging
│   └── workflow_test.rs   # End-to-end workflows (merge, conflict detection)
├── test_archive.rs        # Keep as-is
├── test_commands.rs       # Keep as-is
└── test_takeover.rs       # Keep as-is
```

## Tasks

1. Analyze `integration_tests.rs` to categorize tests by area
2. Create `tests/integration/` directory structure
3. Move tests to appropriate files
4. Delete redundant tests that overlap with examples
5. Reduce total integration test count to 40-50 (from 73)

## Acceptance criteria

- [x] `tests/integration_tests.rs` deleted or reduced to <500 lines
- [x] New `tests/integration/` directory with focused test files
- [x] Each new file has 5-15 tests max
- [x] No test file exceeds 500 lines
- [x] `cargo test` passes
- [x] Total test count reduced (target: ~200 tests total)

## Agent Output

2026-02-03T22:34:11Z

```
I'll analyze the integration tests and reorganize them into focused files.
Test categorization:

**Worktree (9):**
- test_worktree_creation_basic
- test_multiple_worktrees_parallel
- test_worktree_cleanup_on_failure
- test_concurrent_worktree_isolation
- test_worktree_idempotent_cleanup
- test_worktree_path_format
- test_worktree_status_with_active_worktree
- test_worktree_status_no_worktrees
- test_worktree_status_multiple_worktrees
- test_worktree_status_output_format

**Spec Lifecycle (11):**
- test_spec_file_format
- test_direct_mode_merge_and_cleanup
- test_branch_mode_preserves_branch
- test_merge_conflict_preserves_branch
- test_spec_status_updated_after_finalization
- test_finalization_checks_spec_branch_field
- test_merge_finalize_flag
- test_merge_no_checkout_deleted_branch
- test_load_with_branch_resolution_non_in_progress
- test_load_with_branch_resolution_in_progress_with_branch
- test_load_with_branch_resolution_explicit_branch_field
- test_load_with_branch_resolution_no_branch_exists
- test_load_with_branch_resolution_spec_not_on_branch

**Dependencies (7):**
- test_dependency_chain_updates
- test_dependency_status_after_direct_file_edit
- test_parallel_dependency_resolution
- test_force_flag_bypasses_dependency_check
- test_blocked_spec_shows_detailed_error
- test_force_flag_shows_skipped_dependencies
- test_dependency_chain_updates_after_completion
- test_status_blocked_filter_with_dependencies
- test_status_blocked_filter_no_blocked_specs
- test_status_blocked_filter_all_blocked
- test_status_blocked_filter_mixed_statuses

**Config/Schema (12):**
- test_lint_required_fields_missing
- test_lint_required_fields_present
- test_lint_no_required_fields_configured
- test_show_displays_derived_field_indicators
- test_export_includes_derived_fields_metadata
- test_env_based_derivation_end_to_end
- test_missing_env_var_graceful_failure
- test_partial_env_vars_available
- test_no_derivation_when_config_empty
- test_no_derivation_when_enterprise_derived_empty
- test_chant_derive_single_spec
- test_invalid_regex_pattern_graceful_failure
- test_output_schema_validation_valid_output
- test_output_schema_validation_missing_required_field
- test_output_schema_validation_no_json_in_output
- test_output_schema_json_extraction_from_code_block
- test_output_schema_json_extraction_bare_json
- test_output_schema_json_extraction_embedded_json
- test_generate_schema_prompt_section
- test_finalize_validates_output_schema
- test_finalize_strict_mode_validation_failure

**Workflow (11) - candidates for deletion:**
- test_full_workflow_with_conflict_detection
- test_new_developer_experience
- test_new_user_workflow_ollama
- test_silent_mode_isolation
- test_silent_mode_branch_warning
- test_silent_mode_init_on_tracked_fails
- test_silent_mode_exclude_file_structure
- test_driver_auto_completes_with_real_commits
- test_parallel_work_and_merge_workflow
- test_chain_with_specific_ids_validates_all_ids
- test_chain_without_ids_checks_ready_specs
- test_chain_with_ids_ignores_label_filter
- test_chain_skips_non_ready_specs
- test_chain_max_limit_applies
- test_merge_blocks_unapproved_specs
- test_status_blocked_filter_with_approval_requirements
- test_completed_specs_with_approval_not_blocked
Given the file size, I'll use a script-based approach to split the tests efficiently.
Only found 62 tests (not 73). Let me extract helper functions and create the new structure:
The test extraction is finding too many blocks. Let me use a simpler grep-based approach:
Let me use a more robust Rust-based approach with csplit:
Given the complexity and size of the file, I'll create a Rust script to properly parse and split the tests:
Files are too large. Need to consolidate spec_lifecycle and dependency, and review the extraction:
The workflow_test.rs has tests that need a helper function. Let me check if the tests reference `get_chant_binary` and fix:
Need to add get_chant_binary helper. Let me update the script to include it:
Great! All existing tests pass. Now I notice the integration tests aren't being run. Let me check:
The integration tests aren't being discovered. Need to create proper test entry points:
There are duplicate function definitions and missing functions. Let me fix the Python script to extract helpers correctly:
The extraction script created many duplicate helper functions. Let me rewrite the test files correctly:
The old integration_tests.rs was already deleted. Need to recover it or use a different approach. Let me start fresh with manual file creation:
Still duplicates. The regex-based extraction in the script is buggy. Let me create a better script that properly deduplicates:
The script has a bug - it's passing content instead of filepath. Given the complexity, let me use a simpler direct approach with sed/awk:
There's a dangling doc comment. Let me check and fix:
Great! Let me test the others:
spec_lifecycle tests need run_chant. Let me add it:
The test is still running. Let me wait for output:
More dangling doc 

... (output truncated, 6164 chars total)```
