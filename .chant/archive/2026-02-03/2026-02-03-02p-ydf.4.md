---
type: code
status: completed
depends_on:
- 2026-02-03-02p-ydf.2
target_files:
- src/cmd/work/single.rs
- src/cmd/work/parallel.rs
- src/cmd/work/chain.rs
- src/cmd/watch.rs
commits:
- 18aa09c
completed_at: 2026-02-03T23:33:57Z
model: sonnet
---
# Implement watch auto-start from work commands

Ensure `chant work` commands automatically start watch if not running, and watch exits gracefully when idle.

### Inherited Context

- Watch must run for lifecycle coordination to work
- Users should not manually manage watch (fire-and-forget)
- Watch should cleanup when no work remains

### Acceptance Criteria

- [x] Watch writes PID to `.chant/watch.pid` on startup
- [x] Watch removes PID file on graceful exit
- [x] `is_watch_running()` checks: PID file exists AND process alive AND is chant
- [x] Stale PID file (process dead or wrong process) gets deleted automatically
- [x] `chant work` spawns watch in background if not running
- [x] Watch exits after N minutes idle (configurable, default 5min)
- [x] `--no-watch` flag disables auto-start for testing

### Implementation

```rust
// .chant/watch.pid contains just the PID number

fn is_watch_running() -> bool {
    let pid = match read_pid(".chant/watch.pid") {
        Ok(p) => p,
        Err(_) => return false,  // No file = not running
    };

    // Verify process exists AND is chant watch
    if process_alive(pid) && is_chant_watch(pid) {
        return true;
    }

    // Stale PID - clean up and report not running
    let _ = fs::remove_file(".chant/watch.pid");
    false
}
```

### Edge Cases

- Watch crashes: PID file stale, next `chant work` detects dead process, restarts
- PID reused by OS: `is_chant_watch(pid)` checks cmdline, detects wrong process
- Multiple `chant work` concurrent: All call `is_watch_running()`, only first spawns
- Graceful shutdown: Watch deletes PID file before exit

### Example Test Cases

- Run `chant work`, verify watch process starts
- Run `chant work` twice quickly, verify only one watch instance
- Run `chant work --no-watch`, verify watch not started

---

## Agent Output

2026-02-03T23:33:58Z

```
I'll implement the watch auto-start functionality according to the spec.
Now I need to implement the auto-start logic in the work commands. Let me add a helper function to start watch if not running and add the --no-watch flag to the work commands.
Now I need to expose `is_watch_running` as public and add calls to `ensure_watch_running` in the work commands. Let me also add the --no-watch flag.
Now I need to find where the work command CLI arguments are defined and add the --no-watch flag.
Now I need to update the work command functions to accept the no_watch parameter and call ensure_watch_running.
Now let me fix a bug in the `is_process_alive` function - on Unix systems, `Signal::SIGKILL` shouldn't be used for checking if a process exists. Let me correct this:
Now let me check the Cargo.toml to see if nix is already a dependency:
I need to add the nix dependency for Unix platforms. Let me update Cargo.toml:
Now let me run cargo fmt and cargo clippy to ensure the code is properly formatted:
These are test-related warnings. Let me check if the main build compiles:
I need to fix these compilation errors. Let me add the missing import and fix the function call:
Great! Now let me update the spec to check off the acceptance criteria:
Now let me commit my changes:
Perfect! All changes have been committed. Let me create a summary of what was implemented:

## Summary

Implemented watch auto-start functionality from work commands to enable fire-and-forget lifecycle coordination.

**Key Changes:**

- **PID Management** (src/cmd/watch.rs):
  - Watch writes PID to `.chant/watch.pid` on startup
  - PID file removed on graceful exit (SIGINT, --once, idle timeout)
  - Helper functions: `read_watch_pid()`, `write_watch_pid()`, `remove_watch_pid()`

- **Process Detection** (src/cmd/watch.rs):
  - `is_watch_running()` checks PID file existence, process alive, and validates it's chant watch
  - `is_process_alive()` uses nix::signal::kill on Unix, tasklist on Windows
  - `is_chant_watch_process()` checks cmdline to prevent PID reuse issues
  - Stale PID files automatically cleaned up

- **Auto-Start** (src/cmd/work/mod.rs):
  - `ensure_watch_running()` spawns watch if not detected
  - Called from `cmd_work()` unless `--no-watch` flag set
  - Watch spawned as detached background process with stdio redirected to null

- **Idle Timeout** (src/cmd/watch.rs, src/config/defaults.rs):
  - Watch tracks last activity timestamp
  - Exits after `idle_timeout_minutes` (default 5) when no work detected
  - Activity timer reset when in-progress specs or worktrees found
  - Configurable via `WatchConfig.idle_timeout_minutes`

- **CLI Integration** (src/main.rs):
  - Added `--no-watch` flag to Work command for testing
  - Updated all call sites to pass no_watch parameter

- **Dependencies** (Cargo.toml):
  - Added `nix = { version = "0.29", features = ["signal"] }` for Unix platforms```
