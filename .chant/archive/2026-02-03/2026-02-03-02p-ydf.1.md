---
type: code
status: completed
depends_on: []
target_files:
- src/worktree/status.rs
- src/worktree/mod.rs
commits:
- 768d6c9
completed_at: 2026-02-03T23:19:27Z
model: sonnet
---
# Implement agent status file format

Create the foundational data structure and I/O layer for agent-to-watch communication via `.chant-status.json`.

### Inherited Context

- Agents are stateless workers; watch owns all state transitions
- Status file is the single communication channel from agent to watch
- Must be atomic to prevent race conditions

### Acceptance Criteria

- [x] `src/worktree/status.rs` with `AgentStatus` struct matching spec schema
- [x] `write_status()` function with atomic write (temp + rename)
- [x] `read_status()` function with error handling for missing/corrupt files
- [x] Unit tests for serialization round-trip
- [x] Unit test verifying atomic write behavior

### Edge Cases

- Corrupt JSON: `read_status()` should return `Result::Err` with clear error
- Missing file: Should return distinct error (not a parse error)
- Concurrent writes: Atomic rename ensures last write wins without corruption

### Example Test Cases

- Serialize `AgentStatus{status: "done", commits: ["abc"]}`, deserialize, verify fields match
- Write status file, verify temp file cleaned up, verify final file exists
- Attempt to read non-existent file, verify error type


- `AgentStatus` struct with fields: `spec_id`, `status` (enum: Working/Done/Failed), `updated_at`, `error`, `commits`
- `write_status(path: &Path, status: &AgentStatus) -> Result<()>` - Atomic write
- `read_status(path: &Path) -> Result<AgentStatus>` - Read and parse

---

## Agent Output

2026-02-03T23:19:27Z

```
I'll implement the agent status file format according to the spec.
## Summary

Created `src/worktree/status.rs` with agent status file format for worktree communication.

- AgentStatus struct with spec_id, status enum (Working/Done/Failed), updated_at, error, commits fields
- write_status() with atomic write using temp file + rename pattern
- read_status() with distinct error handling for missing files vs corrupt JSON
- 6 unit tests covering serialization round-trip, atomic write behavior, error cases, and multiple commits

Reorganized worktree module by moving `src/worktree.rs` to `src/worktree/git_ops.rs` and creating `src/worktree/mod.rs` for submodule organization.```
