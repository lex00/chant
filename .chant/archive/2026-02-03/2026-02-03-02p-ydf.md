---
type: group
status: completed
depends_on:
- 2026-02-03-02p-ydf.1
- 2026-02-03-02p-ydf.2
- 2026-02-03-02p-ydf.3
- 2026-02-03-02p-ydf.4
- 2026-02-03-02p-ydf.5
- 2026-02-03-02p-ydf.6
labels:
- watch
- worktree
- architecture
completed_at: 2026-02-03T23:42:29Z
---
# Extend chant watch as unified lifecycle coordinator

## Problem

Current execution model has race conditions and no recovery:

1. **Agents write directly to main** - spec file races in parallel execution
2. **No crash recovery** - agent dies → spec stuck in_progress forever
3. **Inconsistent lifecycle** - single/parallel/chain each handle finalize differently
4. **Orphaned resources** - stale worktrees and branches accumulate

## Solution

Extend `chant watch` to be the **single lifecycle coordinator** for ALL work execution:

```
ANY work (single, parallel, chain)
    ↓
chant work spawns agent(s) + ensures watch is running
    ↓
Agent works in worktree, writes .chant-status.json, exits
    ↓
Watch handles ALL lifecycle:
  - Update spec status on main
  - Merge branch to main
  - Finalize spec
  - Cleanup worktree + branch
  - Handle failures + retries
```

**Key principle:** Agents are stateless workers. Watch owns all state transitions.

## Architecture

```
Agent (worktree)                    Watch (main)
────────────────                    ────────────
create worktree + branch
write status: "working"       →     see working → update spec: InProgress
do work, commit to branch
write status: "done"          →     see done → merge → finalize → cleanup
  (or "failed" on error)            (or handle failure)
exit
```

## Tasks

### Task 1: Agent status file format

**File**: `.chant-status.json` in worktree root

```json
{
  "spec_id": "2026-02-03-02p-ydf",
  "status": "working" | "done" | "failed",
  "updated_at": "2026-02-03T14:30:00Z",
  "error": null,
  "commits": ["abc123"]
}
```

**Acceptance criteria**:
- [ ] `src/worktree/status.rs` with `AgentStatus` struct
- [ ] Atomic write (temp file + rename)
- [ ] Unit tests for round-trip and atomic write

### Task 2: Extend watch to monitor worktrees

Add worktree status file monitoring to existing `chant watch`.

**File**: `src/cmd/watch.rs`

**New behavior**:
- Scan for active worktrees (chant/* branches with worktrees)
- Check `.chant-status.json` in each worktree
- Process status transitions

**Acceptance criteria**:
- [ ] `find_active_worktrees()` returns worktree paths for in_progress specs
- [ ] `check_worktree_status(path)` reads and returns AgentStatus
- [ ] Watch loop includes worktree status checks
- [ ] Status "done" triggers merge + finalize + cleanup
- [ ] Status "failed" triggers failure handling
- [ ] Unit tests for worktree discovery and status parsing

### Task 3: Remove lifecycle code from agents

Agents should ONLY: work + write status file + exit.

**Files**:
- `src/cmd/work/single.rs`
- `src/cmd/work/parallel.rs`
- `src/cmd/work/chain.rs`
- `src/cmd/agent.rs`

**Remove from agents**:
- `spec.save()` calls (status updates)
- `finalize_spec()` calls
- Direct merge operations

**Add to agents**:
- Write `AgentStatus{status: "working"}` on start
- Write `AgentStatus{status: "done", commits}` on success
- Write `AgentStatus{status: "failed", error}` on failure

**Acceptance criteria**:
- [ ] No `spec.save()` in agent code paths
- [ ] No `finalize_spec()` in agent code paths
- [ ] Agent writes status file at start/end
- [ ] Integration test: agent completes, spec unchanged until watch processes

### Task 4: Auto-start watch from work commands

`chant work` should ensure watch is running.

**Acceptance criteria**:
- [ ] `chant work` checks if watch is running (lockfile or process check)
- [ ] If not running, starts watch in background
- [ ] Watch exits gracefully when no work remains for configurable duration
- [ ] `--no-watch` flag to disable auto-start (for testing)

### Task 5: Startup recovery

On startup, watch should recover from previous crashes.

**Acceptance criteria**:
- [ ] Scan for existing worktrees with `.chant-status.json`
- [ ] "done" status but not merged → queue for merge
- [ ] "working" status but stale (>1 hour) → mark failed
- [ ] Cleanup orphaned worktrees (no status file, old)
- [ ] Integration test: simulate crash, restart, verify recovery

### Task 6: MCP integration (optional)

Expose watch status via MCP for visibility.

**Acceptance criteria**:
- [ ] `chant_watch_status` tool shows active worktrees and their status
- [ ] `chant_watch_start` / `chant_watch_stop` for manual control

## Migration

1. Implement status file writing in agents (backward compatible)
2. Extend watch to process status files
3. Remove lifecycle code from agents (watch handles it)
4. Auto-start watch from work commands

External API unchanged: `chant work`, `chant work --parallel`, `chant work --chain`

## Testing

1. **Unit**: Status file read/write, worktree discovery
2. **Integration**: Single spec through watch lifecycle
3. **Parallel**: Multiple agents, watch handles all merges
4. **Recovery**: Kill agent mid-work, kill watch mid-merge, verify recovery