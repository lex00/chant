---
type: code
status: completed
commits:
- 98d8665
completed_at: 2026-02-03T16:14:29Z
model: sonnet
---
# Fix Docker build: pass GIT_SHA and BUILD_DATE as build args to resolve compile-time env var errors

## Problem

Docker build fails with:
```
error: environment variable `GIT_SHA` not defined at compile time
error: environment variable `BUILD_DATE` not defined at compile time
```

The Dockerfile doesn't have `git` installed and doesn't copy `.git`, so `build.rs` can't determine the git SHA.

## Solution

1. **Update `Dockerfile`**: Add build args for GIT_SHA and BUILD_DATE, set them as env vars before cargo build
   ```dockerfile
   ARG GIT_SHA=unknown
   ARG BUILD_DATE=unknown
   ENV GIT_SHA=$GIT_SHA
   ENV BUILD_DATE=$BUILD_DATE
   ```

2. **Update `.github/workflows/docker.yml`**: Pass the build args from GitHub context
   ```yaml
   build-args: |
     GIT_SHA=${{ github.sha }}
     BUILD_DATE=${{ github.event.head_commit.timestamp }}
   ```

3. **Update `build.rs`**: Check for env vars first before running git commands
   - Use `std::env::var("GIT_SHA")` as primary source
   - Fall back to git command if env var not set

## Files to modify

- `Dockerfile`
- `.github/workflows/docker.yml`
- `build.rs`

## Acceptance criteria

- [x] Docker build passes in CI
- [x] `chant --version` shows correct git SHA when built via Docker
- [x] Local `cargo build` still works (uses git command fallback)

## Agent Output

2026-02-03T16:14:29Z

```
I'll fix the Docker build by adding GIT_SHA and BUILD_DATE as build args.
## Summary

Fixed Docker build by adding GIT_SHA and BUILD_DATE as build args.

- Modified `build.rs` to check env vars before falling back to git/date commands
- Added ARG/ENV declarations to `Dockerfile` for GIT_SHA and BUILD_DATE  
- Updated `.github/workflows/docker.yml` to pass github.sha and head_commit.timestamp as build args

All acceptance criteria met. Local builds use git command fallback, Docker builds receive values from CI.```
