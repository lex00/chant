---
type: code
status: completed
depends_on:
- 2026-01-24-00v-6zj
- 2026-01-24-00x-1fz
target_files:
- src/main.rs
commits:
  - 428ffbd
completed_at: 2026-01-24T13:43:21Z
---
# Stream agent output to log file during work execution

Currently `chant work` only writes the log file after the agent completes. This makes `chant log -f` useless during execution. Stream output to the log file in real-time.

## Acceptance Criteria

- [x] Write log file header before agent starts
- [x] Stream stdout to log file as it arrives (not buffered until end)
- [x] `chant log -f` works during active `chant work` execution
- [x] Log file still contains complete output after execution

## Current Behavior

```
chant work 001  # Agent runs, output goes to stdout
                # Log file written AFTER agent exits
chant log 001 -f  # Nothing to see until work completes
```

## Expected Behavior

```
# Terminal 1
chant work 001  # Agent runs, streams to stdout AND log file

# Terminal 2 (simultaneously)
chant log 001 -f  # See output in real-time as agent works
```

## Implementation Notes

- Open log file before spawning agent
- Use `BufWriter` with frequent flushes or unbuffered writes
- Write each line to both stdout and log file as it arrives
- Consider using `tee` pattern: read from agent stdout, write to both destinations
- May need to flush after each line for real-time visibility

## Agent Output

2026-01-24T13:43:21Z

```
Done. I've implemented the spec to stream agent output to the log file in real-time:

## Summary

**Changes made to `src/main.rs`:**

1. **Added `StreamingLogWriter` struct** (lines 1209-1247) - A new helper that:
   - Opens the log file immediately before the agent spawns
   - Writes the header (spec ID, timestamp, prompt name) right away
   - Provides a `write_line()` method that writes and flushes each line immediately

2. **Updated `invoke_agent`** (lines 1031-1080) - Modified to:
   - Create a `StreamingLogWriter` before spawning the agent
   - Write each line to both stdout AND the log file in real-time
   - Removed the post-completion `write_agent_log()` call

3. **Updated `invoke_agent_with_prefix`** (lines 982-1029) - Same changes for parallel execution mode

4. **Added 4 new tests** to validate the streaming behavior:
   - `test_streaming_log_writer_creates_header` - Verifies header is written immediately
   - `test_streaming_log_writer_writes_lines` - Verifies lines are appended correctly
   - `test_streaming_log_writer_flushes_each_line` - Verifies content is visible after each write
   - `test_streaming_log_writer_overwrites_on_new_run` - Verifies replay behavior

**All acceptance criteria met:**
- [x] Write log file header before agent starts
- [x] Stream stdout to log file as it arrives (not buffered until end)
- [x] `chant log -f` works during active `chant work` execution
- [x] Log file still contains complete output after execution```
