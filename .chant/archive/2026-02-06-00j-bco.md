---
type: code
status: completed
depends_on:
- 2026-02-06-00i-la0
commits:
- '052e205'
completed_at: 2026-02-06T23:31:11Z
model: sonnet
---
# Fix commit detection branch context in src/cmd/work/single.rs. Per research 00a-0dn: lines 670-673 use get_commits_for_spec() which searches current branch (main), but agent commits are on the worktree branch (chant/SPEC_ID) and haven't been merged yet. Fix: use get_commits_for_spec_with_branch() and pass spec.frontmatter.branch to search the worktree branch. Use SpecStateMachine for the in_progress→completed transition.

## Agent Output

2026-02-06T23:31:11Z

```
I'll fix the commit detection to search the correct branch and use SpecStateMachine for the state transition.
The code already uses `get_commits_for_spec_with_branch()` and passes `spec_branch` (lines 672-676). The issue is that the status transition to completed happens in `finalize_spec()` (line 824), not using SpecStateMachine. I need to check if `finalize_spec()` uses SpecStateMachine or if we need to update it.
I see. Line 83 in finalize.rs directly sets `spec.frontmatter.status = SpecStatus::Completed` without using SpecStateMachine. According to the spec, I need to replace this direct assignment with SpecStateMachine. Let me check the spec file to confirm the requirements.
Reading the spec more carefully: the issue reported is about lines 670-673 in single.rs, but when I read those lines (660-690), I see the code already uses `get_commits_for_spec_with_branch()` (line 676). However, looking at the broader context, the old code on line 674 calls `get_commits_for_spec_allow_no_commits()` which doesn't take a branch parameter. The fix appears to already be partially implemented, but I need to verify the issue. Let me re-read the critical section.
Let me search for the research reference mentioned in the spec:
Now I understand! The research spec 00a-0dn documented the bug and says the fix was implemented, but when I check the current code (lines 670-676), I see it's using a conditional with `allow_no_commits`. When `allow_no_commits` is true, it calls `get_commits_for_spec_allow_no_commits()` which doesn't take a branch parameter. The fix should ensure that when a branch is available, we always use `get_commits_for_spec_with_branch()`.

Additionally, the spec requires using SpecStateMachine for the in_progress→completed transition, which currently happens directly in finalize.rs line 83.

Let me verify the current state and make both fixes:
Wait, that removed the `allow_no_commits` logic. Let me check if that's needed or if the branch-aware function handles it:
I see that `get_commits_for_spec_with_branch()` calls `get_commits_for_spec_internal()` with `allow_no_commits=false`. I need to check if there's a way to pass both branch and allow_no_commits, or if I should modify the approach. Let me check the broader context:
I see the internal function accepts both parameters. The issue is that there's no public function that accepts both. Let me check where `allow_no_commits` is used and whether I need to preserve that logic or if using the branch-aware version is sufficient:
I see the error handling still references `allow_no_commits`. My edit removed that conditional logic. I need to add a wrapper function or use the internal function directly. Let me check if there's a better approach or if I should revert and fix it properly:
I need to add a new function that combines both branch awareness and allow_no_commits. Let me add it to commits.rs:
Now I need to fix single.rs to use this new function:
Good! Now I need to add the use of SpecStateMachine in finalize.rs. Let me check what's imported:
Now I'll add the TransitionBuilder import and replace the direct status assignment:
Now replace the direct status assignment with SpecStateMachine:
Now let me run cargo fmt and clippy:
Great! Now let me check the spec file for acceptance criteria:
The spec doesn't have acceptance criteria listed. Let me verify my changes are correct by reading the modified sections:
Perfect! Now let me commit the changes:
## Summary

Fixed commit detection to search the correct worktree branch and use SpecStateMachine for state transitions.

- Added `get_commits_for_spec_with_branch_allow_no_commits()` in commits.rs to combine branch-aware search with fallback support
- Updated single.rs lines 673-680 to always use branch-aware commit functions (with or without allow_no_commits)
- Replaced direct `spec.frontmatter.status = SpecStatus::Completed` in finalize.rs with `TransitionBuilder::new(spec).require_clean_tree().to(SpecStatus::Completed)`
- Ensures agent commits on `chant/SPEC_ID` branch are found before merge to main```
