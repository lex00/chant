---
type: code
status: pending
target_files:
  - tests/integration_tests.rs
---

# Add integration test for invalid regex pattern handling

## Problem

No integration test verifies graceful handling when enterprise config contains invalid regex patterns.

**Gap:** Config with syntax errors in patterns untested in real workflow.

## Solution

Add integration test that:
1. Creates enterprise config with INVALID regex pattern
2. Runs `chant add` and verifies it handles regex compilation failure gracefully
3. Verifies spec created without fields from invalid patterns
4. Verifies fields from valid patterns still work

## Test Implementation

```rust
#[test]
fn test_invalid_regex_pattern_graceful_failure() {
    let temp_dir = "/tmp/chant-test-invalid-regex";
    setup_test_repo(temp_dir);

    // Create enterprise config with INVALID regex
    let config = r#"
enterprise:
  derived:
    bad_field:
      from: branch
      pattern: "[invalid regex("   # Invalid regex - unclosed bracket
    good_field:
      from: env
      pattern: "TEAM_NAME"         # Valid pattern
"#;
    write_config(temp_dir, config);

    // Checkout branch
    Command::new("git")
        .args(["checkout", "-b", "test-branch"])
        .current_dir(temp_dir)
        .output()
        .unwrap();

    // Run chant add (should succeed despite invalid regex)
    let output = Command::new(env!("CARGO_BIN_EXE_chant"))
        .args(["add", "Test spec"])
        .env("TEAM_NAME", "platform")
        .current_dir(temp_dir)
        .output()
        .expect("Failed to run chant add");

    // Command should succeed
    assert!(output.status.success());

    // Verify spec created
    let spec_content = read_latest_spec(temp_dir);

    // bad_field should be missing (invalid regex)
    assert!(!spec_content.contains("bad_field:"));

    // good_field should work (valid pattern)
    assert!(spec_content.contains("good_field: platform"));

    // derived_fields should only list good_field
    assert!(spec_content.contains("derived_fields:\n  - good_field"));
    assert!(!spec_content.contains("bad_field") || !spec_content.contains("derived_fields"));
}
```

## Acceptance Criteria

- [ ] Add test to tests/integration_tests.rs
- [ ] Test creates config with syntactically invalid regex pattern
- [ ] Test includes both invalid and valid patterns
- [ ] Test runs `chant add` command
- [ ] Test verifies command succeeds (doesn't crash)
- [ ] Test verifies field with invalid regex is omitted
- [ ] Test verifies fields with valid patterns still work
- [ ] Test passes: `cargo test test_invalid_regex_pattern`
- [ ] Cleanup temp directory after test