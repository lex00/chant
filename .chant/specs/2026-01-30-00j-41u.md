---
type: code
status: completed
target_files:
- src/spec.rs
- src/cmd/work.rs
commits:
- 5ab6a39
completed_at: 2026-01-30T23:30:25Z
model: sonnet
---
# Fix short ID resolution bug - chant work matches archived specs but chant list does not

## Problem

When resolving short spec IDs:
- `chant list` only shows active specs (correct)
- `chant work 2mk` returns "Ambiguous spec ID '2mk'. Matches: 2026-01-30-00i-2mk, 2026-01-27-003-2mk"

The second match (`2026-01-27-003-2mk`) is archived and shouldn't be matched.

## Expected Behavior

Short ID resolution should only match active specs (in `.chant/specs/`), not archived specs (in `.chant/archive/`).

## Acceptance Criteria

- [x] Identify where short ID resolution occurs
- [x] Fix resolution to exclude archived specs
- [x] `chant work <short-id>` only matches active specs
- [x] Add test for short ID resolution excluding archives
- [x] Verify fix works

## Agent Output

2026-01-30T23:30:25Z

```
I'll implement the fix for the short ID resolution bug. Let me start by creating a todo list and then investigating the code.
Now let me find where short ID resolution occurs in the codebase.
Let me look at the spec.rs file where the error message appears:
Let me see more of the resolve_spec function:
Perfect! I found the issue. Let me look at the function signature to understand the full context:
Great! I found the problem. The `resolve_spec` function on line 773 explicitly loads archived specs on lines 781-784. The comment on line 772 even says "Searches both active specs and archived specs." This is the root cause.

Now let me check if there are other callers of this function and understand the usage:
I see this function is widely used. Let me check if there are any test cases that specifically test archived spec resolution:
I can see there are existing tests that verify `resolve_spec` finds archived specs (lines 1244-1304). This means the current behavior is intentional for some use cases. However, based on the spec description, this is now considered a bug.

Let me look at how `chant list` works to understand the difference:
Let me check the main.rs for the list command:
Let me find where the List command is handled:
Now let me look at the `cmd_list` implementation:
Perfect! I can see that `cmd_list` uses `load_all_specs` (line 379) which only loads specs from the `.chant/specs/` directory, not the archived specs. This is the correct behavior.

Now let me understand the solution. The issue is that `resolve_spec` loads both active and archived specs. Based on the problem description, it should only match active specs. Let me update my todo and implement the fix:
Now I'll fix the `resolve_spec` function to exclude archived specs:
Good! Now I need to update or remove the tests that were testing for archived spec resolution since that's no longer the intended behavior. Let me first update the tests:
Now let me add a new test that specifically tests the scenario described in the bug report:
Let me add a test that reproduces the exact scenario from the bug report:
Perfect! Now let me update the todo and run cargo fmt:
Great! Now let me run the tests:
Let me check the full output to see if tests passed:
Perfect! All tests passed. Now let me verify the implementation works by building the binary and testing it manually:
Let me verify that the binary works with the short ID:
Now let me check if there are archived specs with similar short IDs:
Perfect! There's an archived spec with the same short ID. Now let me test if the resolution works correctly:
Excellent! The fix works correctly. It resolved `2mk` to the active spec `2026-01-30-00i-2mk` and did not throw an ambiguity error about the archived spec `2026-01-27-003-2mk`.

Now let me verify that it correctly fails when trying to resolve a short ID that only exists in archives:
Perfect! The implementation is working correctly. Now let me update the acceptance criteria:
Now let me commit the changes:
Perfect! Now let me commit the changes:
Now let me verify git status is clean:
Perfect! Let me update the todo list to mark everything as completed:
## Summary

I've successfully fixed the short ID resolution bug. Here's what was done:

### Problem Identified
The `resolve_spec()` function in src/spec.rs:773 was loading both active specs from `.chant/specs/` and archived specs from `.chant/archive/`, causing ambiguous matches when resolving short IDs.

### Solution Implemented
1. **Modified `resolve_spec()` function** - Removed the code that loads archived specs (lines 776-784), so it now only searches active specs
2. **Updated documentation** - Changed function docstring to reflect that it only searches active specs
3. **Updated existing tests** - Modified 3 existing tests to verify that archived specs are now excluded:
   - `test_resolve_spec_excludes_archived_specs` 
   - `test_resolve_spec_excludes_archived_by_partial_id`
   - `test_resolve_spec_only_searches_active_specs`
4. **Added new test** - `test_resolve_spec_short_id_no_ambiguity_with_archived` to specifically test the bug scenario

### Verification
- All tests pass (`just test`)
- Code formatted with `cargo fmt`
- No clippy warnings
- Manual testing confirmed:
  - `chant show 2mk` resolves to active spec `2026-01-30-00i-2mk` (not the archived `2026-01-27-003-2mk`)
  - `chant show cxn` (archived-only spec) correctly fails with "Spec not found"
- Git status is clean
- All acceptance criteria checked off

The fix ensures that short ID resolution behavior matches `chant list` - both now only consider active specs, not archived ones.```
