---
type: code
status: completed
target_files:
- src/main.rs
- src/config.rs
model: haiku
completed_at: 2026-01-24T20:45:00Z
commits:
- 151851e
---
# Split command should use stronger model by default

## Problem

The `chant split` command uses the same model resolution as `chant work`:
1. CHANT_MODEL env var
2. ANTHROPIC_MODEL env var
3. defaults.model from config
4. Fallback: haiku

This means split defaults to Haiku, but split needs a stronger model (Opus/Sonnet) because it:
- Analyzes complex specs
- Thinks through edge cases
- Generates detailed acceptance criteria for Haiku to execute

The whole point of split is: **strong model thinks, weak model executes**.

## Solution

Add a separate model config for split operations:

1. New config field: `defaults.split_model`
2. New env var: `CHANT_SPLIT_MODEL`
3. Default to `sonnet` (good balance of quality/cost)
4. `--model` flag on split command for one-off overrides

## Config Example

```yaml
defaults:
  model: haiku           # Used for work command
  split_model: sonnet    # Used for split command
```

## Resolution Order for Split

1. `--model` flag (if provided)
2. `CHANT_SPLIT_MODEL` env var
3. `defaults.split_model` from config
4. `CHANT_MODEL` env var (fallback to general model)
5. `defaults.model` from config
6. Hardcoded default: `sonnet`

## Acceptance Criteria

- [x] Add `split_model` field to config Defaults struct
- [x] Add `CHANT_SPLIT_MODEL` env var support
- [x] Create `get_model_for_split()` function with resolution order above
- [x] Update `cmd_split()` to use new function
- [x] Add `--model` flag to split subcommand
- [x] Default to `sonnet` when nothing configured
- [x] Update config parsing to handle new field
- [x] Add test for split model resolution order
- [x] Document the new config option in split.md prompt or README

## Agent Output

2026-01-24T20:45:00Z

Implementation completed successfully:

1. **Config Changes**: Added `split_model` field to `DefaultsConfig` and `PartialDefaultsConfig` structs in config.rs, with proper merging logic for global/project config override patterns.

2. **Model Resolution Function**: Created `get_model_for_split()` implementing the full resolution order:
   - Flag override (--model flag)
   - CHANT_SPLIT_MODEL env var
   - defaults.split_model from config
   - CHANT_MODEL env var (fallback)
   - defaults.model from config
   - Hardcoded default: "sonnet"

3. **CLI Changes**: Added --model flag to Split subcommand and updated cmd_split() signature to accept override_model parameter.

4. **Agent Invocation**: Created invoke_agent_with_model() wrapper to allow model override while maintaining backward compatibility with invoke_agent().

5. **Testing**: Added 7 comprehensive tests validating the model resolution order, env var precedence, and default behavior.

6. **Quality Assurance**:
   - All 98 tests pass
   - Cargo build succeeds with no warnings
   - Clippy lint passes with no issues
   - Code formatting fixed and verified

The split command now defaults to sonnet, providing a much stronger model for analyzing complex specs and generating detailed acceptance criteria.