---
type: code
status: completed
depends_on:
- 2026-01-25-00y-9qp.2
target_files:
- src/cmd/spec.rs
- src/main.rs
commits:
- f87e4f4
completed_at: 2026-01-25T15:02:01Z
model: haiku
---
# Extract spec commands to src/cmd/spec.rs

Move spec management commands into a dedicated module. These commands share common formatting utilities and spec display logic.

### Acceptance Criteria

- [x] All spec command functions moved to `src/cmd/spec.rs`:
  - [x] `cmd_add()`
  - [x] `cmd_list()`
  - [x] `cmd_show()`
  - [x] `cmd_ready()`
  - [x] `cmd_lint()`
  - [x] `cmd_status()`
  - [x] `cmd_delete()`
  - [x] `format_yaml_value()`
  - [x] `key_to_title_case()`
  - [x] All spec display/formatting utilities
  - [x] All execution functions (cmd_work, cmd_work_parallel, finalize_spec, etc)
  - [x] All git operations (create_or_switch_branch, push_branch)
  - [x] All model selection functions
  - [x] All transcript handling functions
  - [x] All split/archive/merge functions
- [x] Public API clearly defined with pub fn for each command
- [x] `src/main.rs` dispatches Commands::Add, Commands::List, etc. to `cmd::spec` functions
- [x] Helper formatting functions are private to cmd::spec
- [x] `just check` passes (cargo fmt, cargo clippy succeed)
- [x] Spec file parsing still works correctly (cmd::spec reads from spec files)
- [x] Tests pass for spec-related functions

### Edge Cases

- **Spec file I/O**: Ensure spec file reading/writing still works from new module location
- **Formatting consistency**: Verify YAML value formatting matches original output exactly
- **Label filtering**: Check that list filtering by labels still works correctly
- **Ready spec detection**: Verify `cmd_ready()` logic is fully migrated and dependency detection works

### Example Test Cases

For spec commands, verify:
- `cmd_list()` output format unchanged
- `cmd_show()` displays spec details identically to before
- `cmd_add()` creates new spec files in correct location
- Spec deletion works without leaving orphaned files
- Label filtering in list produces same results as before

## Agent Output

2026-01-25T15:02:01Z

```
I'll start by reading the relevant code to understand the current structure and what needs to be extracted.
Let me read the main.rs file in sections:
I can see that `src/cmd/spec.rs` already exists. Let me check its current contents and the cmd/mod.rs to understand the current structure:
Good! The `src/cmd/spec.rs` file is just a stub. Now let me read the main.rs file to find the spec-related command functions that need to be extracted. Let me search for the command functions:
Let me search for these functions with a broader pattern:
Let me search for where Commands dispatches to these commands:
Let me read more of main.rs to see all the command implementations and what functions exist:
Let me continue reading to find where the cmd_add, cmd_list, cmd_show functions are defined:
Good! Let me continue reading to find all the spec-related functions:
Let me continue reading to see the rest of cmd_delete and cmd_split, cmd_archive, cmd_merge:
Now let me use the Explore agent to get a comprehensive overview of what needs to be extracted:
Excellent! Now I have a comprehensive understanding. Let me create a plan for extracting all these functions. Let me use the TodoWrite tool to track my work:
Now let me read the entire main.rs file in chunks and extract all the necessary functions. Let me start by reading to identify where cmd_split starts:
Let me read large sections of the file to extract all the functions. I'll start with reading the rest of main.rs systematically:
Let me continue reading to get all the remaining functions:
Due to the size of the file, I'll now start extracting the functions. Let me mark the first extraction task as in progress and begin:
This is a large extraction task. Let me use a Task agent to perform the extraction efficiently:
Excellent! Now let me update the main.rs to dispatch to the new module. First, let me update my todo and then update main.rs:
Now let me read the main.rs file again to see what needs to be replaced. Let me check what the main.rs looks like after the dispatch section:
Now I need to update main.rs to change all the command calls to dispatch to cmd::spec. Let me do the replacements:
Now I need to remove all the extracted functions from main.rs. First, let me get the total line count to determine the section boundaries. Let me check the end of the file:
The file is quite large. Let me delete the extracted functions. I'll start by identifying what needs to stay in main.rs. Let me check what cmd_version, cmd_init, is_silent_mode, and detect_project_name are and whether they need to stay:
These functions (cmd_init, is_silent_mode, detect_project_name, cmd_version) should stay in main.rs. Now I need to systematically delete the extracted functions. Let me start:

The extracted functions occupy ranges from cmd_add (646) to end of file. But I need to keep some functions. Let me carefully delete sections. Let me start by deleting from cmd_add (line 646) to the end of detect_project_name + is_silent_mode functions, but I need to keep things carefully.

Let me be strategic: I'll delete all the spec command functions starting from cmd_add through the last spec-related function. Let me find what's between cmd_init and cmd_add:
Good, so cmd_add starts at 646. Now I need to delete from line 646 to the end of all the extracted functions. Since the file is 7002 lines and I extracted functions all the way to line ~3700 (and there may be other code after), let me check what's after the functions I extracted. Let me find the end of the main.rs file:
So there are tests at the end. Let me check if there are more tests after cmd_version. Let me search for the test module:
There are tests. Let me see what line cmd_version is on and what comes after it:
Perfect! So I need to delete from line 646 (cmd_add) to line 3374 (just before the test module at 3376). Let me be more precise and find where cmd_merge ends:
Perfect! So I need to delete from line 646 to line 3374 (inclusive). Let me do this carefully by reading the section I'm about to delete to make sure, then using Edit:
Now let me delete from line 646 to 3374. I need to create a string that matches from line 646 to 3374. Let me use Bash to extract that section:
Good. Now I need to delete this entire section. Since the Edit tool requires exact string matching and this section is very large, let me use a different approach. Let me create a temporary file with only the parts I want to keep:
Great! Now let me verify the result by checking the line count and the boundaries:
Perfect! Let me verify the dispatch section looks good:
Excellent! The dispatch is correct. Now let me verify that cmd_init, detect_project_name, and is_silent_mode are still present:
Let me check if cmd_version is there:
cmd_version was removed. Let me check if it's being called and needs to be kept. Let me search for it:
I see, cmd_version is called but we accidentally deleted it. I need to check if cmd_version should be extracted or not. According to the spec, cmd_versio

... (output truncated, 14685 chars total)```
