---
type: code
status: completed
target_files:
- tests/integration_tests.rs
model: claude-haiku-4-5-20251001
---
# Integration test for silent mode - verify isolation between silent and normal repos

## Overview

Create an integration test that validates silent mode works correctly and doesn't interfere with normal chant usage. The test simulates a real customer workflow using two separate repos.

## Test Scenario

```
/tmp/test-chant-silent-normal/   <- Normal mode (team repo)
/tmp/test-chant-silent-private/  <- Silent mode (personal repo)
```

### Workflow to Test

1. **Setup Phase**
   - Create two fresh git repos in /tmp
   - Initialize chant normally in repo A
   - Initialize chant with `--silent` in repo B
   - Create a trivial task (edit a text file) as a spec in both

2. **Execution Phase**
   - Work the spec in both repos (or simulate working)
   - Archive completed specs in both

3. **Verification Phase**
   - Repo A: `.chant/` should be committable (not excluded)
   - Repo B: `.chant/` should be in `.git/info/exclude`
   - Verify git status shows no untracked `.chant/` in repo B
   - Verify `chant status` shows "(silent mode)" in repo B only

## Test Implementation

```rust
#[test]
#[serial]
fn test_silent_mode_isolation() {
    // Setup two repos
    let normal_repo = PathBuf::from("/tmp/test-chant-silent-normal");
    let silent_repo = PathBuf::from("/tmp/test-chant-silent-private");

    // Cleanup and setup both repos
    // ...

    // Init chant normally in repo A
    run_chant(&normal_repo, &["init"]);

    // Init chant with --silent in repo B
    run_chant(&silent_repo, &["init", "--silent"]);

    // Verify .git/info/exclude contains .chant/ in silent repo
    let exclude_content = fs::read_to_string(silent_repo.join(".git/info/exclude"));
    assert!(exclude_content.contains(".chant/"));

    // Verify .git/info/exclude does NOT contain .chant/ in normal repo
    let normal_exclude = fs::read_to_string(normal_repo.join(".git/info/exclude"));
    assert!(!normal_exclude.contains(".chant/"));

    // Create specs, work them, verify results...
}
```

## Failure Points to Test

Identify workflow points where chant should warn/error if proceeding would violate silent mode:

| Scenario | Expected Behavior |
|----------|-------------------|
| `chant init --silent` on already-tracked .chant/ | Error: "Cannot enable silent mode" |
| `chant work --pr` in silent mode | Error: "Cannot create PR in silent mode" |
| `chant work --branch` in silent mode | Warning: "Branch will be visible to team" |
| `chant merge` in silent mode | Should work (local merge) |

## Edge Cases to Cover

1. **Worktree usage in silent mode**
   - Worktrees should respect parent repo's silent mode
   - Use `git rev-parse --git-common-dir` for correct exclude path

2. **User transitions out of silent mode**
   - Remove .chant/ from exclude, git add, commit
   - Chant should work normally after

## Acceptance Criteria

- [x] Add helper function to run chant binary in a given directory
- [x] Test: Initialize normal repo, verify .chant/ not in exclude
- [x] Test: Initialize silent repo, verify .chant/ in exclude
- [x] Test: Create and work trivial spec in normal repo
- [x] Test: Create and work trivial spec in silent repo
- [x] Test: `chant status` shows "(silent mode)" only in silent repo
- [x] Test: `--pr` fails in silent mode with correct error message
- [x] Test: `--branch` produces warning in silent mode
- [x] Test: Verify git status is clean in silent repo (no untracked .chant/)
- [x] Test: Both repos function independently without interference
- [x] All tests pass