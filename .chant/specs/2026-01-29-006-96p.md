---
type: code
status: pending
---

# Fix parallel + branch interaction: auto-merge completed branches

## Problem

Counter-intuitive behavior when using `chant work --parallel` with `branch: true`:

**What users expect:**
- Parallel execution = isolated work (✓ works via worktrees)
- `branch: true` = don't work directly on main (✓ works)
- Completed work = merged to main automatically

**What actually happens:**
- Parallel creates isolated branches (R.1, R.2, etc)
- Work completes successfully on those branches
- Branches are NOT auto-merged
- Finalization fails (no commits on main)
- User has orphaned branches with completed work

**Why this is confusing:**
- User sets `branch: true` to avoid working on main directly
- But parallel ALREADY uses worktrees/branches for isolation
- The `branch: true` setting prevents auto-merge
- Result: completed work stuck on unmergeable branches

## Current Behavior

`chant work --parallel` with `branch: true`:
1. Creates worktree with branch for each spec
2. Agent completes work and commits to branch
3. Marks spec as completed
4. Leaves branch unmerged
5. Finalization looks for commits on main → fails

## Desired Behavior

**Option A: Auto-merge by default in parallel mode**
- Parallel + completed spec = auto-merge to main
- Parallel + failed spec = leave branch for debugging
- Override with `auto_merge: false` in spec frontmatter

**Option B: Add --auto-merge flag to parallel**
- `chant work --parallel --auto-merge`
- Merge completed branches automatically
- Failed branches stay for review

**Option C: Separate branch from auto_merge**
- `branch: true` = use feature branch (isolation)
- `auto_merge: true` = merge when complete (cleanup)
- Default in parallel: branch=true, auto_merge=true

## Investigation Needed

1. What does `branch: true` mean semantically?
   - Isolation during work? (parallel does this anyway)
   - Keep for review after work? (current behavior)
   - Both?

2. Should parallel always auto-merge successful completions?
   - Pro: Matches user expectations
   - Con: No review step
   - Solution: Add finalize --no-merge for review mode?

3. What about single spec with `branch: true`?
   - Should behave differently than parallel?
   - Manual merge expected?

4. When should branches be left unmerged?
   - Failed specs (always)
   - Specs needing approval (maybe)
   - Never for completed specs? (maybe)

## Recommendation (Draft)

**Simplest fix:** Auto-merge completed branches in parallel mode
- If spec completes successfully → auto-merge to main
- If spec fails → leave branch for debugging
- Works for both `branch: true` and `branch: false`
- Add `--no-merge` flag if user wants manual review

## Acceptance Criteria

- [ ] Decide on semantics of `branch: true` setting
- [ ] Decide if parallel should auto-merge by default
- [ ] Design solution (Option A, B, C, or other)
- [ ] Document interaction between parallel and branch settings
- [ ] Implementation plan for chosen solution
