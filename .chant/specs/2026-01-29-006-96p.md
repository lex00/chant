---
type: code
status: pending
target_files:
- src/cmd/work.rs
- src/cmd/merge.rs
- src/cmd/spec.rs
---

# Fix parallel + branch workflow: auto-merge and finalization issues

## Problem

Multiple issues with `chant work --parallel` + `branch: true` workflow:

### Issue 1: Finalization looks in wrong place
**What happened:**
- Agents committed correctly with `chant(SPEC-ID):` format
- But commits were on feature branches (due to `branch: true`)
- Finalization searched main only, found nothing, marked specs "failed"
- Work was actually complete, just on branches

**Fix:** Finalization should check the spec's branch field, not just main

### Issue 2: Merge tries to checkout deleted branches
**What happened:**
```bash
$ chant merge --rebase false
✓ Merged successfully
✗ Failed to return to original branch 'chant/...'
error: pathspec '...' did not match any file(s) known to git
```
- The merge succeeded (branch deleted after merge)
- Then it tried to checkout the deleted branch → error
- Every merge reported "failed" but actually worked

**Fix:** Don't try to return to branch after deleting it

### Issue 3: Merge resets spec status to pending
**What happened:**
- Branches had `status: completed` in spec files
- Merge overwrote main's spec with branch version
- All specs went back to `status: pending` after successful merge
- `chant finalize` then refused: "must be in_progress, completed, or failed"
- Had to manually edit status with sed

**Fix:** Merge should preserve/update status intelligently

### Issue 4: No atomic parallel → completed path
**Expected workflow:**
```bash
chant work --parallel
# → work done → specs completed ✓
```

**Actual workflow:**
```bash
chant work --parallel
# → work done → branches created → manual merge → manual status fix → finally "completed"
```

**Fix:** Add `chant merge --finalize` to mark specs completed after merge

### Issue 5: Error messages lack context
**What happened:**
```
✗ No matching commits found
```

**What would help:**
```
✗ No matching commits found on main
  Found 1 commit on branch chant/2026-01-29-001-abc
  Run 'chant merge 2026-01-29-001-abc' to merge the branch first
```

**Fix:** Suggest checking branches when finalization fails

## Solution

### Part 1: Auto-merge completed branches in parallel mode

**Default behavior:**
- `chant work --parallel` with `branch: true` → auto-merge on completion
- Completed spec → merge to main automatically
- Failed spec → leave branch for debugging
- Add `--no-merge` flag to disable auto-merge

**Implementation:**
- After agent completes successfully, auto-merge the branch
- Use existing merge logic, just call it automatically
- Only for parallel mode (single spec keeps manual merge)

### Part 2: Fix finalization to check branches

**Current:** Only looks for commits on main
**New:** Check spec's `branch` field first, fall back to main

```rust
fn get_commits_for_spec(spec_id: &str, spec: &Spec) -> Result<Vec<String>> {
    // If spec has a branch, check that branch first
    if let Some(branch) = &spec.frontmatter.branch {
        if let Ok(commits) = find_commits_on_branch(branch, spec_id) {
            if !commits.is_empty() {
                return Ok(commits);
            }
        }
    }

    // Fall back to checking main
    find_commits_on_branch("main", spec_id)
}
```

### Part 3: Fix merge branch cleanup

**Current:** Deletes branch then tries to checkout it
**New:** Don't checkout after successful delete

```rust
// After merge and delete
if delete_succeeded {
    // Don't try to checkout deleted branch
    // Stay on main or original branch
} else {
    // Only checkout if delete failed
}
```

### Part 4: Fix merge status handling

**Options:**

**Option A:** Merge status intelligently
- If branch has `status: completed` → keep it
- If main has `status: pending` → use branch's status
- Prefer more advanced status

**Option B:** Add `--finalize` flag to merge
```bash
chant merge --finalize
# Merge + mark as completed atomically
```

**Recommendation:** Both - do A (smart merge) + B (explicit flag)

### Part 5: Improve error messages

Add helpful context when finalization fails:

```rust
if commits_on_main.is_empty() {
    if let Some(branch) = &spec.frontmatter.branch {
        if let Ok(branch_commits) = find_commits_on_branch(branch, spec_id) {
            if !branch_commits.is_empty() {
                return Err(anyhow!(
                    "No matching commits found on main\n\
                     Found {} commit(s) on branch {}\n\
                     Run 'chant merge {}' to merge the branch first",
                    branch_commits.len(), branch, spec_id
                ));
            }
        }
    }
    return Err(anyhow!("No matching commits found"));
}
```

## Acceptance Criteria

- [ ] Auto-merge completed branches in parallel mode by default
- [ ] Add `--no-merge` flag to disable auto-merge in parallel
- [ ] Fix finalization to check spec's branch field before main
- [ ] Fix merge to not checkout deleted branches
- [ ] Fix merge to preserve completed status from branch
- [ ] Add `chant merge --finalize` flag to mark specs completed after merge
- [ ] Improve finalization error messages to suggest checking branches
- [ ] Add tests for parallel + branch workflow
- [ ] Update documentation for parallel + branch interaction
- [ ] All tests passing
- [ ] Code linted and formatted
