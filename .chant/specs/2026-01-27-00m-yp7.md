---
type: code
status: pending
target_files:
  - tests/integration_tests.rs
model: claude-sonnet-4-5
---

# Add integration test for missing env var handling

## Problem

No integration test verifies graceful handling when environment variables referenced in config are not set.

**Gap:** Missing env vars untested in real workflow.

## Solution

Add integration test that:
1. Creates enterprise config expecting environment variables
2. Runs `chant add` WITHOUT setting those env vars
3. Verifies command succeeds and spec created
4. Verifies fields from missing env vars are omitted

## Test Implementation

```rust
#[test]
fn test_missing_env_var_graceful_failure() {
    let temp_dir = "/tmp/chant-test-missing-env";
    setup_test_repo(temp_dir);

    // Create enterprise config expecting env vars
    let config = r#"
enterprise:
  derived:
    team:
      from: env
      pattern: "TEAM_NAME"         # Not set
    environment:
      from: env
      pattern: "DEPLOY_ENV"        # Not set
    component:
      from: path
      pattern: "/([^/]+)\\.md$"    # Should still work
"#;
    write_config(temp_dir, config);

    // Run chant add WITHOUT setting environment variables
    let output = Command::new(env!("CARGO_BIN_EXE_chant"))
        .args(["add", "Test spec"])
        .current_dir(temp_dir)
        // Explicitly do NOT set TEAM_NAME or DEPLOY_ENV
        .output()
        .expect("Failed to run chant add");

    // Command should succeed
    assert!(output.status.success());

    // Verify spec created
    let spec_content = read_latest_spec(temp_dir);

    // team and environment should be missing (env vars not set)
    assert!(!spec_content.contains("team:"));
    assert!(!spec_content.contains("environment:"));

    // component should work (doesn't depend on env)
    assert!(spec_content.contains("component:"));

    // derived_fields should only list component
    assert!(spec_content.contains("derived_fields:\n  - component"));
}

#[test]
fn test_partial_env_vars_available() {
    let temp_dir = "/tmp/chant-test-partial-env";
    setup_test_repo(temp_dir);

    // Create enterprise config expecting multiple env vars
    let config = r#"
enterprise:
  derived:
    team:
      from: env
      pattern: "TEAM_NAME"         # Will be set
    environment:
      from: env
      pattern: "DEPLOY_ENV"        # NOT set
"#;
    write_config(temp_dir, config);

    // Run chant add with only one env var set
    let output = Command::new(env!("CARGO_BIN_EXE_chant"))
        .args(["add", "Test spec"])
        .env("TEAM_NAME", "platform")  // Set this one
        // DEPLOY_ENV not set
        .current_dir(temp_dir)
        .output()
        .expect("Failed to run chant add");

    assert!(output.status.success());

    // Verify partial success
    let spec_content = read_latest_spec(temp_dir);
    assert!(spec_content.contains("team: platform"));      // Set
    assert!(!spec_content.contains("environment:"));       // Not set
    assert!(spec_content.contains("derived_fields:\n  - team"));
}
```

## Acceptance Criteria

- [x] Add two tests to tests/integration_tests.rs
- [x] First test: All env vars missing
- [x] Test verifies command succeeds
- [x] Test verifies env-derived fields omitted
- [x] Test verifies non-env fields still work
- [x] Second test: Some env vars set, others missing
- [x] Test verifies partial derivation (only available vars)
- [x] Tests pass: `cargo test test.*env_var`
- [x] Cleanup temp directories after tests