---
type: code
status: pending
target_files:
  - src/derivation.rs
---

# Add unit tests for unicode in derivation sources

## Problem

No unit tests verify derivation handles unicode/non-ASCII characters correctly in branch names, paths, environment variables, or git user info.

**Gap:** International characters, emojis, and multi-byte sequences untested.

## Solution

Add unit tests to src/derivation.rs that verify correct handling of:
- Branch names with unicode characters
- Environment variables with unicode values
- Git user names with non-ASCII characters
- Path components with unicode

## Test Cases

```rust
#[test]
fn test_branch_with_unicode_characters() {
    let context = DerivationContext {
        branch_name: Some("feature/È°πÁõÆ-123/am√©lioration".to_string()),
        ..default_context()
    };

    let mut derived = HashMap::new();
    derived.insert("project".to_string(), DerivedFieldConfig {
        from: DerivationSource::Branch,
        pattern: "feature/([^/]+)/".to_string(),
        validate: None,
    });
    derived.insert("description".to_string(), DerivedFieldConfig {
        from: DerivationSource::Branch,
        pattern: "feature/[^/]+/(.+)".to_string(),
        validate: None,
    });

    let config = EnterpriseConfig { derived, required: vec![] };
    let engine = DerivationEngine::new(config);
    let result = engine.derive_fields(&context);

    assert_eq!(result.get("project"), Some(&"È°πÁõÆ-123".to_string()));
    assert_eq!(result.get("description"), Some(&"am√©lioration".to_string()));
}

#[test]
fn test_env_value_with_unicode() {
    let mut env_vars = HashMap::new();
    env_vars.insert("AUTHOR_NAME".to_string(), "Jos√© Garc√≠a".to_string());
    env_vars.insert("TEAM_NAME".to_string(), "–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞".to_string());
    env_vars.insert("DESCRIPTION".to_string(), "Fix üêõ in parser".to_string());

    let context = DerivationContext {
        env_vars,
        ..default_context()
    };

    let mut derived = HashMap::new();
    derived.insert("author".to_string(), DerivedFieldConfig {
        from: DerivationSource::Env,
        pattern: "AUTHOR_NAME".to_string(),
        validate: None,
    });
    derived.insert("team".to_string(), DerivedFieldConfig {
        from: DerivationSource::Env,
        pattern: "TEAM_NAME".to_string(),
        validate: None,
    });
    derived.insert("desc".to_string(), DerivedFieldConfig {
        from: DerivationSource::Env,
        pattern: "DESCRIPTION".to_string(),
        validate: None,
    });

    let config = EnterpriseConfig { derived, required: vec![] };
    let engine = DerivationEngine::new(config);
    let result = engine.derive_fields(&context);

    assert_eq!(result.get("author"), Some(&"Jos√© Garc√≠a".to_string()));
    assert_eq!(result.get("team"), Some(&"–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞".to_string()));
    assert_eq!(result.get("desc"), Some(&"Fix üêõ in parser".to_string()));
}

#[test]
fn test_git_user_with_unicode() {
    let context = DerivationContext {
        git_user_name: Some("Fran√ßois M√ºller".to_string()),
        git_user_email: Some("fran√ßois.m√ºller@example.com".to_string()),
        ..default_context()
    };

    let mut derived = HashMap::new();
    derived.insert("author".to_string(), DerivedFieldConfig {
        from: DerivationSource::GitUser,
        pattern: "name".to_string(),
        validate: None,
    });
    derived.insert("email".to_string(), DerivedFieldConfig {
        from: DerivationSource::GitUser,
        pattern: "email".to_string(),
        validate: None,
    });

    let config = EnterpriseConfig { derived, required: vec![] };
    let engine = DerivationEngine::new(config);
    let result = engine.derive_fields(&context);

    assert_eq!(result.get("author"), Some(&"Fran√ßois M√ºller".to_string()));
    assert_eq!(result.get("email"), Some(&"fran√ßois.m√ºller@example.com".to_string()));
}

#[test]
fn test_path_with_unicode_directory_names() {
    let context = DerivationContext {
        spec_path: Some(PathBuf::from(".chant/specs/Âπ≥Âè∞/ÊñáÊ°£.md")),
        ..default_context()
    };

    let mut derived = HashMap::new();
    derived.insert("team".to_string(), DerivedFieldConfig {
        from: DerivationSource::Path,
        pattern: "specs/([^/]+)/".to_string(),
        validate: None,
    });

    let config = EnterpriseConfig { derived, required: vec![] };
    let engine = DerivationEngine::new(config);
    let result = engine.derive_fields(&context);

    assert_eq!(result.get("team"), Some(&"Âπ≥Âè∞".to_string()));
}
```

## Acceptance Criteria

- [ ] Add 4+ tests to src/derivation.rs tests module
- [ ] Test branch names with Chinese characters
- [ ] Test branch names with accented Latin characters
- [ ] Test env var values with Cyrillic characters
- [ ] Test env var values with emojis
- [ ] Test git user names with accented characters
- [ ] Test git user emails with unicode
- [ ] Test paths with unicode directory names
- [ ] All tests verify exact unicode preservation
- [ ] Tests pass: `cargo test test.*unicode`