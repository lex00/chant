---
type: code
status: pending
target_files:
  - src/merge.rs
  - src/cmd/lifecycle.rs
---

# Add --no-ff as default merge strategy for diverged branches

## Problem

**User Report:** "Several merges failed with 'can't fast-forward' errors, requiring --rebase --auto or manual --no-ff merges. This happened when both branches diverged from the same base."

**User Confirmation:**
- `git merge --no-ff` success rate: 100% - it always succeeded
- Conflict type: Fast-forward rejections only, NOT content conflicts
- Error: "Not possible to fast-forward, aborting"
- Cause: Both branches diverged from same base (parallel execution creates sibling branches)
- Preferred: "Automatic --no-ff when divergence detected, or make --no-ff the default for parallel merges (siblings always need it)"

Git's default fast-forward merge fails when branches have diverged. Current behavior:
```bash
$ chant merge 2026-01-27-001-abc
Error: Not possible to fast-forward, aborting
```

Users must manually use `--no-ff`, which breaks workflow smoothness. The `--rebase` option tried to address this but failed due to worktree conflicts.

## Solution

**Auto-detect divergence and use appropriate strategy:**

1. Check if branches have diverged:
   ```bash
   git merge-base --is-ancestor chant/spec-id HEAD
   ```
2. If diverged: Use `--no-ff` automatically
3. If clean fast-forward possible: Use fast-forward
4. If conflicts exist: Suggest --rebase or manual resolution

**Implementation:**

```rust
pub fn merge_spec_branch(spec_id: &str) -> Result<()> {
    let branch = format!("chant/{}", spec_id);

    // Check if fast-forward is possible
    let can_ff = Command::new("git")
        .args(["merge-base", "--is-ancestor", &branch, "HEAD"])
        .output()?
        .status
        .success();

    let merge_strategy = if can_ff {
        vec!["merge", &branch]  // Fast-forward
    } else {
        vec!["merge", "--no-ff", &branch, "-m", &format!("Merge spec {}", spec_id)]
    };

    let output = Command::new("git")
        .args(&merge_strategy)
        .output()?;

    if !output.status.success() {
        bail!("Merge failed. Try: chant merge {} --rebase", spec_id);
    }

    Ok(())
}
```

## Acceptance Criteria

- [x] Add divergence detection before merge
- [x] Use --no-ff automatically when branches diverged
- [x] Use fast-forward when possible (backwards compatible)
- [x] Add clear error message suggesting --rebase if conflicts
- [x] Add unit test for diverged branches
- [x] Add integration test: parallel work creates diverged branches
- [x] Test: merge automatically uses --no-ff
- [x] All existing tests pass