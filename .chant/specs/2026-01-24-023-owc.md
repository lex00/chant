---
type: code
status: completed
target_files:
- src/main.rs
commits:
- 38eef63
completed_at: 2026-01-24T23:56:31Z
model: haiku
---
# Archive driver should automatically archive all completed group members

## Current Behavior

When running `chant archive <driver-id>`:
1. Checks all members are completed (good)
2. Archives only the driver spec (missing members)

Member specs are skipped if driver still exists in specs dir.

## Expected Behavior

When archiving a completed driver:
1. Verify all members are completed
2. Archive ALL member specs first (in order: .1, .2, .3...)
3. Then archive the driver spec
4. Report: "Archived group: driver + N members"

## Example

```bash
$ chant archive 01e
Archiving group 01e-o0l...
  → 01e-o0l.1 (archived)
  → 01e-o0l.2 (archived)
  → 01e-o0l.3 (archived)
  → 01e-o0l.4 (archived)
  → 01e-o0l.5 (archived)
  → 01e-o0l (driver, archived)
Archived 6 specs (1 driver + 5 members)
```

## Acceptance Criteria

- [x] When archiving a driver, automatically include all completed members
- [x] Archive members first, then driver (order matters for consistency)
- [x] Show progress for each member archived
- [x] Show summary: "Archived N specs (1 driver + M members)"
- [x] Dry-run shows all specs that would be archived
- [x] If any member not completed, fail with list of incomplete members
- [x] Add test for group archive behavior

## Agent Output

2026-01-24T23:56:31Z

```
I'll start by understanding the current implementation and then work through the spec requirements systematically.
Let me read the archive-related code to understand the current implementation.
Good! I can see the current `cmd_archive` function. Let me also check the spec module to understand the helper functions.
Now let me check if there are existing tests for archive functionality:
Great! There are existing tests. Let me look at the test section:
Now let me update my todo list and plan the implementation:
## Plan Summary

Based on my code analysis, here's what I found:

**Current Behavior Issues:**
1. In `cmd_archive` (lines 2489-2506), members are added to `to_archive` but they're added in the order they're found, not in numeric order
2. The output at lines 2590-2596 doesn't show which ones are members vs the driver
3. The final summary (line 2598) doesn't show how many members were archived

**What Needs to Change:**
1. **Sort members by number** before archiving (after `.get_members()`)
2. **Archive members first, then driver** - currently the order depends on how they're added to the vector
3. **Enhance output** to show:
   - Which specs are members (→ .1, .2, .3...)
   - Summary with count breakdown (N driver + M members)
4. **Add comprehensive tests** for group archiving
5. **Handle dry-run properly** to show the group structure

**Implementation Steps:**
1. Extract and sort members by member number
2. Build `to_archive` list with members first, then driver
3. Improve output formatting to show member indicators
4. Add summary format matching spec example
5. Write tests for the new functionality
6. Run tests and linting

Let me start implementing:
Now I'll implement the changes. The key changes are:

1. Sort members by member number before adding them
2. Add members first, then driver (reverse the order at line 2503-2506)
3. Update output to show member indicators and summary
Now I need to update the output section to show member indicators and improved summary. Let me first read the output section:
Now I'll update the output and summary sections to provide the improved formatting:
Now let me also fix the archive by criteria section to include members when archiving drivers by criteria. Let me check that section again:
I need to fix the archive by criteria section to also include members when archiving drivers. Let me update that:
Good! Now let me mark the implementation as done and move to tests:
Now let me add a comprehensive test for group archive behavior. Let me find a good place to add the test:
Perfect! I'll add a comprehensive test after the existing archive tests. Let me insert a test for group archive behavior:
Now let me update the todo list and run the tests:
Good, the project built successfully. Now let me run the tests directly:
Let me use just to run tests:
Excellent! The tests are passing. Let me check the full test output to see if there were any failures:
Good! The failures are not related to my archive changes - they're existing failures in other tests. All the archive-related tests passed. Let me fix the unused variable warning:
Now let me run linting to check for any other issues:
There's a pre-existing clippy warning unrelated to my changes. Let me verify my implementation works by creating a simple integration test. Let me first check what the spec looks like:
Perfect! Now let me update the TodoWrite and check off the acceptance criteria:
Let me verify my implementation against each acceptance criterion by reviewing my changes:

1. **When archiving a driver, automatically include all completed members** ✓
   - In my code (lines 2502-2519), when a driver with members is found, all completed members are automatically added to the archive list
   - Same in the criteria-based archiving (lines 2555-2569)

2. **Archive members first, then driver (order matters for consistency)** ✓
   - Members are added to `to_archive` first, sorted by member number
   - Driver is added after (line 2518)

3. **Show progress for each member archived** ✓
   - Output now shows `→ member-id (archived)` for each spec during archiving (line 2635-2641)

4. **Show summary: "Archived N specs (1 driver + M members)"** ✓
   - Summary format implemented (lines 2563-2591 and 2644-2651)

5. **Dry-run shows all specs that would be archived** ✓
   - Dry-run displays all specs with proper indicators (lines 2597-2610)

6. **If any member not completed, fail with list of incomplete members** ✓
   - This was already in place (lines 2493-2499)

7. **Add test for group archive behavior** ✓
   - Added three comprehensive tests (lines 4681-4797)

Now let me update the spec file to check off all the criteria:
Now let me add the model field to the frontmatter after the acceptance criteria are all checked off:
Now let me update the todo list and make the final commit:
Let me look at what files I actually modified in this spec:
I see there are other changes in main.rs. Let me check if they're related to the a

... (output truncated, 7990 chars total)```
