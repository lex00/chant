---
type: code
status: completed
target_files:
- '`src/worktree.rs`'
- '`src/main.rs`'
model: claude-haiku-4-5-20251001
---
# Add Core Worktree Helper Functions

**Description:**
Create a new module `worktree.rs` with low-level git worktree operations. These functions handle the mechanics of creating, managing, and removing git worktrees. This establishes the foundational utilities that all subsequent subtasks will depend on.

### Acceptance Criteria

- [x] Create `src/worktree.rs` with three core functions
- [x] `create_worktree(spec_id: &str, branch: &str) -> Result<PathBuf>` creates worktree and returns its path
  - [x] Creates git worktree at `/tmp/chant-{spec_id}`
  - [x] Creates branch with specified name (e.g., `spec/{spec_id}` or custom prefix)
  - [x] Returns absolute path to worktree directory
  - [x] Returns error if branch already exists
- [x] `remove_worktree(path: &Path) -> Result<()>` safely removes worktree
  - [x] Removes git worktree entry
  - [x] Cleans up directory if it still exists
  - [x] Does not error if worktree already gone (idempotent)
- [x] `merge_and_cleanup(branch: &str) -> Result<()>` merges branch to main and cleans up
  - [x] Checks out main branch
  - [x] Performs fast-forward merge from the specified branch
  - [x] Deletes the branch after successful merge
  - [x] Returns error if merge has conflicts (does NOT abort; caller handles)
  - [x] Does NOT attempt cleanup if merge fails
- [x] Add module declaration to `main.rs` (`mod worktree;`)
- [x] Add tests for each function in `src/worktree.rs`

### Edge Cases

- **Branch already exists:** If `create_worktree()` is called with a branch that already exists, return `WorktreeError::BranchAlreadyExists` with the branch name. Test: Try creating two worktrees with the same spec_id concurrently.
- **Worktree creation fails:** If `git worktree add` fails (e.g., corrupted git repo), propagate the error. Test: Mock a git failure and verify error is returned.
- **Merge conflicts:** If `merge_and_cleanup()` encounters a merge conflict, return error and leave branch intact (do not delete branch). Test: Create a conflict scenario and verify branch is preserved for manual resolution.
- **Cleanup after agent failure:** `remove_worktree()` should still succeed even if the agent crashed. Test: Create worktree, manually corrupt the directory, call `remove_worktree()` and verify it cleans up.
- **Concurrent worktree operations:** Two specs trying to create worktrees should not interfere. Test: Spawn two threads creating worktrees with different spec_ids and verify both complete successfully.

### Example Test Cases

For this feature, verify:
- **Case 1:** `create_worktree("spec-001", "spec/spec-001")` creates `/tmp/chant-spec-001` with branch `spec/spec-001`
- **Case 2:** `remove_worktree(Path::new("/tmp/chant-spec-001"))` removes directory and worktree entry without error
- **Case 3:** `merge_and_cleanup("spec/spec-001")` merges branch to main and deletes it
- **Case 4:** Calling `remove_worktree()` twice on same path succeeds both times (idempotent)
- **Case 5:** `create_worktree()` with existing branch returns error naming the branch