---
type: code
status: in_progress
target_files:
  - src/cmd/lifecycle.rs
  - src/git.rs
  - .chant/prompts/merge-conflict.md
---

# Implement rebase-before-merge strategy for chant merge command

## Problem

When multiple specs run in parallel, they create branches that diverge from main at the same point. After the first branch merges (via ff-only), subsequent branches are no longer fast-forwardable because main has moved.

**Current behavior:**
```
main ─────────────────────○ (after first merge)
      ╲                   ↑
       spec/00e ──────────┘ (ff merge works)
      ╲
       spec/00i ────────── ✗ (ff merge fails - diverged)
      ╲
       spec/00j ────────── ✗
```

**Desired behavior:**
```
main ─────────────────────○──────○──────○──────○
      ╲                   ↑      ↑      ↑      ↑
       spec/00e ──────────┘      │      │      │
                                 │      │      │
       spec/00i (rebased) ───────┘      │      │
                                        │      │
       spec/00j (rebased) ──────────────┘      │
                                               │
       spec/00k (rebased) ─────────────────────┘
```

## Solution: Rebase-before-merge

Add `--rebase` flag to `chant merge`:

```bash
chant merge --all --rebase           # Rebase each branch before ff-merge
chant merge --all --rebase --yes     # Skip confirmation
```

### Algorithm

For each branch to merge:
1. `git checkout <spec-branch>`
2. `git rebase main`
3. If rebase conflict:
   - Option A: Abort rebase, skip this branch, continue with next
   - Option B: Invoke agent with merge-conflict prompt to resolve
4. `git checkout main`
5. `git merge --ff-only <spec-branch>`
6. Delete branch if requested

### Conflict Resolution (Option B)

When rebase has conflicts, create a conflict resolution context and invoke agent:

```
$ chant merge --all --rebase
→ Rebasing spec/00i-939 onto main...
⚠ Conflict in src/main.rs

Invoking agent to resolve conflict...
[Agent resolves by including both additions]

✓ Conflict resolved, continuing rebase...
✓ Merged spec/00i-939
```

## CLI Interface

```bash
chant merge --all                    # Current: ff-only, fails on diverged branches
chant merge --all --rebase           # New: rebase before merge
chant merge --all --rebase --auto    # New: auto-resolve conflicts with agent
```

## Prompt: merge-conflict.md

Create a prompt for agent-assisted conflict resolution:

```markdown
# Resolve Merge Conflict

You are resolving a git conflict during rebase.

## Conflict Context
- Branch: {{branch_name}}
- Rebasing onto: {{target_branch}}
- Conflicting files: {{conflicting_files}}

## Conflict Markers
{{conflict_diff}}

## Instructions
1. Analyze the conflict markers (<<<<<<< ======= >>>>>>>)
2. Determine the correct resolution (usually include both changes)
3. Edit the file to resolve the conflict
4. Stage the resolved file with `git add`
5. Continue rebase with `git rebase --continue`

For additive conflicts (both sides add lines), include both additions.
For modification conflicts, prefer the incoming changes unless they break existing code.
```

## Acceptance Criteria

- [ ] Add `--rebase` flag to `chant merge`
- [ ] Implement rebase-before-merge logic in git.rs
- [ ] Handle rebase conflicts gracefully (abort and report)
- [ ] Add `--auto` flag for agent-assisted conflict resolution
- [ ] Create merge-conflict.md prompt template
- [ ] Test with parallel branch scenario
- [ ] Update docs

## Test Case

Current situation with 4 parallel branches:
- spec/2026-01-26-00e-94e (drift)
- spec/2026-01-26-00i-939 (resume)
- spec/2026-01-26-00j-bfs (export)
- spec/2026-01-26-00k-6j4 (disk)

All modify main.rs and mod.rs with additive changes. This spec should enable:
```bash
chant merge 00e 00i 00j 00k --rebase --yes
```
