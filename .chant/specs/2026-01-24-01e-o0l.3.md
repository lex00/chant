---
type: code
status: completed
depends_on:
- 2026-01-24-01e-o0l.2
target_files:
- src/main.rs
model: claude-haiku-4-5-20251001
---
# Ensure cmd_work() calls finalize_spec() on all success paths

Add finalization to all code paths where work succeeds, before returning.

### Acceptance Criteria

- [x] finalize_spec() is called after successful agent completion
- [x] finalize_spec() is called after successful acceptance criteria validation
- [x] finalize_spec() errors prevent the function from returning success
- [x] PR creation happens AFTER finalization (so PR URL can be saved to spec)
- [x] Agent output is appended to spec AFTER finalization (so finalized spec is the base)
- [x] Test verifies spec is finalized even if PR creation is skipped
- [x] Test verifies spec is finalized even if agent output appending fails (or not needed)

### Edge Cases

- PR creation fails after finalization: Spec should still be marked completed, error reported separately
- Agent output append fails: Should not undo finalization that already succeeded
- Multiple acceptance criteria checks: Finalization should happen once after all checks pass

### Example Test Cases

For this feature, verify:
- Case 1: Normal flow: agent succeeds, criteria all checked, spec is finalized
- Case 2: Unchecked criteria: finalization doesn't happen, status is Failed
- Case 3: Force flag bypasses unchecked criteria, spec is finalized
- Case 4: PR creation fails after finalization - spec is still completed
- Case 5: Agent output append doesn't undo finalization