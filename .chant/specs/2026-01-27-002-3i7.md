---
type: code
status: completed
commits:
- 491bdd4
completed_at: 2026-01-27T14:34:26Z
model: haiku
---
# Bootstrap prompt with prep script

## Problem

The current prompt assembly embeds the full spec content directly into the CLI argument passed to Claude. This causes:
1. Large initial prompts that may trigger aggressive rate limiting
2. Claude attempts to process everything at once, making many parallel tool calls
3. On replay/resume, the spec may contain stale agent conversation that confuses the agent

## Solution

### 1. Bootstrap Prompt

Create a new `bootstrap` prompt that:
- Is minimal - just tells the agent to run a prep command
- Does NOT embed `{{spec.description}}` or `{{spec}}`
- Instructs the agent to call `chant prep <spec-id>` to get the work

Example bootstrap prompt:
```markdown
You are implementing spec {{spec.id}} for {{project.name}}.

Run this command to get your instructions:
\`\`\`
chant prep {{spec.id}}
\`\`\`

Follow the instructions returned by that command.
```

### 2. Prep Command (`chant prep <spec-id>`)

New CLI command that outputs the spec content, with preprocessing:
- Reads the spec file
- If `--clean` or by default: strips any "## Agent Conversation" or similar sections that may have been added during previous runs
- Outputs clean spec content for the agent to read
- Could add other preprocessing in future (inject context, check dependencies, etc.)

### 3. Spawn Jitter

Change `stagger_delay_ms` to use jitter instead of exact interval:
- Add `stagger_jitter_ms` config option (default: 20% of delay)
- Actual delay = `stagger_delay_ms + random(-jitter, +jitter)`
- Prevents synchronized bursts when multiple agents finish/start at similar times

## Acceptance Criteria

- [x] New `bootstrap` prompt in `.chant/prompts/bootstrap.md`
- [x] New `chant prep <spec-id>` command that outputs cleaned spec content
- [x] Prep command strips agent conversation sections from spec body
- [x] `stagger_jitter_ms` config option added to parallel config
- [x] Spawn delay uses jitter: `delay + random(-jitter, +jitter)`
- [x] Documentation updated for new prompt and prep command
- [x] `just lint` passes

## Agent Output

2026-01-27T14:34:26Z

```
I'll start by understanding the structure of this project and then work on implementing the bootstrap prompt with prep script feature.
Let me explore the codebase to understand the project structure and existing code:
Now let me update my todo and read the key files to understand what needs to be implemented:
Now let me read the key files to understand the exact implementation details:
Now let me read the cmd/work.rs file to see how specs are currently executed:
Now let me look at how prompts are structured and check existing prompts:
Now let me examine the current spec and understand what needs to be built. Let me update my todo list and start planning:
Now I'll start implementing. First, let me create the bootstrap prompt:
Now let me implement the `chant prep` command. First, let me look at how other commands are structured in the cmd module:
Now let me create the prep command module:
Now let me add the prep command to the cmd module's mod.rs:
Now let me add the prep command to the CLI:
Let me continue reading the main.rs to find where I need to add the prep command:
Now I'll add the Prep command to the Commands enum and the handler:
Now add the handler in the match statement:
Now let me update the config.rs to add the stagger_jitter_ms option. First, let me read more of the config file:
Now let me add the jitter configuration to ParallelConfig:
Now add the default jitter function and update the Default implementation:
Now I need to find where the stagger_delay_ms is used and implement the jitter. Let me check the work.rs file:
Let me look at that section in work.rs:
Now I need to update the stagger delay code to include jitter. Let me look at the imports at the top of work.rs:
Now I'll add the rand crate import and update the stagger delay code:
Now update the stagger delay code to use jitter:
Now I need to add `use std::thread` and `use std::time::Duration` if they're not already there. Let me check:
Good, those imports are already in the function scope. Now let me check if rand is in Cargo.toml:
Great! Now let me test if the code compiles:
Let me look for documentation files that need to be updated:
Let me find the reference docs:
Let me read and update these documentation files:
Let me continue reading the CLI docs to find where to add prep documentation:
Let me search for where to add the prep command documentation. Let me look further in the CLI docs:
Let me add the prep command documentation in the appropriate section. I'll add it after the "Split Spec" section:
Now let me update the config.md documentation to add the jitter configuration:
Let me update the parallel configuration section in the config docs:
Now let me check the prompts documentation:
Let me find where to add the bootstrap prompt documentation:
Now I'll add the bootstrap prompt to the built-in prompts table and description:
Now add the detailed description for bootstrap:
Now let me run the build to check for any compilation errors:
I need to fix the ParallelConfig initializers in the test file. Let me find where they are:
Let me fix the work.rs file first:
Now fix the agent_rotation.rs file:
Let me use a different approach:
Let me fix the remaining ones:
Now let me check if the build compiles:
Let me check what's wrong with the spec imports in prep.rs:
I need to use chant::spec instead of crate::spec. Let me fix this:
Let me check if there are any remaining errors:
Good! Now let me fix the unused import warning:
Excellent! Now let me run the tests:
I have a test failure. The issue is that my logic for stripping agent conversation sections is removing level 3 headers because I'm removing them when skip_section is true. Let me fix the logic:
I see the issue. The problem is that when we encounter a "## Agent Conversation" section, we set skip_section = true and continue, which skips that header line. But then we keep skipping until we hit another level 2 header. However, in my test case, the "### Subsection" is a level 3 header, so it gets skipped while skip_section is true. Let me fix the logic:
Actually, looking at the test case more carefully, the issue is different. The test has "## Agent Conversation" followed by a "### Subsection", but when we encounter the "## Agent Conversation", we're still in a skipped section for the level 3 header. The real issue is we need to end the skip_section when we hit a new section header. Let me trace through the test case:

```
# Spec

## Agent Conversation

Should remove.

### Subsection

This is level 3, not a section header.
```

When we process:
1. "# Spec" - not level 2, include
2. "" - empty, include
3. "## Agent Conversation" - level 2, matching, set skip_section=true, continue (skip line)
4. "" - not level 2, skip_section is true, so skip
5. "Should remove." - not level 2, skip_section is true, so skip
6. "" - not level 2, skip_section is true, so skip
7. "### Subsection" - level 3, skip_section is true, so skip!

The issue is that we need to end the skip when we encounter a NEW level 2 he

... (output truncated, 15152 chars total)```
