---
type: code
status: pending
target_files:
  - src/cmd/lifecycle.rs
---

# Archive should verify target files have changes

## Problem

A spec can be marked `status: completed` with `target_files` listed, but the actual implementation code may be missing due to:
- Merge conflicts resolved incorrectly (took wrong version)
- Cherry-pick that only grabbed spec metadata, not code changes
- Manual status updates without implementation

When archiving, chant doesn't verify that target_files actually have changes from the spec's commits. This allows "completed" specs with no actual implementation to be archived.

**Example from post-mortem**:
- Spec 00l-egi marked completed
- `target_files: [tests/integration_tests.rs]`
- But merge conflict resolution discarded the actual test code
- Archive succeeded even though no test exists

## Solution

Before archiving a spec, verify implementation exists:

1. Get commits associated with spec (from branch or git log search)
2. For each `target_file` listed in frontmatter:
   - Check if any spec commits touched this file
   - Verify file has net additions (not just deletions/renames)
3. If no target_files have changes, warn or fail:
   ```
   Warning: Spec 00l-egi lists target_files but no changes found
   Target files: tests/integration_tests.rs

   This may indicate:
   - Merge conflict resolved incorrectly
   - Implementation was lost during merge
   - Spec manually marked completed without implementation

   Archive anyway? [y/N]
   ```

## Acceptance Criteria

- [ ] Add verification logic to cmd_archive
- [ ] Check git log for commits matching spec ID pattern
- [ ] For each target_file, verify commits touched it
- [ ] Count net additions (insertions - deletions)
- [ ] Warn if no target_files have changes
- [ ] Add --force flag to skip verification
- [ ] Test: archive spec with implementation succeeds silently
- [ ] Test: archive spec without changes shows warning
- [ ] All existing tests pass
