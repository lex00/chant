---
type: group
status: in_progress
target_files:
- src/main.rs
- src/git.rs
---
# Improve parallel execution - isolate specs with git worktrees

## Background

Current parallel execution has no isolation - all threads share the same working directory, causing:
- File edit conflicts
- Git commit race conditions
- Build artifact conflicts

## Solution: Git Worktrees

Each parallel spec runs in its own git worktree with its own branch.

```bash
# For each spec in parallel:
git worktree add /tmp/chant-{spec.id} -b spec/{spec.id}
cd /tmp/chant-{spec.id}
# ... run agent ...
# on completion: merge or leave branch
git worktree remove /tmp/chant-{spec.id}
```

## Behavior by Mode

| Mode | Worktree Branch | After Completion |
|------|-----------------|------------------|
| Direct commit | `spec/{id}` | Auto-merge to main, delete branch |
| Branch mode (`--branch`) | `{prefix}{id}` | Leave branch for `chant reconcile` |

## Implementation Steps

### Step 1: Add worktree helper functions
- `create_worktree(spec_id: &str, branch: &str) -> Result<PathBuf>`
- `remove_worktree(path: &Path) -> Result<()>`
- `merge_and_cleanup(spec_id: &str, branch: &str) -> Result<()>`

### Step 2: Update cmd_work_parallel()
- Before spawning thread: create worktree
- Pass worktree path to agent (set working directory)
- After completion: merge to main (direct mode) or leave branch (branch mode)
- Cleanup worktree

### Step 3: Update invoke_agent to accept working directory
- Add `cwd: Option<&Path>` parameter
- Run claude CLI in specified directory

### Step 4: Handle edge cases
- Worktree creation failure (branch already exists)
- Merge conflicts (abort, mark spec as needs-attention)
- Cleanup on agent failure

## Acceptance Criteria

- [ ] Create worktree in `/tmp/chant-{spec.id}` for each parallel spec
- [ ] Each worktree gets branch `spec/{spec.id}` (or `{prefix}{id}` in branch mode)
- [ ] Agent runs in worktree directory (isolated)
- [ ] Direct mode: auto-merge to main after completion
- [ ] Branch mode: leave branch for reconcile command
- [ ] Cleanup worktree after completion (success or failure)
- [ ] Handle merge conflicts gracefully
- [ ] Existing sequential `chant work` unchanged (no worktree)
- [ ] Add tests for worktree creation/cleanup