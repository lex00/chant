---
type: code
status: completed
model: claude-haiku-4-5-20251001
---
# Add API throttle detection and retry logic - detect 400/429 errors and tool use concurrency issues, implement exponential backoff retry, add max_retries config option, log retry attempts

## Acceptance Criteria

- [x] Detect 400/429 HTTP status codes and implement retryable error handling
- [x] Implement exponential backoff retry logic for both OpenAI and Ollama providers
- [x] Add max_retries configuration option to provider configs (default 3)
- [x] Add retry_delay_ms configuration option to provider configs (default 1000)
- [x] Log retry attempts with status codes and backoff delays
- [x] Handle tool use concurrency issues in agent retry loops
- [x] All tests pass (248 unit tests, 16 integration tests)
- [x] Code formatted with cargo fmt
- [x] No clippy warnings in provider.rs and agent.rs

## Implementation Summary

### Changes Made

1. **Configuration Layer** (`src/provider.rs`):
   - Added `max_retries` (default 3) and `retry_delay_ms` (default 1000) fields to `OllamaConfig`
   - Added `max_retries` and `retry_delay_ms` fields to `OpenaiConfig`
   - Added corresponding fields to `OllamaProvider` and `OpenaiProvider` structs

2. **OpenAI Provider Retry Logic** (`src/provider.rs`):
   - Implemented retry loop with exponential backoff for HTTP requests
   - Detects retryable errors: 429 (rate limit), 500, 502, 503, 504 (server errors)
   - Extracted response processing to separate method for cleaner retry logic
   - Logs retry attempts with status codes and backoff delays
   - Calculates exponential backoff with jitter (±10%) to prevent thundering herd

3. **Ollama Provider Retry Logic** (`src/agent.rs`):
   - Created `run_agent_with_retries()` function with configurable retry policy
   - Original `run_agent()` delegates to new function with defaults (3 retries, 1000ms delay)
   - Implements retry loop for HTTP requests in agent chat loop
   - Detects both HTTP errors (429, 5xx) and network errors (Connection, timeout, reset)
   - Logs retry attempts with error details
   - Uses same exponential backoff algorithm as OpenAI provider

4. **Provider Initialization** (`src/cmd/agent.rs`):
   - Updated `get_model_provider()` to extract retry config from `ProviderConfig`
   - Falls back to defaults if config not specified
   - Passes retry parameters to provider constructors

### Retry Behavior

- **Retryable errors**: 429 (rate limit), 500, 502, 503, 504 (server errors), network errors
- **Non-retryable errors**: 401 (auth), 4xx (bad request), others after max retries
- **Backoff formula**: `delay_ms = base_delay * 2^(attempt-1) ± 10% jitter`
- **Max retries**: Configurable, default 3
- **Initial delay**: Configurable, default 1000ms

### Configuration Example

```yaml
providers:
  openai:
    endpoint: https://api.openai.com/v1
    max_retries: 5
    retry_delay_ms: 2000
  ollama:
    endpoint: http://localhost:11434/v1
    max_retries: 3
    retry_delay_ms: 1000
```

### Logging

Retry attempts are logged as:
```
[Retry 1] HTTP 429 - waiting 950ms before retry
[Retry 2] HTTP 429 - waiting 1900ms before retry
[Retry 1] Network error - waiting 1050ms before retry: Connection refused
```