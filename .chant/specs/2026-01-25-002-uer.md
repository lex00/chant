---
type: research
status: in_progress
target_files:
- src/main.rs
- src/diagnose.rs
---
# Investigate uncommitted formatting changes - ensure fmt runs before commit

## Problem

After working specs, `src/diagnose.rs` had uncommitted formatting changes that should have been applied before the commit. This suggests:
1. Code was written without running `cargo fmt`
2. The commit was created before formatting was applied
3. User left with dirty working tree

## Questions to Answer

1. Where in the chant workflow should `cargo fmt` run?
   - Before commit in finalize_spec()?
   - As a pre-commit hook?
   - Agent should run it as part of workflow?

2. Should chant automatically run `cargo fmt` before committing?
   - Pro: Ensures consistent formatting
   - Con: May be slow, may conflict with user preferences

3. Should this be configurable?
   - Add `auto_format: true` to chant config?
   - Respect existing pre-commit hooks?

4. What about other linting (clippy)?
   - Should clippy also run before commit?
   - Or just rely on CI?

## Acceptance Criteria

- [x] Investigate where formatting should occur in chant workflow
- [x] Determine if auto-formatting should be built into chant
- [x] Recommend solution (auto-format, pre-commit hook, or agent responsibility)
- [x] If implementing: ensure all code changes are formatted before commit
- [x] Document decision in findings

## Investigation Findings

### Current Workflow Architecture

After analyzing the chant codebase, the workflow is:

1. **Spec Execution**: Agent works in isolated worktree (via `create_worktree()` in `src/worktree.rs`)
2. **Merging**: After agent completes, `worktree::merge_and_cleanup()` merges branch to main via `git merge --ff-only`
3. **Spec Finalization**: `finalize_spec()` updates spec status to `completed` and saves the spec file
4. **Transcript Commit**: `commit_transcript()` (recently added in spec 2026-01-25-001-xud) commits the transcript
5. **Result**: User gets working tree with all committed changes

### The Formatting Issue

The problem identified: Code written in the worktree is not formatted before being merged to main. While the previous spec (2026-01-25-001-xud) solved the transcript not being committed, it didn't address code formatting.

**Root Cause**: The agent runs code, creates commits in the worktree, but doesn't run `cargo fmt` before the final merge to main.

### Three Possible Solutions

#### Option 1: Agent Responsibility (Current State - NOT RECOMMENDED)
- Agents should run `just fmt` as part of their workflow before completion
- **Problem**: Not enforced, relies on agent discipline; formatting can be forgotten
- **Evidence**: Previous work left `src/diagnose.rs` with formatting differences

#### Option 2: Pre-commit Hook (NOT RECOMMENDED)
- Use git pre-commit hooks to run formatting automatically
- **Problem**: Requires user setup, not part of chant workflow; hooks can be skipped; conflicts with user preferences
- **Problem**: Chant is designed to be deterministic; user-configured hooks break reproducibility

#### Option 3: Auto-format Before Merge (RECOMMENDED)
- Run `cargo fmt` in the worktree BEFORE `worktree::merge_and_cleanup()`
- **Advantages**:
  - Automatic and deterministic - no agent needs to remember
  - Aligns with chant's principle that "chant gets to write files"
  - Ensures clean formatting before merge to main
  - Non-breaking - formatting changes are local to the branch
  - Idempotent - running fmt multiple times has no additional effect
- **Trade-offs**:
  - Adds slight overhead to spec execution (fmt is fast)
  - Assumes project uses rustfmt (reasonable for Rust projects)
  - Could conflict with controversial formatter decisions (but that's the linter's job)

### Recommendation

**Implement Option 3: Auto-format in worktree before merge**

**Why**:
- Chant's philosophy is to automate reproducible workflows
- Users should not need to remember formatting - it should "just work"
- Formatting is a hygiene concern, not a feature concern
- The worktree branch is isolated until merge, so formatting changes don't affect main during dev
- Aligns with how `just check` already includes `fmt-check`

**Implementation**:
1. Add `cargo fmt` call in `worktree::merge_and_cleanup()` BEFORE `git merge --ff-only`
2. Alternatively: Add it as a separate pre-merge step in `main.rs`
3. No user configuration needed - formatting is automatic
4. Consider: Make this a project-wide setting that respects .rustfmt.toml

### Verdict

**This is an infrastructure issue, not an agent issue.** The formatting should be handled by chant's infrastructure before merge, not delegated to the agent. This ensures:
- All specs produce consistently formatted code
- No spec gets "blamed" for formatting issues
- Formatting is non-negotiable (like a build requirement)
- User never sees formatting diffs (cleaner main branch)