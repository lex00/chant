---
type: code
status: in_progress
target_files:
- .chant/prompts/standard.md
---
# Standard prompt tuning - fix fmt ordering leaving uncommitted files

## Problem

Agents are running `cargo fmt` at the end of their work loop, AFTER committing. This leaves uncommitted formatting changes.

Evidence from spec 00r:
- Agent made commit `8da38b3` with 12 lines (reformatting only)
- But 145+ lines of actual implementation were left uncommitted
- Agent likely: implemented → committed → ran fmt → fmt created new changes → never committed those

## Root Cause

The standard prompt has this ordering issue:

```markdown
## Instructions
1. Read
2. Plan
3. Implement
4. Verify
5. Check off acceptance criteria
6. Commit  ← COMMIT HAPPENS HERE

## Constraints
- Always lint all and fix errors and warnings  ← BUT LINT/FMT RUNS HERE
- When complete, Always run all tests and fix errors
```

The constraints section mentions linting but it's AFTER the commit step in Instructions. Agents interpret this as:
1. Do work
2. Commit
3. Run lint/fmt (as constraint says)
4. Now there are uncommitted changes

## Solution

Restructure the prompt to ensure fmt/lint happens BEFORE commit:

```markdown
## Instructions
1. Read the relevant code first
2. Plan your approach before coding
3. Implement the changes
4. Run `cargo fmt` to format code
5. Run `cargo clippy` to fix lint errors
6. Run tests and fix any failures
7. Verify the implementation works
8. Check off each acceptance criterion
9. Commit with message: `chant({{spec.id}}): <description>`
10. Verify git status is clean (no uncommitted changes)
```

## Acceptance Criteria

- [x] Move fmt/lint/test steps to BEFORE commit in Instructions
- [x] Add explicit "verify git status is clean" step after commit
- [x] Remove redundant lint mentions from Constraints section
- [x] Test by working a spec and verifying no uncommitted changes remain