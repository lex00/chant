---
type: code
status: in_progress
model: sonnet
---
# Fix agent writing invalid model value in spec frontmatter (claude-sonnet-4 â†’ sonnet)

Agents write full model IDs like `claude-sonnet-4` to spec frontmatter, but chant expects short names like `sonnet`.

## Problem

In `prompts/standard.md` line 79:
```
- Always add model: {{spec.model}} to frontmatter after all acceptance criteria met
```

But `{{spec.model}}` doesn't exist as a template variable. Agents interpret this literally and write whatever model name they see from their invocation (e.g., `claude-sonnet-4-20250514`).

## Solution

Either:
1. **Normalize on write**: When agent writes `model: claude-sonnet-4`, chant normalizes to `sonnet`
2. **Normalize on read**: Accept full model names and normalize internally
3. **Fix the prompt**: Remove `{{spec.model}}` template variable reference

Option 2 is safest - accept any valid model string and normalize it.

## Implementation

In `src/spec.rs` where frontmatter is parsed, normalize model names:

```rust
fn normalize_model_name(model: &str) -> String {
    if model.contains("opus") { "opus".to_string() }
    else if model.contains("sonnet") { "sonnet".to_string() }
    else if model.contains("haiku") { "haiku".to_string() }
    else { model.to_string() }
}
```

## Acceptance Criteria

- [x] Spec with `model: claude-sonnet-4` parses successfully
- [x] `spec.frontmatter.model` returns normalized value `sonnet`
- [x] Same normalization for opus, haiku variants
- [x] Unknown models pass through unchanged
- [x] `cargo test` passes