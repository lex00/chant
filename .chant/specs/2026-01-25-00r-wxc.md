---
type: code
status: completed
commits:
- 8da38b3
completed_at: 2026-01-25T12:18:40Z
model: claude-haiku-4-5-20251001
target_files:
- tests/integration_tests.rs
- justfile
---
# Integration test: mock new developer clone and build experience

## Purpose

Simulate a brand new developer cloning the repo for the first time. Validate:
- Clean clone works
- Build succeeds with no errors
- No unexpected warnings
- Tests pass
- No missing dependencies or setup steps

## Test Scenario

```bash
# Simulate fresh clone into temp directory
cd /tmp
git clone https://github.com/lex00/chant.git chant-fresh-clone
cd chant-fresh-clone

# First-time build
cargo build

# Run tests
cargo test

# Run linter
cargo clippy

# Check formatting
cargo fmt --check

# Try the binary
./target/debug/chant --version
./target/debug/chant --help
```

## Test Implementation

**Manual-only test** - excluded from regular test suite to avoid doubling test time.

```rust
#[test]
#[ignore]  // Run manually: cargo test test_new_developer_experience -- --ignored
#[serial]
fn test_new_developer_experience() {
    let test_dir = PathBuf::from("/tmp/test-chant-new-dev");
    let _ = cleanup_test_repo(&test_dir);

    // Clone the repo (use local path to avoid network dependency)
    let repo_root = std::env::var("CARGO_MANIFEST_DIR").unwrap();
    let clone_output = Command::new("git")
        .args(["clone", &repo_root, test_dir.to_str().unwrap()])
        .output()
        .expect("Failed to clone");
    assert!(clone_output.status.success(), "Clone failed");

    // Build
    let build_output = Command::new("cargo")
        .args(["build"])
        .current_dir(&test_dir)
        .output()
        .expect("Failed to build");
    assert!(build_output.status.success(), "Build failed: {}",
        String::from_utf8_lossy(&build_output.stderr));

    // Check for unexpected warnings in build output
    let stderr = String::from_utf8_lossy(&build_output.stderr);
    // Allow known warnings, fail on unexpected ones

    // Run tests
    let test_output = Command::new("cargo")
        .args(["test"])
        .current_dir(&test_dir)
        .output()
        .expect("Failed to run tests");
    assert!(test_output.status.success(), "Tests failed");

    // Verify binary works
    let version_output = Command::new("./target/debug/chant")
        .args(["--version"])
        .current_dir(&test_dir)
        .output()
        .expect("Failed to run --version");
    assert!(version_output.status.success(), "--version failed");

    // Cleanup
    let _ = cleanup_test_repo(&test_dir);
}
```

## Checks to Validate

| Check | Expected | Failure Indicates |
|-------|----------|-------------------|
| `git clone` | Success | Repo URL or permissions issue |
| `cargo build` | Success, no errors | Missing deps, syntax errors |
| `cargo build` warnings | Only known/expected | New warnings introduced |
| `cargo test` | All pass | Broken functionality |
| `cargo clippy` | No errors | Code quality issues |
| `cargo fmt --check` | No changes needed | Unformatted code committed |
| `chant --version` | Prints version | Binary not built correctly |
| `chant --help` | Prints help | CLI broken |

## Warning Audit

Capture current expected warnings so test can detect NEW warnings:

```rust
const KNOWN_WARNINGS: &[&str] = &[
    "field `success` is never read",  // worktree.rs:90
    // Add any other known warnings here
];

fn check_for_unexpected_warnings(stderr: &str) -> Vec<String> {
    let mut unexpected = Vec::new();
    for line in stderr.lines() {
        if line.contains("warning:") {
            let is_known = KNOWN_WARNINGS.iter().any(|w| line.contains(w));
            if !is_known {
                unexpected.push(line.to_string());
            }
        }
    }
    unexpected
}
```

## Edge Cases

1. **Rust toolchain not installed** - Test assumes Rust is available
2. **Network issues** - Use local clone to avoid flakiness
3. **Disk space** - Temp directory needs ~500MB for build
4. **Parallel test runs** - Use unique temp dir per test

## Running the Test

```bash
# Run manually (not part of regular test suite)
cargo test test_new_developer_experience -- --ignored

# Or add to justfile:
just test-new-dev
```

**Add to `justfile`:**
```just
# Test new developer clone/build experience (slow, manual only)
test-new-dev:
    cargo test test_new_developer_experience -- --ignored --nocapture
```

## Acceptance Criteria

- [x] Test marked with `#[ignore]` (excluded from `cargo test`)
- [x] Test clones repo to fresh temp directory
- [x] Test runs `cargo build` and asserts success
- [x] Test captures and validates warnings (fails on unexpected)
- [x] Test runs `cargo test` and asserts all pass
- [x] Test runs `cargo clippy` and asserts no errors
- [x] Test runs `cargo fmt --check` and asserts clean
- [x] Test verifies `chant --version` works
- [x] Test verifies `chant --help` works
- [x] Test cleans up temp directory
- [x] Add `just test-new-dev` command to justfile
- [x] Document any known/expected warnings