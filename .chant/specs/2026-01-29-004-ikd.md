---
type: task
status: completed
model: claude-opus-4-5-20251101
---
# Separate project config from user config

## Problem

.chant/config.md currently mixes project settings with user settings:

**Project settings** (should be in git, shared across team):
- defaults: prompt, branch, branch_prefix, model
- enterprise: derived_fields, schema
- approval: reviewers, required_approvals
- git: ignore_patterns

**User settings** (should NOT be in git, user-specific):
- parallel.agents: list with personal API keys/accounts
  Example: agents[0].command = "claude --profile personal"
- Personal model preferences
- Local paths

## Current Issues

1. **Security**: Agent configs may contain API keys/tokens
2. **Not portable**: Different users have different agent setups
3. **Conflicts**: Users overwrite each other's agent configs
4. **Confusion**: Is .chant/config.md for project or user?

## Investigation Needed

Evaluate options:

### Option 1: Split config files
- .chant/config.md (project, in git)
- .chant/agents.md (user, in .gitignore)
- Merge at runtime

### Option 2: Global + Local pattern
- ~/.config/chant/config.md (user global)
- .chant/config.md (project only, no agents)
- Project can't see user's agents

### Option 3: Local override pattern
- .chant/config.md (project, in git)
- .chant/config.local.md (user, ignored, overrides)
- Similar to .env / .env.local pattern

### Option 4: Example file pattern
- .chant/config.example.md (in git, template)
- .chant/config.md (in .gitignore, user copies example)
- Users must customize locally

## Questions to Answer

1. Should chant init add config.md to .gitignore by default?
2. Where should agent configs live?
3. How do we migrate existing users?
4. What's the least disruptive change?
5. Can we detect secrets in config and warn?
6. Should we support config inheritance/merging?

## Expected Outcome

A clear design for separating concerns with:
- Migration path for existing users
- Documentation for new users
- Implementation plan

---

## Analysis Report

### Current Architecture

The codebase already has a two-tier config system:

1. **Global config**: `~/.config/chant/config.md` (user-wide defaults)
2. **Project config**: `.chant/config.md` (project-specific)

The `Config::load_merged()` function (src/config.rs:327-350) loads both and merges them with project values overriding global values. However, there are issues:

1. **`load_merged()` is rarely used** - Most code paths use `Config::load()` which only reads `.chant/config.md`
2. **No dedicated agents-only file** - Agent configs are embedded in the same config file as project settings
3. **No `.gitignore` protection for agents** - The current `.chant/.gitignore` only ignores `.locks/`, `.store/`, and `logs/`

### Option Evaluation

| Option | Pros | Cons | Disruption |
|--------|------|------|------------|
| **1: Split files** (.chant/agents.md) | Clear separation, familiar pattern | New file to manage, requires merge logic extension | Medium |
| **2: Global + Local** (existing pattern) | Already partially implemented, user agents stay global | Users can't have project-specific agent configs | Low |
| **3: Local override** (.chant/config.local.md) | Familiar .env pattern, single override point | Unclear what to put where, full duplication needed | Medium |
| **4: Example file** | Clear template, users understand pattern | Breaks existing projects, requires manual setup | High |

### Recommendation: **Hybrid of Option 2 + Option 1**

The solution should:
1. **Use the existing global config** (`~/.config/chant/config.md`) for user-specific agent settings
2. **Keep `.chant/config.md` for project settings** (no agents section)
3. **Add optional `.chant/agents.md`** for project-specific agent overrides (gitignored)
4. **Fix `Config::load()` to use `load_merged()` semantics** everywhere

**Merge priority** (highest wins):
1. `.chant/agents.md` (local user agents, if exists)
2. `~/.config/chant/config.md` (global user config including agents)
3. `.chant/config.md` (project config)

This approach:
- Leverages existing global config infrastructure
- Keeps project config clean and committable
- Allows project-specific agent overrides when needed
- Is backward compatible (existing configs continue to work)

---

## Answers to Questions

### 1. Should chant init add config.md to .gitignore by default?

**No.** The project config (`config.md`) should be committed because it contains shareable settings (project name, defaults, enterprise rules).

However, `chant init` should:
- Add `agents.md` to `.chant/.gitignore`
- Warn if `parallel.agents` is detected in `.chant/config.md` when the file is tracked in git

### 2. Where should agent configs live?

**Primary**: `~/.config/chant/config.md` (global, user-wide)
**Override**: `.chant/agents.md` (local, project-specific, gitignored)

The global location means users configure agents once and use them across all projects. Project-specific overrides are rare but supported.

### 3. How do we migrate existing users?

**Graceful migration**:
1. Continue reading `parallel.agents` from `.chant/config.md` (backward compatible)
2. If `.chant/agents.md` exists, use that instead
3. If global config has agents, use those as base
4. Add a `chant config migrate-agents` command that:
   - Extracts `parallel.agents` from `.chant/config.md`
   - Writes to `~/.config/chant/config.md` (global) or `.chant/agents.md` (local)
   - Removes agents section from `.chant/config.md`
5. Show deprecation warning when agents are found in project config:
   ```
   ⚠ Agent config found in .chant/config.md
     Consider moving to ~/.config/chant/config.md (global) or .chant/agents.md (local)
     Run `chant config migrate-agents` to migrate automatically
   ```

### 4. What's the least disruptive change?

Implement in phases:

**Phase 1 (non-breaking):**
- Support reading from `~/.config/chant/config.md` for agents
- Support optional `.chant/agents.md` (gitignored)
- Show deprecation warning for agents in project config

**Phase 2 (deprecation):**
- Add `chant config migrate-agents` command
- Update docs to recommend new locations
- `chant init` creates agents.md template in .gitignore

**Phase 3 (optional removal):**
- Remove support for agents in `.chant/config.md`
- (Can be delayed indefinitely if backward compat is valued)

### 5. Can we detect secrets in config and warn?

**Yes, with heuristics:**
- Check for `API_KEY`, `SECRET`, `TOKEN`, `PASSWORD` in agent commands
- Check for `--api-key`, `--token` flags
- Check for long base64-like strings (potential tokens)
- Warn if detected and file is tracked in git

Implementation:
```rust
fn detect_potential_secrets(command: &str) -> Vec<&str> {
    let patterns = ["API_KEY", "SECRET", "TOKEN", "PASSWORD", "--api-key", "--token"];
    patterns.iter()
        .filter(|p| command.to_uppercase().contains(*p))
        .copied()
        .collect()
}
```

### 6. Should we support config inheritance/merging?

**Yes, but keep it simple:**

Current merge behavior (project overrides global) is correct. Extend it:

```
Final config = merge(
    defaults,                           // Built-in defaults
    ~/.config/chant/config.md,          // Global user config
    .chant/config.md,                   // Project config
    .chant/agents.md (parallel only),   // Local agents override
)
```

For `parallel.agents` specifically:
- If `.chant/agents.md` exists → use only those agents (full override)
- Else if global config has agents → use global agents
- Else if `.chant/config.md` has agents → use project agents (deprecated)
- Else → use default single agent

---

## Implementation Plan

### Phase 1: Core Changes (2 specs)

**Spec 1: Add agents.md support**
- Add `.chant/agents.md` to the default `.gitignore` template
- Create `load_agents()` function that checks:
  1. `.chant/agents.md`
  2. `~/.config/chant/config.md` (parallel section)
  3. `.chant/config.md` (parallel section, deprecated)
- Update `Config::load_merged()` to use new agent loading
- Update all callers to use `load_merged()` instead of `load()`

**Spec 2: Migration and warnings**
- Add `chant config migrate-agents` command
- Show deprecation warning when agents found in `.chant/config.md`
- Add secret detection with warnings

### Phase 2: Documentation (1 spec)

**Spec 3: Update documentation**
- Update CLAUDE.md config section
- Update docs/reference/config.md
- Add migration guide
- Update getting-started guide

### Phase 3: Init updates (1 spec)

**Spec 4: Update chant init**
- Add `agents.md` to `.gitignore` by default
- Create example `~/.config/chant/config.md` if it doesn't exist
- Show guidance about agent configuration during init wizard

---

## File Changes Summary

| File | Change |
|------|--------|
| `src/config.rs` | Add `load_agents()`, update merge logic |
| `src/main.rs` | Add `config migrate-agents` command, update init |
| `.chant/.gitignore` template | Add `agents.md` |
| `docs/reference/config.md` | Document new config locations |
| `CLAUDE.md` | Update configuration section |

---

## Acceptance Criteria

- [x] Analysis of current config architecture complete
- [x] All four options evaluated with pros/cons
- [x] Recommended design documented
- [x] All six questions answered
- [x] Migration path defined
- [x] Implementation plan with phased specs created