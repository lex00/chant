---
type: group
status: completed
model: claude-opus-4-5-20251101
completed_at: 2026-01-25T12:00:00Z
---
# Phase 2: Split cmd/work.rs into smaller modules

Current state: `src/cmd/work.rs` is 1336 lines of code with no tests. Split into focused modules under 800 lines each.

## Analysis

| Function | Lines | Purpose |
|----------|-------|---------|
| cmd_work | ~300 | Single spec execution |
| cmd_work_parallel | ~570 | Parallel execution with worktrees |
| finalize_spec | ~190 | Mark spec complete, update frontmatter |
| create_or_switch_branch | ~30 | Git branch operations |
| push_branch | ~60 | Push to remote |
| commit_transcript | ~65 | Save agent output |
| parse_model_from_claude_version | ~35 | Model detection |
| is_silent_mode | ~5 | Check .chant location |

## Phase 1: Extract finalization logic → `cmd/finalize.rs`

Move finalization-related functions (~300 lines):
- `finalize_spec()`
- `confirm_re_finalize()` (if exists)
- `get_commits_for_spec()` (if in work.rs)
- Related constants and helpers

**Acceptance Criteria:**
- [ ] `src/cmd/finalize.rs` created with finalization logic
- [ ] `work.rs` imports from `cmd::finalize`
- [ ] `just check` passes

## Phase 2: Extract parallel execution → `cmd/parallel.rs`

Move parallel execution (~600 lines):
- `cmd_work_parallel()`
- `ParallelResult` struct
- Worktree coordination logic

**Acceptance Criteria:**
- [ ] `src/cmd/parallel.rs` created with parallel execution
- [ ] `work.rs` re-exports or dispatches to parallel module
- [ ] `just check` passes

## Phase 3: Extract git helpers → `cmd/git_ops.rs`

Move git operation helpers (~100 lines):
- `create_or_switch_branch()`
- `push_branch()`
- `commit_transcript()`

**Acceptance Criteria:**
- [ ] `src/cmd/git_ops.rs` created
- [ ] Shared by work.rs and parallel.rs
- [ ] `just check` passes

## Phase 4: Verify and clean up

- Verify work.rs is under 800 lines
- Remove any dead code
- Ensure no circular dependencies

**Acceptance Criteria:**
- [ ] `work.rs` under 800 lines
- [ ] All modules under 800 lines
- [ ] `just check` passes
- [ ] No clippy warnings