---
type: code
status: pending
target_files:
  - src/git.rs
  - src/cmd/work.rs
  - src/worktree.rs
---

# Add ensure_on_main_branch safeguard to chant commands

## Problem

The main repo can get "flipped" off the main branch during various chant operations:

1. **`merge_and_cleanup`** (worktree.rs:199) - calls `git checkout main` in main repo, but if it fails mid-operation, state is unclear
2. **`create_or_switch_branch`** (git_ops.rs:11) - switches main repo to spec branch for single-spec branch mode
3. **Failed operations** - any interruption can leave main on wrong branch

Users expect the main repo to always be on `main` branch. Worktrees handle isolation; main should stay stable.

## Solution

Add an `ensure_on_main_branch()` helper that snaps the main repo back to main, and call it:

1. At the **start** of significant commands (work, merge, finalize)
2. At the **end** of commands (success or failure)
3. In error recovery paths

## Implementation

### Add helper to src/git.rs

```rust
/// Ensure the main repo is on the main branch.
///
/// Call this at command boundaries to prevent branch drift.
/// Uses config's main_branch setting (defaults to "main").
pub fn ensure_on_main_branch(main_branch: &str) -> Result<()> {
    let output = Command::new("git")
        .args(["branch", "--show-current"])
        .output()
        .context("Failed to get current branch")?;

    let current = String::from_utf8_lossy(&output.stdout).trim().to_string();

    if current != main_branch {
        let output = Command::new("git")
            .args(["checkout", main_branch])
            .output()
            .context("Failed to checkout main branch")?;

        if !output.status.success() {
            let stderr = String::from_utf8_lossy(&output.stderr);
            // Don't fail hard - just warn
            eprintln!("Warning: Could not return to {}: {}", main_branch, stderr);
        }
    }

    Ok(())
}
```

### Call sites

1. **cmd_work** - at end of single-spec execution
2. **cmd_work_parallel** - after merge phase completes
3. **merge_and_cleanup** - in error paths
4. **cmd_merge** - at start and end

### Config integration

Use `config.defaults.main_branch` (defaults to "main") to support repos with different default branches.

## Acceptance Criteria

- [ ] Add `ensure_on_main_branch(main_branch: &str)` to src/git.rs
- [ ] Call at end of `cmd_work` (single spec mode)
- [ ] Call at end of `cmd_work_parallel` (after merge phase)
- [ ] Call in `merge_and_cleanup` error recovery
- [ ] Warn but don't fail if checkout fails (dirty worktree, etc.)
- [ ] Use config's main_branch setting
- [ ] Add test for ensure_on_main_branch
