---
type: group
status: pending
labels:
- cursor-integration
- enhancement
target_files:
- src/commands/watch.rs
- src/commands/mod.rs
- src/main.rs
- src/config.rs
---
# Native Orchestrator - chant watch command for automated spec lifecycle management

## Problem

When running multiple agents via `chant work --parallel`, the command starts specs but exits. Users need an external loop to:
- Monitor when specs complete
- Run finalization
- Merge feature branches
- Handle failures with retries

This should be native to chant.

## Solution

Add `chant watch` - a monitoring daemon that reacts to spec state changes.

### Key Distinction from Existing Commands

| Command | Role | Behavior |
|---------|------|----------|
| `--chain` | Executor | Starts and runs specs sequentially |
| `--parallel` | Executor | Starts specs in parallel, then exits |
| `watch` | Monitor | Watches running specs, handles lifecycle |
| `dashboard` | Reporter | Shows status (read-only) |

`watch` doesn't start specs - it monitors specs already in-progress and handles their lifecycle events.

## Commands

```bash
chant watch              # Start monitoring loop
chant watch --dry-run    # Show what would happen, don't act
chant watch --once       # Single pass, then exit
```

## Event Loop

```
while running:
  for spec in in_progress_specs:
    if spec.is_completed():
      finalize(spec)
      if spec.on_branch():
        merge(spec)
    elif spec.is_failed():
      handle_failure(spec)

  sleep(poll_interval)
```

## Configuration

In `config.md`:

```yaml
watch:
  poll_interval_ms: 5000

  failure:
    max_retries: 3
    retry_delay_ms: 60000
    backoff_multiplier: 2.0
    retryable_patterns:
      - "rate_limit"
      - "timeout"
      - "connection refused"
      - "503"
    on_permanent_failure: skip  # skip | stop
```

### Failure Handling

1. **Transient errors** (match `retryable_patterns`): Wait with exponential backoff, then `chant resume`
2. **Permanent errors**: Based on `on_permanent_failure`:
   - `skip`: Log, mark spec as needs-attention, continue watching others
   - `stop`: Log, exit watch with error code

## Logging and Status Output

Structured output showing watch activity:

```
[12:34:56] Watching 3 in-progress specs: 00a-xyz, 00b-abc, 00c-def
[12:35:01] 00a-xyz completed → finalizing
[12:35:02] 00a-xyz finalized → merging branch chant/00a-xyz
[12:35:03] 00a-xyz merged to main ✓
[12:35:06] 00b-abc failed: rate_limit_exceeded
[12:35:06] 00b-abc retry scheduled (1/3) in 60s
[12:36:06] 00b-abc resuming...
[12:36:10] 00c-def completed → finalizing
[12:36:11] 00c-def finalized (no branch to merge)
[12:40:00] No in-progress specs, waiting...
```

Log file written to `.chant/logs/watch.log` with timestamps.

## Completion Detection

A spec is "completed" when:
1. All acceptance criteria are checked (`- [x]`)
2. Worktree has no uncommitted changes
3. Status is still `in_progress` (not yet finalized)

A spec is "failed" when:
1. Agent process exited
2. Spec status is `in_progress`
3. Acceptance criteria NOT all checked

## Acceptance Criteria

- [ ] `chant watch` command starts event loop
- [ ] Poll interval configurable via `watch.poll_interval_ms` (default 5000)
- [ ] Detects spec completion by checking acceptance criteria and worktree status
- [ ] Auto-finalize: runs `chant finalize <spec-id>` on completion
- [ ] Auto-merge: runs `chant merge <spec-id>` for specs on feature branches
- [ ] Failure detection: identifies failed specs (agent exited, criteria incomplete)
- [ ] Retry logic: exponential backoff with configurable max_retries and delay
- [ ] Retryable pattern matching against error output
- [ ] `on_permanent_failure` config: `skip` continues, `stop` exits
- [ ] `--dry-run` flag shows actions without executing
- [ ] `--once` flag runs single pass then exits
- [ ] Graceful shutdown on SIGINT/SIGTERM
- [ ] Structured log output to stdout with timestamps
- [ ] Log file written to `.chant/logs/watch.log`
- [ ] Exit code 0 if all specs succeeded, non-zero if any permanent failures
- [ ] **No new spec creation**: watch must not call `chant add` or `chant work <new-spec>`
- [ ] **No agent spawning**: watch only calls finalize, merge, resume (no Task tool usage)

## Agent Spawning Constraints

**Critical design principle**: `chant watch` is a *monitor*, not an *orchestrator that spawns work*.

### What Watch CAN Do
- Poll spec files and worktree status (read-only observation)
- Run `chant finalize` (metadata update, no agent)
- Run `chant merge` (git operation, no agent)
- Run `chant resume` for failed specs (restarts existing spec's agent)
- Write logs

### What Watch CANNOT Do
- Start new specs (`chant work <new-spec>`)
- Create specs (`chant add`)
- Spawn sub-agents or background tasks
- Make decisions about *what* to work on next
- Modify spec content (acceptance criteria, description)

### Why These Constraints Matter

Without clear boundaries, monitoring systems tend to grow into "smart" orchestrators that:
1. Spawn agents to "help" with failing specs
2. Create new specs to "fix" detected issues
3. Chain into unrelated work when specs complete
4. Make autonomous decisions the user didn't request

This leads to runaway agent spawning, wasted compute, and unpredictable behavior.

### Separation of Concerns

| Concern | Responsible Command |
|---------|---------------------|
| Deciding what to work on | User (manual) or `--chain`/`--parallel` |
| Starting agent work | `chant work` |
| Monitoring running work | `chant watch` |
| Lifecycle actions (finalize/merge) | `chant watch` or user |
| Creating new specs | User or external automation |

### Resume vs New Work

`chant resume` is allowed because it:
- Continues an *existing* spec the user already approved
- Uses the *same* agent configuration
- Doesn't change scope or create new work

If a spec fails permanently, watch should mark it `needs_attention` and notify—not spawn investigative agents or create fix specs.

## Out of Scope (Future)

- Desktop/webhook notifications (add later as `--notify` flag)
- Prompt-based behavior customization (config.md is sufficient)
- Cleanup of stale artifacts (use existing `chant cleanup` command)
- Starting new specs (use `--chain` or `--parallel` for that)
- "Smart" orchestration that decides what to work on next