---
type: code
status: completed
depends_on: []
target_files:
- src/cmd/watch.rs
- Possibly src/spec.rs for worktree/criteria utilities
commits:
- e391cb6
completed_at: 2026-01-31T15:18:46Z
model: sonnet
---
# Spec completion and failure detection

Implement functions to detect whether a spec is completed (ready for finalization) or failed (agent exited with incomplete criteria).

### Inherited Context

- Watch is monitor-only: detection must be read-only observation
- Cannot modify spec content or spawn agents

### Acceptance Criteria

- [x] `is_completed(spec_id) -> Result<bool>` checks all criteria `[x]` and worktree clean
- [x] `is_failed(spec_id) -> Result<bool>` checks agent exited, status `in_progress`, criteria incomplete
- [x] Worktree check uses `git status --porcelain` for uncommitted changes
- [x] Criteria parsing handles malformed markdown gracefully
- [x] Returns error if spec file unreadable or worktree inaccessible

### Edge Cases

- Spec with no acceptance criteria: Treat as completed if worktree clean
- Agent still running: `is_failed()` returns false
- Spec already finalized: `is_completed()` returns false (status not `in_progress`)
- Worktree has untracked files: Should this count as dirty? (Assume yes for safety)

### Example Test Cases

- Spec with all `[x]`, clean worktree → `is_completed()` = true
- Spec with `[ ]`, agent exited → `is_failed()` = true
- Spec with all `[x]`, dirty worktree → `is_completed()` = false


- `is_completed(spec_id: &str) -> Result<bool>` - Errors on I/O failure
- `is_failed(spec_id: &str) -> Result<bool>` - Errors on I/O failure

---