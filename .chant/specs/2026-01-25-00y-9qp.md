---
type: group
status: in_progress
---
# Refactor large files into smaller modules

Reduce main.rs (7302 lines), spec.rs (1498 lines), and merge.rs (813 lines) to under 800 lines each by extracting logical modules into `src/cmd/` directory.

## Phase 1: Scaffold cmd/ module

Create `src/cmd/mod.rs` with submodule declarations. Update `main.rs` to include `mod cmd;`. No code movement yet - just establish the module structure.

**Acceptance Criteria:**
- [ ] `src/cmd/mod.rs` exists with placeholder submodule declarations
- [ ] `main.rs` has `mod cmd;` declaration
- [ ] `just check` passes

## Phase 2: Extract agent invocation

Move to `src/cmd/agent.rs` (~400 lines):
- `get_model_provider()`
- `invoke_agent()`, `invoke_agent_with_prefix()`, `invoke_agent_with_model()`
- `extract_text_from_stream_json()`
- Related streaming/callback handling

**Acceptance Criteria:**
- [ ] `src/cmd/agent.rs` contains all agent invocation logic
- [ ] `main.rs` imports and uses functions from `cmd::agent`
- [ ] `just check` passes

## Phase 3: Extract spec commands

Move to `src/cmd/spec.rs` (~800 lines):
- `cmd_add()`, `cmd_list()`, `cmd_show()`, `cmd_ready()`
- `cmd_lint()`, `cmd_status()`, `cmd_delete()`
- `format_yaml_value()`, `key_to_title_case()`
- Spec display formatting utilities

**Acceptance Criteria:**
- [ ] `src/cmd/spec.rs` contains spec management commands
- [ ] `main.rs` dispatches to `cmd::spec` functions
- [ ] `just check` passes

## Phase 4: Extract work execution

Move to `src/cmd/work.rs` (~1200 lines):
- `cmd_work()`, `cmd_work_parallel()`
- `finalize_spec()`, `re_finalize_spec()`
- `get_commits_for_spec()`
- Worktree management during execution

**Acceptance Criteria:**
- [ ] `src/cmd/work.rs` contains work execution logic
- [ ] `main.rs` dispatches to `cmd::work` functions
- [ ] `just check` passes

## Phase 5: Extract lifecycle commands

Move to `src/cmd/lifecycle.rs` (~600 lines):
- `cmd_merge()`, `cmd_archive()`
- `cmd_split()`, `cmd_diagnose()`
- `cmd_log()`, `lookup_log_file()`
- Branch/PR operations

**Acceptance Criteria:**
- [ ] `src/cmd/lifecycle.rs` contains lifecycle commands
- [ ] `main.rs` dispatches to `cmd::lifecycle` functions
- [ ] `just check` passes

## Phase 6: Extract driver/group logic from spec.rs

Move to `src/spec_group.rs` (~300 lines):
- `is_member_of()`, `get_members()`, `extract_driver_id()`, `extract_member_number()`
- `all_members_completed()`, `get_incomplete_members()`, `all_prior_siblings_completed()`
- `mark_driver_in_progress()`, `auto_complete_driver_if_ready()`

**Acceptance Criteria:**
- [ ] `src/spec_group.rs` contains all driver/group orchestration logic
- [ ] `spec.rs` imports from `spec_group` where needed
- [ ] `just check` passes
- [ ] `spec.rs` is under 1200 lines

## Phase 7: Clean up merge.rs duplication

Remove duplicate functions from merge.rs:
- Remove duplicate `is_member_of()` - import from `spec_group`
- Remove duplicate sequence extraction functions - import from `spec`
- Consolidate any other duplicated logic

**Acceptance Criteria:**
- [ ] No duplicate functions between merge.rs and spec.rs/spec_group.rs
- [ ] `merge.rs` is under 700 lines
- [ ] `just check` passes