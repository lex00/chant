---
type: code
status: cancelled
labels:
- cursor-integration
- enhancement
target_files:
- src/commands/cost.rs
- src/commands/mod.rs
- src/main.rs
- src/spec.rs
- src/config.rs
---
# Cost Tracking - Track token usage and costs per spec

## Problem

Users have no visibility into token usage and costs per spec. This makes it hard to:
- Budget AI usage
- Identify expensive specs
- Compare model cost-effectiveness
- Track spending over time

## Solution

Add cost tracking that:
1. Stores token usage in spec frontmatter (input_tokens, output_tokens)
2. Calculates costs based on configurable pricing
3. Provides `chant cost` command for reporting

## Token Storage (Frontmatter)

```yaml
tokens:
  input: 45000
  output: 12000
  total: 57000
cost_usd: 0.42
```

Tokens are recorded by the agent during execution (via MCP tool or CLI flag).

## Pricing Configuration

In `~/.config/chant/config.md`:

```yaml
pricing:
  claude-opus-4:
    input_per_million: 15.00
    output_per_million: 75.00
  claude-sonnet-4:
    input_per_million: 3.00
    output_per_million: 15.00
  claude-haiku-4:
    input_per_million: 0.25
    output_per_million: 1.25
```

## Commands

### `chant cost`
Shows cost summary:
```
Cost Summary (last 7 days)
--------------------------
Total: $12.45 (234,567 tokens)

By Model:
  claude-opus-4:   $8.20 (54%)
  claude-sonnet-4: $4.25 (46%)

By Status:
  Completed: $10.20 (82%)
  Failed:    $2.25 (18%)

Top 5 Specs:
  00a-xyz: $2.10 (auth refactor)
  00b-abc: $1.80 (api migration)
  ...
```

### `chant cost <spec-id>`
Shows cost for specific spec:
```
Spec 00a-xyz: Auth Refactor
-----------------------------
Model: claude-opus-4
Tokens: 45,000 input / 12,000 output
Cost: $2.10

Execution History:
  Run 1: $0.80 (failed)
  Run 2: $1.30 (completed)
```

### `chant cost --since <duration>`
Filter by time: `1d`, `1w`, `1m`, `all`

### `chant cost --format json`
JSON output for tooling integration

## MCP Tool: `chant_record_tokens`

New MCP tool for agents to report token usage:
```json
{
  "tool": "chant_record_tokens",
  "input": {
    "spec_id": "00a-xyz",
    "input_tokens": 45000,
    "output_tokens": 12000
  }
}
```

## Acceptance Criteria

- [ ] Token fields added to spec frontmatter schema (input_tokens, output_tokens, cost_usd)
- [ ] Pricing configuration in config.md with per-model rates
- [ ] `chant cost` command shows summary (total, by model, by status, top specs)
- [ ] `chant cost <spec-id>` shows detailed cost for single spec
- [ ] `--since` flag for time filtering (1d, 1w, 1m, all)
- [ ] `--format json` flag for JSON output
- [ ] `chant_record_tokens` MCP tool for agents to report usage
- [ ] Cost calculation from tokens and pricing config
- [ ] Handle missing token data gracefully (show "unknown")
- [ ] Unit tests for cost calculation and formatting