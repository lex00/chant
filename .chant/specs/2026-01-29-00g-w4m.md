---
type: code
status: completed
target_files:
- src/spec.rs
- src/cmd/finalize.rs
- src/cmd/work.rs
- docs/reference/spec-format.md
commits:
- '3998064'
completed_at: 2026-01-29T17:26:26Z
model: opus
---
# Add structured output validation for specs

## Problem

Agent output inconsistency was observed in multi-spec execution:
- **Consistent**: Specs C.1.1, C.1.2, C.1.3, C.2.4 all included `spec_id` field
- **Missing**: Specs C.1.4, C.2.1, C.2.2, C.2.3, C.2.5, C.3.1-C.3.4 omitted `spec_id` field
- **Pattern**: B-series reports were consistent, C-series were not

**Root causes identified:**
1. **No enforced schema** - Agents generate JSON freeform based on context
2. **Different agent instances** - claude2 vs claude3 may format differently
3. **Prompt drift** - The "standard" prompt doesn't mandate specific fields
4. **No validation** - Chant accepts any agent output without validation

This creates downstream problems:
- Post-processing scripts fail when expected fields are missing
- Data aggregation across specs becomes unreliable
- No feedback to agent that output was malformed

## Solution

Add structured output validation to chant specs with three approaches:

### 1. Output Schema Definition (Frontmatter)

Add optional `output_schema` field to spec frontmatter:

```yaml
---
type: task
status: ready
output_schema: .chant/schemas/research-report.json
---
```

The schema file would be a JSON Schema (draft 2020-12):

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "required": ["spec_id", "findings", "recommendation"],
  "properties": {
    "spec_id": {
      "type": "string",
      "pattern": "^[A-Z]\\.[0-9]+\\.[0-9]+$"
    },
    "findings": {
      "type": "array",
      "items": {"type": "string"},
      "minItems": 1
    },
    "recommendation": {
      "type": "string"
    }
  }
}
```

### 2. Prompt Enhancement

When `output_schema` is present, automatically inject schema requirements into the agent prompt:

```markdown
## Output Format

Your output MUST be valid JSON matching this schema:

{schema_content}

Required fields: spec_id, findings, recommendation

Example:
{
  "spec_id": "C.1.1",
  "findings": ["Root cause identified in state management"],
  "recommendation": "Add locking mechanism"
}
```

### 3. Validation Points

Agent output validation can happen at multiple points:

#### A. Post-Execution (Immediate)

Validate during/after spec execution, before finalization:

```rust
// In finalize.rs or work.rs after agent completes
if let Some(schema_path) = spec.frontmatter.output_schema {
    match validate_agent_output(&spec_id, &schema_path) {
        Ok(()) => println!("✓ Output validation passed"),
        Err(e) => {
            eprintln!("✗ Output validation failed: {}", e);
            eprintln!("  → Agent output does not match required schema");
            eprintln!("  → Review .chant/logs/{}.log for details", spec_id);

            // Options:
            // 1. Mark spec as needs_attention
            // 2. Fail the spec execution
            // 3. Warn but allow (configurable)

            if config.strict_output_validation {
                spec.frontmatter.status = SpecStatus::NeedsAttention;
                return Err(anyhow!("Output validation failed"));
            }
        }
    }
}
```

#### B. Linter Integration (Batch)

Extend `chant lint` to validate agent output for completed specs:

```rust
// In cmd_lint(), add new check:

// Check output_schema validation for completed specs
if spec.frontmatter.status == SpecStatus::Completed {
    if let Some(schema_path) = &spec.frontmatter.output_schema {
        match validate_agent_output(&spec.id, schema_path) {
            Ok(()) => {
                // Validation passed
            }
            Err(e) => {
                spec_issues.push(format!("Output validation failed: {}", e));
            }
        }
    }
}
```

**Usage:**
```bash
# Validate all specs including output schemas
chant lint

# Output:
# ✓ C.1.1: All checks passed
# ✓ C.1.2: All checks passed
# ✗ C.1.4: Output validation failed: missing required field 'spec_id'
# ✗ C.2.1: Output validation failed: missing required field 'spec_id'
```

**Benefits of linter approach:**
- Batch validation across all specs
- Can run anytime (CI/CD, pre-commit, manual)
- Doesn't block spec execution (validates after the fact)
- Identifies patterns (e.g., "C-series specs consistently missing spec_id")

**Trade-off:**
- Post-hoc validation means agent already finished
- No immediate feedback to retry with corrected output
- Good for auditing, not good for real-time enforcement

**Recommendation:** Use both!
- **Post-execution validation**: Immediate feedback, retry opportunity
- **Linter validation**: Batch auditing, CI/CD integration

### 4. Validation Modes (Config)

Add config option for validation strictness:

```yaml
## validation

- strict_output_validation: true  # Fail spec if output doesn't match schema
- strict_output_validation: false # Warn but allow (default)
```

## Implementation Plan

1. **Add `output_schema` field to `SpecFrontmatter`**
   - Optional `String` field in frontmatter struct
   - Parsed during spec loading

2. **Create JSON Schema validation module**
   - Add `jsonschema` crate dependency
   - Module: `src/validation.rs` or in `src/spec.rs`
   - Function: `validate_agent_output(spec_id: &str, schema_path: &Path) -> Result<()>`
   - Extract JSON from agent output (look for code blocks, or parse entire output)

3. **Inject schema into prompts**
   - When `output_schema` is present, read the schema file
   - Add "Output Format" section to agent prompt with:
     - Schema definition
     - Required fields list
     - Example output
   - Location: `src/cmd/work.rs` where prompts are assembled

4. **Add post-execution validation**
   - After agent completes, before finalization
   - Validate output against schema if `output_schema` present
   - Handle validation failures based on config (fail vs warn)

5. **Add config option**
   - `validation.strict_output_validation: bool` in config
   - Default: false (warn only, for backward compatibility)

6. **Update documentation**
   - Add section in `docs/reference/spec-format.md` on `output_schema`
   - Include JSON Schema examples
   - Document validation modes

## Example Usage

**Create schema file:**
```bash
cat > .chant/schemas/research-report.json <<'EOF'
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "required": ["spec_id", "root_cause", "affected_files"],
  "properties": {
    "spec_id": {"type": "string"},
    "root_cause": {"type": "string"},
    "affected_files": {
      "type": "array",
      "items": {"type": "string"}
    }
  }
}
EOF
```

**Create spec with schema:**
```yaml
---
type: task
status: ready
output_schema: .chant/schemas/research-report.json
---

# Research issue #1234

Investigate root cause and produce structured report.
```

**Work the spec:**
```bash
chant work <spec-id>
# Agent sees schema in prompt, produces conforming output
# Validation runs automatically after completion
# ✓ Output validation passed
```

**If validation fails:**
```bash
chant work <spec-id>
# ✗ Output validation failed: missing required field 'spec_id'
#   → Agent output does not match required schema
#   → Review .chant/logs/<spec-id>.log for details
# [spec marked as needs_attention if strict mode enabled]
```

## Alternative: Inline Schema

For simple cases, allow inline schema in frontmatter:

```yaml
---
type: task
output_format:
  required_fields:
    - spec_id
    - findings
    - recommendation
  example: |
    {
      "spec_id": "C.1.1",
      "findings": ["..."],
      "recommendation": "..."
    }
---
```

This is simpler than JSON Schema but less powerful.

## Acceptance Criteria

- [x] Add `output_schema` optional field to `SpecFrontmatter` struct
- [x] Implement JSON Schema validation module (use `jsonschema` crate)
- [x] Extract JSON from agent output (handle code blocks, plain JSON)
- [x] Inject schema into agent prompt when `output_schema` present
- [x] Validate output after spec execution, before finalization (post-execution validation)
- [x] Add output validation check to `chant lint` command (batch validation)
- [x] Add `validation.strict_output_validation` config option
- [x] Handle validation failures (warn vs fail based on config)
- [x] Add clear error messages showing what's missing/wrong
- [x] Linter reports which specs have output validation issues
- [x] Update `docs/reference/spec-format.md` with `output_schema` documentation
- [x] Include JSON Schema examples in docs
- [x] Add integration test with valid and invalid outputs
- [x] All existing tests pass
- [x] Run `cargo fmt` and `cargo clippy`

## Files to Create/Modify

- `src/spec.rs` - Add `output_schema` to frontmatter, validation logic
- `src/cmd/work.rs` - Inject schema into prompts, call post-execution validation
- `src/cmd/finalize.rs` - Validation in finalization flow
- `src/cmd/spec.rs` - Add output validation check to `cmd_lint()` function
- `src/config.rs` - Add `validation.strict_output_validation` config
- `Cargo.toml` - Add `jsonschema` dependency
- `docs/reference/spec-format.md` - Document `output_schema` field
- `.chant/schemas/` - Create directory for example schemas (optional)
- `tests/integration_tests.rs` - Add validation tests (both immediate and linter)

## Agent Output

2026-01-29T17:26:26Z

```
I'll start by reading the relevant code files to understand the current structure before implementing the output schema validation feature.
Now let me continue reading the spec.rs file to see the rest of it, and also read the cmd/work.rs and cmd/spec.rs files.
Let me search for specific relevant parts of the code:
Let me search for prompt-related code and the lint function:
Now let me check the lib.rs to understand the module structure, and look at the docs directory:
Now let me look at the agent.rs module and the work.rs execution flow to understand how agent output is handled:
Now I have a good understanding of the codebase. Let me update my todo list and start implementing:
Let me start by adding the `output_schema` field to the `SpecFrontmatter` struct and updating the `has_frontmatter_field` method:
Now let me update the `has_frontmatter_field` method to include the new field:
Now let me add the `jsonschema` crate to Cargo.toml:
Now let me create the validation module. I'll create a new file `src/validation.rs`:
Now let me add the validation module to lib.rs:
Now let me add the config option for strict validation. First, let me read the relevant parts of config.rs:
Now I'll add a `ValidationConfig` struct and update the `Config` struct:
Now let me add the validation field to the Config struct:
Now I need to update the PartialConfig struct and merge logic. Let me find the relevant section:
Now let me update the prompt.rs to inject the schema into prompts when `output_schema` is present:
Now I need to modify the `substitute` function to inject the output schema section when present:
Now let me update the test config in prompt.rs to include the new validation field:
Now let me update the todo list and add post-execution validation in work.rs:
Now let me add post-execution validation in work.rs. I need to find the right place after agent execution but before finalization:
Now let me find the location after the agent executes to add the validation. I need to look at the code where `agent_output` is captured and before finalization:
Now I need to add the output schema validation right after the lint check and before finalization. Let me find the right spot:
Now let me update the todo and add output validation to the chant lint command:
Now let me add output validation to the `cmd_lint()` function. Let me first read the lint function:
Now let me check what imports are at the top of cmd/spec.rs:
Now let me add the output validation to the `cmd_lint()` function. I'll add it after the approval schema validation and before combining all warnings:
Now I need to add the `validate_output_schema` function. Let me find the other validation functions:
Now let me add the `validate_output_schema` function after `validate_approval_schema`:
Now let me update the documentation. First, let me update the todo and then modify the schema.md docs:
Now let me add integration tests. Let me first check the existing test structure:
Let me read more of the integration tests to understand the pattern:
Now let me check how many lines are in the file and find a good place to add the validation tests:
The tests in integration_tests.rs seem to test CLI commands. I'll add a section for output schema validation tests. Let me add them at the end:
Now let me run cargo fmt, clippy, and tests:
I need to fix the validation error. The jsonschema API seems to be different. Let me check how to properly iterate over the errors:
Let me check the jsonschema crate usage:
Let me look at the Validator struct and its validate method:
I see! I need to use `iter_errors` instead of `validate` for getting all errors. Let me fix the validation.rs file:
Now let me fix the unused variable warning too:
The warnings are minor and not related to my changes. Let me fix the clippy warnings in my code:
Now I can remove the unused _fence_start variable:
The warning is in existing code, not my changes. Now let me run the tests:
I need to fix the missing field errors in the test configs. Let me find and fix them:
Now let me find and fix the other one in work.rs:
Let me wait for all tests to complete:
All tests pass. Now let me check off the acceptance criteria in the spec file and commit:
Now let me check off all the acceptance criteria:
Now let me add the model field to the frontmatter and commit:
Now let me commit the changes:
I'll continue with committing the changes. Let me first check the git status and recent commits to follow the repository's commit style.
Now I'll stage all the files and commit with the appropriate message format.
The implementation is complete. All tasks have been finished:

**Summary of changes:**
- Added `output_schema` optional field to `SpecFrontmatter` struct in `src/spec.rs`
- Created new `src/validation.rs` module with JSON Schema validation logic
- Added `jsonschema = "0.26"` dependency to `Cargo.toml`
- Added `OutputValidationConfig` with `strict_output_validation` option in `src/config.rs`
- Modified `src/prompt.rs` to inject schema re

... (output truncated, 5435 chars total)```
