---
type: code
status: pending
target_files:
  - src/derivation.rs
---

# Add unit tests for special characters in values

## Problem

No unit tests verify derivation handles special characters correctly (quotes, commas, slashes, regex metacharacters).

**Gap:** Values containing special characters untested.

## Solution

Add unit tests to src/derivation.rs that verify correct handling of:
- Branch names with slashes, hyphens, dots
- Environment variable values with spaces, quotes, commas
- Path separators in different contexts
- Regex metacharacters in values (not patterns)

## Test Cases

```rust
#[test]
fn test_branch_with_special_characters() {
    // Branch: feature/ABC-123/user-name.test
    let context = DerivationContext {
        branch_name: Some("feature/ABC-123/user-name.test".to_string()),
        ..default_context()
    };

    let mut derived = HashMap::new();
    derived.insert("ticket".to_string(), DerivedFieldConfig {
        from: DerivationSource::Branch,
        pattern: "([A-Z]+-\\d+)".to_string(),
        validate: None,
    });

    let config = EnterpriseConfig { derived, required: vec![] };
    let engine = DerivationEngine::new(config);
    let result = engine.derive_fields(&context);

    assert_eq!(result.get("ticket"), Some(&"ABC-123".to_string()));
}

#[test]
fn test_env_value_with_spaces_and_quotes() {
    let mut env_vars = HashMap::new();
    env_vars.insert("TEAM_NAME".to_string(), "Platform Team".to_string());
    env_vars.insert("DESCRIPTION".to_string(), "This is a \"test\" value".to_string());

    let context = DerivationContext {
        env_vars,
        ..default_context()
    };

    let mut derived = HashMap::new();
    derived.insert("team".to_string(), DerivedFieldConfig {
        from: DerivationSource::Env,
        pattern: "TEAM_NAME".to_string(),
        validate: None,
    });
    derived.insert("desc".to_string(), DerivedFieldConfig {
        from: DerivationSource::Env,
        pattern: "DESCRIPTION".to_string(),
        validate: None,
    });

    let config = EnterpriseConfig { derived, required: vec![] };
    let engine = DerivationEngine::new(config);
    let result = engine.derive_fields(&context);

    assert_eq!(result.get("team"), Some(&"Platform Team".to_string()));
    assert_eq!(result.get("desc"), Some(&"This is a \"test\" value".to_string()));
}

#[test]
fn test_path_with_dots_and_hyphens() {
    let context = DerivationContext {
        spec_path: Some(PathBuf::from(".chant/specs/platform-team/feature.v2.md")),
        ..default_context()
    };

    let mut derived = HashMap::new();
    derived.insert("component".to_string(), DerivedFieldConfig {
        from: DerivationSource::Path,
        pattern: "specs/([^/]+)/".to_string(),
        validate: None,
    });

    let config = EnterpriseConfig { derived, required: vec![] };
    let engine = DerivationEngine::new(config);
    let result = engine.derive_fields(&context);

    assert_eq!(result.get("component"), Some(&"platform-team".to_string()));
}

#[test]
fn test_value_with_regex_metacharacters() {
    // Value contains regex metacharacters but they're literal in the VALUE, not pattern
    let context = DerivationContext {
        branch_name: Some("feature/fix-[bug]-in-(parser)".to_string()),
        ..default_context()
    };

    let mut derived = HashMap::new();
    derived.insert("description".to_string(), DerivedFieldConfig {
        from: DerivationSource::Branch,
        pattern: "feature/(.+)".to_string(),
        validate: None,
    });

    let config = EnterpriseConfig { derived, required: vec![] };
    let engine = DerivationEngine::new(config);
    let result = engine.derive_fields(&context);

    assert_eq!(result.get("description"), Some(&"fix-[bug]-in-(parser)".to_string()));
}
```

## Acceptance Criteria

- [ ] Add 4+ tests to src/derivation.rs tests module
- [ ] Test branch names with /, -, . characters
- [ ] Test env var values with spaces and quotes
- [ ] Test paths with dots and hyphens
- [ ] Test values containing regex metacharacters
- [ ] All tests verify exact value preservation
- [ ] Tests pass: `cargo test test.*special_characters`