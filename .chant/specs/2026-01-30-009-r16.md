---
type: code
status: completed
target_files:
- src/main.rs
commits:
- f384fe1
completed_at: 2026-01-30T11:59:10Z
model: opus
---
# Fix handle_agent_update to create MCP config

## Bug

When updating agent configuration on an existing project via the wizard path:
```
chant init → "Add/update agent configuration" → "Claude Code (CLAUDE.md)"
```

The `.mcp.json` file is NOT created, even though the agent template is written.

**Root cause**: `handle_agent_update()` (lines 952-1029 in `src/main.rs`) only writes the template file. It doesn't call `update_claude_mcp_config()` or create `.mcp.json` like the fresh init path does (lines 1805-1878).

## Acceptance Criteria

- [x] `handle_agent_update()` calls `update_claude_mcp_config()` for providers that support MCP
- [x] `handle_agent_update()` creates local `.mcp.json` reference copy for MCP providers
- [x] Print appropriate status messages (same as fresh init path)
- [x] All tests pass

## Agent Output

2026-01-30T11:59:10Z

```
I'll start by reading the relevant code to understand the current implementation and then fix the bug.
Now I understand the issue. The fresh init path (lines 1805-1878) creates the MCP config for providers that support it, but `handle_agent_update()` (lines 952-1029) doesn't include this logic.

Let me also check the `update_claude_mcp_config` function and the `AgentProvider` trait to understand how to check for MCP support.
Now I have a good understanding of the code. I need to add the MCP config creation logic to `handle_agent_update()`. Let me create the fix.
No clippy warnings. Let me run the tests.
Let me check the end of the test output to confirm all tests passed.
All tests pass. Now let me update the acceptance criteria in the spec.
Now I need to add the model to the spec frontmatter since all acceptance criteria are met.
The git status shows some other spec files are modified but those are unrelated to this spec. The files I modified (`src/main.rs` and `.chant/specs/2026-01-30-009-r16.md`) have been committed.
## Summary

I've fixed the bug in `handle_agent_update()` by adding the MCP config creation logic that was missing. The changes:

1. **Added MCP config creation** to `handle_agent_update()` (src/main.rs:1028-1103) - The function now:
   - Checks if any provider supports MCP via `provider.mcp_config_filename().is_some()`
   - Calls `update_claude_mcp_config()` to update the global `~/.claude/mcp.json`
   - Creates the local `.mcp.json` reference copy in the project directory
   - Prints the same status messages as the fresh init path
   - Only creates one MCP config file (breaks after first MCP-capable provider)

2. **All acceptance criteria met:**
   - ✅ `handle_agent_update()` calls `update_claude_mcp_config()` for providers that support MCP
   - ✅ `handle_agent_update()` creates local `.mcp.json` reference copy for MCP providers
   - ✅ Print appropriate status messages (same as fresh init path)
   - ✅ All tests pass

3. **Code formatted and linted** with `cargo fmt` and `cargo clippy`

4. **Committed** with message: `chant(2026-01-30-009-r16): Fix handle_agent_update to create MCP config````
