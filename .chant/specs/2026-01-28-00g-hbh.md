---
type: code
status: in_progress
model: claude-opus-4-5-20251101
---
# Fix test_parallel_work_and_merge_workflow integration test failure

## Problem

After fixing the unit test git repo issues in spec 2026-01-28-00f-vyo, a new integration test failure appeared in CI:

**Test:** `test_parallel_work_and_merge_workflow` (line 4361 in `tests/integration_tests.rs`)

**Error in CI:**
```
Error: Main branch 'main' does not exist

Context:
  - Expected main branch: main
  - This is typically 'main' or 'master'

thread 'test_parallel_work_and_merge_workflow' panicked at tests/integration_tests.rs:4361:5:
Merge of spec1 should succeed
```

**Root cause:** The test creates a temporary git repository using `setup_test_repo()` and then tries to merge a spec branch back to `main`. However, the git repository setup might not be creating the `main` branch correctly, or the merge logic expects `main` to exist but it doesn't in the test environment.

This test was passing before the changes in spec 00f-vyo, suggesting either:
1. A race condition revealed by marking other tests `#[serial]`
2. The test setup doesn't properly initialize the `main` branch
3. The merge logic has a pre-existing bug that's now surfacing

## Solution

Investigate and fix the test:

1. Read the `test_parallel_work_and_merge_workflow` test code
2. Read the `setup_test_repo()` helper to understand git repo initialization
3. Check if `main` branch is created during setup
4. Ensure the merge operation can find the `main` branch
5. Fix the test or the helper function to ensure `main` branch exists

Options:
- **A)** Fix `setup_test_repo()` to explicitly create and checkout `main` branch
- **B)** Fix the test to create `main` branch before merge
- **C)** Mark this test with `#[serial]` if it's a race condition

## Acceptance Criteria

- [x] Read `test_parallel_work_and_merge_workflow` test code
- [x] Read `setup_test_repo()` helper implementation
- [x] Identify why `main` branch doesn't exist during merge
- [x] Implement fix (A, B, or C)
- [x] Run the specific test locally and verify it passes
- [x] Run full integration test suite and verify all pass
- [x] Commit with spec ID reference
- [x] All tests passing
- [x] Code linted and formatted