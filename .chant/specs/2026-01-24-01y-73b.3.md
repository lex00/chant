---
type: code
status: completed
depends_on:
- 2026-01-24-01y-73b.2
target_files:
- src/git.rs
- tests/
model: claude-haiku-4-5-20251001
---
# Implement single spec merge with branching and return logic

Core merge operation for individual specs with proper branch handling.

### Acceptance Criteria

- [x] Implement `merge_single_spec(spec_id, branch_name, main_branch, delete_branch, dry_run)` function in src/git.rs that:
  - Saves current branch name via `get_current_branch()`
  - Checks out main branch with `git checkout {main_branch}`
  - Performs merge with `git merge --ff-only {spec_branch}` (fail if not fast-forward)
  - On successful merge: optionally deletes branch with `git branch -d {spec_branch}` if `--delete-branch` specified
  - Returns to original branch with `git checkout {original_branch}`
  - In dry-run mode: skip actual git commands but show what would happen
- [x] Add error handling for:
  - Main branch doesn't exist → Clear error message
  - Merge conflicts → Abort merge, return to original branch, show error
  - Checkout failures → Return to original branch before failing
  - Branch deletion failures → Log warning but don't fail overall merge
- [x] Implement `format_merge_summary(spec_id, success, dry_run)` to display results
- [x] Add integration tests verifying merge behavior with mock git repos
- [x] Code compiles and existing tests still pass

### Edge Cases

- Edge case 1: Main branch doesn't exist → Error before attempting checkout
- Edge case 2: Merge has conflicts → Abort cleanly, return to original branch
- Edge case 3: User on detached HEAD → Successfully return to detached HEAD after merge
- Edge case 4: Spec branch was already deleted → Error with helpful message
- Edge case 5: `--delete-branch` specified but branch deletion fails → Log warning, don't fail merge
- Edge case 6: Dry-run mode → No git commands execute, only preview shown

### Example Test Cases

For this feature, verify:
- Case 1: Merge spec branch to main with fast-forward succeeds
- Case 2: Dry-run shows what would merge without changing git state
- Case 3: After merge, user returns to original branch
- Case 4: Merge with conflicts aborts and returns to original branch
- Case 5: `--delete-branch` removes branch after successful merge
- Case 6: User on detached HEAD is returned to detached HEAD