---
type: code
status: completed
target_files:
- src/cmd/lifecycle.rs
- src/cmd/commits.rs
completed_at: 2026-01-27T21:23:03Z
model: haiku
---
# Fix commit pattern matching in reconciliation logic

## Problem

**User Report:** "The tool consistently reported 'No commits found matching pattern' even when commits existed with the correct format on branches."

When running `chant merge` or `chant work --parallel` followed by merge, the commit detection logic fails to find commits on spec branches even though they exist with the correct `chant(SPEC-ID):` format.

**Real Example from User:**
```bash
$ git log chant/2026-01-27-04k-yo0 --oneline
abc1234 chant(2026-01-27-04k-yo0): Implement feature
def5678 Initial commit

$ chant merge 2026-01-27-04k-yo0
Error: No commits found matching pattern 'chant(2026-01-27-04k-yo0):'
```

**User Confirmation:**
- Format used: `chant(2026-01-27-04k-yo0): description` - full spec IDs, exact format
- No variation: Every commit followed this pattern precisely
- Bug confirmed: Tool said "No commits found" but `git log` clearly shows commits exist

This breaks the reconciliation workflow and requires manual intervention.

## Root Cause Analysis

Likely causes:
1. Pattern matching is case-sensitive but commits use different case
2. Pattern doesn't account for full vs short spec IDs
3. Whitespace handling differences
4. Branch name resolution fails before commit scanning
5. Pattern expects exact format but commits have variations

## Solution

**Investigation Steps:**
1. Read src/cmd/lifecycle.rs and src/cmd/commits.rs to find commit pattern logic
2. Identify where pattern is constructed and where matching happens
3. Check if pattern handles both full and short spec IDs
4. Verify branch resolution works correctly
5. Add debug logging to see actual pattern vs actual commit messages

**Fix:**
- Ensure pattern is case-insensitive or normalized
- Handle both `chant(2026-01-27-001-abc):` and `chant(001-abc):` formats
- Trim whitespace from commit messages before matching
- Add better error messages showing what pattern was tried
- Add unit tests for various commit message formats

## Test Cases

```rust
#[test]
fn test_commit_pattern_matches_full_spec_id() {
    let commits = vec![
        "chant(2026-01-27-001-abc): Fix bug".to_string(),
        "chant(2026-01-27-001-abc): Add tests".to_string(),
    ];
    let pattern = build_commit_pattern("2026-01-27-001-abc");
    let matches = filter_commits_by_pattern(&commits, &pattern);
    assert_eq!(matches.len(), 2);
}

#[test]
fn test_commit_pattern_matches_short_spec_id() {
    let commits = vec![
        "chant(001-abc): Fix bug".to_string(),
    ];
    let pattern = build_commit_pattern("2026-01-27-001-abc");
    let matches = filter_commits_by_pattern(&commits, &pattern);
    assert_eq!(matches.len(), 1);
}

#[test]
fn test_commit_pattern_with_extra_whitespace() {
    let commits = vec![
        "chant(2026-01-27-001-abc) : Fix bug".to_string(),
        "chant(2026-01-27-001-abc):  Add tests".to_string(),
    ];
    let pattern = build_commit_pattern("2026-01-27-001-abc");
    let matches = filter_commits_by_pattern(&commits, &pattern);
    assert_eq!(matches.len(), 2);
}
```

## Acceptance Criteria

- [x] Identify exact location of commit pattern matching code
- [x] Reproduce the issue with a test case
- [x] Fix pattern to match both full and short spec IDs
- [x] Handle whitespace variations in commit messages
- [x] Add debug logging showing pattern and commits being checked
- [x] Add 5+ unit tests for various commit message formats
- [x] Verify fix with integration test (parallel work -> merge)
- [x] All existing tests still pass