---
type: code
status: pending
target_files:
  - src/cmd/lifecycle.rs
  - src/merge.rs
---

# Improve merge error messages with actionable next steps

## Problem

**User Feedback:** Merge errors don't provide clear next steps, requiring users to figure out recovery on their own.

**Most Confusing Error (User Report):**
```
Failed to checkout chant/2026-01-27-049-lhp:
'chant/2026-01-27-049-lhp' is already used by worktree at '/private/tmp/chant-2026-01-27-049-lhp'
```

Why confusing:
- The branch exists, commits are there, but can't access it
- Requires understanding git worktree mechanics (not obvious)
- Recovery: `git worktree list` → `git worktree remove --force` → `git worktree prune`

**User Preference on Error Detail:**
- "Detailed errors are helpful for the first occurrence"
- "Actionable suggestions would be ideal"
- Example preferred format shown in spec

Current error messages are vague:
- "Merge failed"
- "Can't fast-forward"
- "No commits found"

Users want actionable guidance like the working workflow they discovered:
```bash
# 2. Check branches have commits
git log chant/spec1 --oneline -3

# 3. Clean up worktrees first
git worktree list
git worktree remove /path/to/worktree --force

# 4. Manual merge with --no-ff
git merge --no-ff chant/spec1 -m "Merge spec spec1"
```

## Solution

Enhance error messages with context and recovery steps:

**Template for Good Error Messages:**
```
Error: [What went wrong]

Context:
  - [Relevant state info]
  - [What was attempted]

Diagnosis:
  - [Likely cause]

Next Steps:
  1. [Automated option] chant merge spec-id --rebase --auto
  2. [Manual option] git merge --no-ff chant/spec-id
  3. [Debugging] git log chant/spec-id --oneline

Documentation: See 'chant merge --help' for more options
```

## Error Message Examples

### Fast-Forward Conflict
```
Error: Cannot fast-forward merge for spec 2026-01-27-001-abc

Context:
  - Branch: chant/2026-01-27-001-abc
  - Branches have diverged from common ancestor
  - 3 commits on spec branch, 2 commits on main since divergence

Next Steps:
  1. Use no-fast-forward merge: chant merge 2026-01-27-001-abc --no-ff
  2. Or rebase onto main: chant merge 2026-01-27-001-abc --rebase
  3. Or merge manually: git merge --no-ff chant/2026-01-27-001-abc

Tip: chant merge auto-detects divergence in newer versions
```

### No Commits Found
```
Error: No commits found matching pattern 'chant(2026-01-27-001-abc):'

Context:
  - Branch: chant/2026-01-27-001-abc
  - Commits on branch: 4
  - Expected pattern: 'chant(2026-01-27-001-abc): ...'

Commits found on branch:
  abc1234 Initial commit
  def5678 Add feature
  ghi9012 Fix bug
  jkl3456 Update tests

Next Steps:
  1. Check commit messages: git log chant/2026-01-27-001-abc --oneline
  2. If commits exist but don't match pattern, merge manually
  3. If no work was done, delete branch: git branch -D chant/2026-01-27-001-abc

Debugging: This may be a pattern matching bug - please report if commits look correct
```

### Worktree Conflict
```
Error: Worktree already exists for spec 2026-01-27-001-abc

Context:
  - Worktree path: /tmp/chant-2026-01-27-001-abc
  - Branch: chant/2026-01-27-001-abc

Next Steps:
  1. Clean up worktree: chant cleanup --worktrees
  2. Or remove manually: git worktree remove /tmp/chant-2026-01-27-001-abc --force
  3. Then retry: chant merge 2026-01-27-001-abc
```

## Acceptance Criteria

- [ ] Update merge error messages with context
- [ ] Add "Next Steps" section to all error messages
- [ ] Show relevant branch/commit info in errors
- [ ] Provide 2-3 recovery options for each error type
- [ ] Add examples of what to run
- [ ] Include links to relevant help text
- [ ] Test each error path outputs improved message
- [ ] Update documentation with common error scenarios