---
type: code
status: pending
depends_on:
- 2026-01-24-01x-v06.1
target_files:
- '`src/main.rs`'
---
# Update invoke_agent_with_model() to Accept Working Directory Parameter

**Description:**
Extend the agent invocation function to run the Claude CLI in a specified working directory (or current directory if not specified). This allows individual agents to run in isolated worktrees. The change is backward-compatible: existing calls without a working directory use the current behavior.

### Acceptance Criteria

- [ ] Add `cwd: Option<&Path>` parameter to `invoke_agent_with_model()` signature
- [ ] Update function to set working directory before spawning `claude` CLI process
  - [ ] If `cwd` is `Some(path)`, use `Command::current_dir(path)`
  - [ ] If `cwd` is `None`, use current behavior (no `current_dir` call)
- [ ] Update `invoke_agent()` to accept and pass through `cwd` parameter
- [ ] Update `invoke_agent_with_prefix()` to accept and pass through `cwd` parameter
- [ ] Verify agent output is correctly captured when running in different directory
  - [ ] Logging still goes to correct location
  - [ ] Output is captured correctly
  - [ ] Environment variables (`CHANT_SPEC_ID`, `CHANT_SPEC_FILE`) still set correctly
- [ ] Update all callers of these three functions:
  - [ ] `cmd_work()` → pass `None`
  - [ ] `cmd_work_parallel()` → will pass worktree path in Subtask 3
  - [ ] Any other callers → pass `None`
- [ ] Add test cases for agent invocation in different directories

### Edge Cases

- **Invalid working directory:** If `cwd` points to non-existent directory, `Command::current_dir()` fails when spawning. Verify error is properly propagated. Test: Pass `/nonexistent/path` and verify error message.
- **Agent runs in worktree but logs/output elsewhere:** Ensure logging location logic is not affected by `cwd`. Test: Run agent in `/tmp/chant-xxx` and verify logs still go to `.chant/logs/` relative to main repo.
- **Environment variables in different directory:** Verify `CHANT_SPEC_ID` and `CHANT_SPEC_FILE` are set correctly regardless of working directory. Test: Capture env vars in agent and verify they point to correct spec file.
- **Relative paths in spec:** If spec file paths are relative, they may behave differently when agent runs in different directory. Test: Ensure spec file path is absolute or properly resolved.

### Example Test Cases

For this feature, verify:
- **Case 1:** `invoke_agent_with_model(..., cwd=None)` behaves as before (runs in current dir)
- **Case 2:** `invoke_agent_with_model(..., cwd=Some("/tmp/test"))` runs agent in `/tmp/test`
- **Case 3:** Agent running in alternate directory still produces correct output
- **Case 4:** Logging still targets `.chant/logs/{spec_id}.log` regardless of `cwd`
- **Case 5:** Error propagated correctly if `cwd` is invalid directory