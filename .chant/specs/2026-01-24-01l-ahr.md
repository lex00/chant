---
type: code
status: pending
target_files:
- src/spec.rs
- src/main.rs
---

# Prevent driver spec completion before siblings - add finalize_spec validation

## Problem

Running `chant work 01e-o0l` completed the driver spec before its 5 member specs (.1-.5) were completed. This should be impossible - drivers must wait for all siblings to complete.

## Root Cause

- `is_ready()` blocks driver **execution** until members complete (works correctly)
- BUT `finalize_spec()` has **no validation** - it marks drivers Completed regardless of member status
- Same gap exists in `cmd_work_parallel`'s inline finalization

## Solution

### 1. Add helper functions to `src/spec.rs` (after line 169)

```rust
pub fn has_incomplete_members(driver_id: &str, all_specs: &[Spec]) -> bool
pub fn get_incomplete_members(driver_id: &str, all_specs: &[Spec]) -> Vec<String>
```

### 2. Add validation to `finalize_spec()` in `src/main.rs` (line ~1295)

- Add `all_specs: &[Spec]` parameter
- Check `get_incomplete_members()` before completing
- Return error: `"Cannot complete driver spec '{}' while {} member spec(s) are incomplete: {}"`

### 3. Update call sites

- `cmd_work()` line 812: reload `all_specs` and pass to `finalize_spec()`
- `cmd_work_parallel()` lines 987-1007: add same validation before inline finalization

## Tests (write first - will FAIL before fix, PASS after)

### In `src/spec.rs` tests module:

1. `test_has_incomplete_members_with_pending` - driver with pending member returns true
2. `test_has_incomplete_members_all_completed` - driver with all completed members returns false
3. `test_has_incomplete_members_no_members` - non-driver returns false
4. `test_has_incomplete_members_in_progress` - in_progress members also block

### In `src/main.rs` tests module:

5. `test_finalize_spec_blocks_driver_with_incomplete_members` - finalize returns Err
6. `test_finalize_spec_allows_driver_with_all_complete_members` - finalize returns Ok
7. `test_finalize_spec_allows_non_driver_spec` - regular specs unaffected

## Acceptance Criteria

- [ ] Add `has_incomplete_members()` function to spec.rs
- [ ] Add `get_incomplete_members()` function to spec.rs
- [ ] Add 4 unit tests for helper functions in spec.rs
- [ ] Modify `finalize_spec()` to accept `all_specs` parameter
- [ ] Add validation in `finalize_spec()` to block driver completion with incomplete members
- [ ] Update `cmd_work()` call site to pass `all_specs`
- [ ] Update `cmd_work_parallel()` to add same validation
- [ ] Add 3 integration tests for finalization blocking in main.rs
- [ ] All tests pass (`cargo test`)
- [ ] Linter passes (`cargo clippy`)
