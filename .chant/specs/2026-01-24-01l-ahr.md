---
type: code
status: completed
target_files:
- src/spec.rs
- src/main.rs
commits:
- 31b8780
completed_at: 2026-01-24T23:53:23Z
model: haiku
---
# Prevent driver spec completion before siblings - add finalize_spec validation

## Problem

Running `chant work 01e-o0l` completed the driver spec before its 5 member specs (.1-.5) were completed. This should be impossible - drivers must wait for all siblings to complete.

## Root Cause

- `is_ready()` blocks driver **execution** until members complete (works correctly)
- BUT `finalize_spec()` has **no validation** - it marks drivers Completed regardless of member status
- Same gap exists in `cmd_work_parallel`'s inline finalization

## Solution

### 1. Add helper functions to `src/spec.rs` (after line 169)

```rust
pub fn has_incomplete_members(driver_id: &str, all_specs: &[Spec]) -> bool
pub fn get_incomplete_members(driver_id: &str, all_specs: &[Spec]) -> Vec<String>
```

### 2. Add validation to `finalize_spec()` in `src/main.rs` (line ~1295)

- Add `all_specs: &[Spec]` parameter
- Check `get_incomplete_members()` before completing
- Return error: `"Cannot complete driver spec '{}' while {} member spec(s) are incomplete: {}"`

### 3. Update call sites

- `cmd_work()` line 812: reload `all_specs` and pass to `finalize_spec()`
- `cmd_work_parallel()` lines 987-1007: add same validation before inline finalization

## Tests (write first - will FAIL before fix, PASS after)

### In `src/spec.rs` tests module:

1. `test_has_incomplete_members_with_pending` - driver with pending member returns true
2. `test_has_incomplete_members_all_completed` - driver with all completed members returns false
3. `test_has_incomplete_members_no_members` - non-driver returns false
4. `test_has_incomplete_members_in_progress` - in_progress members also block

### In `src/main.rs` tests module:

5. `test_finalize_spec_blocks_driver_with_incomplete_members` - finalize returns Err
6. `test_finalize_spec_allows_driver_with_all_complete_members` - finalize returns Ok
7. `test_finalize_spec_allows_non_driver_spec` - regular specs unaffected

## Acceptance Criteria

- [x] Add `get_incomplete_members()` function to spec.rs
- [x] Add unit tests for `get_incomplete_members()` in spec.rs
- [x] Modify `finalize_spec()` to accept `all_specs` parameter
- [x] Add validation in `finalize_spec()` to block driver completion with incomplete members
- [x] Update `cmd_work()` call site to pass `all_specs`
- [x] Update `cmd_work_parallel()` to add same validation
- [x] Add 3 integration tests for finalization blocking in main.rs
- [x] All tests pass (`cargo test`)
- [x] Linter passes (`cargo clippy`)

## Agent Output

2026-01-24T23:53:23Z

```
I'll implement this spec step by step. Let me start by reading the relevant code files to understand the current implementation.
Now let me read the main.rs file to find the finalize_spec function and the cmd_work functions:
Let me read these specific functions:
Let me continue reading to find where finalize_spec is called:
Let me find where finalize_spec is called:
Let me read around line 1033 to see how finalize_spec is called in cmd_work:
Now let me look at cmd_work_parallel to see if it has inline finalization:
Perfect! I found the issue. In `cmd_work_parallel`, lines 1314-1332 contain inline finalization code without any validation for driver specs. Let me create a todo list and start implementing the solution:
Now let's start implementing. First, I'll add the helper functions to spec.rs:
Now I'll add the two helper functions after `all_members_completed`:
Now let's mark the first todo as completed and add unit tests:
Now let's add the unit tests for the helper functions. I'll add them at the end of the tests module:
Now I'll add the tests before the closing brace:
Now let's update the todo and modify the finalize_spec function signature and add validation:
Now let's modify the finalize_spec function. First, let me read the full function:
Now I'll modify finalize_spec to add the all_specs parameter and validation:
Now let's update the cmd_work call site. Let me find the exact location again:
Now I'll update the call to finalize_spec to reload all_specs and pass it:
Now let's update the cmd_work_parallel inline finalization. Let me read that section again:
Let me update my todo list and continue with updating the parallel finalization:
Now I need to update the cmd_work_parallel inline finalization. The issue is that in the parallel execution thread, we need to validate before marking as Completed. Let me modify that section:
I made an error in my code. Let me check the variable name issue - I used `spec_dir_clone` but that variable doesn't exist. Let me fix that:
Let me see more:
I see the issue - line 1328 has `spec_dir_clone.to_vec()` which is wrong. I need to fix this. Let me replace that section properly. The correct approach is to use an empty vec if loading fails:
Now I need to review the return type issue - the modified code is supposed to return `(success_final, status_final)` but now we're reassigning it. Let me look at the context:
I need to simplify this code. The issue is that I'm returning within nested closures. Let me rewrite it more cleanly:
I see the problem - the code on line 1387 is trying to use success_final and status_final, but those are being reassigned in the block. Let me fix this by using proper variable names:
Now I need to find all the places where `finalize_spec` is called in the tests and update them to pass the all_specs parameter. Let me first compile to see what errors we get:
Let me check if the justfile has a build command:
Good! The code builds with just a warning about `has_incomplete_members` being unused. Now I need to update all test call sites. Let me find them:
There are many test calls. Let me create a script to update them all. First, let me write a test helper that creates an empty vec for tests:
I see all the tests use an empty vec of specs. Let me use a bash command with sed to update all the calls:
Now let's run a build to check if there are any other issues:
Let me use the just command:
Good, the build is successful. The warning is just about `has_incomplete_members` not being used in tests - we'll add a test for it. Let me now write the integration tests in the main.rs tests module. First, let me find a good place to add them:
Let me check the end of the tests module:
Perfect! Now I'll add the integration tests for finalize_spec before the closing brace. Let me add them:
Let me read the end of the file first:
Let me look further:
Let me find the actual end:
Perfect! Now let me add the tests before the closing brace:
Now let me update the todo list and run the tests:
Now let me run the tests:
Let me check what path the build uses:
Let me use the full path:
The tests are in main.rs which is a binary. Let me run the binary tests:
I have several issues to fix:

1. `re_finalize_spec` calls are getting the extra `&[]` argument 
2. `Config::default()` doesn't exist
3. There's an unused `mut` warning

Let me fix these:
Now let me check the Config issue by looking at what's used elsewhere:
Let me look at how Config is used in other tests:
I see - Config doesn't have Default. Let me look at how other tests create Config:
I see - I need to use `Config::parse()`. Let me update my tests:
Let me find the config string used in other tests:
Perfect! Now I'll update my tests with proper config initialization. Let me fix all three test functions:
Let me read the test section first:
Now let me update all three tests with proper config initialization:
Now let me fix the unused `mut` warning. Let me find that line:
Now let's run the tests again:
Good news - my new tests are

... (output truncated, 11277 chars total)```
