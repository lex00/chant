---
type: code
status: completed
target_files:
- src/cmd/work.rs
model: claude-haiku-4-5-20251001
---
# Fix parallel mode merge strategy and UX

## Problem

When running `chant work --parallel`, each spec tries to merge independently after completing. This causes cascade failures and confusing UX:

1. First spec merges successfully, main moves forward
2. Remaining specs fail with "Not possible to fast-forward"
3. All failing specs get marked as `needs_attention` (⚠)
4. User sees 13+ warning icons with no clear indication of what happened or what to do
5. The work is done (on branches) but that's not obvious

## Current Behavior

- Each parallel worker thread calls `merge_and_cleanup()` independently, racing to merge
- Failed merges result in `needs_attention` status
- No summary of what succeeded vs failed
- User left confused about next steps

## Solution

### 1. Serialize merges after parallel work

Instead of each thread racing to merge:
1. All specs execute in parallel (work phase)
2. Collect all completed branches
3. After all work completes, merge branches sequentially to main
4. If a real conflict occurs, stop and create one conflict spec

### 2. Improve parallel summary output

After parallel execution, show clear summary:
```
Parallel execution complete:
  ✓ 14 specs completed work
  ✓ 14 branches merged to main

# Or when merges fail:
Parallel execution complete:
  ✓ 14 specs completed work
  ✓ 1 merged to main
  → 13 branches preserved (run `chant merge` to merge sequentially)
```

### 3. Better status for "work done, merge pending"

Consider a status like `merge_pending` instead of `needs_attention` for specs where:
- Work completed successfully
- Commits exist on branch
- Only the merge step failed

This distinguishes "needs human attention" from "just needs merge".

## Acceptance Criteria

- [x] Parallel mode serializes merge step after all work completes
- [x] Clear summary shows completed vs merged vs pending
- [x] Failed merges don't mark specs as `needs_attention` when work succeeded
- [x] User knows what to do next (e.g., "run `chant merge`")
- [x] All tests pass
- [x] Code linted