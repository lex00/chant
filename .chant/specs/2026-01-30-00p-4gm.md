---
type: code
status: pending
labels:
  - ux
  - agent-config
target_files:
  - src/cmd/init.rs
  - templates/agent-claude.md
  - templates/agent-claude-mcp.md
---

# Safe CLAUDE.md integration - append chant config without overwriting user content

## Problem

Currently `chant init --agent claude` overwrites any existing CLAUDE.md entirely. This destroys user customizations and project-specific instructions.

Additionally, when MCP is configured, CLAUDE.md contains redundant information (command docs that MCP tools already describe).

## Solution

1. **Safe append**: Add chant instructions to existing CLAUDE.md, don't replace
2. **Compact template when MCP present**: Smaller footprint, no command docs duplication
3. **Idempotent**: Running init twice doesn't duplicate chant section

## Design

### Section Markers

Use HTML comments as markers (invisible in rendered markdown):

```markdown
<!-- chant:begin -->
## Chant Agent Instructions

[compact instructions here]
<!-- chant:end -->
```

### Behavior

| Scenario | Action |
|----------|--------|
| No CLAUDE.md exists | Create with chant section |
| CLAUDE.md exists, no chant section | Append chant section at end |
| CLAUDE.md exists, has chant section | Replace only chant section |
| MCP configured | Use compact template (workflow rules only) |
| No MCP | Use full template (includes command reference) |

### Compact Template (MCP present)

~50 lines focused on:
- Orchestrator role (don't implement directly)
- Spec workflow (add → edit → work)
- Commit message format
- What NOT to do (no direct edits, no Task tool for parallel specs)

Excludes:
- Command reference (MCP tools have descriptions)
- Configuration docs
- Detailed examples

### Full Template (No MCP)

Current template content for clients that can't use MCP tools.

## Acceptance Criteria

- [ ] Add `<!-- chant:begin -->` / `<!-- chant:end -->` markers to template
- [ ] `chant init` detects existing CLAUDE.md and preserves content outside markers
- [ ] If markers exist, only content between them is replaced
- [ ] If no markers, append chant section at end of file
- [ ] Create `templates/agent-claude-mcp.md` - compact version (~50 lines)
- [ ] Use compact template when `.mcp.json` exists or `--agent claude` with MCP
- [ ] `chant init --force` still respects safe-add (replaces chant section only)
- [ ] Works with `chant init` interactive wizard
- [ ] All tests pass
