---
type: code
status: completed
labels:
- ux
- agent-config
target_files:
- src/main.rs
- src/templates.rs
- templates/chant-section.md
- templates/chant-section-mcp.md
commits:
- d9e4f07
completed_at: 2026-01-30T16:21:22Z
model: opus
---
# Safe CLAUDE.md integration - append chant config without overwriting user content

## Problem

1. `chant init --agent claude` overwrites existing CLAUDE.md entirely, destroying user customizations
2. CLAUDE.md files often contain instructions for **multiple tools** (Cursor, Claude Code, Copilot, Windsurf, etc.)
3. Each tool/environment may have its own section with specific instructions
4. Chant shouldn't clobber other tools' configurations

## Solution

**Inject a small, clearly-marked chant section** into existing CLAUDE.md without touching other content.

## Design

### Section Markers (Tool-Specific)

```markdown
<!-- chant:begin -->
## Chant Workflow

[compact chant-specific instructions]
<!-- chant:end -->
```

### What Chant Section Contains (~30-50 lines)

**Core workflow only:**
- You are an orchestrator, use `chant work` not direct edits
- Spec lifecycle: `chant add` → edit spec → `chant work`
- Commit format: `chant(SPEC-ID): description`
- Monitor with `chant log`, finalize with `chant finalize`

**What NOT to include:**
- Full command reference (use `chant --help` or MCP tools)
- Configuration documentation
- Examples and detailed explanations
- Anything the agent can discover via tools

### Behavior Matrix

| CLAUDE.md State | Chant Markers | Action |
|-----------------|---------------|--------|
| Doesn't exist | - | Create minimal file with chant section only |
| Exists | None | Append chant section at end |
| Exists | Has markers | Replace content between markers |
| Exists | Has markers (different version) | Update content between markers |

### Not Chant's Responsibility

Chant does NOT manage:
- Cursor-specific instructions
- Copilot hints
- Project-wide coding standards
- Language/framework conventions

Users manage those sections themselves. Chant only owns content between its markers.

### Template Files

Instead of full agent templates, use minimal injection templates:

- `templates/chant-section.md` - Compact section (~40 lines)
- `templates/chant-section-mcp.md` - Even smaller when MCP available (~25 lines)

### MCP Optimization

When `.mcp.json` configures chant MCP server:
- Skip command documentation entirely
- Focus only on behavioral rules
- Agent discovers commands via MCP tool descriptions

## Example Result

User's existing CLAUDE.md:
```markdown
# Project Instructions

## Code Style
Use TypeScript strict mode...

## Cursor Settings
Prefer inline completions...

<!-- chant:begin -->
## Chant Workflow

You are an orchestrator. Do not edit files directly.

### Commands
- `chant add "description"` - Create spec
- `chant work <id>` - Execute spec
- `chant log <id>` - Monitor progress

### Rules
- All changes flow through specs
- Commit format: `chant(SPEC-ID): description`
<!-- chant:end -->

## Testing
Run `npm test` before committing...
```

## Acceptance Criteria

- [x] Create `templates/chant-section.md` (~40 lines, core workflow)
- [x] Create `templates/chant-section-mcp.md` (~25 lines, behavioral rules only)
- [x] `chant init --agent claude` detects existing CLAUDE.md
- [x] If no markers found, append chant section at end
- [x] If markers found, replace only content between them
- [x] Preserve all content outside markers (before and after)
- [x] Use MCP template when `.mcp.json` exists with chant server
- [x] If no CLAUDE.md exists, create minimal file (just chant section)
- [x] `--force` replaces chant section, not entire file
- [x] Idempotent: running twice produces same result
- [x] All tests pass

## Agent Output

2026-01-30T16:20:20Z

```
I'll start by understanding the codebase structure and then implement the safe CLAUDE.md integration feature.
Now let me read the specific files I need to understand the current implementation in detail.
Now I need to see where CLAUDE.md is written in main.rs and understand the flow better.
Let me read the relevant sections of main.rs to understand the exact flow for writing CLAUDE.md.
Now I have a clear understanding of the codebase. Let me create a todo list to track my implementation work.
Let me create the compact chant section template first.
Now let me create the MCP version - even more compact since MCP tools provide the command details.
Now I need to add the section injection logic to templates.rs. Let me add the new functions and constants.
Now let me add the functions for section injection after the existing functions.
Now I'll add the new section injection functions before the tests.
Now let me add tests for the new injection functions. First, let me see where the tests end.
Now I'll add tests for the new injection functions.
Now I need to modify main.rs to use the new injection logic instead of overwriting. There are two places where CLAUDE.md is written:
1. `handle_agent_update` function (around line 1096)
2. `cmd_init` function (around line 1963)

Let me first look at more context around the first location to understand what needs to change.
I see the issue now. The current logic:
1. Checks if file exists
2. If exists and not force, prompts/skips
3. If allowed (or force), writes full template

I need to change this to:
1. For Claude provider only: use injection logic
2. For other providers: keep existing behavior (full template)

Let me also check if there's a way to detect whether MCP is already configured (since that affects which template to use).
Now I'll create a helper function to handle the CLAUDE.md writing logic specifically, and then modify both places to use it. Let me look for a good place to add this helper function.
I'll add a helper function that handles the CLAUDE.md writing with section injection. Let me add it before `handle_agent_update`.
Now I need to modify the `handle_agent_update` function to use this new helper. Let me read the current implementation after the modification.
Now I need to refactor `handle_agent_update` to use the new helper function. The key insight is that:
1. For Claude, we need to detect if MCP exists before writing the CLAUDE.md
2. We should use the new `write_agent_config_file` helper
Now I need to do the same refactoring for the `cmd_init` function. Let me find the relevant section.
Now I understand the flow in `cmd_init`. The issue is that in `cmd_init`, MCP config is created AFTER the CLAUDE.md is written, so we need to handle this differently. Let me think about this:

1. In `cmd_init`, MCP is created after CLAUDE.md
2. So we need to either:
   - Create MCP first, then write CLAUDE.md with MCP awareness
   - Or check if the provider supports MCP and will create MCP config

Actually, looking at the logic more carefully, the MCP config is created for Claude provider. So if we're creating CLAUDE.md for Claude, we know MCP will be created. Let me refactor to handle this.
Now I need to update the output section at the end that reports on created agent files.
Now I need to update the output section to use the new data structures. Let me update both the agent file printing and the summary.
Now let me run cargo fmt and clippy to check for any issues.
Let me fix those clippy warnings.
No warnings now. Let me run the tests.
I see several test failures. Let me analyze them:

1. Template tests failing - the templates don't contain expected content
2. `test_init_force_reinstalls_agents` - the content has an extra newline at the end
3. Several tests expect `.mcp.json` to not exist after certain operations

Let me first fix the template tests by looking at what they expect.
I see there's a trailing newline in the file. The test `test_init_force_reinstalls_agents` expects the content to end with `<!-- chant:end -->\n\n` but my section ends with `<!-- chant:end -->\n`. Let me check the test expectations more closely.

The key issue is the template tests are checking for specific content. Let me read what the template tests expect and what the MCP template actually contains.

Looking at the test output:
- left (actual): ends with `<!-- chant:end -->\n`
- right (expected): ends with `<!-- chant:end -->\n\n`

The existing test expected the full CLAUDE template, not the compact section. I need to update the tests to match the new behavior, or update the template to add a trailing newline.

Wait, let me look at the test failure more carefully. The test `test_init_force_reinstalls_agents` is comparing:
- actual file content (has one trailing newline)
- expected (has two trailing newlines)

This is because the test was expecting the FULL template to be written twice, not a section injection. The test needs to be updated to expect section injection behavior for Claude.


... (output truncated, 16936 chars total)```