---
type: code
status: in_progress
labels:
- ux
- agent-config
target_files:
- src/main.rs
- templates/chant-section.md
- templates/chant-section-mcp.md
---
# Safe CLAUDE.md integration - append chant config without overwriting user content

## Problem

1. `chant init --agent claude` overwrites existing CLAUDE.md entirely, destroying user customizations
2. CLAUDE.md files often contain instructions for **multiple tools** (Cursor, Claude Code, Copilot, Windsurf, etc.)
3. Each tool/environment may have its own section with specific instructions
4. Chant shouldn't clobber other tools' configurations

## Solution

**Inject a small, clearly-marked chant section** into existing CLAUDE.md without touching other content.

## Design

### Section Markers (Tool-Specific)

```markdown
<!-- chant:begin -->
## Chant Workflow

[compact chant-specific instructions]
<!-- chant:end -->
```

### What Chant Section Contains (~30-50 lines)

**Core workflow only:**
- You are an orchestrator, use `chant work` not direct edits
- Spec lifecycle: `chant add` → edit spec → `chant work`
- Commit format: `chant(SPEC-ID): description`
- Monitor with `chant log`, finalize with `chant finalize`

**What NOT to include:**
- Full command reference (use `chant --help` or MCP tools)
- Configuration documentation
- Examples and detailed explanations
- Anything the agent can discover via tools

### Behavior Matrix

| CLAUDE.md State | Chant Markers | Action |
|-----------------|---------------|--------|
| Doesn't exist | - | Create minimal file with chant section only |
| Exists | None | Append chant section at end |
| Exists | Has markers | Replace content between markers |
| Exists | Has markers (different version) | Update content between markers |

### Not Chant's Responsibility

Chant does NOT manage:
- Cursor-specific instructions
- Copilot hints
- Project-wide coding standards
- Language/framework conventions

Users manage those sections themselves. Chant only owns content between its markers.

### Template Files

Instead of full agent templates, use minimal injection templates:

- `templates/chant-section.md` - Compact section (~40 lines)
- `templates/chant-section-mcp.md` - Even smaller when MCP available (~25 lines)

### MCP Optimization

When `.mcp.json` configures chant MCP server:
- Skip command documentation entirely
- Focus only on behavioral rules
- Agent discovers commands via MCP tool descriptions

## Example Result

User's existing CLAUDE.md:
```markdown
# Project Instructions

## Code Style
Use TypeScript strict mode...

## Cursor Settings
Prefer inline completions...

<!-- chant:begin -->
## Chant Workflow

You are an orchestrator. Do not edit files directly.

### Commands
- `chant add "description"` - Create spec
- `chant work <id>` - Execute spec
- `chant log <id>` - Monitor progress

### Rules
- All changes flow through specs
- Commit format: `chant(SPEC-ID): description`
<!-- chant:end -->

## Testing
Run `npm test` before committing...
```

## Acceptance Criteria

- [ ] Create `templates/chant-section.md` (~40 lines, core workflow)
- [ ] Create `templates/chant-section-mcp.md` (~25 lines, behavioral rules only)
- [ ] `chant init --agent claude` detects existing CLAUDE.md
- [ ] If no markers found, append chant section at end
- [ ] If markers found, replace only content between them
- [ ] Preserve all content outside markers (before and after)
- [ ] Use MCP template when `.mcp.json` exists with chant server
- [ ] If no CLAUDE.md exists, create minimal file (just chant section)
- [ ] `--force` replaces chant section, not entire file
- [ ] Idempotent: running twice produces same result
- [ ] All tests pass