---
type: code
status: pending
target_files:
  - src/cmd/work.rs
  - src/config.rs
  - .chant/prompts/parallel-cleanup.md
---

# Enhance chant work --parallel with multi-account support and robust cleanup

Make parallel execution viable by supporting multiple Claude accounts and adding robust error recovery.

## Problem

Current `--parallel` is broken because:
1. All workers use same account → hits API concurrency limits
2. No distribution strategy across multiple accounts
3. Poor recovery when things go wrong (partial failures, merge conflicts)
4. No cleanup assistance for parallel-specific issues

## Configuration

```yaml
# config.yaml
parallel:
  agents:
    - name: main
      command: claude           # shell alias or path
      max_concurrent: 2         # limited - may have active session
    - name: alt1
      command: claude-alt1
      max_concurrent: 3
    - name: alt2
      command: claude-alt2
      max_concurrent: 3

  # Safety caps
  total_max: 8                  # never exceed this many concurrent agents

  # Cleanup
  cleanup:
    enabled: true
    prompt: parallel-cleanup    # prompt for agent-assisted recovery
    auto_run: false             # require confirmation before cleanup agent runs
```

## Distribution Strategy

When `chant work --parallel` with N ready specs:

1. **Gather available capacity** from configured agents
2. **Respect per-agent limits** (main: 2, alt1: 3, alt2: 3 = 8 total)
3. **Distribute round-robin** or **fill least-loaded first**
4. **Track which agent runs which spec** for error attribution

Example with 5 specs:
```
main:  spec-001, spec-004
alt1:  spec-002, spec-005
alt2:  spec-003
```

## Parallel Pitfalls to Detect

After parallel run completes, check for:

| Issue | Detection | Severity |
|-------|-----------|----------|
| API errors (429, concurrency) | Exit code, stderr | High |
| Merge conflicts | Git status on branches | High |
| Partial failures | Some specs failed, others succeeded | Medium |
| Dependency violations | Spec A depended on B, both ran | High |
| Uncommitted changes | Worktree has uncommitted work | Medium |
| Stale worktrees | Worktrees not cleaned up | Low |

## Post-Parallel Cleanup

After parallel execution:

1. **Report** — Show summary of what succeeded/failed
2. **Detect issues** — Scan for pitfalls above
3. **Offer cleanup** — If issues found, offer agent-assisted recovery

```
Parallel execution complete: 3/5 specs succeeded

Issues detected:
  ✗ spec-002: API concurrency error (retryable)
  ✗ spec-004: Merge conflict with spec-001
  ⚠ spec-003: Worktree not cleaned up

Run cleanup agent? [y/N]
```

## Cleanup Prompt

Create `.chant/prompts/parallel-cleanup.md` that guides an agent to:

1. Analyze parallel execution results
2. Identify root causes of failures
3. Suggest resolution order (which to retry first)
4. Handle merge conflicts (which branch has correct changes)
5. Clean up stale state (worktrees, branches)

The prompt should be comprehensive about parallel-specific failure modes.

## CLI Changes

```bash
# Use configured agents
chant work --parallel

# Override max concurrency
chant work --parallel --max 4

# Skip cleanup prompt
chant work --parallel --no-cleanup

# Force cleanup even on success
chant work --parallel --cleanup
```

## Acceptance Criteria

- [ ] Config schema supports multiple agents with per-agent limits
- [ ] Parallel distributes work across configured agents
- [ ] Respects per-agent and total concurrency limits
- [ ] Detects common parallel pitfalls after execution
- [ ] Reports clear summary of parallel results
- [ ] Cleanup prompt created and effective
- [ ] Agent-assisted cleanup is optional and configurable
- [ ] Tests for distribution logic
- [ ] Tests for pitfall detection
- [ ] Documentation updated
