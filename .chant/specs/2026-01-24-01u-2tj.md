---
type: code
status: in_progress
target_files:
- src/main.rs
- Cargo.toml
model: claude-haiku-4-5-20251001
---
# Fix broken model name env tests

## Problem

Two tests fail intermittently when run with `cargo test` but pass individually:
- `test_get_model_name_from_chant_model`
- `test_get_model_name_env_takes_precedence_over_config`

This is because Rust runs tests in parallel by default, and these tests modify environment variables (`CHANT_MODEL`, `ANTHROPIC_MODEL`) which pollutes other tests.

## Solution

Use the `serial_test` crate to ensure tests that modify env vars run sequentially.

```rust
use serial_test::serial;

#[test]
#[serial]
fn test_get_model_name_from_chant_model() {
    // ...
}
```

## Acceptance Criteria

- [x] Add `serial_test` to dev-dependencies in Cargo.toml
- [x] Add `#[serial]` attribute to all tests that modify env vars
- [x] All tests pass when run with `cargo test`
- [x] All tests pass when run with `cargo test -- --test-threads=1` (sanity check)
- [x] Identify all tests that set/modify environment variables