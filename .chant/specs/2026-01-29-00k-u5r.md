---
type: code
status: completed
target_files:
- src/templates.rs
- src/main.rs
- src/mcp.rs
- templates/agent-claude.md
- CLAUDE.md
context:
- src/cmd/lifecycle.rs
- src/cmd/spec.rs
- src/cmd/search.rs
commits:
- '0278688'
completed_at: 2026-01-29T21:57:06Z
model: opus
---
# Improve MCP discoverability - auto-create .mcp.json on init and document MCP tools

## Problem

MCP server is fully implemented but invisible:
- Creator forgot it existed
- Agents repeatedly fall off track instead of using structured tools
- Not mentioned anywhere users/agents would see it
- Only 3 basic tools, missing useful operations

## Solution

Four-part approach focusing on Claude Code first, but implementing CLI in a provider-agnostic way:

1. **Auto-create `.mcp.json` on init** - When `chant init --agent claude` runs, also create `.mcp.json` with the chant MCP server config
2. **Expand MCP tools** - Add more tools to cover useful CLI operations (provider-agnostic)
3. **Add MCP section to agent template** - Document MCP tools in `templates/agent-claude.md` so agents know to use them
4. **Add MCP section to orchestrator CLAUDE.md** - Document MCP integration for orchestrators

## Implementation Details

### 1. src/templates.rs

Add MCP support methods to `AgentProvider`:

```rust
impl AgentProvider {
    /// Returns true if this provider supports MCP and should generate config
    pub fn supports_mcp(&self) -> bool {
        match self {
            Self::Claude => true,
            Self::Cursor => false,  // Future: set to true, add mcp_config_filename
            Self::AmazonQ => false,
            Self::Generic => false,
        }
    }

    /// Get MCP config filename if provider supports MCP
    pub fn mcp_config_filename(&self) -> Option<&'static str> {
        match self {
            Self::Claude => Some(".mcp.json"),
            // Future: Self::Cursor => Some(".cursor/mcp.json"),
            _ => None,
        }
    }
}
```

### 2. src/main.rs (init command)

After writing agent files, check if any provider supports MCP and write the config:

```json
{
  "mcpServers": {
    "chant": {
      "type": "stdio",
      "command": "chant",
      "args": ["mcp"]
    }
  }
}
```

### 3. src/mcp.rs - Expand MCP tools

Current tools (keep):
- `chant_spec_list` - list specs with status filter
- `chant_spec_get` - get spec by ID
- `chant_spec_update` - update status/append output

Add query tools (read-only, safe):
- `chant_ready` - list specs with status=ready (convenience wrapper)
- `chant_status` - count specs by status (project summary)
- `chant_log` - read from `.chant/logs/{id}.log`
- `chant_search` - filter specs by query string
- `chant_diagnose` - analyze failed spec

Add mutating tools:
- `chant_add` - create spec file from description
- `chant_finalize` - update spec to completed
- `chant_resume` - reset failed spec to pending
- `chant_cancel` - set status to cancelled
- `chant_archive` - move to archive dir

Note: `chant_work` is intentionally omitted - it spawns an agent process which is complex for MCP. Users should use CLI for that.

### 4. templates/agent-claude.md

Add MCP section after "Core Commands" documenting:
- Available MCP tools and when to use them
- When to use MCP vs CLI
- Note: MCP tools are faster than shelling out to CLI

### 5. CLAUDE.md

Add MCP Integration section for orchestrators documenting setup and available tools.

## Extensibility Notes

To add Cursor support later:
1. Change `supports_mcp()` to return `true` for `Self::Cursor`
2. Add `Self::Cursor => Some(".cursor/mcp.json")` to `mcp_config_filename()`
3. Init will automatically create the config in the right location

## Acceptance Criteria

- [x] `AgentProvider::supports_mcp()` method added returning `true` for Claude, `false` for others
- [x] `AgentProvider::mcp_config_filename()` method added returning `Some(".mcp.json")` for Claude
- [x] Unit tests added for new `AgentProvider` methods
- [x] Init command creates `.mcp.json` when any provider supports MCP
- [x] `.mcp.json` contains correct chant MCP server config
- [x] MCP server exposes `chant_ready` tool
- [x] MCP server exposes `chant_status` tool
- [x] MCP server exposes `chant_log` tool
- [x] MCP server exposes `chant_search` tool
- [x] MCP server exposes `chant_diagnose` tool
- [x] MCP server exposes `chant_add` tool
- [x] MCP server exposes `chant_finalize` tool
- [x] MCP server exposes `chant_resume` tool
- [x] MCP server exposes `chant_cancel` tool
- [x] MCP server exposes `chant_archive` tool
- [x] `echo '{"jsonrpc":"2.0","method":"tools/list","id":1}' | chant mcp` shows 13 tools
- [x] Update test in `mcp.rs` that validates tool count (3 â†’ 13)
- [x] `templates/agent-claude.md` has MCP Tools section after Core Commands
- [x] `CLAUDE.md` has MCP Integration section for orchestrators
- [x] `cargo test` passes
- [x] `cargo clippy` passes

## Agent Output

2026-01-29T21:57:06Z

```
I'll implement this spec to improve MCP discoverability. Let me start by reading the relevant files to understand the current implementation.
Now let me read the agent template and CLAUDE.md files:
Now let me read the spec file to understand exactly what I need to implement:
Now I have a clear understanding of the task. Let me create a todo list to track my progress and start implementing.
Let me start by adding the `supports_mcp()` and `mcp_config_filename()` methods to `AgentProvider` in `src/templates.rs`:
Now let me add unit tests for the new methods:
Now let me update the init command in `src/main.rs` to create `.mcp.json` when any provider supports MCP. I need to find the right place to add this logic, which is after agent files are written:
I can see the agent configuration loop ends at line 1643. I need to add the MCP config creation logic right after that. Let me add the MCP config creation logic after the agent files are created:
Now let me look at the existing MCP implementation more closely and expand the tools. I need to read some of the context files to understand how the CLI commands work for the new tools I need to implement:
Let me also look at the add, finalize, archive, and cancel commands more closely:
Now I have a good understanding of how the CLI commands work. Let me implement the expanded MCP tools. I'll rewrite the MCP implementation:
Now I need to rewrite the MCP tools. Let me create the expanded tools list and handlers. First, let me check what imports I might need:
Let me check what functions are available from chant library for paths and spec management:
Now let me also look at the diagnose module:
Now I have enough understanding. Let me now write the expanded MCP tools. I'll edit the `mcp.rs` file to add all the new tools:
Now let me replace the `handle_tools_list` function with the expanded tools list:
Now let me update the `handle_tools_call` function to dispatch to the new tools:
Now let me add all the new tool implementations. I need to add them after the existing tool functions. Let me first read the end of the file:
Now I need to add all the new tool implementations before the tests. Let me add them after `tool_chant_spec_update`:
Now I need to update the test that validates the tool count from 3 to 13:
Now let me add the MCP section to `templates/agent-claude.md`. I'll add it after the "Core Commands" section:
I'll add the MCP Tools section after the Additional Tools section and before the Spec Format section:
Now let me add the MCP Integration section to the orchestrator's `CLAUDE.md`. I'll add it after the Custom Merge Driver section and before the Testing section:
I'll add the MCP Integration section after the Testing section and before Interactive Wizard Modes:
Now let me run `cargo fmt` to format the code:
Now let me run `cargo clippy` to check for lint warnings:
The clippy warnings are from existing code, not from my changes. Let me specifically check if there are any warnings in my modified files:
Let me check what warnings those are:
I see two issues:
1. Unused import of `Spec`
2. `title` is an `Option<String>`, not a `String`

Let me check the Spec struct to understand the title field:
I need to fix the issues. Let me fix the unused import and the title field handling:
Now let me fix the title field handling in the search tool:
Now let me run clippy again to verify:
Let me check if these are serious warnings:
The warnings are:
1. `supports_mcp` method is never used - but I added code in `cmd_init` that uses it via `mcp_config_filename()`. Let me check if that's actually calling it.
2. `cmd_init` has too many arguments - this is a pre-existing warning.

Let me verify that my init code is correctly using the MCP methods:
I see - I'm calling `mcp_config_filename()` directly but not `supports_mcp()`. The `supports_mcp()` method is not explicitly used since `mcp_config_filename()` returns `None` for unsupported providers. But I still need to have the method for documentation and future use. Let me add `#[allow(dead_code)]` to suppress the warning since it's designed for future extensibility:
Now let me run clippy again:
Now let me run the tests:
All tests pass. Now let me verify that the MCP server works by testing it:
All 13 tools are available. Now let me update the todo list and mark the acceptance criteria in the spec:
Now let me update the spec file to mark all acceptance criteria as complete:
Now let me add the model to the frontmatter (as per spec instructions):
Now let me check git status and commit the changes:
The changes look right. Let me stage and commit only the files related to this spec:
I have successfully implemented the spec. Here's a summary of what was done:

## Summary

### Changes Made

1. **src/templates.rs**
   - Added `supports_mcp()` method to `AgentProvider` - returns `true` for Claude, `false` for others
   - Added `mcp_config_filename()` method - returns `Some(".mcp.json")` for Claude
   - Added unit tests for both new methods

2. **src/

... (output truncated, 6104 chars total)```
