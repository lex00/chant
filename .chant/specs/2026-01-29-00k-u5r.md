---
type: code
status: in_progress
target_files:
- src/templates.rs
- src/main.rs
- src/mcp.rs
- templates/agent-claude.md
- CLAUDE.md
context:
- src/cmd/lifecycle.rs
- src/cmd/spec.rs
- src/cmd/search.rs
model: claude-opus-4-5-20251101
---
# Improve MCP discoverability - auto-create .mcp.json on init and document MCP tools

## Problem

MCP server is fully implemented but invisible:
- Creator forgot it existed
- Agents repeatedly fall off track instead of using structured tools
- Not mentioned anywhere users/agents would see it
- Only 3 basic tools, missing useful operations

## Solution

Four-part approach focusing on Claude Code first, but implementing CLI in a provider-agnostic way:

1. **Auto-create `.mcp.json` on init** - When `chant init --agent claude` runs, also create `.mcp.json` with the chant MCP server config
2. **Expand MCP tools** - Add more tools to cover useful CLI operations (provider-agnostic)
3. **Add MCP section to agent template** - Document MCP tools in `templates/agent-claude.md` so agents know to use them
4. **Add MCP section to orchestrator CLAUDE.md** - Document MCP integration for orchestrators

## Implementation Details

### 1. src/templates.rs

Add MCP support methods to `AgentProvider`:

```rust
impl AgentProvider {
    /// Returns true if this provider supports MCP and should generate config
    pub fn supports_mcp(&self) -> bool {
        match self {
            Self::Claude => true,
            Self::Cursor => false,  // Future: set to true, add mcp_config_filename
            Self::AmazonQ => false,
            Self::Generic => false,
        }
    }

    /// Get MCP config filename if provider supports MCP
    pub fn mcp_config_filename(&self) -> Option<&'static str> {
        match self {
            Self::Claude => Some(".mcp.json"),
            // Future: Self::Cursor => Some(".cursor/mcp.json"),
            _ => None,
        }
    }
}
```

### 2. src/main.rs (init command)

After writing agent files, check if any provider supports MCP and write the config:

```json
{
  "mcpServers": {
    "chant": {
      "type": "stdio",
      "command": "chant",
      "args": ["mcp"]
    }
  }
}
```

### 3. src/mcp.rs - Expand MCP tools

Current tools (keep):
- `chant_spec_list` - list specs with status filter
- `chant_spec_get` - get spec by ID
- `chant_spec_update` - update status/append output

Add query tools (read-only, safe):
- `chant_ready` - list specs with status=ready (convenience wrapper)
- `chant_status` - count specs by status (project summary)
- `chant_log` - read from `.chant/logs/{id}.log`
- `chant_search` - filter specs by query string
- `chant_diagnose` - analyze failed spec

Add mutating tools:
- `chant_add` - create spec file from description
- `chant_finalize` - update spec to completed
- `chant_resume` - reset failed spec to pending
- `chant_cancel` - set status to cancelled
- `chant_archive` - move to archive dir

Note: `chant_work` is intentionally omitted - it spawns an agent process which is complex for MCP. Users should use CLI for that.

### 4. templates/agent-claude.md

Add MCP section after "Core Commands" documenting:
- Available MCP tools and when to use them
- When to use MCP vs CLI
- Note: MCP tools are faster than shelling out to CLI

### 5. CLAUDE.md

Add MCP Integration section for orchestrators documenting setup and available tools.

## Extensibility Notes

To add Cursor support later:
1. Change `supports_mcp()` to return `true` for `Self::Cursor`
2. Add `Self::Cursor => Some(".cursor/mcp.json")` to `mcp_config_filename()`
3. Init will automatically create the config in the right location

## Acceptance Criteria

- [x] `AgentProvider::supports_mcp()` method added returning `true` for Claude, `false` for others
- [x] `AgentProvider::mcp_config_filename()` method added returning `Some(".mcp.json")` for Claude
- [x] Unit tests added for new `AgentProvider` methods
- [x] Init command creates `.mcp.json` when any provider supports MCP
- [x] `.mcp.json` contains correct chant MCP server config
- [x] MCP server exposes `chant_ready` tool
- [x] MCP server exposes `chant_status` tool
- [x] MCP server exposes `chant_log` tool
- [x] MCP server exposes `chant_search` tool
- [x] MCP server exposes `chant_diagnose` tool
- [x] MCP server exposes `chant_add` tool
- [x] MCP server exposes `chant_finalize` tool
- [x] MCP server exposes `chant_resume` tool
- [x] MCP server exposes `chant_cancel` tool
- [x] MCP server exposes `chant_archive` tool
- [x] `echo '{"jsonrpc":"2.0","method":"tools/list","id":1}' | chant mcp` shows 13 tools
- [x] Update test in `mcp.rs` that validates tool count (3 â†’ 13)
- [x] `templates/agent-claude.md` has MCP Tools section after Core Commands
- [x] `CLAUDE.md` has MCP Integration section for orchestrators
- [x] `cargo test` passes
- [x] `cargo clippy` passes