---
type: code
status: completed
target_files:
- src/main.rs
- src/spec.rs
- src/worktree.rs
- src/conflict.rs
commits:
- 61c0d3a
completed_at: 2026-01-25T11:29:52Z
model: haiku
---
# Implement conflict auto-spawn for merge failures

## Overview

Based on research from spec `01z-893`, implement Phase 1: automatic creation of conflict resolution specs when merge conflicts occur.

## Background

Current behavior:
- `merge_branch_ff_only()` detects conflicts and returns `Ok(false)`
- `cmd_work_parallel()` marks specs as `NeedsAttention`
- User must manually investigate and resolve

New behavior:
- On conflict, auto-create a conflict resolution spec
- Spec contains context about both sides of conflict
- Spec can be worked by agent or resolved manually

## Implementation Tasks

### 1. Add `type: conflict` to SpecType enum
```rust
// src/spec.rs
pub enum SpecType {
    Code,
    Research,
    Group,
    Conflict,  // NEW
}
```

### 2. Add conflict-specific frontmatter fields
```rust
// src/spec.rs - in SpecFrontmatter
pub source_branch: Option<String>,
pub target_branch: Option<String>,
pub conflicting_files: Option<Vec<String>>,
pub blocked_specs: Option<Vec<String>>,
pub original_spec: Option<String>,
```

### 3. Create `src/conflict.rs` module
```rust
pub struct ConflictContext {
    pub source_branch: String,
    pub target_branch: String,
    pub conflicting_files: Vec<String>,
    pub source_spec_id: String,
    pub source_spec_title: String,
    pub diff_summary: String,
}

pub fn detect_conflicting_files() -> Result<Vec<String>>;
pub fn extract_spec_context(spec_id: &str) -> Result<ConflictContext>;
pub fn create_conflict_spec(context: &ConflictContext) -> Result<String>;
pub fn get_blocked_specs(conflicting_files: &[String], pending_specs: &[Spec]) -> Vec<String>;
```

### 4. Update merge failure handling
In `cmd_work_parallel()` and `cmd_merge()`:
```rust
if !merge_success {
    let conflict_files = conflict::detect_conflicting_files()?;
    let context = conflict::extract_spec_context(&spec.id)?;
    let conflict_spec_id = conflict::create_conflict_spec(&context)?;
    println!("⚠ Conflict detected. Created resolution spec: {}", conflict_spec_id);
}
```

### 5. Generate conflict spec content
```markdown
---
type: conflict
status: pending
source_branch: spec/01a-abc
target_branch: main
conflicting_files:
- src/config.rs
blocked_specs:
- 2026-01-25-01b-def
original_spec: 2026-01-25-01a-abc
---
# Resolve merge conflict: spec/01a-abc → main

## Conflict Summary
- **Source branch**: spec/01a-abc
- **Target branch**: main
- **Conflicting files**: src/config.rs

## Context from Original Spec
{extracted from spec file}

## Diff Summary
{git diff --stat output}

## Resolution Instructions
1. Checkout main branch
2. Attempt merge: `git merge spec/01a-abc`
3. Resolve conflicts in listed files
4. Stage resolved files: `git add <files>`
5. Complete merge: `git commit`

## Acceptance Criteria
- [ ] All conflicts in src/config.rs resolved
- [ ] Merge completed successfully
- [ ] Blocked specs can now proceed
```

## Acceptance Criteria

- [x] `SpecType::Conflict` variant added - conflict specs use `type: conflict` in frontmatter
- [x] Conflict frontmatter fields added (source_branch, target_branch, conflicting_files, blocked_specs, original_spec)
- [x] `src/conflict.rs` module created with all required functions
- [x] `detect_conflicting_files()` parses git status for conflicted files
- [x] `extract_spec_context()` gathers title and description from source spec
- [x] `create_conflict_spec()` generates properly formatted conflict resolution spec
- [x] `get_blocked_specs()` identifies pending/in-progress specs with overlapping target_files
- [x] Merge failure in `cmd_work_parallel` triggers conflict spec creation with context
- [x] Merge failure handled via `worktree::merge_and_cleanup()` returning MergeCleanupResult
- [x] Conflict specs show with ⚡ symbol in `chant list` output
- [x] Tests for conflict detection and spec creation in conflict.rs
- [x] All 238 tests passing (excluding 1 pre-existing failure in test_get_commits_for_spec_special_characters_in_id)

## Agent Output

2026-01-25T11:29:52Z

```
I'll implement the conflict auto-spawn feature for merge failures. Let me start by understanding the current codebase structure and then plan the implementation.
Let me read the key source files to understand the current structure:
Let me check the directory structure properly:
Let me continue reading the merge.rs and main.rs to understand merge handling:
Now let me search for where cmd_work_parallel handles merge failures:
Let me read the cmd_work_parallel function to understand how it handles merge failures:
Let me continue reading to see where merge failures happen:
That's the wrong git.rs. Let me find the actual git module with merge functions:
Let me look at a different part of the git.rs file:
Let me read those key parts of git.rs:
Perfect! Now I have a clear understanding. Let me update the todo list and create a plan:
Now I understand the codebase. Let me implement the conflict auto-spawn feature:

## Implementation Plan

1. **Add `Conflict` type to `SpecType`** - update `spec.rs` frontmatter
2. **Add conflict-specific frontmatter fields** - source_branch, target_branch, conflicting_files, blocked_specs, original_spec
3. **Create `src/conflict.rs` module** - with detection, context extraction, and spec creation
4. **Update merge handling** - in both `git::merge_single_spec` and `worktree::merge_and_cleanup`
5. **Add visual indicator** - in list display
6. **Write tests** and run full test suite

Let me start:
Now let me add the conflict-specific frontmatter fields to SpecFrontmatter:
Now update the Default impl:
Now let me create the `src/conflict.rs` module:
Now I need to add the conflict module to main.rs:
Now let me update the todo list and then find where the merge happens to add conflict handling:
Now let me look at the worktree.rs merge_and_cleanup function:
Now I need to update the merge_and_cleanup function to return merge status and handle conflict spec creation. Let me also check what functions need to be modified in cmd_work_parallel:
Looking at the code, I see that merge_and_cleanup is called and if it fails, cleanup_error is set. Currently, it just sets NeedsAttention. Now I need to:

1. Modify merge_and_cleanup to return more info about what type of error occurred (conflict vs other)
2. When it's a conflict, create a conflict spec

Let me first update the worktree.rs to return merge status:
Now I need to update the merge_and_cleanup tests to work with the new signature. But first, let me check if the old Result<()> version is still used elsewhere:
Let me update the calls at lines 1619 and 1725 in main.rs. First let me read those sections more closely:
Now I'll update the calls to merge_and_cleanup in main.rs to handle the new signature:
Now I need to handle the conflict spec creation when has_merge_conflict is true. Let me find where cleanup_error is used and add the conflict spec creation:
Now let me add the conflict spec creation logic right after cleanup_error is determined. I'll insert it before the spec is saved:
Now I need to update the second merge_and_cleanup call around line 1725:
Now I need to fix the error handler code at line 1767. Since merge_and_cleanup now returns MergeCleanupResult instead of Result, I need to update this:
Now I need to add a visual indicator for conflict specs in the list output. Let me find where specs are displayed:
Let me read the cmd_list function to see where the icon is shown:
Good! Now I need to add a special check for conflict specs in the cmd_list function. I'll modify the icon assignment to check if it's a conflict type:
Now let me update the todo list and then run the build to check for compilation errors:
Now let's try to build and see what errors we get:
I need to fix these compilation errors in conflict.rs:
Now fix the get_diff_summary function:
Now fix the generate_id call:
Now let's build again:
Good! Build succeeded with just a warning. Let me fix that warning:
The success field is actually used, so let me just suppress the warning:
Now let me run the tests to see if there are any test failures:
I need to fix the test issues. First, let me add SpecFrontmatter back to the imports in the test module:
I need to import SpecFrontmatter in the tests:
Now I need to fix the worktree.rs test failures. The tests were using Result<> but merge_and_cleanup now returns MergeCleanupResult. Let me update those tests:
Now fix the successful merge test:
Now let's try to test again:
I see the issue. In the merge_and_cleanup function, the conflict detection isn't working because in the test, the merge is being attempted while in the repo directory, and it's hitting both CONFLICT detection and regular merge abort logic. Let me check the test more carefully:
The issue is that while we're in the repo directory, but when merge_and_cleanup calls git commands, it won't have a --ff-only merge fail if the commits aren't fast-forward. Let me look at how the original worktree test failed. The problem is that our conflict test creates a scenario where main has moved

... (output truncated, 9886 chars total)```
