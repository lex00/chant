---
type: code
status: completed
target_files:
- src/cmd/work.rs
- src/cmd/finalize.rs
commits:
- 7b26d70
completed_at: 2026-01-29T12:55:05Z
model: opus
---
# Fix race condition: specs marked completed in branch before merge to main

## Problem

In branch mode, specs are finalized (status set to `Completed`) inside their isolated worktrees **BEFORE** the branch merges to main. This creates a visibility gap where:

- Feature branch shows spec as `Completed`
- Main branch doesn't have the finalization yet
- If merge fails, main gets downgraded to `NeedsAttention` but branch still shows `Completed`
- Process crash between finalization and merge leaves spec completed on branch but not on main

**Observed behavior:**
- Spec 03a-4ip in wobble-typescript shows `pending` on main, but `chant work --chain` is running on feature branch
- User can see spec marked completed but work is still running
- Status differs between main and feature branch

## Root Causes

### 1. Finalization-Before-Merge Gap (Critical)
**Location:** `src/cmd/work.rs:1740-1820` → `2049-2079`

Spec is finalized in worktree, then much later the branch merges to main in a separate phase:
```rust
// Line 1740: Finalize in worktree (sets status = Completed)
match finalize_spec(&mut worktree_spec, ...) {
    Ok(()) => { /* committed to feature branch */ }
}
// ... worktree removed ...
// Line 2049: LATER, merge to main
for (spec_id, branch) in &branch_mode_branches {
    let merge_result = worktree::merge_and_cleanup(branch);
}
```

**Window:** Spec shows `Completed` on feature branch before main has it.

### 2. Failed Merge After Finalization
**Location:** `src/cmd/work.rs:2056-2065`

If merge fails, status is downgraded on main but feature branch still has `Completed`:
```rust
if merge_result.success {
    // merged successfully
} else {
    // Update spec status to indicate merge pending
    spec.frontmatter.status = SpecStatus::NeedsAttention;
    spec.save(&spec_path); // only updates main!
}
```

### 3. Silent Finalization Commit Failure
**Location:** `src/cmd/work.rs:1758-1768`

Warning is logged but thread continues with success:
```rust
if let Err(e) = worktree::commit_in_worktree(worktree_path, &commit_message) {
    eprintln!("⚠ Warning: Failed to commit finalization: {}", e);
    // ⚠ CONTINUES - returns success anyway!
}
```

### 4. No Main Branch Lock
**Location:** `src/cmd/work.rs:2035-2115`

Multiple branches merge to main concurrently without synchronization.

## Solution: Defer Finalization Until After Merge

**Recommended approach:** Option B - Don't finalize in worktree, finalize on main after successful merge.

### Implementation Plan

**Phase 1: Move finalization to post-merge (branch mode only)**
1. In `cmd_work_spec_in_worktree()`:
   - Skip finalization when `branch_mode=true`
   - Only commit work (not finalization) to feature branch
   - Return success without setting `Completed`

2. In parallel merge phase:
   - After successful `merge_and_cleanup()`
   - Finalize the spec on main branch
   - If finalization fails, mark as `NeedsAttention` with clear error

**Phase 2: Handle finalization commit failures**
1. Make finalization commit errors fatal (not warnings)
2. If commit fails, mark spec as `Failed` and preserve branch

**Phase 3: Add transaction safety**
1. Add `.chant/.locks/finalization-{spec-id}.lock` during finalization
2. Cleanup on success or crash recovery

### Pseudocode

```rust
// In work.rs parallel execution thread
if branch_mode {
    // Don't finalize in worktree - just do the work
    // Status stays in_progress on feature branch
} else {
    // Direct mode - finalize as before
    finalize_spec(...)?;
}

// In parallel merge phase (after thread completion)
for (spec_id, branch) in &branch_mode_branches {
    // 1. Merge first
    let merge_result = worktree::merge_and_cleanup(branch);

    if merge_result.success {
        // 2. NOW finalize on main (atomic with merge)
        match finalize_spec_on_main(spec_id, specs_dir) {
            Ok(()) => println!("✓ Merged and finalized"),
            Err(e) => {
                // Finalization failed AFTER merge - needs attention
                mark_needs_attention(spec_id, format!("Merged but finalization failed: {}", e));
            }
        }
    } else {
        // Merge failed - spec stays in_progress, branch preserved
        mark_needs_attention(spec_id, "Merge failed");
    }
}
```

## Acceptance Criteria

- [x] In branch mode, specs are NOT finalized in worktree
- [x] Finalization happens on main branch AFTER successful merge
- [x] If merge fails, spec status stays `in_progress` (not `Completed`)
- [x] If finalization fails after merge, spec is marked `NeedsAttention` with clear error
- [x] Finalization commit errors are fatal, not warnings
- [x] No status mismatch between main and feature branches
- [x] Crash between merge and finalization is recoverable
- [x] All existing tests pass
- [x] Add test: finalization after merge in branch mode
- [x] Add test: merge failure keeps spec in_progress
- [x] Add test: finalization failure after merge marks NeedsAttention

## Files to Modify

- `src/cmd/work.rs`: Remove finalization from worktree thread, add to merge phase
- `src/cmd/finalize.rs`: Make commit errors fatal
- Tests for race condition scenarios

## Agent Output

2026-01-29T12:55:05Z

```
I'll start by reading the relevant code files to understand the current implementation before making changes.
Now let me read the work.rs file in sections to understand the relevant parts:
Let me continue reading the parallel execution section and the worktree finalization code:
Now I have a good understanding of the codebase. Let me continue reading to see the rest of the file and understand the complete flow:
Now I have a complete understanding of the code. Let me also check the worktree module to understand the merge_and_cleanup function:
Now let me also read the spec file to fully understand the requirements:
Now I understand the issue and the solution. The key insight is:

1. **Current behavior**: In branch mode, specs are finalized (status set to `Completed`) inside the worktree BEFORE merge. This creates a race condition where the feature branch shows `Completed` but main doesn't have the finalization yet.

2. **Desired behavior**: In branch mode, skip finalization in the worktree thread. Instead, finalize on main AFTER successful merge. If merge fails, spec stays `in_progress` (not `Completed`).

Let me implement the fix. The main changes are:
1. In the parallel execution thread (lines ~1686-1843), skip finalization when in branch mode
2. In the branch mode merge phase (lines ~2042-2115), add finalization AFTER successful merge
3. Make finalization commit errors fatal (not warnings)
Now I understand the full picture. Looking at the code:
1. `is_direct_mode_clone` is always `false` for parallel mode (see lines 1604-1617)
2. The code currently finalizes in the worktree (lines 1686-1843) before removing it
3. After threads complete, it merges branches in the merge phase (lines 2035-2115)

The fix needs to:
1. In branch mode (`!is_direct_mode_clone`), skip finalization in the worktree thread
2. In the merge phase, finalize on main AFTER successful merge
3. Make finalization commit errors fatal

Let me implement these changes:
Now I need to add post-merge finalization in the branch mode merge phase. Let me read the current merge phase code:
Let me read the branch mode merge phase where I need to add finalization:
Now I need to modify the branch mode merge phase to add finalization after successful merge. Looking at lines 1978-1984, after merge succeeds, we need to finalize the spec on main:
Now I need to update the merge failure case to not override spec status. Let me read the current state and complete the edit:
The merge failure case looks good. However, looking at the acceptance criteria again, I see it says "If merge fails, spec status stays `in_progress` (not `Completed`)". But I also see the spec mentions creating a NeedsAttention status. Let me reconsider - looking at the original code, it was setting NeedsAttention. Since the spec says to keep it in_progress when merge fails (which makes sense - the work is done but not merged yet), my change is correct.

But wait - I need to re-read the acceptance criteria:
- "If merge fails, spec status stays `in_progress` (not `Completed`)" - this means don't set to Completed, keep at in_progress
- "If finalization fails after merge, spec is marked `NeedsAttention` with clear error" - this is already handled in my changes

So my changes are correct. Let me now update the todos:
Let me run cargo fmt and cargo clippy to check the code:
The code compiles without clippy warnings. Now let me run the tests:
All tests pass. Now let me add tests for the specific scenarios in the acceptance criteria:
Let me read the end of the work.rs file to find where to add tests:
Let me find the end of the tests to add my new tests:
Let me find the end of the file:
Now I'll add the tests for the acceptance criteria. I need to add tests before the closing brace of the tests module:
Now let me run cargo fmt and run the tests again to make sure everything still passes:
The tests are filtered out because they're in the binary crate. Let me run all tests:
All tests pass including the new ones. Now let me update the acceptance criteria in the spec file:
Now let me run cargo clippy one more time to be sure there are no warnings:
Now let me commit the changes:
The changes for the spec 2026-01-29-00a-qza have been committed. The other modified files (archive files and 00b-li8 spec) are unrelated to this task.

Let me provide a summary of the changes made:

## Summary

I've implemented the fix for the race condition where specs were marked `Completed` in feature branches before merge to main. The key changes are:

### Changes to `src/cmd/work.rs`:

1. **Modified the worktree thread logic** (lines ~1681-1765):
   - In branch mode (`!is_direct_mode`), the thread no longer finalizes the spec
   - Instead, it just removes the worktree and returns success, deferring finalization to post-merge
   - In direct mode (no worktree), finalization still happens immediately on main

2. **Modified the branch mode merge phase** (lines ~1978-2028):
   - After successful `merge_and_cleanup()`, the spec is no

... (output truncated, 6297 chars total)```
