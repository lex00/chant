---
type: code
status: in_progress
target_files:
- src/cmd/work.rs
- src/cmd/finalize.rs
---
# Fix race condition: specs marked completed in branch before merge to main

## Problem

In branch mode, specs are finalized (status set to `Completed`) inside their isolated worktrees **BEFORE** the branch merges to main. This creates a visibility gap where:

- Feature branch shows spec as `Completed`
- Main branch doesn't have the finalization yet
- If merge fails, main gets downgraded to `NeedsAttention` but branch still shows `Completed`
- Process crash between finalization and merge leaves spec completed on branch but not on main

**Observed behavior:**
- Spec 03a-4ip in wobble-typescript shows `pending` on main, but `chant work --chain` is running on feature branch
- User can see spec marked completed but work is still running
- Status differs between main and feature branch

## Root Causes

### 1. Finalization-Before-Merge Gap (Critical)
**Location:** `src/cmd/work.rs:1740-1820` → `2049-2079`

Spec is finalized in worktree, then much later the branch merges to main in a separate phase:
```rust
// Line 1740: Finalize in worktree (sets status = Completed)
match finalize_spec(&mut worktree_spec, ...) {
    Ok(()) => { /* committed to feature branch */ }
}
// ... worktree removed ...
// Line 2049: LATER, merge to main
for (spec_id, branch) in &branch_mode_branches {
    let merge_result = worktree::merge_and_cleanup(branch);
}
```

**Window:** Spec shows `Completed` on feature branch before main has it.

### 2. Failed Merge After Finalization
**Location:** `src/cmd/work.rs:2056-2065`

If merge fails, status is downgraded on main but feature branch still has `Completed`:
```rust
if merge_result.success {
    // merged successfully
} else {
    // Update spec status to indicate merge pending
    spec.frontmatter.status = SpecStatus::NeedsAttention;
    spec.save(&spec_path); // only updates main!
}
```

### 3. Silent Finalization Commit Failure
**Location:** `src/cmd/work.rs:1758-1768`

Warning is logged but thread continues with success:
```rust
if let Err(e) = worktree::commit_in_worktree(worktree_path, &commit_message) {
    eprintln!("⚠ Warning: Failed to commit finalization: {}", e);
    // ⚠ CONTINUES - returns success anyway!
}
```

### 4. No Main Branch Lock
**Location:** `src/cmd/work.rs:2035-2115`

Multiple branches merge to main concurrently without synchronization.

## Solution: Defer Finalization Until After Merge

**Recommended approach:** Option B - Don't finalize in worktree, finalize on main after successful merge.

### Implementation Plan

**Phase 1: Move finalization to post-merge (branch mode only)**
1. In `cmd_work_spec_in_worktree()`:
   - Skip finalization when `branch_mode=true`
   - Only commit work (not finalization) to feature branch
   - Return success without setting `Completed`

2. In parallel merge phase:
   - After successful `merge_and_cleanup()`
   - Finalize the spec on main branch
   - If finalization fails, mark as `NeedsAttention` with clear error

**Phase 2: Handle finalization commit failures**
1. Make finalization commit errors fatal (not warnings)
2. If commit fails, mark spec as `Failed` and preserve branch

**Phase 3: Add transaction safety**
1. Add `.chant/.locks/finalization-{spec-id}.lock` during finalization
2. Cleanup on success or crash recovery

### Pseudocode

```rust
// In work.rs parallel execution thread
if branch_mode {
    // Don't finalize in worktree - just do the work
    // Status stays in_progress on feature branch
} else {
    // Direct mode - finalize as before
    finalize_spec(...)?;
}

// In parallel merge phase (after thread completion)
for (spec_id, branch) in &branch_mode_branches {
    // 1. Merge first
    let merge_result = worktree::merge_and_cleanup(branch);

    if merge_result.success {
        // 2. NOW finalize on main (atomic with merge)
        match finalize_spec_on_main(spec_id, specs_dir) {
            Ok(()) => println!("✓ Merged and finalized"),
            Err(e) => {
                // Finalization failed AFTER merge - needs attention
                mark_needs_attention(spec_id, format!("Merged but finalization failed: {}", e));
            }
        }
    } else {
        // Merge failed - spec stays in_progress, branch preserved
        mark_needs_attention(spec_id, "Merge failed");
    }
}
```

## Acceptance Criteria

- [x] In branch mode, specs are NOT finalized in worktree
- [x] Finalization happens on main branch AFTER successful merge
- [x] If merge fails, spec status stays `in_progress` (not `Completed`)
- [x] If finalization fails after merge, spec is marked `NeedsAttention` with clear error
- [x] Finalization commit errors are fatal, not warnings
- [x] No status mismatch between main and feature branches
- [x] Crash between merge and finalization is recoverable
- [x] All existing tests pass
- [x] Add test: finalization after merge in branch mode
- [x] Add test: merge failure keeps spec in_progress
- [x] Add test: finalization failure after merge marks NeedsAttention

## Files to Modify

- `src/cmd/work.rs`: Remove finalization from worktree thread, add to merge phase
- `src/cmd/finalize.rs`: Make commit errors fatal
- Tests for race condition scenarios