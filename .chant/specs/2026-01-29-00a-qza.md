---
type: code
status: pending
---

# Fix race condition: specs marked completed in branch before merge to main

PROBLEM: In branch mode, specs are finalized (status set to Completed) inside their isolated worktrees BEFORE the branch merges to main. This creates a visibility gap where:
- Feature branch shows spec as Completed
- Main branch doesn't have the finalization yet
- If merge fails, main gets downgraded to NeedsAttention but branch still shows Completed
- Process crash between finalization and merge leaves spec completed on branch but not on main

ROOT CAUSES:
1. Finalization happens in worktree (line 1740 in work.rs), merge happens later in serial phase (line 2049)
2. Finalization commit failure is logged as warning but thread continues (line 1758-1768)
3. Failed merge downgrades main to NeedsAttention but feature branch keeps Completed (line 2063)
4. No atomicity between finalization and merge operations

OBSERVED BEHAVIOR:
- Spec 03a-4ip in wobble-typescript shows pending on main, but chant work --chain is running on feature branch
- Similar reports of specs showing completed while still running

SOLUTION OPTIONS:

Option A (Two-Phase Commit):
- Don't set status=Completed in worktree
- Set status=finalizing (new intermediate state) 
- After successful merge to main, set Completed on main
- Rollback to in_progress if merge fails

Option B (Defer Finalization):
- Don't finalize in worktree at all
- Merge branch to main first
- Finalize on main after successful merge
- Simpler, no intermediate states

Option C (Atomic Finalize-and-Merge):
- Keep finalization in worktree
- Make merge mandatory (fail the spec if merge fails)
- Add transaction log for crash recovery
- More complex but supports current workflow

RECOMMENDED: Option B (defer finalization until after merge)
- Simplest implementation
- No new states needed
- Maintains atomicity guarantee
- Clear failure semantics
