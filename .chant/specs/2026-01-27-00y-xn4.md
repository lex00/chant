---
type: code
status: pending
target_files:
  - src/cmd/work.rs
---

# Fix parallel execution not finalizing spec metadata

## Problem

**Critical Bug:** Parallel execution completes work but doesn't finalize spec metadata, leaving specs in "ready" state.

**User Report:**
- Sequential `chant work` properly shows ● completed in `chant list`
- Parallel `chant work --parallel` shows ○ ready even after successful completion
- Spec file investigation shows `status: pending` instead of `status: completed`
- Missing fields: `commits`, `completed_at`, `model`
- The parallel agents committed code but didn't update spec metadata
- Message says "✓ 2 specs completed work" but specs aren't finalized
- User did NOT run `chant finalize` manually (assumed it was automatic)

**Impact:**
- Users can't tell which specs actually completed
- Risk of re-running already-completed specs
- No audit trail (missing commits, timestamps, model)
- Status tracking completely broken for parallel mode

## Root Cause

Sequential execution path calls finalization, but parallel path doesn't.

**Expected Flow:**
1. Agent completes work in worktree
2. Commits are made to branch
3. `finalize_spec()` is called
4. Spec frontmatter updated: status, commits, completed_at, model
5. Spec saved to disk

**Current Parallel Flow (Broken):**
1. Agent completes work in worktree ✅
2. Commits are made to branch ✅
3. `finalize_spec()` is NOT called ❌
4. Spec frontmatter NOT updated ❌
5. Spec shows as ready, not completed ❌

## Solution

Add finalization step to parallel execution workflow:

**In src/cmd/work.rs:**

```rust
pub fn execute_parallel_specs(specs: Vec<Spec>, config: &Config) -> Result<()> {
    // ... parallel execution ...

    for spec_result in completed_specs {
        if spec_result.success {
            // NEW: Finalize the spec
            let spec_path = format!(".chant/specs/{}.md", spec_result.spec_id);
            let spec = Spec::load(&spec_path)?;

            // Get commits from branch
            let commits = get_commits_for_spec(&spec.id)?;

            // Finalize with all metadata
            finalize_spec(&spec, commits)?;

            println!("✓ Finalized {}", spec.id);
        }
    }

    Ok(())
}
```

**Key Requirements:**
- Call finalize_spec() for each successfully completed spec
- Extract commits from spec branch
- Update frontmatter: status, commits, completed_at, model
- Save spec to disk
- Match sequential execution behavior exactly

## Acceptance Criteria

- [x] Identify where sequential execution calls finalize
- [x] Add finalize_spec() call in parallel execution path
- [x] Extract commits from spec branch after parallel work
- [x] Update spec frontmatter with all metadata fields
- [x] Save finalized spec to disk
- [x] Add logging: "✓ Finalized {spec_id}"
- [x] Integration test: parallel work -> verify status: completed in frontmatter
- [x] Integration test: parallel work -> verify commits, completed_at, model present
- [x] Integration test: parallel work -> chant list shows ● completed
- [x] All existing tests pass