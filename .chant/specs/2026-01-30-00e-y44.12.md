---
type: code
status: completed
depends_on:
- 2026-01-30-00e-y44.11
target_files:
- src/cli/work.rs
commits:
- e9f761a
completed_at: 2026-01-31T18:09:14Z
model: sonnet
---
# Integrate Scoring into chant work

Add quality warning before starting work on low-quality specs.

### Acceptance Criteria

- [x] Calculate quality score before agent starts work
- [x] If status is Refine (red), show warning with dimensions and suggestions
- [x] Prompt user: "Continue anyway? [y/N]"
- [x] Abort work if user declines
- [x] If status is Review (yellow), show info message but proceed automatically
- [x] Ready (green) status proceeds silently

### Edge Cases

- Non-interactive mode (CI) should respect a `--force` flag to skip prompts
- Warnings should be clear about which dimensions failed
- User input validation (y/yes/n/no case insensitive)

### Example Test Cases

- Starting work on Grade A spec proceeds immediately
- Starting work on Grade D spec shows warning and waits for confirmation
- User entering "n" aborts work and returns to CLI
- `chant work --force` on Grade D spec proceeds without prompt

### Requires

- Calls scoring functions from Members 2-8

## Agent Output

2026-01-31T18:09:14Z

```
I'll implement the scoring integration into `chant work` by following the spec's requirements. Let me start by reading the relevant code and understanding the current implementation.
Let me search for the main work function more broadly.
Good, I can see the main `cmd_work` function. Let me continue reading to understand where the agent is invoked.
Perfect! I can see where the agent is invoked at line 623-634. This is where I need to add the quality scoring check. Let me now read the scoring functions from previous specs to understand what's available.
Good! Now let me check what other scoring functions are available by looking at the spec files that mention scoring.
Let me check what scoring functions have already been implemented by looking at lib.rs to see what modules are exposed.
It looks like only `calculate_complexity` is currently implemented. Let me check the members 2-8 specs to see what other scoring functions should be available.
Good! I can see that members 2-8 have been implementing the scoring functions. Let me check what functions are already available by looking at the score module.
Excellent! Let me check the mod.rs to see what functions are exposed, and then check the traffic_light.rs to understand how to calculate the overall score.
Perfect! Now let me check if there's a function to calculate the overall score. Let me look for a `calculate_score` or similar function:
Great! Now let me check if there's a top-level function to calculate the full SpecScore. Let me look at scoring.rs again for any score calculation function:
I need to create a function to calculate the overall SpecScore. Let me plan my approach now.
Now let me plan my approach:

**Plan:**

1. **Create a helper function** in `src/scoring.rs` to calculate the overall `SpecScore` for a spec, calling all the individual scoring functions from the `score` module
2. **Add quality check logic** in `cmd_work` function (before line 588 where status is set to InProgress) that:
   - Calculates the quality score
   - Checks the traffic light status
   - If Refine (red), displays warning with dimensions and suggestions, prompts user to continue
   - If Review (yellow), displays info message but proceeds automatically
   - If Ready (green), proceeds silently
3. **Add user confirmation** logic for Refine status with proper input validation
4. **Handle the existing `force` flag** to skip the quality check
5. **Handle non-interactive mode** properly (respect `--force` flag in CI)

Let me start implementing:
Now let me add a function to calculate the overall SpecScore. I'll add it at the end of scoring.rs:
Now let me update the work.rs file to add the quality check before the agent starts work. First, let me find the right place to add it:
Perfect! I need to add the quality check before line 588 (where the status is updated to InProgress). Let me insert the quality check logic there:
Now I need to add a helper function to format the grades. Let me add it at the top of the work.rs file:
Now let me run cargo fmt and cargo clippy to check for any issues:
I need to find the correct method name for extracting acceptance criteria. Let me search for it:
Let me search for how ac_quality module extracts criteria:
I see, the ac_quality function takes a `&[String]` of criteria. Let me search for how to extract the criteria strings from a spec:
I see there's a function in `src/cmd/spec/lint.rs`. Let me check that:
Perfect! I need to create a similar helper function or use the existing one. Since the function exists in multiple places, I should extract the criteria directly in my code. Let me update the scoring.rs:
Now let me add the helper function to extract acceptance criteria:
Now let me try building again:
I need to move the new functions before the tests module. Let me find where the tests module starts:
I need to move my new functions before the test module. Let me do that:
Now I need to remove the duplicate functions at the end of the file. Let me check what's at the end:
I need to remove the duplicate functions. Let me check the full end of the file:
I need to remove these duplicate functions at the end. Let me delete them:
Now let me run clippy again:
Great! No clippy warnings. Now let me run the tests:
Excellent! All tests pass. Now let me verify all acceptance criteria are met and update the spec file:
Let me verify all acceptance criteria:

✅ Calculate quality score before agent starts work - DONE (line 591-595 in work.rs)
✅ If status is Refine (red), show warning with dimensions and suggestions - DONE (lines 599-633 in work.rs)
✅ Prompt user: "Continue anyway? [y/N]" - DONE (lines 638-650 in work.rs)
✅ Abort work if user declines - DONE (lines 651-654 in work.rs)
✅ If status is Review (yellow), show info message but proceed automatically - DONE (lines 655-679 in work.rs)
✅ Ready (green) status proceeds silently - DONE (lines 680-682 in work.rs)

Edge cases:
✅ Non-interactive mode (CI) should respect a `--force` flag to skip promp

... (output truncated, 7735 chars total)```
