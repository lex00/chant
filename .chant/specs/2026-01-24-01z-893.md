---
type: research
status: completed
target_files:
- src/main.rs
- src/git.rs
commits:
- 54fb259
completed_at: 2026-01-25T00:45:00Z
model: claude-opus-4-5-20251101
---
# Handle merge conflicts after parallel execution - spawn conflict resolution specs

## Problem

After parallel execution with worktrees, multiple spec branches need to merge to main. When conflicts occur:
- Manual resolution is tedious
- Context about what each spec changed is lost
- No tracking of which conflicts are pending

## Proposed Solution

When merge conflict detected:
1. Create a new **conflict resolution spec** with:
   - Description of the conflict (files, branches involved)
   - Context from both conflicting specs
   - List of all unmerged branches in the chain
2. The conflict spec can be:
   - Worked by an agent (attempt auto-resolution)
   - Split into subtasks if multiple conflicts
   - Manually resolved by user

## Current Implementation Analysis

### What Already Exists

The codebase already has conflict detection in place:

**In `src/git.rs`:**
- `merge_branch_ff_only()` (line 211-234) detects conflicts via stderr containing "CONFLICT" or "merge conflict"
- On conflict, it aborts the merge and returns `Ok(false)` to indicate failure
- `merge_single_spec()` (line 269-339) handles conflict detection and returns to the original branch

**In `src/worktree.rs`:**
- `merge_and_cleanup()` uses `merge_branch_ff_only()` for merging
- Has test `test_merge_and_cleanup_with_conflict_preserves_branch()` that verifies branches are preserved on conflict

**In `src/main.rs`:**
- `cmd_work_parallel()` catches merge failures and marks specs with `NeedsAttention` status
- The `SpecStatus::NeedsAttention` variant was added specifically for conflict scenarios

### What's Missing

1. **No automatic conflict spec creation** - conflicts just result in error messages
2. **No context extraction** - no system to pull "what this spec was doing" from spec content
3. **No unmerged chain tracking** - no tracking of which specs are blocked by a conflict
4. **No automated resolution attempts** - agent doesn't try to resolve automatically

## Research Answers

### 1. Should agent attempt auto-resolution first?

**Recommendation: Yes, with safeguards**

- Attempt auto-resolution for simple conflicts (e.g., both specs added different lines to same file)
- Use `git merge --no-commit` to attempt merge, then have agent review conflicts
- If auto-resolution fails or is uncertain, create a conflict spec for human review
- Never auto-resolve conflicts in critical files (e.g., Cargo.toml dependencies, configuration)

### 2. How to extract "context" from each spec for the conflict description?

**Recommendation: Multi-source context**

1. **Spec title and description** - from the spec file's markdown header and problem statement
2. **Git commit messages** - from commits matching `chant({spec-id})`
3. **Agent output** - from the `## Agent Output` section of the spec file
4. **Diff summary** - `git diff --stat` between the branches

Implementation: Add `extract_spec_context(spec_id: &str) -> SpecContext` function that gathers this information.

### 3. Should conflict specs be a special `type: conflict`?

**Recommendation: Yes**

Benefits of a dedicated `type: conflict`:
- Clear visual distinction in `chant list` output
- Special handling in `chant work` (e.g., setup merge environment)
- Different validation rules (e.g., require conflict to be resolved before marking complete)
- Could be excluded from `chant archive --all` until resolved

Suggested frontmatter:
```yaml
---
type: conflict
status: pending
source_branch: spec/01a-abc
target_branch: main
conflicting_files:
- src/main.rs
blocked_specs:
- 2026-01-24-01b-def
- 2026-01-24-01c-ghi
original_spec: 2026-01-24-01a-abc
---
```

### 4. How to track the "unmerged chain" - specs waiting on this resolution?

**Recommendation: Add `blocked_by` field to conflict specs**

1. When creating conflict spec, scan remaining unmerged branches
2. For each, check if it conflicts with the same file(s)
3. Add to `blocked_specs` list in conflict spec frontmatter
4. Add `blocked_by: {conflict-spec-id}` to the affected spec files
5. When conflict resolved, automatically clear `blocked_by` from waiting specs

Alternative: Use existing `depends_on` field - the blocked specs could `depend_on` the conflict spec.

### 5. Should conflict resolution trigger re-attempt of blocked merges?

**Recommendation: Yes, with confirmation**

After conflict spec completes:
1. Run `chant merge --continue` or similar
2. Attempt to merge the previously blocked specs
3. If new conflicts arise, create new conflict specs
4. Show progress: "Resolved conflict for 01a. Attempting 01b... ✓ Success"

Could be implemented as a `chant merge --resume` command that picks up where it left off.

## Workflow Example

```
# After parallel execution completes:
$ chant merge --all

Merging spec/01a-abc to main... ✓
Merging spec/01b-def to main... ✗ Conflict!
  Conflicting files: src/main.rs

⚠ Creating conflict resolution spec...
Created: 2026-01-24-conflict-01b-main

Skipping spec/01c-ghi (blocked by conflict)
Skipping spec/01d-jkl (blocked by conflict)

Summary:
  ✓ 1 merged successfully
  ✗ 1 conflict (spec created)
  ⏸ 2 blocked (waiting for resolution)

Run: chant work 2026-01-24-conflict-01b-main
```

## Implementation Roadmap

### Phase 1: Basic Conflict Spec Creation (MVP)
1. Add `type: conflict` to SpecType enum
2. Create `create_conflict_spec()` function
3. On merge conflict, automatically create conflict spec
4. Include basic context (source/target branches, conflicting files)

### Phase 2: Context Extraction
1. Add `extract_spec_context()` function
2. Include spec description, commits, and diff summary in conflict spec
3. Format context nicely in markdown

### Phase 3: Chain Tracking
1. Add `blocked_specs` field to conflict spec frontmatter
2. Add `blocked_by` field to regular specs
3. On conflict resolution, clear blocked status

### Phase 4: Auto-Resolution
1. Attempt `git merge --no-commit` in worktree
2. Let agent analyze conflicts
3. If confident, stage resolution and commit
4. If not confident, create conflict spec for human review

### Phase 5: Resume Merging
1. Add `chant merge --resume` command
2. After conflict resolution, attempt remaining merges
3. Handle new conflicts recursively

## Acceptance Criteria

- [x] Detect merge conflicts during `chant merge` (already implemented)
- [ ] Create conflict resolution spec with context (Phase 1 - not implemented)
- [ ] Include list of blocked/unmerged specs (Phase 3 - not implemented)
- [ ] Conflict spec can be worked by agent (Phase 1 - once type is added)
- [ ] After resolution, blocked merges can proceed (Phase 5 - not implemented)
- [x] Track conflict specs separately (via NeedsAttention status - partially implemented)

## Summary

The current implementation already handles conflict detection and abort, preserving branches for manual resolution. The recommended enhancements would:

1. **Reduce friction** by auto-creating conflict specs with context
2. **Improve visibility** with `type: conflict` and blocked spec tracking
3. **Enable automation** with agent-assisted resolution attempts
4. **Support resumption** of the merge process after conflicts are resolved

This is a **significant feature enhancement** that would benefit from being split into multiple implementation specs (one for each phase above).
