---
type: code
status: in_progress
model: claude-opus-4-5-20251101
---
# Fix Windows CI stack overflow in integration tests

## Problem

Windows CI is failing with stack overflow errors across 19 integration tests since the approval system implementation (after commit e734ecc):

**Error pattern:**
```
thread 'main' has overflowed its stack
thread 'test_lint_required_fields_present' panicked at tests\integration_tests.rs:2120:5:
Lint should pass when required fields are present
```

**Affected tests (19 total):**
- test_blocked_spec_shows_detailed_error
- test_chant_derive_single_spec
- test_dependency_chain_updates
- test_dependency_chain_updates_after_completion
- test_dependency_status_after_direct_file_edit
- test_env_based_derivation_end_to_end
- test_export_includes_derived_fields_metadata
- test_force_flag_bypasses_dependency_check
- test_force_flag_shows_skipped_dependencies
- test_invalid_regex_pattern_graceful_failure
- test_lint_no_required_fields_configured
- test_lint_required_fields_missing
- test_lint_required_fields_present
- test_missing_env_var_graceful_failure
- test_no_derivation_when_config_empty
- test_no_derivation_when_enterprise_derived_empty
- test_parallel_dependency_resolution
- test_partial_env_vars_available
- test_show_displays_derived_field_indicators

**Timeline:**
- Last successful Windows CI: commit e734ecc (before approval system)
- First Windows failure: commit 961b8fa (v0.5.0 release with approval system)
- Ubuntu/macOS: Working fine (all tests pass)

**Likely causes:**
1. **Deep recursion** in approval/enterprise config parsing code
2. **Large data structures** on the stack (nested frontmatter parsing)
3. **Windows-specific stack size limits** (Windows default: 1MB, Linux: 8MB)

## Solution

Investigate and fix the stack overflow:

1. **Identify the root cause:**
   - Compare code changes between e734ecc and 961b8fa
   - Look for recursive functions in approval system (src/cmd/spec.rs, src/config.rs)
   - Check for large stack allocations in enterprise config parsing
   - Review frontmatter parsing changes (spec.rs)

2. **Potential fixes:**
   - **A) Reduce stack usage:** Convert recursive algorithms to iterative
   - **B) Heap allocation:** Move large data structures to heap with Box<T>
   - **C) Increase stack size:** Add build configuration for Windows (only if necessary)
   - **D) Fix specific bug:** If caused by infinite recursion, fix the logic error

3. **Test on Windows:**
   - Cannot test locally on macOS, must rely on CI feedback
   - Add targeted unit tests if recursion is identified
   - Verify fix doesn't regress Ubuntu/macOS

## Acceptance Criteria

- [x] Compare commits e734ecc..961b8fa for recursive patterns
- [x] Read approval system code (src/cmd/spec.rs approval functions)
- [x] Read enterprise config code (src/config.rs)
- [x] Read frontmatter parsing (src/spec.rs)
- [x] Identify likely stack overflow cause
- [x] Implement fix (A, B, C, or D)
- [ ] Push to CI and verify Windows tests pass
- [x] Verify Ubuntu tests still pass
- [x] All tests passing
- [x] Code linted and formatted