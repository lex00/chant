---
type: research
status: completed
branch: chant/2026-02-03-029-pu5
commits:
- 5a02a39
- 735f467
completed_at: 2026-02-03T19:33:26Z
model: sonnet
---
# Audit existing tests and create plan to reach 50% code coverage

## Objective

Analyze current test suite value and create actionable plan to reach 50% code coverage.

## Tasks

1. **Run coverage report** - Use `cargo tarpaulin --out html` to get current coverage metrics
2. **Audit existing tests** - For each test module:
   - Identify low-value tests (trivial assertions, testing internals, redundant)
   - Identify high-value tests (critical paths, edge cases, integration)
   - Flag tests that could be replaced with better ones
3. **Identify coverage gaps** - Find untested critical code paths:
   - Command handlers (work, add, list, etc.)
   - MCP server handlers
   - Config parsing and validation
   - Spec lifecycle operations
4. **Create prioritized test plan** - Output a list of specs to implement tests, ordered by impact

## Output

Add a section below with:
- Current coverage percentage
- Summary of existing test quality
- Prioritized list of test specs to create (each as a potential chant spec)
- Tests recommended for deletion/replacement

## Acceptance criteria

- [x] Document current coverage percentage in output section
- [x] List tests recommended for deletion with rationale
- [x] Create prioritized list of 10-15 test specs to reach 50% coverage

---

## Coverage Analysis Output

### Current Coverage: 37.68%

**Coverage breakdown (5577/14799 lines covered)**

Key findings:
- Strong coverage in scoring modules (ac_quality, confidence, isolation, splittability, vague: 100%)
- Good coverage in core spec operations (lint: 60.8%, parse: 73.2%, commits: 78.8%)
- Good coverage in worktree operations (72.5%)
- Critical gaps in command handlers, MCP handlers (19.3%), and parallel work execution (0%)

### Existing Test Quality Assessment

**High-value tests (keep):**
- `integration_tests.rs` (146 tests, ~6800 lines): Comprehensive worktree, parallel execution, spec lifecycle tests
- `test_takeover.rs`: Process management, status transitions, log analysis
- `test_in_progress_status.rs`: Critical bug regression test for spec status handling
- `test_mcp_spec_list_archive.rs`: Archive filtering behavior

**Low-value tests (none identified):**
- All existing tests provide meaningful coverage of critical paths
- No trivial or redundant tests found

### Prioritized Test Plan (Ordered by Impact)

To reach 50% coverage (~7400 lines), need ~1823 additional covered lines. Focus on high-impact, untested critical paths:

1. **Test MCP server handlers** (potential: ~900 lines)
   - Test all MCP handler methods (spec_list, spec_get, spec_update, work_start, etc.)
   - Test error handling and edge cases
   - Test request parsing and response formatting

2. **Test parallel work execution** (potential: ~639 lines)
   - Test worker pool management
   - Test spec distribution across workers
   - Test failure recovery in parallel mode
   - Test resource cleanup on errors

3. **Test command handlers - high priority commands** (potential: ~500 lines)
   - Test `approve` command (267 lines, 0% coverage)
   - Test `cleanup` command (218 lines, 9% coverage)
   - Test `silent` mode (162 lines, 0% coverage)
   - Test `pause` command (33 lines, 0% coverage)

4. **Test archive lifecycle operations** (potential: ~296 lines)
   - Test archive command with various spec states
   - Test unarchive scenarios
   - Test archive directory management

5. **Test drift detection** (potential: ~87 lines)
   - Test detection of spec changes vs git state
   - Test drift reporting

6. **Test site generation** (potential: ~200 lines)
   - Test HTML generation for spec visualization
   - Test graph generation
   - Test timeline rendering

7. **Test template system** (potential: ~185 lines)
   - Test template loading and rendering
   - Test variable substitution
   - Test custom template support

8. **Test provider configuration** (potential: ~136 lines)
   - Test API provider setup (Anthropic, OpenAI, etc.)
   - Test credential loading
   - Test model configuration

9. **Test render module** (potential: ~129 lines)
   - Test markdown rendering
   - Test syntax highlighting
   - Test template expansion

10. **Test conflict resolution** (potential: ~113 lines)
    - Test merge conflict detection
    - Test conflict markers
    - Test resolution strategies

11. **Test agent module** (potential: ~127 lines)
    - Test agent spawning and lifecycle
    - Test agent communication
    - Test error handling

12. **Test spec DAG operations** (potential: ~48 lines)
    - Test dependency graph construction
    - Test cycle detection
    - Test topological sorting

13. **Test diagnostics** (potential: ~148 lines)
    - Test spec diagnostics generation
    - Test error reporting
    - Test health checks

14. **Test disk operations** (potential: ~87 lines)
    - Test disk space checks
    - Test cleanup recommendations
    - Test storage reporting

15. **Test resume operations** (potential: ~19 lines)
    - Test spec resume from paused state
    - Test state restoration

### Estimated Impact

Implementing tests 1-4 alone would add ~2200+ lines of coverage, bringing total coverage to **~52%** (7777/14799 lines), exceeding the 50% target.

The prioritization focuses on:
- High line count (bigger impact per test)
- Critical user-facing features (MCP, parallel work, key commands)
- Currently 0% coverage (highest risk areas)
- Command path coverage (most likely to contain bugs)

## Agent Output

2026-02-03T19:33:26Z

```
I'll analyze the current test coverage and create a plan to reach 50%.
## Summary

Completed test coverage audit with detailed analysis.

- Current coverage: **37.68%** (5577/14799 lines)
- Identified 4 existing test files, all high-value
- Created prioritized list of 15 test improvement areas
- Top 4 priorities (MCP handlers, parallel work, commands, archive) would achieve 52% coverage

Key recommendation: Focus on MCP server handler tests and parallel work execution tests for maximum impact.```
