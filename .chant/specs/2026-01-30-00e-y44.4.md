---
type: code
status: completed
depends_on:
- 2026-01-30-00e-y44.3
target_files:
- src/score/confidence.rs
commits:
- 9bfbbd0
completed_at: 2026-01-31T17:16:12Z
model: sonnet
---
# Confidence Scoring Implementation

Implement scoring based on spec structure, bullet quality, and vague language.

### Inherited Context

- Good specs: bulleted lists, imperative verbs, specific language
- Bad specs: walls of prose, vague phrases like "improve", "as needed"

### Acceptance Criteria

- [x] Implement `calculate_confidence(spec: &Spec, config: &Config) -> ConfidenceGrade` function
- [x] Calculate bullet-to-prose ratio (bullet lines / paragraph lines)
- [x] Detect imperative verbs starting bullets (implement, add, create, update, fix, etc.)
- [x] Detect vague language using vague pattern detection
- [x] Grade A: High bullet ratio (>80%), verbs in >80% bullets, no vague patterns
- [x] Grade B: Medium bullet ratio (>50%), verbs in >50% bullets, <3 vague patterns
- [x] Grade C: Low bullet ratio (>20%), verbs in >30% bullets, 3-5 vague patterns
- [x] Grade D: Very low bullet ratio (<20%) OR >5 vague patterns

### Edge Cases

- Specs with no body text should default to Grade D
- Empty bullets should not count toward bullet ratio
- Multiple vague patterns in one line count separately

### Example Test Cases

- Spec with 10 bullet points, 2 paragraphs, no vague language → Grade A
- Spec with 5 bullets, 5 paragraphs, 2 vague patterns → Grade B
- Spec with 1 paragraph, 10 lines, 6 vague patterns → Grade D

### Requires

- Uses `detect_vague_patterns()` from Member 3

### Provides

- `calculate_confidence(spec: &Spec, config: &Config) -> ConfidenceGrade` - Returns grade based on structure/clarity

## Agent Output

2026-01-31T17:16:12Z

```
I'll implement the confidence scoring system based on spec structure, bullet quality, and vague language detection. Let me start by reading the relevant code and understanding the existing structure.
Now let me check the scoring.rs file to see if there's already some structure in place.
Perfect! Now I understand the structure. I need to create a `confidence.rs` file in the `src/score/` directory with a `calculate_confidence` function. Let me update the todo and start implementing.
Now let me create the confidence.rs file with the implementation:
Now I need to update the score/mod.rs file to include the confidence module:
I need to fix several clippy errors and a compilation error. Let me update the confidence.rs file:
Let me check how Config::default is used elsewhere:
I can see that Config doesn't have a Default implementation. Let me check how other tests create Config:
Now I'll fix all the issues in confidence.rs:
Now let's run clippy again to see if we fixed all the issues:
Great! Clippy passes. Now let's update the todo and run the tests:
I have 4 test failures to fix. Let me analyze and fix them:

1. `test_count_bullets_with_imperative_verbs` - Expected 4 but got 3
2. `test_empty_bullets_not_counted` - Expected 2 but got 1
3. `test_grade_a_high_bullet_ratio_no_vague` - Got B instead of A
4. `test_grade_d_many_vague_patterns` - Got C instead of D

Let me check the test cases more carefully:
The issue with `test_empty_bullets_not_counted` is that the line `-` alone doesn't match my pattern `"- "` (with space). Let me check what's happening:
The issue is that `-` alone (without a space) is being counted as a paragraph. Let me check the logic more carefully. The line `-` doesn't start with `"- "` so it's being counted as a paragraph line. I need to handle this edge case - a lone `-` should not be counted as a paragraph. Let me trace through the logic:

1. Line `-` doesn't match `"- "` or `"* "`
2. It's not empty, not a code fence, not a heading
3. So it gets counted as a paragraph

I should fix this by not counting lines that are just bullet markers without content. Let me update the function:
Now let me check the issue with detecting vague patterns. The test expects 6 vague patterns but we're only getting a few. Let me read the test:
I see - the spec says "Multiple vague patterns in one line count separately" in the edge cases. So "as needed" appearing twice should be counted as 2 instances. But the vague detection function deduplicates patterns. Let me re-read the spec requirements:

Looking at the spec:
- Edge case: "Multiple vague patterns in one line count separately"

This means if I have "improve as needed", that should count as 2 vague patterns (improve + as needed), not 1. But currently, `detect_vague_patterns` returns deduplicated unique patterns found. 

Let me count the vague patterns in the test case:
- "Improve" - 1
- "as needed" - 2 (appears twice) 
- "and related" - 2 (appears twice)
- "etc" - 1
- "Similar" - 1

Total: 7 vague pattern instances

But the current implementation only counts unique patterns, not total instances. I need to change the logic to count all instances. Let me update the calculate_confidence function:
I need to create a new function that counts all instances of vague patterns, not just unique ones. Let me add this:
Now let me add the `count_all_vague_instances` function:
Now let's run the tests again to see if we've made progress:
Good progress! Two tests still failing:
1. `test_count_bullets_with_imperative_verbs` - Expected 4 but got 3
2. `test_grade_a_high_bullet_ratio_no_vague` - Got B instead of A

Let me look at the imperative verb test more closely. The test expects:
- "Implement" ✓
- "Add" ✓
- "Create" ✓
- "Update" (in "Something without checkbox but with verb Update") ✓

But the line is: "- Something without checkbox but with verb Update"

The first word after "- " is "Something", not "Update". My function gets the first word, which is "Something", not an imperative verb. The test is incorrect - it expects 4 but should expect 3. Let me check the test comment:
The test comment says it expects "update" from the last bullet, but that bullet doesn't start with "Update" - it starts with "Something". I think the test expectation is wrong. Let me fix it to expect 3 instead of 4:
Now let me check the grade A test. It's getting B instead of A. Let me read it:
The test has:
- 10 bullets  
- 2 paragraphs
- Ratio: 10/(10+2) = 83.3% (>80% ✓)
- All bullets have imperative verbs = 100% (>80% ✓)
- Should have no vague patterns

But it's returning B instead of A. The issue is that my grading logic checks conditions in the wrong order. Let me look at it:
The issue is that the logic checks for B before A! With 83% bullets, 100% verbs, and 0 vague patterns:
- It passes the B check (>50%, >50%, <3 vague) and returns B
- It never reaches the A check

I need to reverse the order - check A first, then B, then C. Let me fix this:
Now let me remove the unused import and ru

... (output truncated, 7228 chars total)```
