---
type: code
status: completed
target_files:
- src/cmd/work.rs
completed_at: 2026-01-27T22:30:25Z
model: opus
---
# Warn when parallel execution ignores model/prompt config due to agent profiles

## Problem

When using `--prompt` flag with parallel execution, users may expect the prompt choice to influence which model is used, but it's **silently ignored** because each agent command (`claude2`, `claude3`) has its own CLI profile with its own model.

**User Experience:**
```bash
$ chant work --parallel --prompt research-analysis
# User might expect this research prompt to use opus (smarter model)
# But it uses whatever model is in claude2/claude3 profiles (e.g., haiku)
# No warning shown that prompt doesn't control model selection
```

**Confusion:**
- User runs `chant work --parallel --prompt <name>`
- They might expect different prompts to use different models (e.g., "complex-task" → opus, "simple-fix" → haiku)
- The prompt file IS used (for instructions), but model selection comes from agent CLI profiles
- No indication that `--prompt` doesn't control model selection in parallel mode

**Root Cause:**
- In `cmd_work_parallel()`, agent commands are selected from `config.parallel.agents`
- Each agent has its own `command` (e.g., `claude2`, `claude3`)
- Those commands have their own CLI profiles: `~/.config/claude2/config.yaml`
- The profile's `model:` setting overrides everything

## Solution

Add a warning when parallel execution uses agent rotation and the user has set model preferences that will be ignored:

```rust
// In cmd_work_parallel(), after agent distribution
if config.defaults.rotation_strategy != "none" && !config.parallel.agents.is_empty() {
    // Check if user specified --prompt or has model preferences
    let user_specified_prompt = prompt_name != "standard"; // Non-default prompt
    let user_set_model = std::env::var("CHANT_MODEL").is_ok()
        || std::env::var("ANTHROPIC_MODEL").is_ok()
        || config.defaults.model.is_some();

    if user_specified_prompt || user_set_model {
        eprintln!("⚠️  Note: Parallel mode uses agent CLI profile models, not config/prompt settings");
        eprintln!("   The prompt instructions are used, but model selection comes from:");
        for agent in &config.parallel.agents {
            eprintln!("   - {} → model from `{} config show`", agent.name, agent.command);
        }
        eprintln!();
        eprintln!("   To change which model is used:");
        for agent in &config.parallel.agents {
            eprintln!("   $ {} config set model <opus|sonnet|haiku>", agent.command);
        }
        eprintln!();
    }
}
```

**Example Output:**
```
⚠️  Note: Parallel mode uses agent CLI profile models, not config/prompt settings
   The prompt instructions are used, but model selection comes from:
   - claude2 → model from `claude2 config show`
   - claude3 → model from `claude3 config show`

   To change which model is used:
   $ claude2 config set model <opus|sonnet|haiku>
   $ claude3 config set model <opus|sonnet|haiku>
```

## Acceptance Criteria

- [ ] Detect when user has set model preferences (env vars or config)
- [ ] Detect when parallel execution uses agent rotation
- [ ] Print warning explaining the override behavior
- [ ] List which agents will be used and where their config comes from
- [ ] Show exact commands to update agent models
- [ ] Only show warning once at start of parallel execution
- [ ] Warning appears before "Starting N specs in parallel" message
- [ ] Add test: parallel with CHANT_MODEL set → shows warning
- [ ] Add test: parallel with rotation_strategy: none → no warning
- [ ] All existing tests pass