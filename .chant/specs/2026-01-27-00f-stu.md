---
type: code
status: completed
target_files:
- tests/integration_tests.rs
completed_at: 2026-01-27T21:14:36Z
model: haiku
---
# Add integration test for fast-path when no config

## Problem

The fast-path optimization (skip derivation when enterprise.derived is empty) is tested at unit level but not integration level.

**Gap:** Need to verify that `chant add` doesn't fail or have side effects when no enterprise config is present.

## Solution

Add integration test that:
1. Creates test git repository WITHOUT enterprise config
2. Runs `chant add` and verifies it works normally
3. Verifies NO derived_fields key is added to frontmatter
4. Verifies spec creation is fast (no unnecessary processing)

## Test Implementation

```rust
#[test]
fn test_no_derivation_when_config_empty() {
    let temp_dir = "/tmp/chant-test-no-deriv";
    setup_test_repo(temp_dir);

    // Create config WITHOUT enterprise section
    let config = r#"
project:
  name: test-project
"#;
    write_config(temp_dir, config);

    // Run chant add
    let output = Command::new(env!("CARGO_BIN_EXE_chant"))
        .args(["add", "Test spec"])
        .current_dir(temp_dir)
        .output()
        .expect("Failed to run chant add");

    assert!(output.status.success());

    // Verify spec created normally without derived fields
    let spec_content = read_latest_spec(temp_dir);
    assert!(!spec_content.contains("derived_fields:"));
    assert!(spec_content.contains("type: code"));
    assert!(spec_content.contains("status: pending"));
}

#[test]
fn test_no_derivation_when_enterprise_derived_empty() {
    let temp_dir = "/tmp/chant-test-empty-deriv";
    setup_test_repo(temp_dir);

    // Create config with enterprise section but empty derived
    let config = r#"
enterprise:
  derived: {}
  required: []
"#;
    write_config(temp_dir, config);

    // Run chant add
    let output = Command::new(env!("CARGO_BIN_EXE_chant"))
        .args(["add", "Test spec"])
        .current_dir(temp_dir)
        .output()
        .expect("Failed to run chant add");

    assert!(output.status.success());

    // Verify no derivation occurred
    let spec_content = read_latest_spec(temp_dir);
    assert!(!spec_content.contains("derived_fields:"));
}
```

## Acceptance Criteria

- [ ] Add two tests to tests/integration_tests.rs
- [ ] First test: No enterprise config at all
- [ ] Second test: Enterprise config with empty derived map
- [ ] Both tests verify spec creation succeeds
- [ ] Both tests verify NO derived_fields in frontmatter
- [ ] Both tests verify normal spec fields present (type, status, etc.)
- [ ] Tests pass: `cargo test test_no_derivation`
- [ ] Cleanup temp directories after tests