---
type: code
status: pending
depends_on:
- 2026-01-30-00h-f77.2
- 2026-01-30-00h-f77.3
- 2026-01-30-00h-f77.1
target_files:
- src/cmd/watch.rs
- Possibly src/cmd/finalize.rs, src/cmd/merge.rs for shared utilities
---
# Lifecycle operations (finalize, merge, resume)

Orchestrate calls to `chant finalize`, `chant merge`, and `chant resume` based on spec state. Handle branch detection and error reporting.

### Inherited Context

- Watch is monitor-only: lifecycle ops are the ONLY actions watch can take
- Cannot spawn agents (resume restarts existing spec's agent via CLI)
- Cannot create new specs or modify spec content

### Acceptance Criteria

- [ ] `handle_completed(spec_id)` runs finalize, then merge if branch exists
- [ ] `handle_failed(spec_id, retry_decision)` schedules resume or marks permanent failure
- [ ] Branch detection: check if spec worktree is on `chant/<spec-id>` branch
- [ ] Use existing CLI commands: `chant finalize`, `chant merge`, `chant resume`
- [ ] Return `Result` with descriptive errors for subprocess failures

### Edge Cases

- Finalize fails (e.g., criteria not actually complete): Log error, do not proceed to merge
- Merge fails (e.g., conflicts): Log error, mark spec for manual intervention
- Resume fails (e.g., spec file corrupted): Treat as permanent failure
- Spec on main branch: Skip merge step (no branch to merge)

### Example Test Cases

- Completed spec on branch → finalize succeeds, merge succeeds
- Completed spec on main → finalize succeeds, skip merge
- Failed spec with retry decision → schedule resume with delay
- Failed spec with permanent failure → log and mark needs_attention


- `handle_completed(spec_id: &str) -> Result<()>` - Errors on subprocess failure
- `handle_failed(spec_id: &str, config: &FailureConfig) -> Result<()>` - Errors on subprocess failure

---