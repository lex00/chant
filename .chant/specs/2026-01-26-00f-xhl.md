---
type: group
status: completed
labels:
- autonomy
- v0.2.0
target_files:
- src/main.rs
- src/cmd/lifecycle.rs
---
# Implement chant replay command to re-execute a spec from scratch

Add a `chant replay` command that re-executes a completed spec's intent against the current codebase. This enables fixing drift by re-applying the original intent, or updating implementations to match current patterns.

## Context

When drift is detected (via `chant drift` or `chant verify`), the solution is often to re-execute the spec. Unlike `resume` (which retries failed specs), `replay` takes a completed spec and runs it fresh against the current codebase.

Example from docs:
```
$ chant replay 023
Replaying spec 023: Add rate limiting

Original completion: 2026-01-15
Current codebase: 2026-01-22

Agent analyzing...
  - Original implementation was removed
  - Current patterns differ (new middleware framework)
  - Will re-implement using current patterns

Proceed? [y/N]

[Agent re-implements rate limiting]

Replay complete.
  Commit: xyz789
  Files changed: 2
  Tests: passing
```

## Design

### Command Interface

```
chant replay [OPTIONS] <ID>

Arguments:
  <ID>  Spec ID to replay (must be completed)

Options:
  --branch [PREFIX]  Create a feature branch for replay
  --pr              Create a pull request after replay
  --force           Skip confirmation prompt
  --dry-run         Show what would happen without executing
  --prompt <NAME>   Use a specific prompt (default: standard)
```

### Replay Flow

1. Load spec (must be status: completed)
2. Show diff between original completion and current state
3. Prompt for confirmation (unless --force)
4. Reset spec status to `in_progress`
5. Execute spec via normal work flow (in worktree)
6. On success:
   - Update `replayed_at` timestamp
   - Add replay event to history (if tracking)
   - Commit with message: `chant(<id>): replay - <description>`
7. On failure:
   - Keep spec as `in_progress` or mark `failed`
   - Allow user to fix and retry

### Commit Message Format

```
chant(<id>): replay - <original title>

Replayed spec to restore/update implementation.
Original completion: <date>
Replay reason: <drift detected | manual | etc>
```

### Frontmatter Updates

```yaml
replayed_at: 2026-01-26T10:00:00Z
replay_count: 1
original_completed_at: 2026-01-15T15:00:00Z  # Preserved from first completion
```

## Acceptance Criteria

- [ ] `chant replay <id>` re-executes a completed spec
- [ ] Only completed specs can be replayed
- [ ] Shows comparison between original and current state
- [ ] Prompts for confirmation before executing
- [ ] `--force` skips confirmation prompt
- [ ] `--dry-run` shows what would happen without executing
- [ ] `--branch` creates feature branch for replay work
- [ ] `--pr` creates pull request after successful replay
- [ ] Spec status is set to `in_progress` during replay
- [ ] On success, spec returns to `completed` with updated `replayed_at`
- [ ] Commit message follows `chant(<id>): replay - <title>` format
- [ ] `replay_count` is incremented in frontmatter
- [ ] Original `completed_at` is preserved as `original_completed_at`
- [ ] Failed replay can be resumed with `chant resume`
- [ ] Tests cover replay functionality
- [ ] `just lint` passes with no warnings

## Notes

- Replay is expensive (full agent execution), so confirmation is important
- The `--dry-run` flag helps users understand what will happen
- Consider showing cost estimate before execution
- Replay should work with all the same flags as `work` (branch, pr, etc.)