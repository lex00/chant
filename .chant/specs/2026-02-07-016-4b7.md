---
type: code
status: blocked
depends_on:
- 2026-02-07-014-tp3
labels:
- state-machine
- safety
target_files:
- src/operations/update.rs
- src/spec/lifecycle.rs
- src/spec_group.rs
- src/cmd/lifecycle/merge.rs
---
# Enforce state machine on normal code paths

## Context

The codebase has a `TransitionBuilder` state machine but `force_status` is called on normal (non-error) code paths, bypassing validation:

1. **`operations/update.rs:36`** — the unified update operation uses `force_status` directly, meaning every MCP status update bypasses the state machine
2. **`spec/lifecycle.rs:45,48`** — blocked/unblocked status changes use `force_status` even though Pending↔Blocked are valid transitions
3. **`spec_group.rs:392,465`** — driver status changes to InProgress/Completed use `force_status`
4. **`cmd/lifecycle/merge.rs:743`** — `--finalize` flag does inline finalization with `force_status` instead of calling operations layer

These are all normal code paths (not error recovery) that should use validated transitions.

## Task

Replace `force_status` with validated transitions on all normal (non-error) code paths. In `operations/update.rs`, use `TransitionBuilder` with `force: bool` opt-in in `UpdateOptions`. In `spec/lifecycle.rs`, use `set_status()` since Pending↔Blocked are valid transitions. In `spec_group.rs`, use `TransitionBuilder` for driver InProgress/Completed. In `cmd/lifecycle/merge.rs`, replace inline finalization with a call to `operations::finalize_spec`.

## Acceptance Criteria

- [ ] `operations/update.rs` uses `TransitionBuilder` with `force` opt-in via `UpdateOptions`
- [ ] `spec/lifecycle.rs` uses `set_status()` for blocked/unblocked transitions
- [ ] `spec_group.rs` uses `TransitionBuilder` for driver status changes
- [ ] `cmd/lifecycle/merge.rs --finalize` calls `operations::finalize_spec`
- [ ] `cargo test` passes
- [ ] `cargo clippy -- -D warnings` passes