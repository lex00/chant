---
type: code
status: completed
depends_on:
- 2026-01-24-01y-73b.3
target_files:
- src/main.rs
- src/git.rs
- tests/
model: claude-haiku-4-5-20251001
---
# Implement driver spec merge with member ordering

Handle merging of spec groups, ensuring all members merge before driver.

### Acceptance Criteria

- [x] Implement `merge_driver_spec(driver_spec, all_specs, ...)` function that:
  - Calls `collect_member_specs(driver_spec, all_specs)` to get members in order
  - For each member: calls `merge_single_spec()` with same options
  - If any member merge fails: stop and report which member failed
  - After all members succeed: calls `merge_single_spec()` for driver itself
  - Maintains single original branch context throughout
- [x] Check driver merge preconditions:
  - All member specs have `status == Completed`
  - All member branches exist
  - If any precondition fails: error with clear listing of incomplete members
- [x] Implement `is_driver_spec(spec)` helper to detect group specs
- [x] Merge order verification: members always merge before driver
- [x] Add tests covering:
  - Driver with all members completed → all merge in correct order
  - Driver with one member pending → error listing incomplete member
  - Driver with multiple members → correct sequential merge
- [x] Code compiles and existing tests still pass

### Edge Cases

- Edge case 1: Driver spec with members where member.1 pending → Error: "Member X is not completed"
- Edge case 2: Driver with member branches missing → Error listing missing branches
- Edge case 3: Member merge succeeds but driver merge fails → Report which part failed, undo main branch checkout
- Edge case 4: Dry-run shows all member merges and driver merge in order
- Edge case 5: `--delete-branch` deletes member branches first, then driver branch

### Example Test Cases

For this feature, verify:
- Case 1: Driver with 3 completed members merges all in order (.1, .2, .3, then driver)
- Case 2: Driver with pending member.2 shows error before attempting merge
- Case 3: Dry-run with driver shows 4 merges (3 members + driver) in order
- Case 4: Member merge fails → driver merge doesn't attempt
- Case 5: `--delete-branch` removes all 4 branches after successful merge