---
type: code
status: completed
target_files:
- src/worktree.rs
commits:
- 461c8e3
completed_at: 2026-01-25T20:10:00Z
model: opus
---
# Fix CI test failure - test_merge_and_cleanup_successful_merge

## Problem

CI is failing on `test_merge_and_cleanup_successful_merge` in `src/worktree.rs:374`:

```
assertion failed: result.success && result.error.is_none()
```

This test passes locally on macOS but fails on Linux CI (ubuntu-latest).

## Root Cause

The `merge_and_cleanup()` function executed git commands without specifying the working directory context. While the test used `set_current_dir()` to change directories, the function relied on process environment state that could be lost or differ between macOS and Linux systems. This caused git commands to fail when executed in the wrong context.

## Fix

Created an internal `merge_and_cleanup_in_dir()` function that accepts an optional `work_dir` parameter. All git commands now explicitly use `Command::current_dir()` when a working directory is provided. The public API remains unchanged (backward compatible), and tests now pass the repo directory explicitly.

## Acceptance Criteria

- [x] Identify root cause of Linux-only failure (working directory context issues)
- [x] Fix the test to pass on both macOS and Linux (use explicit working directory)
- [x] Verify fix by running all tests locally
- [x] All tests pass locally (257 unit + 17 integration tests)
- [x] Code formatted with rustfmt
- [x] Clippy linter passes with no warnings
- [x] Build succeeds
