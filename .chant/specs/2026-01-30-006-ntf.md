---
type: code
status: in_progress
model: claude-opus-4-5-20251101
---
# Add test coverage for worktree features (status command, prompt context, environment variables)

## Problem

Three worktree features were recently implemented without test coverage:
- Spec 005-5lp: `chant worktree status` command
- Spec 003-qme: Worktree context in agent prompts
- Spec 004-t9y: Worktree environment variables

While the existing test suite passes (no regressions), there are no tests verifying the new functionality works correctly.

## Solution

Add comprehensive test coverage for all three features:

### 1. `chant worktree status` Command Tests

Add integration tests in `tests/integration_tests.rs`:
- Test `chant worktree status <spec-id>` with an active worktree
- Test with non-existent spec ID (error handling)
- Test with spec that has no worktree (graceful handling)
- Verify output format includes: path, branch, spec status

### 2. Worktree Context in Prompts Tests

Add unit tests in `src/prompt.rs`:
- Test `substitute()` with worktree context populated (path, branch)
- Test template variables: `{{worktree.path}}`, `{{worktree.branch}}`, `{{worktree.in_worktree}}`
- Test with `WorktreeContext::default()` (no worktree)
- Test worktree context section is rendered when context is present

### 3. Worktree Environment Variables Tests

Add integration or unit tests for agent invocation:
- Test `invoke_agent_with_command()` sets `CHANT_WORKTREE=1` when cwd is set
- Test `CHANT_WORKTREE_PATH` is set to the worktree path
- Test `CHANT_BRANCH` is set to the branch name
- Test environment variables are NOT set when no worktree (regular execution)
- Could add to `tests/integration_tests.rs` or add unit tests in `src/cmd/agent.rs`

## Test Organization

**Integration tests** (`tests/integration_tests.rs`):
- `chant worktree status` command execution and output
- Environment variables in actual agent invocation (if feasible)

**Unit tests**:
- `src/prompt.rs`: Worktree context substitution
- `src/cmd/agent.rs` (optional): Environment variable setting logic

## Acceptance Criteria

- [x] Tests for `chant worktree status` command added
  - [x] Test with active worktree shows correct output
  - [x] Test with non-existent spec handles error gracefully
  - [x] Test with spec without worktree handles gracefully
- [x] Tests for worktree prompt context added
  - [x] Test `substitute()` with worktree context populates variables
  - [x] Test worktree context section renders correctly
  - [x] Test default context (no worktree) doesn't render worktree section
- [x] Tests for worktree environment variables added
  - [x] Test `CHANT_WORKTREE=1` is set in worktree mode
  - [x] Test `CHANT_WORKTREE_PATH` contains correct path
  - [x] Test `CHANT_BRANCH` contains branch name
  - [x] Test variables NOT set in non-worktree mode
- [x] All new tests pass
- [x] Existing tests still pass
- [x] `cargo fmt` and `cargo clippy` pass

## Files to Modify

- `tests/integration_tests.rs` - Add worktree status and env var tests
- `src/prompt.rs` - Add worktree context substitution tests (in `mod tests` section)
- `src/cmd/agent.rs` (optional) - Add unit tests for env var setting

## Notes

- The existing worktree tests (`test_worktree_creation_basic`, `test_multiple_worktrees_parallel`) should remain unchanged
- Focus on testing the NEW functionality, not re-testing existing worktree behavior
- Environment variable tests may be challenging in integration tests - unit tests for the logic might be sufficient