---
type: code
status: in_progress
labels:
- bug
- state-machine
- worktree
target_files:
- src/spec/state_machine.rs
- src/spec/lifecycle.rs
branch: chant/2026-02-07-012-ax4
---
# Fix hardcoded paths in state machine

## Context

Two bugs in state machine path resolution:

**Bug 1**: `state_machine.rs:274` hardcodes `Path::new("/tmp").join(format!("chant-{}", spec_id))` but `worktree/git_ops.rs:26-31` supports project-name namespacing (`/tmp/chant-myproject-spec-id`). When `project.name` is configured, the state machine checks the wrong directory.

**Bug 2**: `state_machine.rs:148,171` hardcodes `Path::new(".chant/specs")` — a relative path that depends on CWD. Breaks in worktree contexts or when MCP runs from a different directory.

## Task

1. Replace hardcoded worktree path in `is_clean()` with `worktree::get_active_worktree()` or `worktree::worktree_path_for_spec()` — thread project name through `TransitionBuilder`
2. Replace hardcoded `.chant/specs` in `check_preconditions()` with a parameter — add `.with_specs_dir(path)` builder method
3. Update `TransitionBuilder` callsites to pass the correct paths where available
4. Add tests for project-name-aware path resolution

## Acceptance Criteria

- [ ] `is_clean()` uses `worktree::worktree_path_for_spec()` (no hardcoded `/tmp/chant-{}`)
- [ ] `check_preconditions()` uses parameterized specs_dir (no hardcoded `.chant/specs`)
- [ ] `TransitionBuilder` has builder methods for project name and specs_dir
- [ ] Test verifying correct worktree path with project name set
- [ ] `cargo test` passes
- [ ] `cargo clippy -- -D warnings` passes