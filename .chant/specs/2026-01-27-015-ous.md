---
type: code
status: pending
target_files:
  - src/cmd/finalize.rs
  - src/cmd/work.rs
  - src/worktree.rs
  - src/cmd/lifecycle.rs
model: claude-opus-4-5-20251101
---

# Move finalize operation to worktree before merge

## Problem

Currently `chant finalize` operates on the spec file in the main branch, while the actual work happened in a feature branch worktree. This creates divergent versions:

- Main branch: `status: completed`, has `completed_at` and `model`
- Feature branch: `status: in_progress`, missing metadata

When merging the feature branch back to main, frontmatter conflicts occur because both sides modified the same spec file but with different metadata.

**Root cause**: Finalize happens AFTER merging or on main branch instead of IN the worktree before merge.

## Solution

Change finalize workflow to operate in the worktree:

1. When `chant work <spec-id>` completes successfully:
   - If `--finalize` flag passed, automatically finalize in worktree
   - Update spec status to `completed` in the worktree
   - Add `completed_at`, `model` fields in the worktree
   - Commit these changes to the feature branch

2. OR update `chant finalize <spec-id>` to:
   - Detect if spec has an active worktree
   - If yes, finalize in the worktree (not main branch)
   - If no worktree exists, finalize on current branch

3. This way when feature branch merges to main, both sides have same status/metadata = no conflict

## Acceptance Criteria

- [x] Update cmd_finalize to detect active worktrees
- [x] If worktree exists, finalize in worktree not main
- [x] Update spec file in worktree and commit
- [x] `chant work --finalize` auto-finalizes before returning
- [x] Document new finalize workflow
- [x] Test: work + finalize in worktree + merge has no conflict
- [x] Test: finalize without worktree still works on main
- [x] All existing tests pass
