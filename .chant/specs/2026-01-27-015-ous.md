---
type: code
status: completed
target_files:
- src/cmd/finalize.rs
- src/cmd/work.rs
completed_at: 2026-01-27T23:35:47Z
model: opus
---
# Move finalize operation to worktree before merge

## Problem

Currently `chant finalize` operates on the spec file in the main branch, while the actual work happened in a feature branch worktree. This creates divergent versions:

- Main branch: `status: completed`, has `completed_at` and `model`
- Feature branch: `status: in_progress`, missing metadata

When merging the feature branch back to main, frontmatter conflicts occur because both sides modified the same spec file but with different metadata.

**Root cause**: Finalize happens AFTER merging or on main branch instead of IN the worktree before merge.

## Solution

Change finalize workflow to operate in the worktree:

1. When `chant work <spec-id>` completes successfully:
   - If `--finalize` flag passed, automatically finalize in worktree
   - Update spec status to `completed` in the worktree
   - Add `completed_at`, `model` fields in the worktree
   - Commit these changes to the feature branch

2. OR update `chant finalize <spec-id>` to:
   - Detect if spec has an active worktree
   - If yes, finalize in the worktree (not main branch)
   - If no worktree exists, finalize on current branch

3. This way when feature branch merges to main, both sides have same status/metadata = no conflict

## Acceptance Criteria

- [ ] Update cmd_finalize to detect active worktrees
- [ ] If worktree exists, finalize in worktree not main
- [ ] Update spec file in worktree and commit
- [ ] `chant work --finalize` auto-finalizes before returning
- [ ] Document new finalize workflow
- [ ] Test: work + finalize in worktree + merge has no conflict
- [ ] Test: finalize without worktree still works on main
- [ ] All existing tests pass