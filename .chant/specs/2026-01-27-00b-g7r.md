---
type: code
status: completed
target_files:
- tests/integration_tests.rs
completed_at: 2026-01-27T22:31:38Z
model: opus
---
# Add integration test for branch-based derivation

## Problem

Branch-based derivation is well-tested at the unit level (src/derivation.rs) but has ZERO integration tests verifying it works end-to-end with `chant add`.

**Current Coverage:**
- ✅ Unit tests verify DerivationEngine extracts from branch name
- ❌ NO test that `chant add` actually derives from branch in real workflow

**Risk:** Real-world git branch commands, worktree setup, or config parsing could fail despite unit tests passing.

## Solution

Add integration test that:
1. Creates a test git repository
2. Checks out a branch with a pattern-matching name (e.g., `sprint/2026-Q1-W4/PROJ-123`)
3. Sets up enterprise config with branch derivation pattern
4. Runs `chant add "description"`
5. Verifies the created spec has derived fields from branch name

## Test Implementation

```rust
#[test]
fn test_branch_based_derivation_end_to_end() {
    let temp_dir = "/tmp/chant-test-branch-deriv";
    setup_test_repo(temp_dir);

    // Create enterprise config
    let config = r#"
enterprise:
  derived:
    sprint:
      from: branch
      pattern: "sprint/([^/]+)"
    jira_key:
      from: branch
      pattern: "([A-Z]+-\\d+)"
"#;
    write_config(temp_dir, config);

    // Checkout branch with pattern
    Command::new("git")
        .args(["checkout", "-b", "sprint/2026-Q1-W4/PROJ-123-feature"])
        .current_dir(temp_dir)
        .output()
        .expect("Failed to create branch");

    // Run chant add
    let output = Command::new(env!("CARGO_BIN_EXE_chant"))
        .args(["add", "Test spec"])
        .current_dir(temp_dir)
        .output()
        .expect("Failed to run chant add");

    assert!(output.status.success());

    // Read created spec and verify derived fields
    let spec_content = read_latest_spec(temp_dir);
    assert!(spec_content.contains("sprint: 2026-Q1-W4"));
    assert!(spec_content.contains("jira_key: PROJ-123"));
    assert!(spec_content.contains("derived_fields:\n  - sprint\n  - jira_key"));
}
```

## Acceptance Criteria

- [ ] Add test to tests/integration_tests.rs
- [ ] Test creates real git repo with branch
- [ ] Test sets up enterprise config with branch pattern
- [ ] Test runs `chant add` command via Command::new
- [ ] Test verifies spec file contains derived field values
- [ ] Test verifies derived_fields list includes field names
- [ ] Test passes: `cargo test test_branch_based_derivation_end_to_end`
- [ ] Cleanup temp directory after test