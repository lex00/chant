---
type: code
status: completed
depends_on:
- 2026-01-27-003-2mk
target_files:
- src/cmd/spec.rs
- src/spec.rs
model: claude-haiku-4-5-20251001
---
# Integrate derivation into spec creation workflow

## Problem

When users run `chant add "description"`, derived fields should be automatically populated if enterprise config is present. This provides immediate value and ensures fields are captured at creation time.

Critical requirements:
- **Must be no-op if enterprise config is empty** - No chance of failure for users without enterprise config
- Derived fields added to spec frontmatter
- Works for both manual `chant add` and programmatic spec creation

## Solution

Integrate derivation into spec creation flow in `src/cmd/spec.rs`:

```rust
// In the add command handler
pub fn add_spec(
    description: &str,
    config: &Config,
    // ... other params
) -> Result<Spec> {
    // 1. Create basic spec structure
    let mut spec = Spec::new(...);

    // 2. Derive fields if enterprise config present
    if !config.enterprise.derived.is_empty() {
        let context = build_derivation_context(&spec, config)?;
        let engine = DerivationEngine::new(config.enterprise.clone());
        let derived_fields = engine.derive_fields(&context);

        // 3. Add derived fields to frontmatter
        spec.add_derived_fields(derived_fields);
    }

    // 4. Write spec file with derived fields
    spec.write()?;
    Ok(spec)
}
```

Helper to build context:
- Get current branch: `git rev-parse --abbrev-ref HEAD`
- Get spec path from spec ID
- Get env vars from `std::env::vars()`
- Get git user: `git config user.name` and `git config user.email`

## Acceptance Criteria

- [x] Add `add_derived_fields()` method to `Spec` struct for frontmatter updates
- [x] Build `DerivationContext` in spec creation with all sources
- [x] Call derivation engine during `chant add` if enterprise config present
- [x] Add derived fields to spec frontmatter before writing file
- [x] Fast path: Skip entirely if `config.enterprise.derived.is_empty()`
- [x] Get current branch name via git command
- [x] Get git user name and email via git config
- [x] Capture environment variables for env-based derivation
- [x] Add integration test: spec creation with enterprise config derives fields
- [x] Add integration test: spec creation without enterprise config is unchanged
- [x] All existing tests pass