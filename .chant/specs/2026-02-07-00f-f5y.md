---
type: code
status: failed
labels:
- refactor
- testing
- infrastructure
target_files:
- tests/support/mod.rs
- tests/support/harness.rs
- tests/support/factory.rs
- tests/common.rs
---
# Unify test infrastructure with TestHarness, SpecFactory, and TempDir isolation

## Problem

The test suite (869 tests) has fragmented infrastructure with significant duplication and isolation issues:

### Duplicated setup code
15+ helper functions duplicated across test files, each with subtle variations:
- `setup_test_env()` appears in multiple files with different signatures
- `create_spec()` / `create_test_spec()` duplicated with varying parameters
- Git repo initialization (git init, git config, initial commit) repeated in ~20 test files
- Config file creation and specs directory setup duplicated everywhere

### Isolation problems
- 11 tests hardcode `/tmp/test-chant-*` paths, causing contention
- 81 tests marked `#[serial]` because they share filesystem state
- Environment variable mutation (`HOME`, `TEAM_NAME`) not isolated between tests
- Cleanup-on-start pattern fragile if previous test crashes

### Structural issues
- Only 1 fixture file (`simple_spec.md`) — everything generated procedurally
- `test_integration_*.rs` wrapper files just re-export `integration/*_test.rs` (compiled twice)
- 1,300-1,493 line test files with no subdivision
- `SpecBuilder` exists in `tests/support/builders.rs` but few other builders

## Approach

### 1. TestHarness
```rust
pub struct TestHarness {
    pub dir: TempDir,          // Auto-cleaned
    pub specs_dir: PathBuf,    // .chant/specs/
    pub config_path: PathBuf,  // .chant/config.md
    pub chant_binary: PathBuf, // From CARGO_BIN_EXE_chant
}

impl TestHarness {
    pub fn new() -> Self              // Creates full chant project structure
    pub fn with_config(cfg: &str)     // Custom config content
    pub fn run(&self, args: &[&str])  // Execute chant binary in context
    pub fn create_spec(&self, id: &str, content: &str)  // Write spec file
    pub fn load_spec(&self, id: &str) -> Spec            // Read spec back
    pub fn git_commit(&self, msg: &str)                  // Commit current state
}
```

### 2. SpecFactory
```rust
pub struct SpecFactory;

impl SpecFactory {
    pub fn pending(id: &str) -> Spec
    pub fn in_progress(id: &str) -> Spec
    pub fn completed(id: &str) -> Spec
    pub fn failed(id: &str) -> Spec
    pub fn blocked_by(id: &str, deps: &[&str]) -> Spec
    pub fn with_commits(id: &str, commits: &[&str]) -> Spec
    pub fn driver_with_members(id: &str, n: usize) -> Vec<Spec>
}
```

### 3. Migration
- Replace all `/tmp` hardcoded paths with `TempDir`
- Replace all duplicated setup functions with `TestHarness::new()`
- Remove `test_integration_*.rs` wrapper files
- Reduce `#[serial]` count by eliminating shared filesystem state

## Key Considerations

- Migration can be incremental — new tests use `TestHarness`, old tests migrated over time
- Some tests legitimately need serialization (e.g., testing global git config) — `#[serial]` stays for those
- The harness should support both unit-style (in-memory Spec) and integration-style (binary execution) testing
- `SpecBuilder` in `tests/support/builders.rs` should be enhanced, not replaced

## Acceptance Criteria

- [x] `TestHarness` struct exists in `tests/support/harness.rs`
- [x] `SpecFactory` exists in `tests/support/factory.rs`
- [ ] No test uses hardcoded `/tmp` paths in migrated files (partial - 2 files migrated, 5 integration tests still use /tmp)
- [ ] `#[serial]` count reduced by at least 50% (from 81 to under 40) (only 27% reduction to 59)
- [x] `test_integration_*.rs` wrapper files removed (tests run from `integration/` directly)
- [x] At least 5 existing test files migrated to use `TestHarness` (test_archive, test_commands, test_in_progress_status, test_spec_lifecycle partially migrated)
- [ ] All existing tests pass