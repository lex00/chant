---
type: code
status: pending
target_files:
  - tests/integration_tests.rs
---

# Add integration test for parallel work and merge workflow

## Problem

No integration test covers the full parallel execution + merge workflow that users actually perform. This workflow has multiple failure points that aren't tested.

**Untested Workflow:**
1. `chant work spec1 spec2 --parallel`
2. Both specs complete successfully
3. Branches created: chant/spec1, chant/spec2
4. Merge both specs back to main
5. Cleanup worktrees and branches
6. Verify specs marked completed

## Solution

Add comprehensive integration test:

```rust
#[test]
fn test_parallel_work_and_merge_workflow() {
    let temp_dir = setup_test_repo();

    // Create two specs
    create_spec(temp_dir, "spec1");
    create_spec(temp_dir, "spec2");

    // Run parallel execution
    let output = Command::new(env!("CARGO_BIN_EXE_chant"))
        .args(["work", "spec1", "spec2", "--parallel"])
        .current_dir(temp_dir)
        .output()
        .expect("Failed to run parallel work");

    assert!(output.status.success());

    // Verify branches exist
    assert_branch_exists(temp_dir, "chant/spec1");
    assert_branch_exists(temp_dir, "chant/spec2");

    // Verify commits on branches
    let commits1 = get_branch_commits(temp_dir, "chant/spec1");
    assert!(!commits1.is_empty(), "Branch should have commits");

    // Merge both specs
    for spec_id in &["spec1", "spec2"] {
        let merge_output = Command::new(env!("CARGO_BIN_EXE_chant"))
            .args(["merge", spec_id])
            .current_dir(temp_dir)
            .output()
            .expect("Failed to merge");

        assert!(merge_output.status.success());
    }

    // Verify worktrees cleaned up
    let worktrees = list_worktrees(temp_dir);
    assert!(!worktrees.contains("spec1"));
    assert!(!worktrees.contains("spec2"));

    // Verify branches deleted
    assert!(!branch_exists(temp_dir, "chant/spec1"));
    assert!(!branch_exists(temp_dir, "chant/spec2"));

    // Verify specs marked completed
    let list_output = Command::new(env!("CARGO_BIN_EXE_chant"))
        .args(["list"])
        .current_dir(temp_dir)
        .output()
        .expect("Failed to list specs");

    let stdout = String::from_utf8_lossy(&list_output.stdout);
    assert!(stdout.contains("● spec1"));
    assert!(stdout.contains("● spec2"));
}
```

## Acceptance Criteria

- [ ] Add integration test to tests/integration_tests.rs
- [ ] Test creates multiple specs
- [ ] Test runs parallel execution
- [ ] Test verifies branches created
- [ ] Test verifies commits exist on branches
- [ ] Test merges all specs
- [ ] Test verifies worktrees cleaned up
- [ ] Test verifies branches deleted
- [ ] Test verifies specs show completed status
- [ ] Test passes: `cargo test test_parallel_work_and_merge`