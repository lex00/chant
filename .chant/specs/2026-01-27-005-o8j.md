---
type: code
status: in_progress
depends_on:
- 2026-01-27-004-iaw
target_files:
- src/cmd/derive.rs
- src/main.rs
---
# Add chant derive command for manual derivation

## Problem

Users need ability to:
1. Re-derive fields after changing enterprise config
2. Test derivation patterns before committing to config
3. Derive fields for existing specs created before enterprise config
4. See what fields would be derived without modifying specs (dry-run)

## Solution

Add new `chant derive` command with options:

```bash
chant derive [SPEC_ID]           # Derive fields for one spec
chant derive --all               # Derive for all specs
chant derive --dry-run           # Show what would be derived without modifying
```

Implementation in `src/cmd/derive.rs`:

```rust
pub fn derive_command(
    spec_id: Option<String>,
    all: bool,
    dry_run: bool,
    config: &Config,
) -> Result<()> {
    // Fast path: no-op if no enterprise config
    if config.enterprise.derived.is_empty() {
        println!("No enterprise derivation configured");
        return Ok(());
    }

    let specs = if all {
        load_all_specs()?
    } else if let Some(id) = spec_id {
        vec![load_spec(&id)?]
    } else {
        bail!("Specify --all or provide SPEC_ID");
    };

    for spec in specs {
        let context = build_derivation_context(&spec, config)?;
        let engine = DerivationEngine::new(config.enterprise.clone());
        let derived = engine.derive_fields(&context);

        if dry_run {
            print_derived_fields(&spec.id, &derived);
        } else {
            spec.update_derived_fields(derived)?;
            println!("Updated {}", spec.id);
        }
    }

    Ok(())
}
```

## Acceptance Criteria

- [x] Create `src/cmd/derive.rs` module
- [x] Add `derive` subcommand to CLI in `src/main.rs`
- [x] Support deriving single spec: `chant derive <SPEC_ID>`
- [x] Support deriving all specs: `chant derive --all`
- [x] Support dry-run mode: `chant derive --dry-run <SPEC_ID>`
- [x] Print "No enterprise derivation configured" if config is empty
- [x] Update spec frontmatter files with derived fields (unless dry-run)
- [x] Dry-run prints derived fields to stdout without modifying files
- [x] Add integration test: derive single spec updates frontmatter
- [x] Add integration test: derive --dry-run doesn't modify files
- [x] Add integration test: derive with empty config is no-op
- [x] All tests pass