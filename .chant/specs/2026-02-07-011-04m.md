---
type: code
status: completed
labels:
- bug
- timestamps
target_files:
- src/cmd/finalize.rs
- src/cmd/agent.rs
- src/spec_group.rs
branch: chant/2026-02-07-011-04m
commits:
- 012b871
- 8b8c1da
completed_at: 2026-02-07T21:36:05Z
model: sonnet
---
# Fix timestamps — centralize UTC generation, remove Local::now with Z suffix

## Context

Nine locations generate `completed_at` and similar timestamps using `chrono::Local::now()` but format with `Z` (UTC indicator). A user in US Pacific gets `2026-02-07T14:30:00Z` when UTC is actually `22:30:00Z`. The `Z` suffix is a lie.

Meanwhile, some places correctly use `Utc::now()` (merge.rs, approve.rs, executor.rs). The finalization validation checks `completed_at` ends with `Z` — tautological since the format string hardcodes it.

**Bug locations** (all use `Local::now()` + `Z` suffix):
`operations/finalize.rs:109`, `cmd/finalize.rs:96,248,405,507`, `cmd/agent.rs:457,475,545`, `spec_group.rs:467`

**Correctly using `Local::now()`** (display, IDs, should NOT change): `id.rs`, `status.rs`, `watch.rs`, `list.rs`, `archive.rs`

## Task

Create a `pub fn utc_now_iso() -> String` helper in the library crate that uses `chrono::Utc::now()`. Replace all 9 instances of `Local::now().format("%Y-%m-%dT%H:%M:%SZ")` with the new helper. Replace the tautological timestamp validation in both finalize files with a real ISO 8601 parse check. Do NOT change `Local::now()` usages for display/UI/IDs (id.rs, status.rs, watch.rs, list.rs, archive.rs).

## Acceptance Criteria

- [x] `utc_now_iso()` helper function exists in the library crate
- [x] Zero instances of `Local::now()` followed by `format("%Y-%m-%dT%H:%M:%SZ")` remain
- [x] Timestamp validation parses the timestamp (not just checks for `Z` suffix)
- [x] `Local::now()` still used for display contexts (ID generation, watch UI, list formatting)
- [x] `cargo test` passes
- [x] `cargo clippy -- -D warnings` passes

## Agent Output

2026-02-07T21:36:05Z

```
I'll implement this task to fix the timestamp generation issue by centralizing UTC timestamp creation and removing the incorrect use of `Local::now()` with a `Z` suffix.
## Summary

Created `utc_now_iso()` helper in lib.rs to generate UTC timestamps. Replaced 9 incorrect usages of `Local::now()` with `Z` suffix across:

- operations/finalize.rs (1 instance)
- cmd/finalize.rs (5 instances)
- cmd/agent.rs (2 instances)  
- spec_group.rs (1 instance)

Replaced tautological `ends_with('Z')` validation with `chrono::DateTime::parse_from_rfc3339()` in both finalize files. `Local::now()` preserved for display contexts (id.rs, status.rs, watch.rs, list.rs, archive.rs) as intended.```
