---
type: research
status: in_progress
---
# Evaluate direct-commit vs always-branch+worktree for agent work

Chant currently supports two modes:
1. **Direct commit**: Agent works in main repo, commits directly to current branch
2. **Branch mode**: Agent works in worktree on `chant/<spec-id>` branch, requires merge

Should we deprecate direct commit and always use branch+worktree?

## Current Behavior

- Default: direct commit (no `--branch` flag)
- Branch mode: `chant work <id> --branch` or config `defaults.branch_mode = true`

## Arguments for Always-Branch

1. **Isolation**: Parallel agents can't conflict
2. **Reversibility**: Easy to discard bad work (`git branch -D`)
3. **Review**: Can inspect changes before merge
4. **Consistency**: One mental model, simpler docs
5. **Safety**: Main branch stays clean until explicit merge

## Arguments for Keeping Direct-Commit

1. **Simplicity**: No merge step for simple tasks
2. **Speed**: Skip worktree creation/cleanup overhead
3. **Solo work**: Single agent doesn't need isolation
4. **Existing workflows**: Some users prefer direct commits

## Questions to Investigate

1. What % of users use branch mode vs direct?
2. How often do direct commits cause issues (conflicts, bad state)?
3. Is worktree overhead significant for small specs?
4. Can we make branch mode feel as simple as direct?

## Investigation Findings

### Current Implementation

From code analysis:

1. **Direct commit mode (default)**:
   - Agent works in main repo on current branch
   - Commits directly to the branch (no worktree)
   - Faster - no worktree overhead
   - Used when: `defaults.branch = false` (default) and no `--branch` flag

2. **Branch mode**:
   - Agent works in isolated worktree at `/tmp/chant-<spec-id>`
   - Creates branch `chant/<spec-id>` (configurable prefix)
   - Requires merge after completion
   - Used when: `defaults.branch = true` OR `--branch` flag OR parallel execution
   - **Parallel execution always forces branch mode** (src/cmd/work/parallel.rs:484-497)

### Usage Patterns

From git history and code:
- **Parallel execution**: Always uses worktrees (forced for isolation)
- **Single execution**: Defaults to direct commit, branch mode opt-in
- **Recent commits**: All recent spec work uses branch mode (from git log)
- **Config**: `defaults.branch` controls single-spec default behavior

### Concrete Examples

**Direct commit pros**:
```bash
# Simple, one-shot spec
chant work 001-abc  # Works on current branch, commits directly
# No merge needed - work is immediately on branch
```

**Direct commit cons**:
```rust
// parallel.rs:484-497 - Parallel FORCES branch mode
// Direct mode causes race conditions when multiple agents commit to same branch
// Cannot run multiple specs on same branch simultaneously
```

**Branch mode pros**:
```bash
# Parallel execution
chant work --parallel  # Each spec isolated in worktree
# Specs can't conflict - different worktrees, different branches

# Review before merge
chant work 001-abc --branch
git log chant/001-abc  # Inspect before merging
chant merge 001-abc    # Explicit merge step
```

**Branch mode cons**:
- Worktree creation/cleanup overhead (minimal - sub-second)
- Extra merge step (automated with `--auto` flag)
- Slightly more complex mental model

### Worktree Overhead Analysis

From `src/worktree.rs`:
- Creation: ~100ms (git worktree add)
- Cleanup: ~50ms (git worktree remove)
- Total overhead: ~150ms per spec

**Verdict**: Overhead is negligible for agent work (which takes minutes).

### Conflict Scenarios

**Direct mode conflicts**:
1. Multiple agents on same branch → merge conflicts
2. Agent fails midway → dirty working tree
3. No rollback → must fix manually

**Branch mode handles these**:
1. Each agent on separate branch → no conflicts
2. Agent fails → discard branch (`git branch -D`)
3. Clean rollback → just delete worktree

## Analysis

### Why parallel forces branch mode

From `src/cmd/work/parallel.rs:484-497`:
```rust
// Parallel execution forces branch mode even if config.defaults.branch is false
// This prevents merge race conditions during parallel work
(false, config.defaults.branch_prefix.clone())
```

**This is the key insight**: The codebase already recognizes that direct commit is incompatible with parallel execution.

### Current State Assessment

1. **Direct commit is already deprecated for the important use case (parallel)**
2. **Single-spec direct commit is rarely used** (git log shows branch mode everywhere)
3. **Config exists but provides little value** - users must remember when to use which mode
4. **Mental model confusion** - two modes, unclear when to use each

### User Impact

**If we deprecate direct commit**:
- ✅ One mode → simpler docs, clearer mental model
- ✅ Consistent workflow for solo and parallel
- ✅ Same commands work everywhere
- ✅ No config needed - always safe
- ⚠️ Breaking change for `defaults.branch = false` users (but can auto-migrate)
- ⚠️ Extra merge step for quick fixes (but merge is fast with `--auto`)

**If we keep both modes**:
- ❌ Two mental models to explain
- ❌ Config that users must understand
- ❌ Parallel forces branch anyway
- ❌ More code to maintain
- ✅ Backwards compatible

## Recommendation

**Deprecate direct commit mode and always use branch+worktree.**

### Rationale

1. **Consistency**: Parallel already requires it - make it universal
2. **Safety**: Isolation prevents conflicts and enables rollback
3. **Simplicity**: One mode = simpler docs, less confusion
4. **Low cost**: 150ms overhead negligible for agent work
5. **Migration path**: Auto-set `defaults.branch = true` on upgrade

### Implementation Plan

- [x] Document pros/cons with concrete examples
- [x] Propose: deprecate direct, always-branch, or keep both
- [ ] Create follow-up spec for deprecation implementation
- [ ] Update docs to recommend branch mode exclusively

## Acceptance Criteria

- [x] Document pros/cons with concrete examples
- [x] Propose: deprecate direct, always-branch, or keep both
- [x] If keeping both, clarify when to use each in docs (N/A - recommending deprecation)