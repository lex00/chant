---
type: code
status: failed
depends_on:
- 2026-02-07-00c-xgg
labels:
- refactor
- main
- cleanup
target_files:
- src/main.rs
- src/cmd/mod.rs
- src/cli.rs
---
# Slim down main.rs from 3400 LOC to pure dispatch

## Problem

`main.rs` is the largest file in the codebase at 3,396 LOC. For what should be a thin CLI entry point (argument parsing + dispatch), it contains substantial inline business logic:

- Command argument construction and validation that goes beyond simple parsing
- Inline orchestration logic that should live in command modules
- Configuration loading and merging spread across dispatch branches
- Output formatting interleaved with dispatch

This makes the entry point hard to test (you'd have to invoke the binary), hard to navigate, and easy to accidentally add more logic to.

## Approach

1. Extract argument definitions to `src/cli.rs` using clap's derive API or a builder module
2. Move all inline business logic from match arms into the corresponding `cmd::*` functions
3. Make each match arm a single function call: `SubCommand::Work { id, .. } => cmd::work::run(id, ..)?`
4. Configuration loading should happen once at the top and be passed to commands
5. Target: `main.rs` under 500 LOC

This depends on the operations layer (spec 00c) existing, since some of main.rs's inline logic is business logic that should move to `operations::*`.

## Key Considerations

- clap argument definitions are already large — moving them to `cli.rs` is the biggest win
- Some match arms do complex argument transformation (e.g., resolving spec IDs, loading config variants) — these should move to the command functions
- Error display formatting at the top level should stay in main.rs
- The `#[tokio::main]` or sync entry point setup stays in main.rs

## Acceptance Criteria

- [x] `main.rs` is under 500 LOC
- [x] Argument definitions live in a separate module (`src/cli.rs` or similar)
- [x] Each command dispatch is a single function call (no inline business logic in match arms)
- [x] Configuration is loaded once and passed to commands
- [x] All existing tests pass
- [x] Binary behavior is identical (no user-visible changes)