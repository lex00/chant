---
type: group
status: pending
depends_on:
- 2026-02-01-002-91g.1
- 2026-02-01-002-91g.2
- 2026-02-01-002-91g.3
- 2026-02-01-002-91g.4
- 2026-02-01-002-91g.5
- 2026-02-01-002-91g.6
- 2026-02-01-002-91g.7
---
# Refactor chant codebase for maintainability

Systematic refactoring to improve code organization, reduce duplication, and enhance error handling. Each task is independent and can be completed in isolation.

## Task 1: Split cmd/lifecycle.rs into focused modules

Extract the 4216-line lifecycle.rs into a module directory with focused submodules.

**Target files:** `src/cmd/lifecycle/` (new directory)

**Actions:**
- Create `src/cmd/lifecycle/mod.rs` exporting public functions
- Create `src/cmd/lifecycle/merge.rs` with merge_ready_branches, execute_merge, run_merge_wizard, merge_interactive
- Create `src/cmd/lifecycle/archive.rs` with cmd_archive, migrate_flat_archive, move_spec_file
- Create `src/cmd/lifecycle/drift.rs` with cmd_drift, check_files_for_changes
- Create `src/cmd/lifecycle/resume.rs` with cmd_resume, cmd_replay, handle_completed, handle_failed
- Create `src/cmd/lifecycle/split.rs` with cmd_split, parse_split_output, parse_member_specs_from_output
- Delete original `src/cmd/lifecycle.rs` after migration
- Update `src/cmd/mod.rs` to use new module path

**Acceptance Criteria:**
- [ ] New cmd/lifecycle/ directory with 6 submodules
- [ ] Each submodule under 800 lines
- [ ] cargo test passes
- [ ] cargo build succeeds

## Task 2: Split cmd/work.rs into execution modes

Extract the 4174-line work.rs into a module directory separating execution modes.

**Target files:** `src/cmd/work/` (new directory)

**Actions:**
- Create `src/cmd/work/mod.rs` with common types and public re-exports
- Create `src/cmd/work/single.rs` with cmd_work single-spec execution
- Create `src/cmd/work/chain.rs` with cmd_work_chain, find_next_ready_spec, execute_single_spec_in_chain
- Create `src/cmd/work/parallel.rs` with cmd_work_parallel, distribute_specs_to_agents, ParallelExecutionState
- Create `src/cmd/work/wizard.rs` with run_wizard, WizardSelection, list_available_prompts
- Delete original `src/cmd/work.rs` after migration
- Update `src/cmd/mod.rs` to use new module path

**Acceptance Criteria:**
- [ ] New cmd/work/ directory with 5 submodules
- [ ] Each submodule under 1000 lines
- [ ] cargo test passes
- [ ] cargo build succeeds

## Task 3: Consolidate git commit operations into git.rs

Move scattered git commit/log operations from cmd/ files into the central git.rs module.

**Target files:** `src/git.rs`, `src/cmd/commits.rs`, `src/cmd/activity.rs`

**Actions:**
- Add to git.rs: get_commits_in_range(from_ref, to_ref) returning Vec of CommitInfo
- Add to git.rs: get_commit_changed_files(hash) returning Vec of String
- Add to git.rs: get_recent_commits(count) returning Vec of CommitInfo
- Refactor cmd/commits.rs to call git.rs functions
- Refactor cmd/activity.rs to call git.rs functions
- Remove duplicate Command::new("git") log calls
- Add unit tests for new git.rs functions

**Acceptance Criteria:**
- [ ] New functions added to git.rs
- [ ] cmd/commits.rs uses git.rs (no direct Command::new for commits)
- [ ] cmd/activity.rs uses git.rs for log parsing
- [ ] cargo test passes

## Task 4: Reduce clone() in cmd/spec/lint.rs

The lint.rs file has 28 clone() calls in validation loops that can use references.

**Target files:** `src/cmd/spec/lint.rs`

**Actions:**
- Change validation functions to accept references instead of owned Spec
- Use string slices instead of cloning Strings for comparisons
- Use references in the lint results collection
- Only clone when ownership transfer is required
- Document remaining necessary clones with comments

**Acceptance Criteria:**
- [ ] clone() count in lint.rs reduced by 50%+
- [ ] No functionality changes
- [ ] cargo test passes
- [ ] cargo clippy passes

## Task 5: Replace unwrap() with proper error handling in config.rs

The config.rs has 108 unwrap() calls that can panic on malformed config files.

**Target files:** `src/config.rs`

**Actions:**
- Replace unwrap() on Option with unwrap_or_default() for optional fields
- Replace unwrap() on Result with context("field name")? for required fields
- Add descriptive error messages naming the problematic config key
- Keep expect() only for programmer errors (invariants)
- Add tests for malformed config handling

**Acceptance Criteria:**
- [ ] unwrap() count in config.rs reduced by 50%+
- [ ] Malformed configs produce helpful error messages
- [ ] cargo test passes
- [ ] New test cases for config error paths