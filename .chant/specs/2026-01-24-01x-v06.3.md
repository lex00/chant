---
type: code
status: completed
depends_on:
- 2026-01-24-01x-v06.2
target_files:
- '`src/main.rs`'
- '`src/worktree.rs`'
- '`src/spec.rs`'
- '`src/merge.rs`'
- '`src/git.rs`'
model: claude-haiku-4-5-20251001
---
# Implement Worktree Creation and Cleanup in cmd_work_parallel()

**Description:**
Modify the parallel execution loop to create a git worktree for each spec before spawning its thread, and ensure cleanup happens afterward. This is the core orchestration that ties together worktree creation and agent execution. Handle both direct-commit mode and branch-mode differently per the spec.

### Acceptance Criteria

- [x] Modify `cmd_work_parallel()` to create worktree before spawning thread for each spec
  - [x] Determine branch name based on mode:
    - [x] Direct commit mode: use `spec/{spec_id}`
    - [x] Branch mode: use `{prefix}{spec_id}` (use `config.defaults.branch_prefix`)
  - [x] Call `worktree::create_worktree(spec_id, branch_name)` and capture path
  - [x] Pass worktree path as `cwd` to `invoke_agent_with_prefix()`
- [x] Modify thread spawned in parallel execution to accept worktree path
- [x] After agent completes (in parallel result handling):
  - [x] Direct mode: call `worktree::merge_and_cleanup(branch)` to merge and delete branch
  - [x] Branch mode: call `worktree::remove_worktree(path)` to just remove worktree (leave branch)
- [x] Update `ParallelResult` struct to include worktree path for tracking
- [x] Handle worktree creation failure:
  - [x] If `create_worktree()` fails, mark spec as failed in results
  - [x] Do NOT spawn thread if worktree creation fails
  - [x] Include error message in result
- [x] Handle merge failure in direct mode:
  - [x] If `merge_and_cleanup()` fails (merge conflict), mark spec with status `NeedsAttention` or similar
  - [x] Log conflict message
  - [x] Do NOT delete branch on conflict (leave for manual resolution)
- [x] Verify sequential `chant work` command is UNCHANGED
  - [x] Sequential mode should NOT use worktrees
  - [x] Sequential mode behavior identical to before

### Edge Cases

- **Worktree creation fails (branch exists):** If spec is re-run before previous branch is merged, creation fails. Verify error is caught and reported. Test: Run same spec twice in parallel, second should fail with branch-exists error.
- **Agent crashes in worktree:** Worktree cleanup should still happen. Test: Simulate agent crash and verify worktree is removed via cleanup logic.
- **Merge conflict in direct mode:** Branch should be left intact for user to resolve. Test: Create conflict scenario, verify branch remains, spec marked for attention.
- **Cleanup fails (permission error):** Worktree removal might fail if files are locked. Propagate error and mark spec as needs-attention. Test: Simulate permission error and verify handling.
- **Mixed mode (some specs direct, some branch):** Different specs might have different modes. Verify each is handled correctly. Test: Run multiple specs with different branch_prefix values.

### Example Test Cases

For this feature, verify:
- **Case 1:** Parallel spec execution creates `/tmp/chant-{spec_id}` with branch `spec/{spec_id}`
- **Case 2:** After successful execution in direct mode, branch is merged to main and deleted
- **Case 3:** After successful execution in branch mode, branch is left but worktree is removed
- **Case 4:** If worktree creation fails, spec result includes error and no thread is spawned
- **Case 5:** If merge fails with conflict, branch is preserved and spec marked for review
- **Case 6:** Sequential `chant work` does NOT create worktrees (no `/tmp/chant-*` directories)