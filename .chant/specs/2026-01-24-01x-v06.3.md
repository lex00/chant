---
type: code
status: pending
depends_on:
- 2026-01-24-01x-v06.2
target_files:
- '`src/main.rs`'
- '`src/worktree.rs`'
---
# Implement Worktree Creation and Cleanup in cmd_work_parallel()

**Description:**
Modify the parallel execution loop to create a git worktree for each spec before spawning its thread, and ensure cleanup happens afterward. This is the core orchestration that ties together worktree creation and agent execution. Handle both direct-commit mode and branch-mode differently per the spec.

### Acceptance Criteria

- [ ] Modify `cmd_work_parallel()` to create worktree before spawning thread for each spec
  - [ ] Determine branch name based on mode:
    - [ ] Direct commit mode: use `spec/{spec_id}`
    - [ ] Branch mode: use `{prefix}{spec_id}` (use `config.defaults.branch_prefix`)
  - [ ] Call `worktree::create_worktree(spec_id, branch_name)` and capture path
  - [ ] Pass worktree path as `cwd` to `invoke_agent_with_prefix()`
- [ ] Modify thread spawned in parallel execution to accept worktree path
- [ ] After agent completes (in parallel result handling):
  - [ ] Direct mode: call `worktree::merge_and_cleanup(branch)` to merge and delete branch
  - [ ] Branch mode: call `worktree::remove_worktree(path)` to just remove worktree (leave branch)
- [ ] Update `ParallelResult` struct to include worktree path for tracking
- [ ] Handle worktree creation failure:
  - [ ] If `create_worktree()` fails, mark spec as failed in results
  - [ ] Do NOT spawn thread if worktree creation fails
  - [ ] Include error message in result
- [ ] Handle merge failure in direct mode:
  - [ ] If `merge_and_cleanup()` fails (merge conflict), mark spec with status `NeedsAttention` or similar
  - [ ] Log conflict message
  - [ ] Do NOT delete branch on conflict (leave for manual resolution)
- [ ] Verify sequential `chant work` command is UNCHANGED
  - [ ] Sequential mode should NOT use worktrees
  - [ ] Sequential mode behavior identical to before

### Edge Cases

- **Worktree creation fails (branch exists):** If spec is re-run before previous branch is merged, creation fails. Verify error is caught and reported. Test: Run same spec twice in parallel, second should fail with branch-exists error.
- **Agent crashes in worktree:** Worktree cleanup should still happen. Test: Simulate agent crash and verify worktree is removed via cleanup logic.
- **Merge conflict in direct mode:** Branch should be left intact for user to resolve. Test: Create conflict scenario, verify branch remains, spec marked for attention.
- **Cleanup fails (permission error):** Worktree removal might fail if files are locked. Propagate error and mark spec as needs-attention. Test: Simulate permission error and verify handling.
- **Mixed mode (some specs direct, some branch):** Different specs might have different modes. Verify each is handled correctly. Test: Run multiple specs with different branch_prefix values.

### Example Test Cases

For this feature, verify:
- **Case 1:** Parallel spec execution creates `/tmp/chant-{spec_id}` with branch `spec/{spec_id}`
- **Case 2:** After successful execution in direct mode, branch is merged to main and deleted
- **Case 3:** After successful execution in branch mode, branch is left but worktree is removed
- **Case 4:** If worktree creation fails, spec result includes error and no thread is spawned
- **Case 5:** If merge fails with conflict, branch is preserved and spec marked for review
- **Case 6:** Sequential `chant work` does NOT create worktrees (no `/tmp/chant-*` directories)