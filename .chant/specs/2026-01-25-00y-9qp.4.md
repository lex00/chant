---
type: code
status: completed
depends_on:
- 2026-01-25-00y-9qp.3
target_files:
- src/cmd/work.rs
- src/main.rs
- src/cmd/spec.rs
commits:
- 1c810e7
completed_at: 2026-01-25T15:08:47Z
model: haiku
---
# Extract work execution to src/cmd/work.rs

Move work execution logic (the largest command handler). This includes parallelization, worktree management, and finalization logic.

### Acceptance Criteria

- [x] All work-related functions moved to `src/cmd/work.rs`:
  - `cmd_work()`
  - `cmd_work_parallel()`
  - `finalize_spec()`
  - `re_finalize_spec()`
  - `get_commits_for_spec()`
  - Worktree management during execution
  - All helper functions specific to work execution
- [x] Public API exports `cmd_work()` and `cmd_work_parallel()` as callable from main
- [x] Parallel execution logic preserved identically
- [x] Worktree isolation behavior unchanged
- [x] Spec status transitions (pending → in_progress → completed/failed) work correctly
- [x] `just check` passes (builds and lints successfully)
- [x] Branch creation (--branch flag) still works
- [x] PR creation (--pr flag) still works

### Edge Cases

- **Parallel execution race conditions**: Verify no race conditions when multiple specs execute in parallel
- **Worktree cleanup**: Ensure worktrees are properly cleaned up even if execution fails
- **Spec status atomicity**: Confirm spec status updates are atomic and consistent
- **Force flag behavior**: Check that --force flag still skips unchecked criteria validation
- **Model provider selection**: Verify override_model parameter still works through the call chain

### Example Test Cases

For work execution, verify:
- Single spec execution produces same behavior as before
- Parallel execution of multiple ready specs still works
- Spec status correctly transitions from pending → in_progress → completed
- Failed specs are marked as failed with correct error information
- Finalize step (marking completed, adding model field) works
- Re-finalize (re-running finalize on already-completed spec) works correctly

## Agent Output

2026-01-25T15:08:47Z

```
I'll start by reading the relevant code to understand the current structure and what needs to be extracted to `src/cmd/work.rs`.
Let me check the cmd directory structure:
Interesting! The `src/cmd/work.rs` file already exists. Let me check the current state of the cmd module structure:
Now I need to see the rest of spec.rs to find the work execution functions:
Let me use grep to find the work-related functions:
Perfect! Now I can see the work-related functions are in spec.rs. Let me read those specific sections:
Let me continue reading the parallel and other functions:
Let me continue reading the finalization functions:
Let me continue reading and find the end of the file to see all remaining functions:
Now let me use TodoWrite to plan this task and track my progress:
Now let me find all the helper functions that are specific to work execution. Let me search for functions that are called from cmd_work:
Let me find the is_silent_mode function:
Perfect! Now I have a complete picture. Let me create a detailed extraction plan. The spec already has `src/cmd/work.rs` as a stub. Here's what needs to be extracted:

**Functions to extract to work.rs:**
1. `cmd_work()` - main work command handler
2. `cmd_work_parallel()` - parallel execution
3. `finalize_spec()` - spec finalization
4. `re_finalize_spec()` - re-finalization
5. `get_commits_for_spec()` - get commits
6. `CommitError` enum - error type for commits
7. `ParallelResult` struct - result from parallel execution
8. Helper functions: `confirm_re_finalize()`, `create_or_switch_branch()`, `push_branch()`, `get_model_name()`, `get_model_name_with_default()`, `commit_transcript()`, `append_agent_output()`, `is_silent_mode()`
9. Constants: `MAX_AGENT_OUTPUT_CHARS`
10. Model selection functions and parse utility

Let me update my todo and start the extraction:
Now, let me read all the work execution code and extract it. First, let me read the complete sections I need to move:
Due to size constraints, let me write the work.rs file with all the extracted functions. I'll create it now based on what I've read:
Now I need to remove the work-related functions from spec.rs and update it to import them from work.rs. Let me first check what needs to be removed and what needs to be updated:
Now let me remove the work-related code from spec.rs. I'll do this in sections. First, let me read the end of the spec.rs file to see what functions to keep:
Now I need to edit spec.rs to remove the work-related functions and add re-exports from work module. Let me first update the header comments and imports:
Now let me remove the work and parallel execution functions. I'll read the line numbers for what needs to be removed more precisely. Let me use grep to find the exact line where work functions start and end:
Let me find more details about these sections:
Let me try a different approach:
Now let me read what's in those sections to understand what to delete. Let me check which section is the execution section:
Perfect. So line 710-712 is EXECUTION FUNCTIONS. The next section at line 1510-1512 is SPEC FINALIZATION FUNCTIONS, then line 1818-1820 is GIT OPERATIONS, 1870-1872 is MODEL SELECTION, 1998-2000 is TRANSCRIPT HANDLING, 2063-2065 is SPLIT/ARCHIVE/MERGE and 2747-2749 is HELPER FUNCTIONS.

I need to delete lines 710-2062 (everything from EXECUTION FUNCTIONS through before SPLIT) and then lines 2063-2747 (the helper section, but keep anything needed). Let me be more precise. Let me read around the split function:
Good! So I need to delete from line 710 to line 2062 (inclusive). Let me do that now:
Now I'll delete everything from line 710 to line 2062. Let me do this by reading what comes after and replacing:
Now let me create the new spec.rs by removing all those work functions and adding re-exports. Let me carefully construct this by reading the entire file and then rewriting it without the work functions:
The file is large. I'll use a bash command to extract the parts I need and reassemble:
Perfect! Now let me combine them, but I need to add a blank line and the re-export line:
Good. Now let me copy this back:
Now I need to update main.rs to import from cmd::work instead of cmd::spec for the work command. Let me check the current import:
Now I'll update the main.rs to call cmd::work::cmd_work instead of cmd::spec::cmd_work:
Now let me update my todo list and run formatting and tests:
Now let me run cargo fmt:
I need to use `just` instead. Let me use just fmt:
Good! Now let me run clippy:
I need to fix these issues. Let me:
1. Remove unused imports from spec.rs
2. Move the `get_model_for_split` function to work.rs or back to spec.rs (it's needed by cmd_split)

Let me check where get_model_for_split is used:
The function is used in cmd_split (which is in spec.rs), so I need to find it and add it back. Let me check my work.rs to see if I included it:
It's not there. I need to add it back to spec.rs. Let me read it from the original file by using git:
Good! Now let me add this function 

... (output truncated, 10371 chars total)```
