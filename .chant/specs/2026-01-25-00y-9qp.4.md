---
type: code
status: completed
depends_on:
- 2026-01-25-00y-9qp.3
target_files:
- src/cmd/work.rs
- src/main.rs
- src/cmd/spec.rs
model: claude-haiku-4-5-20251001
---
# Extract work execution to src/cmd/work.rs

Move work execution logic (the largest command handler). This includes parallelization, worktree management, and finalization logic.

### Acceptance Criteria

- [x] All work-related functions moved to `src/cmd/work.rs`:
  - `cmd_work()`
  - `cmd_work_parallel()`
  - `finalize_spec()`
  - `re_finalize_spec()`
  - `get_commits_for_spec()`
  - Worktree management during execution
  - All helper functions specific to work execution
- [x] Public API exports `cmd_work()` and `cmd_work_parallel()` as callable from main
- [x] Parallel execution logic preserved identically
- [x] Worktree isolation behavior unchanged
- [x] Spec status transitions (pending → in_progress → completed/failed) work correctly
- [x] `just check` passes (builds and lints successfully)
- [x] Branch creation (--branch flag) still works
- [x] PR creation (--pr flag) still works

### Edge Cases

- **Parallel execution race conditions**: Verify no race conditions when multiple specs execute in parallel
- **Worktree cleanup**: Ensure worktrees are properly cleaned up even if execution fails
- **Spec status atomicity**: Confirm spec status updates are atomic and consistent
- **Force flag behavior**: Check that --force flag still skips unchecked criteria validation
- **Model provider selection**: Verify override_model parameter still works through the call chain

### Example Test Cases

For work execution, verify:
- Single spec execution produces same behavior as before
- Parallel execution of multiple ready specs still works
- Spec status correctly transitions from pending → in_progress → completed
- Failed specs are marked as failed with correct error information
- Finalize step (marking completed, adding model field) works
- Re-finalize (re-running finalize on already-completed spec) works correctly