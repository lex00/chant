---
type: code
status: in_progress
target_files:
- src/cmd/work/parallel.rs
- src/cmd/work/single.rs
- src/worktree.rs
- tests/integration_tests.rs
---
# Bug: in_progress specs still not marked in_progress

## Problem

Despite fix 007-hsz, specs being worked are still showing as `pending` instead of `in_progress` when running `chant list` or `chant status`.

## Investigation Findings

### Code Flow Traced

**Parallel mode (parallel.rs):**
1. Line 468: `spec_clone.frontmatter.status = SpecStatus::InProgress`
2. Line 469: `spec_clone.save(&spec_path)` - saves to main working dir
3. Line 509: `worktree::create_worktree()` - creates worktree from HEAD
4. Line 516: `worktree::copy_spec_to_worktree()` - copies spec to worktree

**Single mode (single.rs):**
1. Line 576: `spec.frontmatter.status = SpecStatus::InProgress`
2. Line 577: `spec.save(&spec_path)` - saves to current dir
3. No worktree created for single mode (only branch switch)

### Potential Issues Found

1. **Relative path in copy_spec_to_worktree (worktree.rs:171):**
   ```rust
   let main_spec_path = PathBuf::from(".chant/specs").join(format!("{}.md", spec_id));
   ```
   Uses relative path - will fail if current directory changes.

2. **MCP server directory context:**
   - MCP might run with different working directory than expected
   - `load_all_specs` reads from specs_dir which is derived from current dir

3. **Branch resolution prerequisite (spec.rs:376):**
   ```rust
   if spec.frontmatter.status != SpecStatus::InProgress {
       return Ok(spec);
   }
   ```
   Branch resolution only triggers if spec is ALREADY marked InProgress.

## Hypothesis

The main working directory spec file IS being saved with InProgress status, but:
- MCP is reading from a different directory, OR
- Something is reverting the file after save, OR
- The save is failing silently in some edge cases

## Test Plan

Create integration test that:
1. Starts `chant work` in background
2. Immediately checks `chant list --status in_progress`
3. Verifies spec appears in output
4. Tests both with and without worktrees

## Acceptance Criteria

- [x] Root cause identified and documented
- [x] Integration test that reproduces the bug
- [x] Fix uses absolute paths where needed
- [x] Test passes - `chant list --status in_progress` shows working specs
- [x] Verified in user's project