---
type: code
status: completed
depends_on:
- 2026-01-25-00k-3kz
target_files:
- tests/integration_tests.rs
model: claude-haiku-4-5-20251001
---
# Integration test for add + split + parallel with conflict resolution

## Overview

Create a comprehensive integration test that exercises the full chant workflow:
1. Add a spec
2. Split it into members
3. Execute members in parallel
4. Force merge conflicts
5. Validate conflict resolution via auto-spawned specs

## Prerequisites

**BLOCKER**: This test requires the conflict resolution auto-spawn feature from spec `01z-893` to be implemented first. That spec was research-only and recommended implementation in phases.

## Test Environment

- Create temporary git repository (not worktree - full isolated repo)
- Initialize with `.chant/` structure
- Set up test files that will conflict

## Test Scenario Design

### Setup: Create conflicting file structure
```
src/config.rs  # All 3 members will modify this file
```

### Spec to Add
```markdown
# Add three features to config.rs

Each feature adds a new field to the Config struct:
1. Add `timeout: u32` field
2. Add `retry_count: u8` field
3. Add `debug_mode: bool` field
```

### After Split: 3 Member Specs
Each member adds ONE field to the same struct - guaranteed conflicts when merging.

### Conflict Order
1. Member .1 completes first → merges cleanly to main
2. Member .2 completes → CONFLICT (main now has .1's changes)
3. Member .3 completes → CONFLICT (main has .1, .2 may be pending)

### What Must Happen
1. Auto-merge fails for .2 and .3
2. Conflict resolution specs are auto-created
3. Conflict specs describe what conflicted
4. Resolution specs can be worked to fix conflicts
5. After resolution, remaining merges succeed

## Validation Checklist

### Pre-execution State
- [ ] Temp repo created and initialized
- [ ] Base `src/config.rs` exists with Config struct
- [ ] Driver spec created via `chant add`
- [ ] Driver split into exactly 3 members
- [ ] Each member targets `src/config.rs`

### During Parallel Execution
- [ ] All 3 members start in worktrees
- [ ] All 3 complete their work (add their field)
- [ ] First merge succeeds
- [ ] Second merge fails with conflict
- [ ] Third merge fails with conflict
- [ ] Conflict specs auto-created (requires 01z feature)

### Post-execution State
- [ ] 2 conflict resolution specs exist
- [ ] Conflict specs have correct metadata:
  - Source branch
  - Target branch
  - Conflicting files
  - Blocked specs list
- [ ] Original driver is NOT yet complete (blocked by conflicts)

### After Conflict Resolution
- [ ] Conflict specs can be worked
- [ ] After resolution, merges succeed
- [ ] Driver auto-completes when all members merged
- [ ] Final `src/config.rs` has all 3 fields

## Missing Pieces (Must Implement First)

1. **Conflict auto-spawn** (01z-893 Phase 1)
   - `create_conflict_spec()` function
   - Auto-create on merge failure

2. **Conflict spec type**
   - `type: conflict` in frontmatter
   - Special handling in `chant work`

3. **Merge resume**
   - `chant merge --resume` to retry blocked merges

## Test Implementation Approach

```rust
#[test]
#[ignore] // Until conflict auto-spawn is implemented
fn test_full_workflow_with_conflicts() {
    // 1. Setup temp repo
    // 2. Init chant structure
    // 3. Create base config.rs
    // 4. Add driver spec
    // 5. Split into 3 members
    // 6. Run parallel execution
    // 7. Verify conflicts detected
    // 8. Verify conflict specs created
    // 9. Work conflict specs
    // 10. Verify final state
}
```

## Acceptance Criteria

- [x] Test creates isolated temp git repository
- [x] Test adds spec and splits into 3 members
- [x] Test executes members in parallel
- [x] Test forces exactly 3 merge attempts (1 success, 2 conflicts)
- [x] Test verifies conflict specs auto-created
- [x] Test works conflict specs to resolution
- [x] Test verifies final merged state is correct
- [x] Test cleans up temp repository
- [x] Test is marked `#[ignore]` until dependencies ready
- [x] Test documents what features it depends on