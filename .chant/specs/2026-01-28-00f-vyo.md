---
type: code
status: completed
commits:
- 2344feb
completed_at: 2026-01-28T16:52:57Z
model: opus
---
# Fix test_get_commits_for_spec_special_characters_in_id CI failure

## Problem

The unit test `test_get_commits_for_spec_special_characters_in_id` in `src/cmd/spec.rs` passes locally but fails in CI with:

```
→ Searching for commits matching pattern: 'chant(2026-01-24-01p-cmz):'
→ Found 0 commit(s) matching pattern 'chant(2026-01-24-01p-cmz):'
⚠ No commits found with pattern 'chant(2026-01-24-01p-cmz):'. Attempting to use HEAD as fallback.
✗ Could not find any commit for spec '2026-01-24-01p-cmz' and HEAD fallback failed: fatal: not a git repository (or any of the parent directories): .git

assertion failed: result.is_ok()
```

**Root cause:** The test calls `get_commits_for_spec()` which runs `git log` commands. This works locally (inside a git repository) but fails in CI during unit test execution (not in a git repository context).

**Local success:**
```
→ Searching for commits matching pattern: 'chant(2026-01-24-01p-cmz):'
→ Found 1 commit(s) matching pattern 'chant(2026-01-24-01p-cmz):'
test cmd::spec::tests::test_get_commits_for_spec_special_characters_in_id ... ok
```

This is the LAST test failure blocking v0.5.0 release CI from passing.

## Solution

Fix the test to work in CI environments without a git repository. Options:

**A) Set up temporary git repo in test**
```rust
#[test]
fn test_get_commits_for_spec_special_characters_in_id() {
    let temp_dir = tempfile::tempdir().unwrap();
    std::env::set_current_dir(temp_dir.path()).unwrap();
    Command::new("git").arg("init").output().unwrap();
    // ... rest of test
}
```

**B) Mock git command execution**
- Requires refactoring `get_commits_for_spec()` to use a trait for git operations
- More invasive change

**C) Skip test in non-git environments**
```rust
#[test]
fn test_get_commits_for_spec_special_characters_in_id() {
    // Skip if not in git repo
    if !Path::new(".git").exists() {
        return;
    }
    // ... rest of test
}
```

**Recommended: Option A** - Set up a minimal temporary git repository in the test with a commit that matches the expected pattern. This tests the actual functionality without requiring env-specific skipping.

## Acceptance Criteria

- [x] Read `src/cmd/spec.rs` and locate the failing test
- [x] Understand what `get_commits_for_spec()` does and why it needs git
- [x] Implement fix (either A, B, or C based on code structure)
- [x] Run the specific test locally and verify it passes
- [x] Run full test suite locally and verify all pass
- [x] Commit with spec ID reference
- [x] All tests passing
- [x] Code linted and formatted

## Agent Output

2026-01-28T16:52:57Z

```


I'll start by reading the failing test and understanding the `get_commits_for_spec()` function.
Now let me find the `is_git_repo_available()` function and the `get_commits_for_spec_allow_no_commits` function.
Let me read the imports and the actual function implementations.
Now let me look at the actual `get_commits_for_spec_allow_no_commits` and `get_commits_for_spec` implementations to understand what they do with git.
Now I understand the issue clearly:

1. The test calls `get_commits_for_spec_allow_no_commits()` which runs `git log --grep` then falls back to `git rev-parse HEAD`
2. In CI, there's no git repo, so `is_git_repo_available()` should return `false` and the test should skip
3. But the CI error shows the test is NOT skipping — it's actually running and failing at the `git rev-parse HEAD` fallback

The error message in CI is: `fatal: not a git repository (or any of the parent directories): .git` — this means `is_git_repo_available()` is returning `true` even though the test context doesn't have a usable git repo, OR the CI environment has a git repo at the working directory level but `git log` and `git rev-parse HEAD` still fail.

Wait, looking more carefully at the CI error: `git log` succeeds (returns 0 commits) but `git rev-parse HEAD` fails because there's no `.git` directory. That's odd. Let me re-read the error:

```
→ Found 0 commit(s) matching pattern 'chant(2026-01-24-01p-cmz):'
⚠ No commits found with pattern 'chant(2026-01-24-01p-cmz):'. Attempting to use HEAD as fallback.
✗ Could not find any commit for spec '2026-01-24-01p-cmz' and HEAD fallback failed: fatal: not a git repository
```

So `git log` ran successfully (returned 0 results, exit code 0), then `git rev-parse HEAD` failed with "not a git repository". This is a subtle inconsistency — possibly the CI checkout is a shallow clone or the working directory changes between commands.

Actually, looking again: `git log --oneline --grep "pattern" --reverse` might return exit code 0 with empty output even in a non-git-repo on some git versions, or the test is running from within a git repo checkout directory but the HEAD ref is problematic.

Regardless, the best fix is **Option A from the spec**: set up a temporary git repo in the test. This way the test is self-contained and works everywhere. Let me implement that.

The test needs a temp git repo with at least one commit (so `HEAD` exists). Since the test calls `get_commits_for_spec_allow_no_commits`, the fallback path will use `git rev-parse HEAD`, which requires at least one commit.

However, there's a problem: `get_commits_for_spec_internal` runs `git` commands without specifying a directory — it uses whatever the current working directory is. Changing `current_dir` in tests can affect other parallel tests. Let me check if these tests are marked `#[serial]`.
Some tests use `#[serial]`, but the failing test does not:
The best approach is to create a temporary git repo and `cd` into it. Since this changes the working directory, I should add `#[serial]` to prevent race conditions with other tests. Let me also check the other two git-dependent tests to see if they need the same treatment.

Looking at all three tests:
1. `test_get_commits_for_spec_found_commits` (line 3638) — uses `is_git_repo_available()` skip
2. `test_get_commits_for_spec_empty_log_returns_ok` (line 3657) — uses `is_git_repo_available()` skip
3. `test_get_commits_for_spec_special_characters_in_id` (line 3678) — uses `is_git_repo_available()` skip, **the failing test**

The spec says this test "passes locally but fails in CI". The `is_git_repo_available()` check uses `git rev-parse --is-inside-work-tree` — in CI, the checkout likely IS inside a work tree (GitHub Actions checks out the repo), but the test might be running from a directory where `git log` works (finds 0 commits) but `git rev-parse HEAD` fails (maybe the checkout is bare or shallow with no HEAD?). Actually, the more likely scenario: CI runs the test binary from within the git checkout, so `is_git_repo_available()` returns `true`, `git log --grep` returns 0 results (no matching commits in CI), then the HEAD fallback fails because... actually that doesn't make sense either.

Let me re-read the error more carefully:

```
fatal: not a git repository (or any of the parent directories): .git
```

This means `git rev-parse HEAD` was run from a directory that is NOT inside a git repo. So either: (1) another test changed the working directory, or (2) cargo test runs from a different directory.

The root cause is likely that `is_git_repo_available()` ran from the original working directory (inside the git checkout) and returned `true`, but by the time the test body runs, the working directory has changed (due to another parallel test doing `set_current_dir`).

The proper fix: set up a temp git repo with a commit matching the expected pattern, then `cd` into it before running the test, and restore the directory after. Since we're changing di

... (output truncated, 8891 chars total)```
