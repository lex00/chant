---
type: code
status: completed
model: claude-opus-4-5-20251101
---
# Fix test_get_commits_for_spec_special_characters_in_id CI failure

## Problem

The unit test `test_get_commits_for_spec_special_characters_in_id` in `src/cmd/spec.rs` passes locally but fails in CI with:

```
→ Searching for commits matching pattern: 'chant(2026-01-24-01p-cmz):'
→ Found 0 commit(s) matching pattern 'chant(2026-01-24-01p-cmz):'
⚠ No commits found with pattern 'chant(2026-01-24-01p-cmz):'. Attempting to use HEAD as fallback.
✗ Could not find any commit for spec '2026-01-24-01p-cmz' and HEAD fallback failed: fatal: not a git repository (or any of the parent directories): .git

assertion failed: result.is_ok()
```

**Root cause:** The test calls `get_commits_for_spec()` which runs `git log` commands. This works locally (inside a git repository) but fails in CI during unit test execution (not in a git repository context).

**Local success:**
```
→ Searching for commits matching pattern: 'chant(2026-01-24-01p-cmz):'
→ Found 1 commit(s) matching pattern 'chant(2026-01-24-01p-cmz):'
test cmd::spec::tests::test_get_commits_for_spec_special_characters_in_id ... ok
```

This is the LAST test failure blocking v0.5.0 release CI from passing.

## Solution

Fix the test to work in CI environments without a git repository. Options:

**A) Set up temporary git repo in test**
```rust
#[test]
fn test_get_commits_for_spec_special_characters_in_id() {
    let temp_dir = tempfile::tempdir().unwrap();
    std::env::set_current_dir(temp_dir.path()).unwrap();
    Command::new("git").arg("init").output().unwrap();
    // ... rest of test
}
```

**B) Mock git command execution**
- Requires refactoring `get_commits_for_spec()` to use a trait for git operations
- More invasive change

**C) Skip test in non-git environments**
```rust
#[test]
fn test_get_commits_for_spec_special_characters_in_id() {
    // Skip if not in git repo
    if !Path::new(".git").exists() {
        return;
    }
    // ... rest of test
}
```

**Recommended: Option A** - Set up a minimal temporary git repository in the test with a commit that matches the expected pattern. This tests the actual functionality without requiring env-specific skipping.

## Acceptance Criteria

- [x] Read `src/cmd/spec.rs` and locate the failing test
- [x] Understand what `get_commits_for_spec()` does and why it needs git
- [x] Implement fix (either A, B, or C based on code structure)
- [x] Run the specific test locally and verify it passes
- [x] Run full test suite locally and verify all pass
- [x] Commit with spec ID reference
- [x] All tests passing
- [x] Code linted and formatted