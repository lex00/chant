---
type: code
status: completed
depends_on:
- 2026-01-24-01y-73b.4
target_files:
- src/main.rs
- src/git.rs
- tests/
- README or CLI help
model: claude-haiku-4-5-20251001
---
# Implement `--all` flag and full merge orchestration

Complete the merge command with support for merging all completed specs and proper error handling.

### Acceptance Criteria

- [x] Implement full `cmd_merge()` that:
  - [x] Parses all arguments and flags
  - [x] Loads config and specs
  - [x] Collects specs to merge via `get_specs_to_merge()`
  - [x] Validates each spec can be merged
  - [x] For each spec: calls `merge_single_spec()` or `merge_driver_spec()` as appropriate
  - [x] Continues through list or stops on first error (decide on behavior)
  - [x] Displays summary of results
- [x] When `--all` flag used:
  - [x] Collects all specs with `status == Completed`
  - [x] Filters to only those with branches that exist
  - [x] Merges in dependency order (completed member specs before their drivers)
  - [x] Shows count of specs merged
- [x] Add `--continue-on-error` flag to allow continuing after individual spec fails
- [x] Implement result reporting showing:
  - [x] Each spec attempted, whether merged or skipped
  - [x] Any errors encountered
  - [x] Total merged count
  - [x] Whether `--delete-branch` was applied
- [x] Add confirmation prompt before executing merges (unless `--dry-run` or `--yes` flag)
- [x] Update help text and usage documentation
- [x] Add integration tests covering:
  - [x] Merge multiple specs
  - [x] Merge with `--all` flag
  - [x] Merge with `--dry-run`
  - [x] Merge with `--delete-branch`
  - [x] Error cases with appropriate exit codes
- [x] Code compiles, all tests pass, existing functionality unchanged

### Edge Cases

- Edge case 1: User cancels confirmation prompt → Exit gracefully without changes
- Edge case 2: Mix of standalone and driver specs in single merge → Correct handling of both types
- Edge case 3: Two specs with interdependent branches → Correct merge order
- Edge case 4: `--all` with no specs → Informative message
- Edge case 5: One spec merge fails with `--continue-on-error` → Other specs still attempted
- Edge case 6: Merge partially completes, user Ctrl+C → Left in clean state on main branch

### Example Test Cases

For this feature, verify:
- Case 1: `chant merge 001 002 003` merges all three in order
- Case 2: `chant merge --all` merges all completed specs
- Case 3: `chant merge --dry-run --all` shows preview without changing git
- Case 4: `chant merge --delete-branch 001` removes branch after merge
- Case 5: `chant merge 001 --continue-on-error` attempts all even if one fails
- Case 6: Mix of driver and standalone specs merge in correct order
- Case 7: User declines confirmation prompt → No changes made
- Case 8: Merge conflict during multi-spec merge → Aborts, returns to original branch, shows error


## Implementation Notes

### Key Dependencies Between Subtasks

1. **Subtask 1** → Foundation for all others (branch finding, current branch tracking)
2. **Subtask 2** → Needed before merge execution (validation prevents errors)
3. **Subtask 3** → Core merge operation, used by subtask 4
4. **Subtask 4** → Builds on subtask 3, adds group orchestration
5. **Subtask 5** → Final orchestration, uses 3 and 4

### Parallelization Opportunity

- Subtasks 1 and 2 could be done in parallel (minimal dependency)
- Subtask 3 depends on 1 and 2
- Subtasks 4 and 5 build on 3

### Testing Strategy

Each subtask includes unit and integration tests. By subtask 5, you should have:
- Unit tests for individual functions (status validation, collection, etc.)
- Integration tests with real git operations
- End-to-end tests of full merge command with various flag combinations