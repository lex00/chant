---
type: code
status: pending
depends_on:
- 2026-01-24-01x-v06.4
target_files:
- '`tests/parallel_worktree_integration.rs`'
- May depend on test utilities/mocks for agent invocation
---
# Add Integration Tests for Worktree-Based Parallel Execution

**Description:**
Create comprehensive integration tests that verify the entire worktree-based parallel execution flow end-to-end. These tests should cover success paths, edge cases, and both direct and branch modes.

### Acceptance Criteria

- [ ] Create test directory structure in `tests/` for integration tests
- [ ] Test successful parallel execution with worktrees:
  - [ ] Multiple specs run in parallel
  - [ ] Each creates isolated worktree at `/tmp/chant-{spec_id}`
  - [ ] Each completes successfully
  - [ ] Branches are merged or preserved as expected
  - [ ] Worktrees are cleaned up
- [ ] Test direct-commit mode (merge after completion):
  - [ ] Spec branch created
  - [ ] Spec executes (mocked agent output)
  - [ ] Branch merged to main
  - [ ] Branch deleted after merge
  - [ ] Worktree removed
- [ ] Test branch-mode (leave for reconcile):
  - [ ] Spec branch created with custom prefix
  - [ ] Spec executes (mocked agent output)
  - [ ] Branch left on main repo
  - [ ] Worktree removed
  - [ ] Summary shows branch name for manual reconciliation
- [ ] Test error handling:
  - [ ] Worktree creation failure → spec marked failed, no thread spawned
  - [ ] Merge conflict → branch preserved, spec marked for attention
  - [ ] Cleanup failure → error logged, spec status reflects issue
- [ ] Test sequential execution is unchanged:
  - [ ] `chant work` (non-parallel) does NOT use worktrees
  - [ ] Output and behavior identical to before
- [ ] Test concurrent worktree operations don't interfere:
  - [ ] Two specs with different IDs create separate worktrees
  - [ ] Both complete successfully
  - [ ] No file conflicts

### Example Test Cases

For this feature, verify:
- **Case 1:** Run 3 specs in parallel → 3 worktrees created, agents run, results collected
- **Case 2:** Direct mode → branches merged and deleted after completion
- **Case 3:** Branch mode → branches left, worktrees removed, summary lists branches
- **Case 4:** Conflict scenario → branch preserved, spec status updated
- **Case 5:** Sequential execution → no worktrees created, behavior unchanged
- **Case 6:** Cleanup on agent crash → worktree removed even if agent fails


## Summary

| Subtask | Purpose | Dependencies |
|---------|---------|--------------|
| **1** | Core worktree helper functions | None |
| **2** | Add working directory parameter to agent invocation | None |
| **3** | Integrate worktrees into parallel execution | Subtasks 1, 2 |
| **4** | Configure branch mode behavior | Subtasks 1, 2, 3 |
| **5** | Comprehensive integration tests | Subtasks 1, 2, 3, 4 |

**Implementation Order:**
1. Start with **Subtask 1** (worktree helpers) - independent, testable
2. Start with **Subtask 2** (cwd parameter) - independent, minimal changes
3. Proceed to **Subtask 3** (main integration) - depends on 1 & 2
4. Proceed to **Subtask 4** (branch mode config) - depends on 1, 2, 3
5. Complete with **Subtask 5** (integration tests) - validates everything

**Parallelization Opportunity:** Subtasks 1 and 2 can be worked on in parallel since they have no dependencies on each other.