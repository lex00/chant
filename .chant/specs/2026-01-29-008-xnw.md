---
type: code
status: in_progress
target_files:
- src/main.rs
- src/merge_driver.rs
- CLAUDE.md
model: claude-opus-4-5-20251101
---
# Make chant init automatically set up merge driver

## Problem

The custom merge driver (for resolving spec file conflicts) must be manually activated with `chant merge-driver-setup`. This is bad UX because:

**Why users need it:**
- Specs with `branch: true` create merge conflicts (status, commits fields)
- The merge driver automatically resolves these conflicts
- Without it, users manually edit frontmatter or get stuck

**Why manual setup fails:**
- Not mentioned during `chant init`
- Users don't know merge driver exists
- They hit conflicts and don't know the fix
- Only power users read docs and find `chant merge-driver-setup`

**Result:** Core workflow (branch mode) is broken by default

## Solution

Make `chant init` set up the merge driver automatically (or prompt):

### Option A: Automatic (recommended)
```bash
chant init
# Automatically runs merge-driver-setup
# No prompt, just works
```

**Pros:**
- Just works, no friction
- Users never hit spec conflicts
- Core workflow works out of the box

**Cons:**
- Modifies .git/config without asking (but so does `git init`)
- Modifies .gitattributes (but that's checked in anyway)

### Option B: Prompt
```bash
chant init
# Prompt: "Set up custom merge driver for spec files? [Y/n]"
# Default: Yes
```

**Pros:**
- User has control
- More transparent

**Cons:**
- Extra friction
- Users might say no without understanding impact
- Still breaks by default if they skip it

### Recommendation: Option A (automatic)

Just set it up during init. It's core infrastructure, not optional.

## Implementation

Update `src/main.rs` init command:
```rust
Commands::Init { force, silent, agent } => {
    // ... existing init logic
    
    // Set up merge driver automatically
    if let Err(e) = cmd_merge_driver_setup() {
        eprintln!("Warning: Failed to set up merge driver: {}", e);
        eprintln!("Run 'chant merge-driver-setup' manually later");
    }
    
    Ok(())
}
```

Alternatively, for Option B (prompt):
```rust
if !silent {
    let setup_merge_driver = dialoguer::Confirm::new()
        .with_prompt("Set up custom merge driver for spec files?")
        .default(true)
        .interact()?;
    
    if setup_merge_driver {
        cmd_merge_driver_setup()?;
    }
}
```

## What the merge driver does

When git merges branches with spec conflicts:
- **Status field:** Prefers more advanced (completed > in_progress > pending)
- **Commits list:** Merges without duplicates
- **completed_at:** Takes latest timestamp
- **Labels, target_files:** Deduplicates lists

Without it: Git shows conflict markers, user manually edits.

## Acceptance Criteria

- [x] Decide Option A (automatic) or Option B (prompt)
- [x] Update `chant init` to call merge-driver-setup
- [x] Handle errors gracefully (warn but don't fail init)
- [x] Test init in new repo (merge driver should be active)
- [x] Update docs to mention merge driver is automatic
- [x] All tests passing
- [x] Code linted and formatted