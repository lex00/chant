---
type: code
status: completed
target_files:
- src/cmd/work.rs
- src/main.rs
- src/cmd/spec.rs
commits:
- 955d5b4
completed_at: 2026-01-25T17:00:33Z
model: haiku
---
# Fail loudly when agent does not commit with chant(SPEC-ID) pattern

## Problem

When an agent completes work but doesn't commit with the expected `chant(SPEC-ID):` pattern, the `get_commits_for_spec()` function in `src/cmd/work.rs` silently falls back to using HEAD as the commit. This masks the problem and records incorrect commit information in the spec frontmatter.

Current behavior (lines 886-915 in work.rs):
```rust
// If no commits found, use HEAD as fallback
eprintln!("âš  No commits found with pattern 'chant({})'. Attempting to use HEAD as fallback.", spec_id);
```

## Solution

Change the default behavior to fail when no commits match the pattern. Add a `--allow-no-commits` flag (or config option) for cases where fallback to HEAD is intentional.

## Acceptance Criteria

- [x] `get_commits_for_spec()` returns an error when no commits match the pattern (default behavior)
- [x] Error message is clear: "No commits found matching 'chant(SPEC-ID):' pattern. Did the agent forget to commit?"
- [x] Add `--allow-no-commits` flag to `chant work` that enables the fallback behavior
- [x] When flag is provided, current warning behavior is preserved
- [x] Update help text to document the flag
- [x] All existing tests pass
- [x] Add test for the new failure case
- [x] Add test for the `--allow-no-commits` flag

## Technical Details

The change is in `src/cmd/work.rs`:
- Modify `get_commits_for_spec()` to return `Result<Vec<String>>` with error on no matches
- Add parameter or check config for allow-no-commits behavior
- Update `finalize_spec()` to handle the error appropriately
- The flag should be passed through from CLI args

## Why This Matters

When agents don't commit their work:
1. The spec's `commits` field contains wrong commit hashes
2. Git history doesn't properly attribute changes to specs
3. Reproducibility is compromised
4. The problem is hidden, making debugging difficult

## Agent Output

2026-01-25T17:00:33Z

```
I'll start by exploring the relevant code to understand the current implementation and then plan the changes needed for this spec.
Let me read the relevant code files to understand the current implementation:
Now let me check the main.rs to understand the CLI argument structure:
Let me mark the first todo as completed and update to the planning phase:
Now let me create an implementation plan. Based on my analysis:

**Key findings from code review:**

1. The `get_commits_for_spec()` function (lines 853-919 in work.rs) currently silently falls back to HEAD when no commits match the pattern
2. The function is called from:
   - `finalize_spec()` at line 942
   - `re_finalize_spec()` at line 1042
   - `cmd_work_parallel()` at line 521 (which already has `.ok()` fallback)
3. The `cmd_work()` function needs to accept a new `--allow-no-commits` flag
4. Main.rs needs to be updated to add the new flag to the Work command

**Implementation Plan:**

1. Modify `get_commits_for_spec()` to fail by default (no fallback to HEAD)
2. Add `allow_no_commits` parameter to `get_commits_for_spec()`
3. Add `--allow-no-commits` flag to the Work command in main.rs
4. Pass the flag through `cmd_work()` to `finalize_spec()` and `re_finalize_spec()`
5. Update all call sites appropriately
6. Add tests for the new behavior
7. Run `cargo fmt` and `cargo clippy`
8. Run `cargo test` and ensure all tests pass

Let me mark this planning complete and proceed with implementation:
Now let me start implementing. First, I'll modify the `get_commits_for_spec()` function to support the `allow_no_commits` parameter:
Now I need to update the `finalize_spec()` and `re_finalize_spec()` functions to accept and use the `allow_no_commits` flag:
Now update the `re_finalize_spec()` function:
Now I need to update the call site in `cmd_work()` where `finalize_spec()` is called:
Now update the call to `finalize_spec()` in `cmd_work()`:
Now update the call to `re_finalize_spec()` in `cmd_work()`:
Now I need to update main.rs to add the `--allow-no-commits` flag to the Work command:
Now I need to update the call to `cmd::work::cmd_work()` in main.rs to pass the new parameter:
Now let me check if there are any tests that need to be updated. Let me search for test files related to the work module:
Let me check the integration tests to see if there are tests for the commit functionality:
The integration tests don't directly test `get_commits_for_spec()`. Now let me add a unit test module within work.rs. First, let me check if there's a tests module already in work.rs:
Good, there are no existing tests in work.rs. Let me add a test module at the end of the file. First, let me see the end of the file:
Now I'll add tests at the end of the file:
Now let me run the build to see if there are any compilation errors:
Great! The build succeeded. Now let me run the formatting check and then clippy:
Good! Now let me run clippy:
Excellent! Now let me update the todo list and run the tests:
I see the issue. The `finalize_spec()` function is being called from many places in src/cmd/spec.rs. I need to update those call sites to pass the new `allow_no_commits` parameter. Let me check spec.rs first:
These are test calls in spec.rs. I should add `false` as the default for these test calls since they're testing spec finalization without the special allow-no-commits flag. Let me update spec.rs. First, let me read the relevant test sections:
I need to update all the calls to `finalize_spec()` to pass `false` (the default/safe behavior) and all the calls to `re_finalize_spec()` to pass `false`. Let me use edit to make bulk changes:
Let me fix the command:
Good! Now let me update the `re_finalize_spec()` calls:
Now I need to check if there are other calls to finalize_spec that take more parameters (the ones in the finalize module):
Let me update these remaining calls:
Now let me run the tests again to see if there are any remaining issues:
Great! The tests are passing. Let me continue reading the output:
I see the issue. The test failures are because the tests are now expecting no commits to be found (since they're test scenarios without actual git commits with the pattern). The tests that are failing are using `finalize_spec()` and `re_finalize_spec()` which now fail by default when no commits are found.

For these test scenarios, they should use the `allow_no_commits` flag. Let me update those test calls to pass `true` instead of `false`. Let me find and replace in spec.rs where tests call these functions:
Looking at the test failures, all the failing tests are in the `cmd::spec` tests module. These are unit tests that test finalization behavior and they don't have actual git commits with the pattern. For these test cases, we need to use `allow_no_commits=true` because they're testing the finalization logic itself, not commit detection.

Let me update the test calls to use `true` instead of `false`:
Also need to update the finalization calls in the finalize command that take all_specs:
W

... (output truncated, 14255 chars total)```
