---
type: code
status: completed
target_files:
- src/cmd/work.rs
- src/main.rs
- src/cmd/spec.rs
model: claude-haiku-4-5-20251001
---
# Fail loudly when agent does not commit with chant(SPEC-ID) pattern

## Problem

When an agent completes work but doesn't commit with the expected `chant(SPEC-ID):` pattern, the `get_commits_for_spec()` function in `src/cmd/work.rs` silently falls back to using HEAD as the commit. This masks the problem and records incorrect commit information in the spec frontmatter.

Current behavior (lines 886-915 in work.rs):
```rust
// If no commits found, use HEAD as fallback
eprintln!("âš  No commits found with pattern 'chant({})'. Attempting to use HEAD as fallback.", spec_id);
```

## Solution

Change the default behavior to fail when no commits match the pattern. Add a `--allow-no-commits` flag (or config option) for cases where fallback to HEAD is intentional.

## Acceptance Criteria

- [x] `get_commits_for_spec()` returns an error when no commits match the pattern (default behavior)
- [x] Error message is clear: "No commits found matching 'chant(SPEC-ID):' pattern. Did the agent forget to commit?"
- [x] Add `--allow-no-commits` flag to `chant work` that enables the fallback behavior
- [x] When flag is provided, current warning behavior is preserved
- [x] Update help text to document the flag
- [x] All existing tests pass
- [x] Add test for the new failure case
- [x] Add test for the `--allow-no-commits` flag

## Technical Details

The change is in `src/cmd/work.rs`:
- Modify `get_commits_for_spec()` to return `Result<Vec<String>>` with error on no matches
- Add parameter or check config for allow-no-commits behavior
- Update `finalize_spec()` to handle the error appropriately
- The flag should be passed through from CLI args

## Why This Matters

When agents don't commit their work:
1. The spec's `commits` field contains wrong commit hashes
2. Git history doesn't properly attribute changes to specs
3. Reproducibility is compromised
4. The problem is hidden, making debugging difficult