---
type: code
status: completed
target_files:
- src/agent.rs
- Cargo.toml
model: claude-haiku-4-5-20251001
---
# Fix ollama-rs endpoint URL parsing - extract host and port from full URL

## Problem

When using ollama provider, agent.rs receives endpoint like `http://localhost:11434/v1` but ollama-rs's `Ollama::new()` expects just the host and port separately:

```rust
// Current (broken):
let ollama = Ollama::new(endpoint.to_string(), 11434);
// endpoint = "http://localhost:11434/v1" â†’ 404 error

// Expected:
let ollama = Ollama::new("http://localhost".to_string(), 11434);
```

This results in "404 page not found" when trying to work specs with ollama.

## Fix

Parse the endpoint URL to extract host and port:

```rust
// In src/agent.rs
use url::Url;

pub async fn run_agent(
    endpoint: &str,
    // ...
) -> Result<String> {
    // Parse endpoint to extract host and port for ollama-rs
    let url = Url::parse(endpoint).unwrap_or_else(|_| {
        Url::parse("http://localhost:11434").unwrap()
    });
    let host = format!("{}://{}", url.scheme(), url.host_str().unwrap_or("localhost"));
    let port = url.port().unwrap_or(11434);

    let ollama = Ollama::new(host, port);
    // ...
}
```

Add `url` dependency to Cargo.toml:
```toml
url = "2"
```

## Acceptance Criteria

- [x] `url = "2"` added to Cargo.toml dependencies
- [x] `src/agent.rs` parses endpoint URL to extract host and port
- [x] Ollama::new() receives correct host (scheme + host) and port
- [x] `just check` passes
- [x] Manual test: `just chant work <spec-id>` with ollama no longer returns 404