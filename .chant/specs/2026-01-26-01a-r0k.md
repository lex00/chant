---
type: code
status: pending
target_files:
  - src/cmd/agent.rs
  - src/cmd/work.rs
  - src/config.rs
  - docs/reference/cli.md
---

# Add multi-account agent rotation for single spec execution

## Overview

Currently, single spec execution (`chant work 001`) always uses the default provider. Users with multiple Claude accounts want to distribute load across accounts even for single specs.

## Config

```markdown
## Defaults

provider: claude
model: claude-sonnet-4-20250514

## Agent Rotation

Distribute single-spec work across multiple agents. Strategy options:
- `none`: Always use default (current behavior)
- `random`: Random selection weighted by priority
- `round-robin`: Rotate through agents, persisted across runs

rotation_strategy: round-robin

### Agents

| name | command | weight |
|------|---------|--------|
| main | claude | 2 |
| alt1 | claude --profile alt1 | 1 |
| alt2 | claude --profile alt2 | 1 |
```

## Strategies

### None (default)
Current behavior - always uses `defaults.provider`.

### Random
Pick agent randomly, weighted by `weight` field. Higher weight = more likely.
- `weight: 2` gets picked 2x as often as `weight: 1`
- No state needed

### Round-robin
Rotate through agents in order, persist last-used index in `.chant/store/rotation.json`.
- Respects weights by repeating agents (weight:2 = appears twice in rotation)
- Survives restarts

## Implementation

- Add `rotation_strategy` to config parsing
- Add `weight` field to agent config (default: 1)
- Create `select_agent_for_work()` function in agent.rs
- For round-robin, store state in `.chant/store/rotation.json`
- Modify `cmd_work_single` to use selected agent command
- Fall back to default if no agents configured

## Acceptance Criteria

- [ ] Config parses `rotation_strategy` (none/random/round-robin)
- [ ] Config parses `weight` field on agents
- [ ] `none` strategy uses default provider (backward compatible)
- [ ] `random` strategy picks weighted random agent
- [ ] `round-robin` rotates through agents across runs
- [ ] Round-robin state persists in `.chant/store/`
- [ ] Works with existing parallel config agents
- [ ] Falls back gracefully if no agents configured
- [ ] Tests for each strategy
- [ ] Documentation updated
