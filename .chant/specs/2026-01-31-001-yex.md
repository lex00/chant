---
type: driver
status: pending
labels:
  - enhancement
target_files:
  - src/cmd/split.rs
  - .chant/prompts/split.md
---

# Improve chant split command - address dependency graph, context inheritance, and interface contracts

## Problem

When `chant split` breaks a large spec into member specs, several quality issues emerge:

1. **Linear dependency chains** - Split creates sequential 1→2→3→...→N dependencies even when the logical structure is a DAG
2. **Lost parent context** - Member specs don't inherit constraints or design principles from the parent
3. **No interface contracts** - When spec A creates a function spec B needs, there's no shared contract
4. **Implicit cross-references** - Specs reference sibling concepts without explicit links
5. **Infrastructure ordering errors** - Logging/config specs end up late when they should be early
6. **All members over-complex** - Split doesn't warn or recurse when all outputs exceed thresholds

## Observed Behavior

**Test 1: f77 (watch command)**
- 8 member specs, all 150-170 words (all flagged "too complex")
- Linear chain: f77.1 → f77.2 → ... → f77.8
- Logging (f77.7) depends on 6 prior specs, but earlier specs need logging
- No "What Watch CANNOT Do" constraints in any member

**Test 2: yex (this spec)**
- 7 member specs, all 193-229 words (all flagged "too complex")
- Linear chain: yex.1 → yex.2 → ... → yex.7
- Tasks 2-5 could be parallel after Task 1, but were chained linearly
- Meta-irony: spec about split gaps exhibited those exact gaps when split

## Solution

Restructure the split prompt and post-processing to produce higher-quality output.

## Tasks

### Task 1: Split Prompt Restructure

Modify the split prompt to require dependency analysis before task generation.

**Scope:**
- Add "Phase 1: Dependency Analysis" section to split prompt
- Require model to list: inputs, outputs, shared types for each task BEFORE generating specs
- Add "Phase 2: DAG Construction" requiring explicit dependency justification
- Only then "Phase 3: Generate member specs"

**Why first:** This is the root cause - the prompt doesn't require dependency thinking upfront.

**Acceptance criteria:**
- [ ] Split prompt has explicit dependency analysis phase
- [ ] Model must justify each dependency edge
- [ ] Parallel-capable tasks identified before spec generation

**Depends on:** nothing (foundational)

---

### Task 2: Context Inheritance

Propagate parent constraints to member specs.

**Scope:**
- Identify inheritable sections: "Constraints", "Design Principles", "Out of Scope", "What X Cannot Do"
- Add `## Inherited Context` section to each member (concise summary)
- Prompt instructs model to extract and propagate these sections

**Acceptance criteria:**
- [ ] Split prompt identifies constraint sections
- [ ] Each member includes inherited context section
- [ ] Context is summarized, not duplicated verbatim

**Depends on:** Task 1 (prompt restructure)

---

### Task 3: Interface Contracts and Cross-References

Define shared interfaces and explicit links between specs. (Merged: these are tightly coupled)

**Scope:**
- When spec A creates function/type that spec B uses, define contract
- Producer spec: `## Provides` with signature (name, params, return, errors)
- Consumer spec: `## Requires` referencing the contract
- Format: "Uses `ConfigType` from yex.2" or "Calls `detect()` (yex.3)"
- Lint validates cross-references exist

**Acceptance criteria:**
- [ ] Cross-spec function dependencies identified
- [ ] Producer specs include "Provides" section
- [ ] Consumer specs include "Requires" section
- [ ] Explicit format for all cross-references
- [ ] Lint warns on broken references

**Depends on:** Task 1 (prompt restructure)

---

### Task 4: Infrastructure Detection and Ordering

Ensure infrastructure specs appear early in dependency chain.

**Scope:**
- Detect infrastructure patterns: logging, config, types, error handling, utils
- Infrastructure should have minimal deps and be depended upon by many
- Warn if infrastructure spec depends on feature specs (likely wrong)
- Topological sort places infrastructure early

**Acceptance criteria:**
- [ ] Infrastructure keywords/patterns recognized
- [ ] Infrastructure specs get minimal dependencies
- [ ] Warning if infrastructure depends on features
- [ ] DAG correctly orders infrastructure first

**Depends on:** Task 1 (prompt restructure)

---

### Task 5: Split Quality Report

Generate quality assessment after split.

**Scope:**
- ASCII dependency graph showing member relationships
- Complexity metrics per member (words, criteria, files)
- Issue detection: late infrastructure, missing contracts, linear chain warning
- `--report` flag saves to file

**Acceptance criteria:**
- [ ] ASCII DAG displayed after split
- [ ] Complexity metrics shown
- [ ] Issues highlighted with suggestions
- [ ] `--report` saves analysis

**Depends on:** Task 1, Task 4 (needs DAG and infrastructure detection)

---

### Task 6: Recursive Split Option

Handle case where all members exceed complexity threshold.

**Scope:**
- Prominent warning when ALL members exceed threshold
- `--recursive` flag auto-splits over-complex members
- `--max-depth N` limits recursion (default: 2)
- Nested IDs: f77.1.1, f77.1.2

**Acceptance criteria:**
- [ ] Warning when all members over-complex
- [ ] `--recursive` triggers nested splits
- [ ] Depth limit prevents infinite recursion
- [ ] Nested member IDs work correctly

**Depends on:** Task 5 (needs complexity detection from report)

---

## Task Dependency Graph

```
Task 1 (prompt restructure)
   ├── Task 2 (context inheritance)
   ├── Task 3 (contracts + cross-refs)
   ├── Task 4 (infrastructure ordering)
   │      │
   │      v
   └───> Task 5 (quality report) <─── Task 1
              │
              v
         Task 6 (recursive split)
```

Tasks 2, 3, 4 can be parallel after Task 1.
Task 5 needs Task 1 and Task 4.
Task 6 needs Task 5.

## Validation Test

**Self-referential test:** After implementing these changes, splitting THIS spec (yex) should produce:
- Non-linear DAG (Tasks 2,3,4 parallel)
- Each member includes "Out of Scope" context
- Interface contracts for shared functions
- Quality report showing the DAG structure

## Out of Scope

- Automatic merging of over-split specs (manual consolidation)
- AI-powered inference beyond prompt guidance
- Breaking changes to output format (additive only)
- Modifying existing split output retroactively
