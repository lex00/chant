---
type: code
status: completed
target_files:
- src/main.rs
commits:
- 5a8fbfc
completed_at: 2026-01-24T21:51:53Z
model: haiku
---
# Archive command should wait for all group members to complete

## Problem

The archive command doesn't respect spec groups. It can:
1. Archive a driver spec while its members are still pending/in_progress
2. Archive member specs while the driver is still pending

This breaks the group relationship and can leave orphaned specs.

## Expected Behavior

1. **Driver specs**: Only archive if ALL member specs are completed (or already archived)
2. **Member specs**: Only archive if the driver is also being archived (or already archived)
3. **Archive group together**: When archiving a driver, also archive all its completed members

## Implementation

In `cmd_archive()`, before adding a spec to `to_archive`:

1. If spec is a driver (type: group), check all members are completed
2. If spec is a member, check driver is also being archived or already archived
3. Add `--include-members` flag to archive driver + all members together

## Acceptance Criteria

- [x] Skip driver specs if any member is not completed (log warning)
- [x] Skip member specs if driver is not being archived (unless driver already archived)
- [x] Add `--include-members` flag to archive driver and all its members together
- [x] When archiving a driver with `--include-members`, archive all completed members too
- [x] Add warning when skipping specs due to group constraints
- [x] Test: driver with incomplete members is not archived
- [x] Test: driver with all complete members IS archived
- [x] Test: `--include-members` archives driver and members together

## Agent Output

2026-01-24T21:51:53Z

```
I'll start by creating a todo list to track this implementation, then explore the codebase to understand the current archive command implementation.
Let me read the archive command implementation first:
The file is too large. Let me search for the archive command:
Now let me look at the Spec struct to understand how groups work:
Let me look for the Spec structure definition:
Let me search for "pub struct Spec":
Let me search for the spec module to find the Spec structure:
Good! Let me check the spec.rs file:
Perfect! Now I understand the structure. Let me update my todo list and search for helper functions to get members of a spec:
Now let me look at the command-line parsing to see where the archive command is called and what flags it accepts:
Let me look at the command structure for the archive command:
Let me read the Archive command structure section:
Good. Now let me understand the problem better. I need to:
1. Add `--include-members` flag to the Archive command
2. Add validation logic to check group constraints
3. Create helper functions to get members and validate group relationships

Let me update my todo and plan the implementation:
Now let me plan the implementation:

**Plan:**
1. Add helper functions in `spec.rs`:
   - `get_members(driver_id: &str, specs: &[Spec]) -> Vec<&Spec>` - find all members of a driver
   - `all_members_completed(driver_id: &str, specs: &[Spec]) -> bool` - check if all members are completed

2. Add `--include-members` flag to the Archive command structure

3. Modify `cmd_archive()` to:
   - When archiving a specific spec that is a driver with `--include-members`, also archive all completed members
   - When archiving a specific spec that is a member, check that the driver is also being archived or already archived
   - When archiving a driver, check that all members are completed (log warning if skipping)
   - Add appropriate warning messages

4. Write tests for:
   - Driver with incomplete members cannot be archived
   - Driver with all complete members can be archived
   - `--include-members` archives driver and members together
   - Member without driver being archived is skipped

Let me start implementing. First, I'll add the helper functions to `spec.rs`:
Now I'll add the helper functions after `is_member_of`. Let me add them:
Now let me add the `--include-members` flag to the Archive command:
Now update the command match to pass the new flag:
Now let me update the `cmd_archive` function signature and implementation. First, let me read the full function again:
Now I'll replace the entire `cmd_archive` function with the new logic. This is a significant change:
Now let me update the todo list and compile to check for errors:
Let me try with just chant:
I need to format the code. Let me fix the formatting issues:
Now let's check again:
Good. Now let's check linting:
I have a borrow issue. I need to use a reference in the for loop. Let me fix this:
The issue is that I moved `specs` in the for loop. I need to iterate over a reference:
Now I need to adjust the code to use references. Let me look at the part where we push to_archive:
I need to clone the spec when pushing:
Now let's check linting again:
Excellent! Now let me write the tests. Let me check the existing tests in main.rs:
Let me look at the existing archive tests:
Now I'll add tests for the group constraints. Let me add them before the closing brace:
Now let's run the tests:
Great! All the tests pass. Let me run all tests to be sure:
Perfect! All tests pass. Now let me update my todo and run lint again to make sure everything is good:
There are some test failures but they don't seem to be related to my changes. Let me check what these tests are about:
These test failures are not related to my changes about the archive command and group constraints - they appear to be related to model selection. Let me check if these tests were failing before my changes by running only the archive-related tests:
Let me run cargo test directly:
Let me check if these failing tests existed before my changes:
Let me check if these tests are failing on the current code before my changes:
Good, so the tests were already failing before my changes. Let me restore my changes and continue:
Now let me check the spec file I need to update:
Now let me check off the acceptance criteria. Let me trace through what I've implemented:

1. ✅ Skip driver specs if any member is not completed (log warning) - Done with warning message
2. ✅ Skip member specs if driver is not being archived (unless driver already archived) - Done with warning message
3. ✅ Add `--include-members` flag to archive driver and all its members together - Done
4. ✅ When archiving a driver with `--include-members`, archive all completed members too - Done
5. ✅ Add warning when skipping specs due to group constraints - Done
6. ✅ Test: driver with incomplete members is not archived - Done with test_archive_driver_with_incomplete_members
7. ✅ Test: driver with all comple

... (output truncated, 7754 chars total)```
