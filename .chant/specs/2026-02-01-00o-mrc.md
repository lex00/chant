---
type: code
status: in_progress
---
# Fix chant diagnose checking wrong location + improve output clarity

`chant_diagnose` (MCP tool) reports completely wrong data when agents are running in worktrees - shows "failed", "no lock", "no log" when agent is actively working.

## Bug: Wrong Location

Diagnose checks main repo instead of worktree, causing false reports:
```
- "status: failed"      ← Actually in_progress (in worktree)
- "Lock file: Not present"  ← Lock exists in worktree
- "Log file: Does not exist" ← Log exists in worktree
```

Agent is running fine in `/tmp/chant-<spec-id>/` but diagnose only checks `.chant/` in main repo.

## Root Cause

Diagnose likely does:
```rust
// Wrong - only checks main
let spec_path = ".chant/specs/<id>.md";
let lock_path = ".chant/locks/<id>.lock";
```

Should do:
```rust
// Check worktree first if it exists
if let Some(worktree) = get_active_worktree(spec_id) {
    // Check worktree paths
} else {
    // Fall back to main
}
```

## Tasks

1. Find `chant_diagnose` / `cmd_diagnose` implementation
2. Add worktree detection - check if spec has active worktree
3. Read spec/lock/log from worktree when present
4. Show which location was checked: "(checked in worktree)" vs "(checked in main)"
5. Add interpretation hints to output
6. Add summary assessment based on all signals

## Acceptance Criteria

- [x] Diagnose checks worktree paths when worktree exists for spec
- [x] Diagnose shows correct status from worktree spec file
- [x] Diagnose finds lock file in worktree
- [x] Diagnose finds log file in worktree
- [x] Output indicates which location was checked
- [x] Running agents no longer show as "failed" in diagnose