---
type: group
status: completed
target_files:
- src/main.rs
model: haiku
completed_at: 2026-01-24T00:00:00Z
---
# Fix spec finalization bug - ensure status, commits, completed_at are set after work

## Problem

Spec `01a-75r` was left in `status: in_progress` even though:
- The agent completed all work
- All acceptance criteria were checked
- A commit was created with the spec ID

The spec was missing `commits`, `completed_at`, and correct `status`.

## Root Cause

In `cmd_work()`, the spec finalization happens after `invoke_agent()` returns. If something goes wrong between agent completion and spec save, the spec stays in_progress.

Possible causes:
1. Agent output parsing failed
2. Commit detection failed but didn't error
3. Spec save was skipped due to early return
4. Race condition in parallel mode

## Acceptance Criteria

- [x] Investigate the code path in cmd_work after invoke_agent returns
- [x] Ensure spec.save() is always called after successful agent completion
- [x] Add error handling that doesn't silently skip finalization
- [x] Add test that verifies spec is marked completed after work
- [x] Consider adding a "finalize" step that's idempotent (can be re-run)

## Investigation Points

1. Check `cmd_work()` around lines 798-820 where spec is updated
2. Check if `get_commits_for_spec()` can silently fail
3. Check parallel mode finalization in `cmd_work_parallel()`

## Solution Summary

### Changes Made:

1. **Added `finalize_spec()` function** (src/main.rs:1292-1321)
   - Idempotent function that sets status, commits, completed_at, and model
   - Explicitly handles and propagates errors instead of silently ignoring them
   - Consolidates finalization logic in one place

2. **Updated `cmd_work()` to use finalize_spec()** (src/main.rs:811-813)
   - Replaced inline finalization code with a call to `finalize_spec()`
   - Ensures spec is saved even if other operations fail
   - Single source of truth for finalization logic

3. **Improved error handling in `cmd_work_parallel()`** (src/main.rs:982-1027)
   - Changed from silently ignoring save errors (`let _ = ...`) to logging warnings
   - Added `eprintln!()` to report finalization failures to stderr
   - Makes failures visible instead of silent

4. **Added test** (src/main.rs:2752-2809)
   - `test_finalize_spec_sets_status_and_timestamps()` verifies:
     - Spec status is set to `Completed`
     - `completed_at` timestamp is set
     - Changes are persisted to disk
   - Validates the function is idempotent

### Why This Fixes the Issue:

- **Explicit Finalization**: The `finalize_spec()` function ensures all finalization steps are always performed together
- **Error Propagation**: Errors that previously went unnoticed are now surfaced
- **Parallel Mode Visibility**: Warnings in parallel mode now appear instead of silently failing
- **Single Source of Truth**: All spec completion logic is in one place, reducing bugs from duplicate code