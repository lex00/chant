---
type: group
status: pending
target_files:
- src/main.rs
---
# Fix spec finalization bug - ensure status, commits, completed_at are set after work

## Problem

Spec `01a-75r` was left in `status: in_progress` even though:
- The agent completed all work
- All acceptance criteria were checked
- A commit was created with the spec ID

The spec was missing `commits`, `completed_at`, and correct `status`.

## Root Cause

In `cmd_work()`, the spec finalization happens after `invoke_agent()` returns. If something goes wrong between agent completion and spec save, the spec stays in_progress.

Possible causes:
1. Agent output parsing failed
2. Commit detection failed but didn't error
3. Spec save was skipped due to early return
4. Race condition in parallel mode

## Acceptance Criteria

- [ ] Investigate the code path in cmd_work after invoke_agent returns
- [ ] Ensure spec.save() is always called after successful agent completion
- [ ] Add error handling that doesn't silently skip finalization
- [ ] Add test that verifies spec is marked completed after work
- [ ] Consider adding a "finalize" step that's idempotent (can be re-run)

## Investigation Points

1. Check `cmd_work()` around lines 798-820 where spec is updated
2. Check if `get_commits_for_spec()` can silently fail
3. Check parallel mode finalization in `cmd_work_parallel()`