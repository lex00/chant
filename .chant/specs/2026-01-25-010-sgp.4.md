---
type: code
status: completed
model: claude-opus-4-5-20251101
depends_on:
- 2026-01-25-010-sgp.3
target_files:
- src/cmd/finalize.rs
- src/cmd/work.rs
- src/cmd/mod.rs
---
# Extract Finalization Module

Create `src/cmd/finalize.rs` containing all spec finalization logic (marking complete, updating frontmatter).

### Acceptance Criteria

- [x] `src/cmd/finalize.rs` created with the following functions:
  - `pub fn finalize_spec(spec: &mut Spec, spec_path: &Path, config: &Config, all_specs: &[Spec]) -> Result<()>`
  - `pub fn re_finalize_spec(spec: &mut Spec, spec_path: &Path, config: &Config) -> Result<()>`
  - `pub fn confirm_re_finalize(spec_id: &str, force_flag: bool) -> Result<bool>`
  - `pub fn append_agent_output(spec: &mut Spec, output: &str)`
- [x] All finalization functions moved with their implementations (~273 lines)
- [x] Dependencies imported correctly
- [x] Frontmatter updates preserved (status, commits, completed_at, model)
- [x] All validations preserved
- [x] `re_finalize_spec` works on in_progress or completed specs only
- [x] `append_agent_output` truncates output longer than `MAX_AGENT_OUTPUT_CHARS` (5000)
- [x] `src/cmd/work.rs` updated with imports
- [x] `src/cmd/mod.rs` updated to include `pub mod finalize;`
- [x] `just check` passes

### Summary

Reduced work.rs from 1196 to 931 lines (-265 lines). Created finalize.rs with 273 lines.
