---
type: code
status: pending
depends_on:
- 2026-01-25-010-sgp.3
target_files:
- src/cmd/finalize.rs
- src/cmd/work.rs
- src/cmd/mod.rs
---
# Extract Finalization Module

Create `src/cmd/finalize.rs` containing all spec finalization logic (marking complete, updating frontmatter).

### Acceptance Criteria

- [ ] `src/cmd/finalize.rs` created with the following functions:
  - `pub fn finalize_spec(spec: &mut Spec, spec_path: &Path, config: &Config, all_specs: &[Spec]) -> Result<()>`
  - `pub(crate) fn re_finalize_spec(spec: &mut Spec, spec_path: &Path, config: &Config) -> Result<()>`
  - `fn confirm_re_finalize(spec_id: &str, force_flag: bool) -> Result<bool>`
  - `pub(crate) fn append_agent_output(spec: &mut Spec, output: &str)`
- [ ] All three finalization functions moved with their implementations (~320 lines)
- [ ] Dependencies imported correctly:
  - `finalize_spec` checks for incomplete driver members using `spec::get_incomplete_members()`
  - Model name retrieved via `get_model_name()` from model module
  - Commits retrieved via `get_commits_for_spec()` from commits module
  - Transcript committed via `commit_transcript()` from git_ops module
- [ ] Frontmatter updates:
  - Status set to `Completed`
  - `commits` field set (or None if empty)
  - `completed_at` timestamp set in ISO format with 'Z' suffix
  - `model` field set if available
- [ ] All validations preserved:
  - Status actually changed to Completed after save
  - Completed_at is ISO format with 'T' and 'Z'
  - Spec reloaded from disk to verify persistence
  - Commits match between memory and disk
- [ ] `re_finalize_spec` works on in_progress or completed specs only
- [ ] `append_agent_output` truncates output longer than `MAX_AGENT_OUTPUT_CHARS` (5000)
- [ ] `src/cmd/work.rs` updated with imports and calls these functions
- [ ] `src/cmd/mod.rs` updated to include `pub mod finalize;`
- [ ] `just check` passes

### Edge Cases

- `finalize_spec` called on driver spec with incomplete members must fail and list incomplete members
- Both `finalize_spec` and `re_finalize_spec` must validate ISO format: must contain 'T' and end with 'Z'
- Spec file save may fail silently - validation catches this by reloading
- `re_finalize_spec` on pending spec (never started) must fail
- `re_finalize_spec` on blocked or ready spec must fail
- Agent output longer than 5000 chars must be truncated with "..." marker
- User confirmation for re-finalize can be bypassed with --force flag
- Confirmation prompt must accept 'y', 'Y' as affirmative

### Example Test Cases

For this extraction, verify:
- `finalize_spec` sets status to Completed and saves to disk
- Completed_at timestamp is ISO format and persists
- `finalize_spec` on driver with incomplete members fails with member list
- `re_finalize_spec` works on completed specs but not pending
- `confirm_re_finalize` with force=true returns Ok(true) immediately
- `append_agent_output` preserves short output, truncates long output with marker