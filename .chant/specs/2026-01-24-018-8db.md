---
type: code
status: completed
target_files:
- src/main.rs
commit: 3614866
completed_at: 2026-01-24T15:00:00Z
model: claude-opus-4-5
---
# Fix streaming output - use --output-format stream-json instead of --print

## Problem

The `--print` flag causes Claude CLI to buffer all output until completion, not stream in real-time. This means:
- Log file IS created immediately with header (StreamingLogWriter works correctly)
- Header appears right away: `# Agent Log...`, `# Started...`, `# Prompt...`
- Then NOTHING until work completes
- Then entire summary dumps at once

`StreamingLogWriter` IS working correctly - it writes what it receives. But it only receives the final `--print` output, not real-time conversation.

## Solution

Use `--output-format stream-json --verbose` instead of plain `--print`:

```bash
claude --print --output-format stream-json --verbose --dangerously-skip-permissions "..."
```

**Note:** `--verbose` is REQUIRED with `stream-json` (errors without it).

## Acceptance Criteria

- [x] Add `--output-format stream-json --verbose` flags to claude invocation
- [x] Parse each line as JSON
- [x] Extract and display `message.content[].text` from `type=assistant` messages
- [x] Write to both log file and terminal in real-time
- [x] Handle `type=result` message for final result (ignored for now - text extraction works)
- [x] All existing tests pass
- [x] New test verifies JSON parsing

## JSON Format

Each line is a JSON object:
```json
{"type":"system","subtype":"init",...}
{"type":"assistant","message":{"content":[{"type":"text","text":"..."}],...}}
{"type":"result","subtype":"success","result":"...",...}
```

## Implementation

In `invoke_agent()` and `invoke_agent_with_prefix()`:

1. Change command args to include `--output-format stream-json --verbose`
2. Parse each line as JSON using serde_json
3. Extract content from assistant messages
4. Write text to both terminal and log file

```rust
// Change command args:
.arg("--print")
.arg("--output-format")
.arg("stream-json")
.arg("--verbose")
.arg("--dangerously-skip-permissions")

// Parse each line:
for line in reader.lines().map_while(Result::ok) {
    if let Ok(json) = serde_json::from_str::<serde_json::Value>(&line) {
        match json.get("type").and_then(|t| t.as_str()) {
            Some("assistant") => {
                if let Some(content) = json.get("message")
                    .and_then(|m| m.get("content"))
                    .and_then(|c| c.as_array()) {
                    for item in content {
                        if let Some(text) = item.get("text").and_then(|t| t.as_str()) {
                            println!("{}", text);
                            writer.write_line(text)?;
                        }
                    }
                }
            }
            Some("result") => {
                // Capture result for return value
            }
            _ => {} // Ignore init, system messages, etc.
        }
    }
}
```

## Verification

```bash
# Test that logs stream in real-time
chant work <spec-id> &
tail -f .chant/logs/<spec-id>.log
# Should see content appearing as agent works
```

## Future: Kiro Support

When Kiro provider is added (Phase 2), it should also support streaming output. The streaming architecture should be provider-agnostic - each provider parses its own format but writes to the same StreamingLogWriter.
