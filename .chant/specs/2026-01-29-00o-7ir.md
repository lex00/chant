---
type: code
status: completed
model: claude-opus-4-5-20251101
---
# Update chant init to write MCP config to ~/.claude/mcp.json (global location)

## Problem

Current implementation (from spec u5r) writes MCP config to project-local `.mcp.json`, but:
- Claude Code CLI **only** reads from `~/.claude/mcp.json` (global location)
- Project-local `.mcp.json` is ignored by Claude Code
- Users must manually copy config to global location
- MCP integration doesn't "just work" after `chant init --agent claude`

This defeats the purpose of auto-creating MCP config during init.

## Solution

When `chant init --agent claude` runs, write MCP config to **both** locations:

1. **`~/.claude/mcp.json`** (global) - Actually used by Claude Code
2. **`.mcp.json`** (project-local) - Reference copy for documentation

### Implementation Strategy

**Smart merging to avoid overwriting existing MCP servers:**

```rust
fn update_claude_mcp_config() -> Result<()> {
    let global_mcp_path = dirs::home_dir()
        .ok_or_else(|| anyhow!("Could not determine home directory"))?
        .join(".claude")
        .join("mcp.json");

    // Ensure ~/.claude/ directory exists
    if let Some(parent) = global_mcp_path.parent() {
        std::fs::create_dir_all(parent)?;
    }

    // Read existing config if it exists
    let mut config: serde_json::Value = if global_mcp_path.exists() {
        let content = std::fs::read_to_string(&global_mcp_path)?;
        serde_json::from_str(&content).context("Failed to parse existing ~/.claude/mcp.json")?
    } else {
        // Create new config structure
        json!({
            "mcpServers": {}
        })
    };

    // Add or update chant MCP server
    if let Some(servers) = config.get_mut("mcpServers") {
        servers["chant"] = json!({
            "type": "stdio",
            "command": "chant",
            "args": ["mcp"]
        });
    }

    // Write updated config
    let formatted = serde_json::to_string_pretty(&config)?;
    std::fs::write(&global_mcp_path, formatted)?;

    println!("{} Added chant MCP server to {}", "✓".green(), global_mcp_path.display());

    Ok(())
}
```

### Output Messages

**Success (new config):**
```
✓ Created ~/.claude/mcp.json with chant MCP server
✓ Created .mcp.json (reference copy)
ℹ Restart Claude Code to activate MCP integration
```

**Success (merged with existing):**
```
✓ Added chant MCP server to ~/.claude/mcp.json
✓ Created .mcp.json (reference copy)
ℹ Restart Claude Code to activate MCP integration
```

**Error (invalid existing config):**
```
✗ Could not parse existing ~/.claude/mcp.json (invalid JSON)
→ Please manually add the chant MCP server:

{
  "mcpServers": {
    "chant": {
      "type": "stdio",
      "command": "chant",
      "args": ["mcp"]
    }
  }
}

Backup saved to: ~/.claude/mcp.json.backup
```

## Edge Cases

1. **No home directory** - Fail gracefully with clear error
2. **Invalid JSON in existing config** - Create backup, show manual instructions
3. **Permission denied** - Show clear error about file permissions
4. **Config already has chant server** - Update it (idempotent)
5. **Project-local write fails** - Continue anyway (global is what matters)

## Files to Modify

- `src/main.rs` - Update MCP config creation logic in `cmd_init`
- Add dependency: `dirs` crate for home directory detection
- `Cargo.toml` - Add `dirs = "5.0"` dependency

## Acceptance Criteria

- [x] When `chant init --agent claude` runs, writes to `~/.claude/mcp.json`
- [x] Creates `~/.claude/` directory if it doesn't exist
- [x] Merges with existing `~/.claude/mcp.json` without overwriting other servers
- [x] Also creates project-local `.mcp.json` as reference
- [x] Prints clear success message with restart reminder
- [x] Handles invalid existing JSON gracefully (backup + manual instructions)
- [x] Handles missing home directory gracefully
- [x] Handles permission errors gracefully
- [x] Is idempotent (can run multiple times safely)
- [x] Updates existing chant server entry if already present
- [x] `Cargo.toml` includes `dirs` dependency
- [x] All tests pass
- [x] `cargo clippy` passes

## Testing

**Manual test:**
```bash
# Test 1: Fresh installation
rm -f ~/.claude/mcp.json
cd /tmp/test-chant
chant init --agent claude
cat ~/.claude/mcp.json  # Should have chant server

# Test 2: Merge with existing config
cat > ~/.claude/mcp.json << 'EOF'
{
  "mcpServers": {
    "other-server": {
      "command": "other"
    }
  }
}
EOF
chant init --agent claude --force
cat ~/.claude/mcp.json  # Should have both servers

# Test 3: Invalid existing config
echo "invalid json" > ~/.claude/mcp.json
chant init --agent claude --force
# Should show error and create backup
```

## Dependencies

- Depends on spec u5r (MCP infrastructure already implemented)
- Blocks full MCP integration until this is complete