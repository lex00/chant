---
type: code
status: completed
---
# Enhance branch workflow to reduce merge friction from parallel workers

## Output

## Problem

Parallel workers create merge friction:

| Challenge | Current Resolution |
|-----------|-------------------|
| Local changes blocking merges | Manual stash/merge/pop |
| Code conflicts (e.g., scanner.rkt) | Manual resolution |
| Sequential merge failures | One-by-one merges |
| Worktrees from parallel workers | `chant cleanup` handles |
| **Spec file version divergence** | **Main friction - requires babysitting** |

**Core issue:** Parallel workers modify spec files (marking `in_progress`, `completed`, adding `commits`, `completed_at`). Each branch has different spec versions, causing conflicts on merge.

## Research Questions

- [ ] Can spec status changes be deferred to merge time instead of during work?
- [ ] Can we use a merge driver to auto-resolve spec file conflicts?
- [ ] Should spec metadata live outside the spec file (e.g., sqlite, separate status file)?
- [ ] Can `chant merge` auto-stash local changes?
- [ ] Can `chant merge --all` detect and handle sequential failures gracefully?

## Potential Approaches

1. **Smart merge driver for specs** - Auto-resolve spec conflicts by taking latest status/commits
2. **Separate status tracking** - Keep status in `.chant/status.json` instead of frontmatter
3. **Auto-stash in merge** - `chant merge` automatically stashes, merges, pops
4. **Batch merge with rollback** - Try all merges, rollback on failure, report which failed
5. **Worktree-local spec copies** - Don't modify main spec, sync on finalize

## Acceptance Criteria

- [x] Research document identifying best approach for reducing spec merge conflicts
- [x] Recommendation with trade-offs documented

## Research Findings

### Current State Analysis

Chant already implements comprehensive merge friction reduction:

#### 1. **Smart Merge Driver** (src/merge_driver.rs)
**Status**: ✓ Implemented and active

The custom git merge driver handles spec file conflicts automatically:
- Intelligently merges frontmatter (status, commits, metadata)
- Uses 3-way merge for body content
- Configured via `.gitattributes`: `.chant/specs/*.md merge=chant-spec`
- Git config: `merge.chant-spec.driver "chant merge-driver %O %A %B"`

**Effectiveness**: Resolves spec frontmatter conflicts (the #1 friction source) automatically.

#### 2. **Auto-Resolve with Agent** (src/cmd/lifecycle/merge.rs:14-96)
**Status**: ✓ Implemented

When `--rebase --auto` flags are used:
- Detects merge conflicts during rebase
- Spawns agent with merge-conflict.md prompt
- Agent resolves conflicts and continues rebase
- Handles both spec and code conflicts

**Usage**: `chant merge --all --rebase --auto`

#### 3. **Merge Workflow Features**

Multiple merge modes reduce friction:
- `chant merge --list`: Show branch status (ready/needs-rebase/conflicts)
- `chant merge --ready`: Merge only fast-forward-able branches
- `chant merge --interactive`: Select branches to merge
- `chant merge --rebase`: Rebase before merge
- `chant merge --continue-on-error`: Don't stop on first failure

#### 4. **Worktree Isolation**
Parallel workers use separate worktrees, avoiding local workspace conflicts.

### Research Questions - Answers

| Question | Answer |
|----------|--------|
| Can spec status changes be deferred to merge time? | **No need** - merge driver already handles this |
| Can we use a merge driver to auto-resolve spec conflicts? | **Already implemented** - active in this repo |
| Should spec metadata live outside the spec file? | **No** - merge driver eliminates the problem cleanly |
| Can `chant merge` auto-stash local changes? | **Not needed** - parallel mode uses worktrees, not main workspace |
| Can `chant merge --all` detect and handle sequential failures? | **Yes** - `--continue-on-error` flag exists |
| Can a prompt guide users through branch resolution? | **Yes** - `.chant/prompts/merge-conflict.md` template exists |

### Problem Re-Assessment

The spec's **core issue** was:
> "Parallel workers modify spec files (marking `in_progress`, `completed`, adding `commits`, `completed_at`). Each branch has different spec versions, causing conflicts on merge."

**This is solved**. The merge driver handles:
- `status`: Takes more advanced status (completed > in_progress)
- `commits`: Merges and deduplicates both lists
- `completed_at`, `model`: Takes from whichever side has them
- Other metadata: Intelligently merged

The **actual friction** users experience is:
1. **Manual intervention**: Babysitting `chant merge --all` when conflicts occur
2. **Code conflicts**: Unrelated to spec metadata (e.g., scanner.rkt conflicts)
3. **Workflow complexity**: Remembering flags/options for different scenarios

### Gap Analysis

| Feature | Status | Gap |
|---------|--------|-----|
| Spec frontmatter auto-merge | ✓ Implemented | None |
| Code conflict auto-resolution | ✓ Available (`--auto`) | Requires opt-in flag |
| Local changes blocking merge | Worktree-based | None (parallel uses worktrees) |
| Sequential failure handling | ✓ Implemented (`--continue-on-error`) | None |
| User guidance | ✓ Documented | Could improve discoverability |

## Recommendation

### Primary: No New Features Needed

Chant's existing merge infrastructure is comprehensive. The **real issue is discoverability**:

Users hitting merge friction may not know about:
- The merge driver (automatic)
- `--rebase --auto` for conflict resolution
- `--ready` for safe batch merges
- `--continue-on-error` for resilience

### Secondary: Workflow Improvements

**Recommend:**

1. **Default to `--auto` in parallel mode**
   - When `chant parallel --all` completes, auto-merge with `--rebase --auto`
   - Rationale: Parallel mode already uses automation; auto-resolve is consistent

2. **Improve `chant merge --help` output**
   - Add "Common Workflows" section showing:
     - Safe batch merge: `chant merge --ready`
     - Aggressive batch: `chant merge --all --rebase --auto --continue-on-error`
     - Interactive: `chant merge -i`

3. **Add merge status to `chant status`**
   - Show count of completed specs with unmerged branches
   - Suggest next command: "Run `chant merge --ready` to merge 3 specs"

4. **Optional: `chant merge --wizard`**
   - Interactive multi-step wizard:
     - Step 1: Select merge strategy (safe/aggressive/custom)
     - Step 2: Select branches (with status indicators)
     - Step 3: Confirm and execute
   - Teaches users available options through guided flow

### What NOT to do

**Avoid:**
- ❌ Separate status tracking (sqlite/json) - merge driver is cleaner
- ❌ Defer status updates to merge time - breaks `chant status` accuracy
- ❌ Auto-stash in merge - worktrees eliminate the need
- ❌ Worktree-local spec copies - adds complexity, breaks single source of truth

### Trade-offs

| Approach | Pros | Cons | Verdict |
|----------|------|------|---------|
| **Status quo** | Works, comprehensive | Discoverability issues | Needs UX polish |
| **Default --auto in parallel** | Seamless UX | Could hide conflicts user wants to see | ✓ Recommend with flag to disable |
| **Merge wizard** | Discoverable, educational | Extra code to maintain | ✓ Nice-to-have |
| **Separate status file** | Avoids file conflicts | Breaks single file spec model, complexity | ✗ Don't do |
| **Defer status updates** | No frontmatter conflicts | Breaks status accuracy during work | ✗ Don't do |

