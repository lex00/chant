---
type: code
status: in_progress
target_files:
- src/cmd/spec.rs
model: claude-sonnet-4-5-20250929
---
# Auto-commit spec files on creation to prevent untracked specs

## Problem

Spec files (`.chant/specs/*.md`) are never automatically committed during the normal workflow, which causes `chant archive` to fail on completed specs.

**Current Broken Workflow:**
1. `chant add "description"` → Creates `.chant/specs/XXX.md` (untracked)
2. `chant work <spec-id>` → Code changes get committed in worktree and merged, but spec file remains untracked
3. `chant finalize` → Updates spec to `status: completed` (still untracked)
4. `chant archive` → **FAILS**: `fatal: not under version control`

**Root Cause:**
- `cmd_add()` in src/cmd/spec.rs:399 creates the spec file but never commits it
- Spec files remain untracked through their entire lifecycle
- Archive uses `git mv` which requires tracked files

**Real Error:**
```
fatal: not under version control, source=.chant/specs/2026-01-27-008-nkb.md
Error: git mv failed for .chant/specs/2026-01-27-008-nkb.md
```

## Solution

Auto-commit spec files immediately after creation in `cmd_add()`:

```rust
// In src/cmd/spec.rs, after writing spec file (around line 430)

// Write spec file
std::fs::write(&filepath, content)?;

// NEW: Auto-commit the spec file
let relative_path = filepath.strip_prefix(std::env::current_dir()?)
    .unwrap_or(&filepath);

Command::new("git")
    .args(["add", relative_path.to_str().unwrap()])
    .output()?;

Command::new("git")
    .args(["commit", "-m", &format!("chant: Add spec {}", id)])
    .output()?;

println!("Created {}", id);
Ok(())
```

**Benefits:**
- Spec files tracked from creation
- Full lifecycle in git history
- Archive works without manual intervention
- Atomic spec creation (create + commit together)

**Edge Cases to Handle:**
- Repository might be in dirty state → Still commit just the spec file
- User might not want auto-commit → Could add `--no-commit` flag (future)
- Git command might fail → Return clear error message

## Acceptance Criteria

- [x] Modify `cmd_add()` in src/cmd/spec.rs to auto-commit spec files
- [x] After writing spec file, run `git add .chant/specs/<ID>.md`
- [x] Commit with message: `chant: Add spec <ID>`
- [x] Handle errors gracefully if git commands fail
- [x] Test: Create spec → verify file is tracked (not in `git status` untracked)
- [x] Test: Create spec in dirty repo → only spec file gets committed
- [x] Test: Archive newly created spec → works without manual git add
- [x] Integration test: `chant add` → `chant work` → `chant finalize` → `chant archive` succeeds
- [x] All existing tests pass