---
type: code
status: completed
target_files:
- src/main.rs
context:
- src/config.rs
- src/provider.rs
- src/templates.rs
commits:
- 29ef05b
completed_at: 2026-01-29T21:00:26Z
model: opus
---
# Enhance init wizard to configure model provider and be safely re-runnable

## Problem

1. **Model provider not configurable in wizard** - Users must manually edit config.md to switch between Claude CLI, Ollama, or OpenAI
2. **Init is not safely re-runnable** - Users may want to run `chant init` multiple times to:
   - Add a new agent config (e.g., add Cursor after initially setting up Claude)
   - Change the default model provider
   - Update settings without losing existing specs

Currently init either refuses ("already initialized") or requires `--force` which is scary.

## Solution

Make init **additive and safe** by default:

### 1. Wizard asks about model provider

```
$ chant init

Project name: [my-project]
Include prompt templates? [Y/n]
Keep .chant/ local only? [y/N]

Default model provider?
> Claude CLI (recommended)
  Ollama (local)
  OpenAI API

Default model?
> opus
  sonnet
  haiku

Initialize agent configuration?
> None
  Claude Code (CLAUDE.md)
  Cursor (.cursorrules)
  Amazon Q (.amazonq/rules.md)
  Generic (.ai-instructions)
  All of the above
```

### 2. Re-running init is safe and additive

When `.chant/` already exists:

```
$ chant init

Chant already initialized for: my-project

What would you like to configure?
> Add/update agent configuration
  Change default model provider
  Change default model
  Exit (no changes)
```

Or with flags:
```bash
chant init --agent cursor          # Add cursor config, don't touch anything else
chant init --provider ollama       # Update provider in config.md
chant init --model sonnet          # Update default model in config.md
```

### 3. Behavior matrix

| Scenario | Behavior |
|----------|----------|
| Fresh init | Full wizard, create everything |
| Re-run, no flags | Show "what to configure" menu |
| Re-run, `--agent X` | Add/update agent file only |
| Re-run, `--provider X` | Update config.md provider only |
| Re-run, `--model X` | Update config.md model only |
| Re-run, `--force` | Full reinit (preserve specs/config as today) |

### 4. New CLI flags

```
--provider <PROVIDER>   Set default model provider (claude, ollama, openai)
--model <MODEL>         Set default model (opus, sonnet, haiku, or custom)
```

### 5. Config updates are surgical

When updating config.md:
- Parse existing YAML frontmatter
- Update only the specific field being changed
- Preserve all other settings (parallel config, repos, etc.)
- Preserve any content after the frontmatter

## Acceptance Criteria

- [x] Wizard prompts for model provider (Claude CLI, Ollama, OpenAI)
- [x] Wizard prompts for default model (opus/sonnet/haiku, or text input for custom)
- [x] `--provider` flag added to set model provider
- [x] `--model` flag added to set default model
- [x] Re-running init on existing project shows configuration menu (not error)
- [x] `chant init --agent X` only adds/updates agent file, doesn't touch config
- [x] `chant init --provider X` only updates provider in config.md
- [x] `chant init --model X` only updates model in config.md
- [x] Surgical config updates preserve existing settings (parallel, repos, etc.)
- [x] Existing specs are never touched during any init operation
- [x] `cargo test` passes
- [x] `cargo clippy` passes

## Agent Output

2026-01-29T21:00:26Z

```
Now let me read the config.rs and provider.rs files to understand the config structure and available providers.
Now I have a good understanding of the codebase. Let me implement the changes:

1. The `ProviderType` enum in `provider.rs` has `Claude`, `Ollama`, and `Openai` variants
2. The `Config` struct in `config.rs` has a `defaults.provider` field for the provider and `defaults.model` for the default model
3. The `cmd_init` function in `main.rs` handles the init command

I need to:
1. Add `--provider` and `--model` flags to the init command
2. Add provider/model prompts to the wizard
3. Implement re-run configuration menu
4. Implement surgical config updates

Let me start implementing:
Now let me update the `cmd_init` function signature and implementation:
Now let me rewrite the core logic of `cmd_init` to support the new behavior. First, let me read the current implementation around lines 920-1000 to understand the wizard flow better:
Now I need to rewrite the `cmd_init` function with significant changes. Let me create a comprehensive rewrite that handles all the new features:
Now I need to update the rest of the function to handle the new parameters and add the `handle_agent_update` function. Let me continue reading and updating:
Now I need to continue updating the config creation part to include the provider and model. Let me read more of the file:
Now I need to update the config file creation to include provider and model. Let me fix the config creation section:
Now I need to add the `handle_agent_update` function and add display of provider/model in the output. Let me add the helper function and update the output:
Now I need to update the output section to show provider/model info. Let me find and update that section:
Now I need to fix the tests at the end of the file to match the new function signature. Let me check the test code:
Now I need to update all the test function calls to include the new `provider` and `model` parameters. Let me update them:
Now let me update the todo list and run the build to see if there are any compilation errors:
There's a brace matching issue. Let me look at the code around line 1365 to fix it:
I see the issue - the `if chant_dir.exists() && force {` block has wrong indentation. Let me read more to see the full block:
I see the problem - there's a stray closing brace at line 1438 and the inner block at lines 1366-1436 is incorrectly indented. The issue is there's an extra `}` at 1438 that shouldn't be there. Let me fix this:
I need to fix the `handle_agent_update` function - it returns `Result<()>`, so I shouldn't use `?` on it when returning. Let me fix these:
The build succeeds. Now let me run the tests:
There are test calls in `cmd/derive.rs` that also need updating. Let me fix those:
There's one failing integration test. Let me check what that test expects:
The test expects `init --silent` to fail when `.chant/` is already initialized. Looking at my code, when `.chant/` exists and we're in non-TTY mode without specific surgical flags, we now just print "Chant already initialized" and return `Ok(())`. 

The issue is that when the user runs `init --silent` on an already initialized project, we need to check if they are trying to enable silent mode on an existing project. Let me re-examine the logic and fix it:
I see the issue. When `--silent` flag is passed on an already initialized project, we need to check for the git tracking validation before the early return. The validation happens later in the code but we return early. Let me check where the silent mode validation is:
I need to add the silent mode validation check for the case where we're on an existing project and `--silent` is passed. The issue is when the project exists and `--silent` is passed, the validation that checks if `.chant/` is already tracked happens after the early return. Let me add a check for this:
The test passes now. Let me run all the tests to make sure everything works:
All tests pass. Now let me run clippy:
There are a few clippy warnings. Let me fix the wildcard pattern warnings:
The "too many arguments" warning is acceptable in this case since `cmd_init` needs all these parameters. Let me run clippy again:
The remaining warnings are acceptable - the `commit_hash` is in existing code (not my changes) and the `too_many_arguments` is a reasonable tradeoff since refactoring this into a struct would add complexity. Let me run `cargo fmt` and then update the spec file to check off the acceptance criteria:
Now let me update the spec file to check off the acceptance criteria:
Now let me add the model field to the frontmatter and commit the changes:
Now let me check the git status and commit:
The spec has been implemented successfully. Here's a summary of the changes:

## Summary of Changes

### New Features

1. **New CLI flags**:
   - `--provider <PROVIDER>` - Set default model provider (claude, ollama, openai)
   - `--model <MODEL>` - Set default model (opus, sonnet, haiku, or custom model na

... (output truncated, 6177 chars total)```
