---
type: code
status: in_progress
target_files:
- src/main.rs
context:
- src/config.rs
- src/provider.rs
- src/templates.rs
model: claude-opus-4-5-20251101
---
# Enhance init wizard to configure model provider and be safely re-runnable

## Problem

1. **Model provider not configurable in wizard** - Users must manually edit config.md to switch between Claude CLI, Ollama, or OpenAI
2. **Init is not safely re-runnable** - Users may want to run `chant init` multiple times to:
   - Add a new agent config (e.g., add Cursor after initially setting up Claude)
   - Change the default model provider
   - Update settings without losing existing specs

Currently init either refuses ("already initialized") or requires `--force` which is scary.

## Solution

Make init **additive and safe** by default:

### 1. Wizard asks about model provider

```
$ chant init

Project name: [my-project]
Include prompt templates? [Y/n]
Keep .chant/ local only? [y/N]

Default model provider?
> Claude CLI (recommended)
  Ollama (local)
  OpenAI API

Default model?
> opus
  sonnet
  haiku

Initialize agent configuration?
> None
  Claude Code (CLAUDE.md)
  Cursor (.cursorrules)
  Amazon Q (.amazonq/rules.md)
  Generic (.ai-instructions)
  All of the above
```

### 2. Re-running init is safe and additive

When `.chant/` already exists:

```
$ chant init

Chant already initialized for: my-project

What would you like to configure?
> Add/update agent configuration
  Change default model provider
  Change default model
  Exit (no changes)
```

Or with flags:
```bash
chant init --agent cursor          # Add cursor config, don't touch anything else
chant init --provider ollama       # Update provider in config.md
chant init --model sonnet          # Update default model in config.md
```

### 3. Behavior matrix

| Scenario | Behavior |
|----------|----------|
| Fresh init | Full wizard, create everything |
| Re-run, no flags | Show "what to configure" menu |
| Re-run, `--agent X` | Add/update agent file only |
| Re-run, `--provider X` | Update config.md provider only |
| Re-run, `--model X` | Update config.md model only |
| Re-run, `--force` | Full reinit (preserve specs/config as today) |

### 4. New CLI flags

```
--provider <PROVIDER>   Set default model provider (claude, ollama, openai)
--model <MODEL>         Set default model (opus, sonnet, haiku, or custom)
```

### 5. Config updates are surgical

When updating config.md:
- Parse existing YAML frontmatter
- Update only the specific field being changed
- Preserve all other settings (parallel config, repos, etc.)
- Preserve any content after the frontmatter

## Acceptance Criteria

- [x] Wizard prompts for model provider (Claude CLI, Ollama, OpenAI)
- [x] Wizard prompts for default model (opus/sonnet/haiku, or text input for custom)
- [x] `--provider` flag added to set model provider
- [x] `--model` flag added to set default model
- [x] Re-running init on existing project shows configuration menu (not error)
- [x] `chant init --agent X` only adds/updates agent file, doesn't touch config
- [x] `chant init --provider X` only updates provider in config.md
- [x] `chant init --model X` only updates model in config.md
- [x] Surgical config updates preserve existing settings (parallel, repos, etc.)
- [x] Existing specs are never touched during any init operation
- [x] `cargo test` passes
- [x] `cargo clippy` passes