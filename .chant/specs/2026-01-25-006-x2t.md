---
type: code
status: completed
target_files:
- src/main.rs
- src/spec.rs
commits:
- 07866be
completed_at: 2026-01-25T10:05:22Z
model: haiku
---
# Organize archive with folder structure

## Problem

Currently all archived specs go into a flat `.chant/archive/` directory. As projects grow, this becomes unwieldy.

## Design Questions to Resolve

### 1. Is 1 folder per day enough?
Options:
- **Per day**: `.chant/archive/2026-01-25/` - Simple, matches spec ID prefix
- **Per month**: `.chant/archive/2026-01/` - Fewer folders, still organized
- **Per year**: `.chant/archive/2026/` - Minimal folders
- **Hybrid**: `.chant/archive/2026/01/25/` - Full hierarchy

Recommendation: Per day matches spec ID format (`2026-01-25-XXX`) and is granular enough without being excessive.

### 2. Should archive folder naming scheme be configurable?
Options:
- **Not configurable**: Simple, consistent across all projects
- **Configurable in .chant/config.toml**: Flexible but adds complexity

Recommendation: Start simple (not configurable), add config option later if requested.

### 3. What CLI commands need updating?

Commands that interact with archive:
- [ ] `chant archive` - Must create date folders when archiving
- [ ] `chant list` - May need to scan subfolders (if listing archived specs)
- [ ] `chant show` - Must find specs in date subfolders
- [ ] `chant work --force` - Must find archived specs to re-run

Internal functions:
- [ ] `load_all_specs()` / `load_archived_specs()` - Must recurse into subfolders
- [ ] `archive_spec()` - Must create date folder and move spec there

## Implementation

### Archive Structure
```
.chant/archive/
├── 2026-01-24/
│   ├── 2026-01-24-001-abc.md
│   ├── 2026-01-24-002-def.md
│   └── ...
├── 2026-01-25/
│   ├── 2026-01-25-001-xud.md
│   └── ...
```

### Migration
- Existing flat archive files should be migrated to date folders
- Add `chant archive --migrate` or auto-migrate on first run

## Acceptance Criteria

- [x] Archive creates date-based subfolders (YYYY-MM-DD)
- [x] `chant archive` creates folder if needed, moves spec to correct date folder
- [x] `chant list` (if showing archived) scans subfolders
- [x] `chant show` finds specs in archive subfolders
- [x] Existing flat archive files are migrated to date folders
- [x] All tests pass

## Agent Output

2026-01-25T10:05:22Z

```
I'll start by understanding the codebase and the task at hand. Let me create a todo list to track the implementation.
Let me start by exploring the codebase structure to understand how specs are currently managed.
Let me check the directory structure properly:
Now let me check the `.chant` directory and look at the main source files:
Good, I can see there's already an archive directory with many files. Let me check the source code related to spec management:
Now let me read the main source files to understand how specs are archived and loaded:
Let me search for the archive-related code more efficiently:
Let me search more broadly:
Let me check the spec.rs file more carefully to understand spec loading:
Let me continue reading the spec.rs to see the load functions:
Good! Let me read the `load_all_specs` function:
Let me check main.rs to see how archiving works:
Great! Now let me see the archive implementation:
Now let me look at the test files to understand how the archive works:
Let me check if there are any existing archive-related tests:
Now let me check what's currently in the archive directory:
Good! Now I understand the structure. Let me update my todos and plan the implementation:
Let me check all the relevant files in main.rs that interact with archiving and loading specs:
Now let me review the spec.rs file to see how we need to modify `load_all_specs` to also load from archive subfolders:
Now I have a clear understanding. Let me create a plan:

**Implementation Plan:**

1. **Modify `load_all_specs` in spec.rs** to handle both:
   - Direct specs in `.chant/specs/` directory
   - Archived specs in `.chant/archive/YYYY-MM-DD/` subdirectories

2. **Update `cmd_archive` in main.rs** to:
   - Create date-based subdirectories (YYYY-MM-DD) when archiving
   - Move specs to the correct date folder

3. **Add migration logic** in `cmd_archive` to:
   - Detect and migrate existing flat archive files to date subfolders
   - Run automatically when archiving (or on first run)

4. **Update `resolve_spec`** to search both flat and nested archive structures during the transition

5. **Write tests** to verify the new behavior

Let me mark the planning as complete and start implementing:
Now let me start implementing. First, I'll modify the `load_all_specs` function to handle archive subdirectories:
Now I'll modify `load_all_specs` to handle nested directories. Let me first check if there's a helper function or if I need to create one:
Good! Now let me update the `cmd_archive` function to create date-based subdirectories. Let me first check the exact location and structure more carefully:
Now I'll replace the archiving logic to create date-based folders. First, let me add a helper function to extract the date from a spec ID and then modify the archiving logic:
Now I need to add the `migrate_flat_archive` function. Let me add it before the `cmd_archive` function:
Now I'll add the migration function before `cmd_archive`:
Now let me update the todo list and build to see if there are any compilation errors:
Now let me build the project to check for compilation errors:
Good! Just one minor warning about an unused import. Let me fix that:
Now let me build again to verify:
Perfect! Now let me run the tests to ensure nothing broke:
Excellent! All tests pass. Now let me test the actual archiving functionality by creating a test that verifies the new folder structure:
Good! Now let me test the archive functionality manually. First, let me create a simple spec to test with:
Let me check the correct syntax:
Good! Now let me mark it as completed and test archiving:
Let me update the spec to mark it as completed:
Now let me test the archive command with dry-run to see what happens:
Great! Now let me actually archive it:
Perfect! Now let me verify the archive structure:
Excellent! The date-based folder was created correctly. Now let me verify that the old flat archive files are migrated by testing the migration logic. First, let me create a fake flat file in the archive root:
Now let me test if the migration works. I'll create another test spec and archive it:
Let me mark this one as completed:
Let me update it to completed:
Now let me test the migration by archiving this spec and checking if the flat file was migrated:
Now let me check if the flat file was migrated:
Perfect! Let me check if the flat test file was migrated to the 2026-01-24 folder:
Excellent! The migration worked. Now let me check the 2026-01-25 folder:
Perfect! Now let me verify that the `show` command can find archived specs in the subfolders:
Ah, I see. The `show` command needs to also search the archive. Let me check how `show` is implemented:
Let me check the implementation:
I see. The `show` command uses `resolve_spec` which only looks in the specs_dir. I need to also modify `resolve_spec` or create a new function to search both specs and archive. Let me check the `resolve_spec` implementation more closely:
Actually, wait. Let me reconsider. The spec resolution

... (output truncated, 12054 chars total)```
