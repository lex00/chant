---
type: code
status: in_progress
labels:
- bugfix
target_files:
- src/cmd/lifecycle.rs
---
# Fix split dependency validation - detect cycles and prefer Requires section over Dependencies line

## Problem

When splitting specs, the model outputs both `### Requires` sections (detailed cross-references) and `**Dependencies:**` lines (summary). These sometimes contradict each other:

1. `### Requires` says "Uses X from Member 1" but `**Dependencies:**` says "Member 2"
2. `**Dependencies:**` creates cycles (Member 4 depends on Member 5, but Member 5 depends on Member 4)
3. `**Dependencies:**` line sometimes references wrong member numbers

The parsing currently uses BOTH sources and adds them together, which can produce invalid DAGs.

## Observed Behavior

```
### Requires
- Uses `WatchConfig` from Member 1

**Dependencies:** Member 5    ‚Üê Wrong! Should be Member 1
```

Result: Member gets deps = [1, 5] which creates a potential cycle.

## Solution

1. **Prefer Requires over Dependencies** - The `### Requires` section has more detailed/accurate info
2. **Only use Dependencies as fallback** - If no Requires section exists, use Dependencies line
3. **Validate no cycles** - After parsing, check for cycles in dependency graph
4. **Warn on inconsistencies** - If Requires and Dependencies disagree, warn user

## Acceptance Criteria

- [x] Parse `### Requires` section first, use those dependencies
- [x] Only fall back to `**Dependencies:**` line if no Requires section found
- [x] Validate dependency graph has no cycles after parsing
- [x] If cycle detected, warn and remove the edge that creates it
- [x] Add unit test for cycle detection
- [x] Add unit test for Requires-preferred parsing

## Edge Cases

- Both Requires and Dependencies present: Use only Requires, ignore Dependencies line
- Neither present: No dependencies (empty array)
- Requires references non-existent member: Warn but include (will fail at runtime)
- Self-reference (Member 3 requires Member 3): Remove with warning

## Implementation Notes

The parsing flow should be:
1. When entering a new member, reset deps to empty
2. If `### Requires` found, parse it and set `collecting_requires = true`
3. Collect deps from Requires lines
4. When hitting `**Dependencies:**`, check if deps is already populated from Requires
   - If yes: Skip the Dependencies line (don't add to deps)
   - If no: Parse Dependencies line as before
5. After all members parsed, run cycle detection
6. Remove any cyclic edges with warning