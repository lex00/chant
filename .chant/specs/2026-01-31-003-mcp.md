---
type: code
status: completed
labels:
- bugfix
target_files:
- src/cmd/lifecycle.rs
commits:
- ae649bd
completed_at: 2026-01-31T14:00:14Z
model: sonnet
---
# Fix split dependency validation - detect cycles and prefer Requires section over Dependencies line

## Problem

When splitting specs, the model outputs both `### Requires` sections (detailed cross-references) and `**Dependencies:**` lines (summary). These sometimes contradict each other:

1. `### Requires` says "Uses X from Member 1" but `**Dependencies:**` says "Member 2"
2. `**Dependencies:**` creates cycles (Member 4 depends on Member 5, but Member 5 depends on Member 4)
3. `**Dependencies:**` line sometimes references wrong member numbers

The parsing currently uses BOTH sources and adds them together, which can produce invalid DAGs.

## Observed Behavior

```
### Requires
- Uses `WatchConfig` from Member 1

**Dependencies:** Member 5    ‚Üê Wrong! Should be Member 1
```

Result: Member gets deps = [1, 5] which creates a potential cycle.

## Solution

1. **Prefer Requires over Dependencies** - The `### Requires` section has more detailed/accurate info
2. **Only use Dependencies as fallback** - If no Requires section exists, use Dependencies line
3. **Validate no cycles** - After parsing, check for cycles in dependency graph
4. **Warn on inconsistencies** - If Requires and Dependencies disagree, warn user

## Acceptance Criteria

- [x] Parse `### Requires` section first, use those dependencies
- [x] Only fall back to `**Dependencies:**` line if no Requires section found
- [x] Validate dependency graph has no cycles after parsing
- [x] If cycle detected, warn and remove the edge that creates it
- [x] Add unit test for cycle detection
- [x] Add unit test for Requires-preferred parsing

## Edge Cases

- Both Requires and Dependencies present: Use only Requires, ignore Dependencies line
- Neither present: No dependencies (empty array)
- Requires references non-existent member: Warn but include (will fail at runtime)
- Self-reference (Member 3 requires Member 3): Remove with warning

## Implementation Notes

The parsing flow should be:
1. When entering a new member, reset deps to empty
2. If `### Requires` found, parse it and set `collecting_requires = true`
3. Collect deps from Requires lines
4. When hitting `**Dependencies:**`, check if deps is already populated from Requires
   - If yes: Skip the Dependencies line (don't add to deps)
   - If no: Parse Dependencies line as before
5. After all members parsed, run cycle detection
6. Remove any cyclic edges with warning

## Agent Output

2026-01-31T14:00:14Z

```
I'll implement the fix for split dependency validation. Let me start by creating a todo list and then reading the relevant code.
Let me find and read the split command code.
Let me search more broadly for the parsing logic.
Good, I found the parsing logic. Let me read more of the parsing function.
Now let me look at the `parse_dependencies_from_text` function to understand how dependencies are parsed.
Now I understand the current implementation. The issue is that BOTH the `### Requires` section and `**Dependencies:**` line call `parse_dependencies_from_text` and add to the same `deps` vector. This causes dependencies from both sources to be combined, which can create cycles and contradictions.

Let me mark the first task as complete and move to planning.
## Implementation Plan

Based on my analysis, here's the approach:

1. **Track whether Requires was parsed**: Add a flag `has_requires_deps` to track if we've collected dependencies from `### Requires` section
2. **Skip Dependencies line if Requires exists**: When parsing `**Dependencies:**`, check if we already have deps from Requires - if so, skip parsing the Dependencies line
3. **Add cycle detection**: After parsing all members, validate the dependency graph has no cycles using depth-first search
4. **Remove self-references**: Filter out any member that depends on itself
5. **Add comprehensive tests**: Test both the Requires-preferred logic and cycle detection

The key changes in `parse_member_specs_from_output`:
- Change the member state from `(String, String, Vec<String>, Vec<usize>)` to include a boolean flag for "has requires"
- When entering `### Requires` section, set the flag
- When parsing `**Dependencies:**`, check the flag and skip if true
- After all members are parsed, run cycle detection and self-reference removal
- Add validation warnings

Let me implement this now.
Let me read the full parse function to understand the complete flow.
Now I'll implement the changes. The key is to:
1. Track whether we've found dependencies from Requires section
2. Skip parsing the Dependencies line if Requires was already parsed
3. Add cycle detection
4. Add self-reference removal
Now I need to implement the `validate_and_clean_dependencies` function. Let me add it before the `parse_member_specs_from_output` function.
Now let me mark the implementation tasks as complete and move to adding unit tests.
Now let me find where the existing tests are located.
Let me read the test section to see existing test patterns.
Good! I can see there's already a test for the Requires section. Let me read more to understand the existing tests better.
Perfect! Now let me add tests for the new functionality. I'll add tests for:
1. Requires section preferred over Dependencies line
2. Cycle detection
3. Self-reference removal

Let me find the end of the test module to add the new tests.
Now I'll add the new tests before the closing brace of the test module.
Now let me run cargo fmt to format the code.
Now let me run cargo clippy to check for any lint errors.
Good, there are only two clippy warnings. Let me fix both of them.
The file was formatted by cargo fmt. Let me read it again.
Now I can fix the clippy warnings.
Now let me run clippy again to verify the warnings are fixed.
Perfect! No more warnings. Let me update the todo list and run the tests.
Let me check the full output to see if there were any test failures.
Let me check the end of the file to see if all tests passed.
Perfect! All tests passed. Let me update the todo list and then update the acceptance criteria in the spec file.
Now I'll check off all the acceptance criteria.
Now let me commit the changes.
Perfect! Git status is clean. Let me mark the final task as complete.
## Summary

I've successfully completed the spec to fix split dependency validation. Here's what was implemented:

### Changes Made

1. **Requires-Preferred Parsing** (src/cmd/lifecycle.rs:682-825)
   - Added `MemberInProgress` type alias to simplify complex tuple types
   - Modified `parse_member_specs_from_output` to track a `has_requires` flag for each member
   - When parsing `### Requires` section, set the flag to true
   - When parsing `**Dependencies:**` line, check the flag and skip if Requires was already parsed
   - Added warning message when Dependencies line is ignored

2. **Cycle Detection & Removal** (src/cmd/lifecycle.rs:841-929)
   - Implemented `validate_and_clean_dependencies` function
   - Removes self-references with warnings
   - Detects cycles using depth-first search with recursion stack tracking
   - Automatically breaks cycles by removing the edge that creates the cycle
   - Provides detailed warnings showing the cycle path

3. **Comprehensive Tests** (src/cmd/lifecycle.rs:3493-3622)
   - `test_requires_preferred_over_dependencies` - Verifies Requires takes precedence
   - `test_cycle_detection_and_removal` - Verifies cycles are detected and broken
   - `test_self_reference_removal` - Verifies self-references are removed
   -

... (output truncated, 5552 chars total)```
