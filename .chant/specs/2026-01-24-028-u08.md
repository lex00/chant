---
type: code
status: completed
model: claude-haiku-4-5-20251001
---
# Audit and fix all test failures - investigate root causes and resolve

## Summary

Fixed all test failures in the chant codebase through systematic investigation and targeted fixes:

### Issues Fixed:
1. **git::tests::test_merge_single_spec_successful_dry_run** - Fixed dry-run checkout behavior in merge_single_spec
2. **tests::test_re_finalize_is_idempotent** - Fixed git repo initialization in tests
3. **tests::test_re_finalize_preserves_pr_url** - Fixed git repo initialization in tests
4. **worktree::tests::test_merge_and_cleanup_successful_merge** - Fixed through merge_single_spec changes

### Root Causes:
1. **Dry-run branch checkout issue**: The merge_single_spec function was passing dry_run=true to checkout_branch when returning to the original branch, which caused it to skip the actual checkout operation. This resulted in tests expecting the current branch to be 'main' getting 'feature/new-feature' instead.

2. **Missing git repo initialization**: Tests were calling get_commits_for_spec which requires a git repository. The tests were using TempDir but not initializing them as git repos, causing git log commands to fail with "fatal: your current branch 'main' does not have any commits yet".

3. **Test isolation issues**: Integration and worktree tests were using hardcoded /tmp paths and changing the global current directory, causing parallel test execution conflicts.

### Changes Made:

**src/git.rs:**
- Line 322: Changed `checkout_branch(&original_branch, dry_run)` to `checkout_branch(&original_branch, false)` to ensure we always return to the original branch even during dry-runs.

**src/main.rs:**
- Updated test_re_finalize_is_idempotent and test_re_finalize_preserves_pr_url to properly initialize git repositories with initial commits before running tests.
- Added #[serial_test::serial] attribute to all re-finalize tests to prevent parallel execution conflicts.

**src/merge.rs:**
- Added #[serial_test::serial] attribute to merge_driver_spec tests that call git functions.

**src/worktree.rs:**
- Added #[serial_test::serial] attribute to worktree tests using hardcoded /tmp paths.

**tests/integration_tests.rs:**
- Added #[serial_test::serial] attribute to all integration tests to prevent parallel execution conflicts.

### Test Results:
- All 213 unit tests pass
- All 10 integration tests pass
- Total: 223 tests passing, 0 failures