---
type: code
status: completed
target_files:
- src/config.rs
commits:
- 0c6c0dc
completed_at: 2026-01-27T19:01:20Z
model: haiku
---
# Add enterprise config schema and parsing

## Problem

The enterprise derived frontmatter feature requires configuration schema to define:
- Field derivation rules (which fields to derive, from what source, using what pattern)
- Validation rules (enum checking, required fields)
- This configuration must integrate with existing Config system

Currently, the `Config` struct in `src/config.rs` has no enterprise-specific fields.

## Solution

Extend the configuration system to support enterprise features with these structures:

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct EnterpriseConfig {
    #[serde(default)]
    pub derived: HashMap<String, DerivedFieldConfig>,
    #[serde(default)]
    pub required: Vec<String>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DerivedFieldConfig {
    pub from: DerivationSource,
    pub pattern: String,
    #[serde(default)]
    pub validate: Option<ValidationRule>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(rename_all = "snake_case")]
pub enum DerivationSource {
    Branch,
    Path,
    Env,
    GitUser,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(rename_all = "snake_case")]
pub enum ValidationRule {
    Enum { values: Vec<String> },
}
```

Add `enterprise` field to main `Config` struct and ensure it defaults to empty (no-op).

## Acceptance Criteria

- [x] Add `EnterpriseConfig` struct with `derived` and `required` fields
- [x] Add `DerivedFieldConfig` struct with `from`, `pattern`, `validate` fields
- [x] Add `DerivationSource` enum (Branch, Path, Env, GitUser)
- [x] Add `ValidationRule` enum with Enum variant
- [x] Add `enterprise` field to main `Config` struct with proper defaults
- [x] Config parsing handles missing enterprise section (defaults to empty)
- [x] Add unit tests for parsing enterprise config from YAML
- [x] Add unit tests that config works when enterprise section is omitted
- [x] All existing tests still pass

## Agent Output

2026-01-27T19:01:20Z

```
I'll start by creating a todo list to track the implementation of this spec.
Let me read the existing config.rs file:
Good! Now let me mark the first todo as completed and move on to planning:
Now I'll plan my approach before implementing. Based on my read of config.rs, I can see:

1. **Existing Pattern**: The codebase uses:
   - Structs with `#[derive(Debug, Deserialize)]` for configuration
   - `#[serde(default)]` for optional fields with defaults
   - Private helper functions for default values (e.g., `default_prompt()`)
   - Proper documentation comments

2. **What I need to add**:
   - `EnterpriseConfig` struct with `derived` and `required` fields
   - `DerivedFieldConfig` struct with `from`, `pattern`, and optional `validate` fields
   - `DerivationSource` enum (Branch, Path, Env, GitUser)
   - `ValidationRule` enum with Enum variant
   - Add `enterprise` field to main `Config` struct with `#[serde(default)]`
   - Update `PartialConfig` to support enterprise config for merging
   - Add unit tests for parsing with and without enterprise section

3. **Implementation details**:
   - Use `HashMap<String, DerivedFieldConfig>` for derived fields
   - Use `Vec<String>` for required fields
   - Apply `#[serde(rename_all = "snake_case")]` to enums for YAML compatibility
   - Ensure all fields have proper defaults using `#[serde(default)]`

Let me mark planning as complete and start implementing:
Now I'll add the enterprise configuration structs. First, I need to add the imports and then the struct definitions:
Now I'll add the enterprise configuration structs before the Config struct definition:
Good! Now I need to update the `PartialConfig` struct to support enterprise configuration for the merging feature:
Now I need to update the `merge_with` method in `PartialConfig` to handle the enterprise configuration:
Now let me mark this todo as complete and move on to writing tests:
Now I'll add the unit tests for enterprise config parsing. I'll add these before the closing brace of the tests module:
Now let me run cargo fmt to format the code:
Now let me run cargo fmt and clippy:
Good! Now let me run clippy:
I need to fix the missing `enterprise` field in the Config initializers. Let me find and fix those:
I'll fix this by adding the enterprise field:
Now let me check the prompt.rs file:
Let me fix this file:
Now let me check the cmd/work.rs file:
Let me fix this one:
Now let me run clippy again:
Good! The compilation errors are fixed. The remaining warnings are pre-existing and not related to my changes. Let me mark this todo as complete and run the tests:
Now let me run the test suite:
I see the issue. The YAML deserialization is failing because I need to handle the enum serialization/deserialization differently. The issue is that when I use `#[serde(rename_all = "snake_case")]` on an enum with nested struct variants, serde expects a tag. I need to use `#[serde(tag = "type")]` or restructure the validation rules. Let me fix this:
Actually, looking at the test YAML, it looks like the structure expects a flattened format. Let me look at what serde is expecting. The error says it's expecting a YAML tag. I think I need to use a different approach - let me check the actual structure more carefully and restructure the test YAML:
I see. The test YAML structure expects `validate: enum: [values]`. Let me reconsider the enum definition. Actually, let me use internally-tagged approach which is cleaner:
Hmm, but the issue is that serde doesn't know what variant to use when deserializing a map. Let me try a different approach - using `#[serde(untagged)]`:
Wait, that won't work either. Looking at the YAML structure more carefully, the issue is that `validate: enum: [list]` means validate is a map where enum is a key. Let me use a better structure. Actually, I think the real issue is that my field name in the struct doesn't match what's expected. Let me try using `#[serde(rename)]`:
Now the issue is that when serde tries to deserialize the YAML structure `{enum: [list]}`, it needs to know this is a newtype variant. Actually, looking at the error more carefully, I think the problem is that serde expects a tagged enum and doesn't know how to deserialize a map into the enum variant. Let me try using `#[serde(tag = "")]` or better yet, restructure how validate is defined. Let me use an internally tagged enum:
Now let me also update the test to match this new structure:
Now let me run the tests again to see if this fixes the issue:
The issue is that serde still doesn't know how to deserialize the map structure. Let me check what the actual YAML structure looks like - maybe I should change how the tests define the validation rules. Actually, I think the problem is that when we have `validate: enum: [list]`, serde sees `validate` as a map with key `enum`. Let me look at whether using `#[serde(flatten)]` would help, or whether I should just change the test structure. Let me try a simpler approach with a direct struct:
Actually, that wo

... (output truncated, 8255 chars total)```
