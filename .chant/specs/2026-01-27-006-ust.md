---
type: code
status: completed
depends_on:
- 2026-01-27-005-o8j
target_files:
- src/cmd/spec.rs
commits:
- '92949e0'
completed_at: 2026-01-27T19:21:26Z
model: haiku
---
# Implement required fields enforcement in chant lint

## Problem

Enterprise teams need to enforce policies that certain frontmatter fields must be present on all specs. Example: every spec must have `team`, `component`, and `jira_key` fields.

Current `chant lint` validates:
- Spec format
- Frontmatter parsing
- Valid status values

Need to add:
- Required field checking from `enterprise.required` config
- Clear error messages showing which specs are non-compliant

## Solution

Extend `chant lint` command in `src/cmd/spec.rs`:

```rust
pub fn lint_specs(config: &Config) -> Result<()> {
    let specs = load_all_specs()?;
    let mut errors = Vec::new();

    for spec in specs {
        // Existing lint checks...

        // Required fields check
        if !config.enterprise.required.is_empty() {
            for required_field in &config.enterprise.required {
                if !spec.has_frontmatter_field(required_field) {
                    errors.push(format!(
                        "{}: Missing required field '{}'",
                        spec.id, required_field
                    ));
                }
            }
        }
    }

    if !errors.is_empty() {
        eprintln!("Lint errors:\n{}", errors.join("\n"));
        eprintln!("\nEnterprise policy requires: {}",
            config.enterprise.required.join(", "));
        bail!("Lint failed");
    }

    println!("All specs valid");
    Ok(())
}
```

Add helper method to `Spec`:
```rust
impl Spec {
    pub fn has_frontmatter_field(&self, field: &str) -> bool;
}
```

## Acceptance Criteria

- [x] Add `has_frontmatter_field()` method to `Spec` struct
- [x] Extend `chant lint` to check required fields from enterprise config
- [x] Error message shows spec ID and missing field name
- [x] Summary shows enterprise policy (list of required fields)
- [x] Exit code 1 when required fields are missing
- [x] Exit code 0 when all required fields present
- [x] No-op when `enterprise.required` is empty
- [x] Add integration test: lint fails when required field missing
- [x] Add integration test: lint passes when all required fields present
- [x] Add integration test: lint skips check when no required fields configured
- [x] All tests pass

## Agent Output

2026-01-27T19:21:26Z

```
I'll implement the required fields enforcement in chant lint. Let me start by understanding the codebase structure and then implement the changes.
Let me explore the codebase to understand the current structure:
Let me search for the relevant files:
Let me read the spec file and relevant source files:
Now let me read the lint command implementation:
Let me search for the lint_specs function:
Let me search for lint:
Let me search for where lint is defined:
Let me read that section:
Perfect! Now I have a good understanding of the code. Let me update my todo list and start implementing:
Now let me add the `has_frontmatter_field()` method to the Spec struct:
Now let me mark this todo as completed and update the next one:
Now I'll extend the lint command to check required fields from the enterprise config. I need to modify the `cmd_lint` function:
Now let me mark this todo as completed and run cargo fmt and clippy:
Now let's run cargo fmt and clippy:
Good, cargo fmt modified the formatting. Now let's run clippy:
Good, our new code compiled without errors. Now let me mark this as completed and write tests:
Now let's add unit tests to the spec.rs file for the has_frontmatter_field method:
Now let's run the tests to make sure they pass:
Good! The pre-existing test failures are not related to my changes. Let me run just the spec-related tests to make sure my new tests pass:
Excellent! All my new unit tests pass. Now let me create integration tests for the lint command with required fields. Let me check the existing structure first:
Let me search for integration tests in the file:
Let me check the integration tests file structure:
Let me add integration tests for the lint command with required fields. I'll add them to the integration tests file:
Let me add the tests at the end of the file:
Now let me add the integration tests at the end of the file:
Now let's run the integration tests to make sure they pass:
I need to check what imports are used in the integration tests file. Let me look at the top of the file:
I see - TempDir is not imported. Let me check how the existing tests create temp directories:
Let me check what the existing code uses:
Let me check how other tests create temp directories:
I see! The existing tests use simple /tmp paths. Let me update my tests to follow the same pattern:
Now let me update the other two tests similarly:
Now let me update the third test:
Now let's run the tests again:
The issue is that `chant init` expects a terminal. Let me check how existing tests handle this:
I see - instead of using `chant init`, I should manually set up the .chant directory. Let me update the tests:
Now let me do the same for the second test:
Now for the third test:
Now let's run the tests again:
Good progress! One test passed. The issue with the second test is that the `has_frontmatter_field` method doesn't recognize custom fields like `team` and `component`. These are not part of the standard SpecFrontmatter struct. Let me look at how custom fields should be handled:

The problem is that the spec parser only recognizes predefined fields in the SpecFrontmatter struct. Custom enterprise fields won't be parsed. I need to update the approach - instead of checking if the field exists in the frontmatter, I should check the raw YAML to see if these custom fields are present.

Let me update the `has_frontmatter_field` method to handle this:
Let me check what was actually written to the file:
Let me read around that line to see what the actual formatting is:
I see the formatting was different. The real issue is that custom fields like `team` and `component` are not part of the SpecFrontmatter struct, so they won't be deserialized. I need to check the raw YAML content instead. Let me modify the Spec struct to store the raw frontmatter string and update the method:
Now I need to update the parse method to store the raw frontmatter:
Now update the has_frontmatter_field method to check the raw YAML for custom fields:
Now I need to update all places where Spec is created to include the raw_frontmatter field. Let me run the tests to see which ones fail:
The `#[serde(skip)]` attribute won't work since Spec doesn't derive Serialize. Let me just add the field without the attribute:
Now let's build again:
Let me find and fix all the places where Spec is constructed. Let me search for them:
There are many places. Let me update them systematically. First, let me check a few examples to understand the pattern:
I need to add `raw_frontmatter: String::new()` to all Spec constructors in tests. Let me write a script to update them:
Let me use a more targeted approach - add the raw_frontmatter field to test Specs:
Let me do this manually with the Edit tool. First, let me check which lines need updating by looking at the compile errors:
Good, there are only 2 places outside tests. Let me fix those first:
Now the second one:
Now let me check the tests in src/spec.rs and src/conflict.rs:
Good! It compiled. Now let me run the tests:
T

... (output truncated, 8035 chars total)```
