---
type: code
status: pending
depends_on:
- 2026-01-25-010-sgp.5
target_files:
- src/cmd/work.rs
---
# Refactor Parallel Execution

Refactor `cmd_work_parallel()` and `ParallelResult` struct to use the newly extracted modules and ensure it remains under 600 lines.

### Acceptance Criteria

- [ ] `cmd_work_parallel()` function refactored to use extracted modules:
  - Uses `commit::get_commits_for_spec()` for commit tracking
  - Uses `finalize::finalize_spec()` for finalization
  - Uses `git_ops::{create_or_switch_branch, push_branch}()` for branch/PR operations
  - Uses `model::get_model_name_with_default()` for model retrieval (no full config in threads)
- [ ] `ParallelResult` struct remains unchanged (used for thread communication)
- [ ] Parallel execution flow preserved:
  - Load and filter ready specs
  - Filter by labels if specified
  - Create thread pool for parallel execution
  - Each thread resolves spec, executes agent, finalizes
  - Collect results and report summary
- [ ] Worktree creation and cleanup still works
  - Worktrees created in isolated directories
  - Branch operations (create/switch) use extracted functions
  - PR creation flow maintained
- [ ] Error handling in parallel threads preserved
- [ ] Summary reporting at end (X succeeded, Y failed)
- [ ] `cmd_work_parallel()` is under 600 lines
- [ ] All imports are correct from extracted modules
- [ ] No circular dependencies between modules
- [ ] `just check` passes
- [ ] No clippy warnings

### Edge Cases

- Multiple threads may race on git operations - must use proper locking/isolation (worktrees should isolate)
- Thread panic must be caught and reported, not crash entire execution
- Finalization failures in one spec must not block other specs
- PR creation may fail - should report error but continue with other specs
- Label filtering may result in empty spec list - should handle gracefully
- Branch prefix conflicts between parallel specs must be handled
- Commit message generation must include spec ID for proper tracking

### Example Test Cases

For this refactoring, verify:
- Parallel execution of multiple ready specs works
- Label filtering reduces spec list correctly
- Worktree isolation prevents git conflicts
- Failed spec in one thread doesn't block others
- Final summary shows correct counts
- Branch/PR operations use extracted git_ops functions
- No stale worktrees left after completion