---
type: code
status: pending
depends_on:
- 2026-01-25-010-sgp.4
target_files:
- src/cmd/work.rs
---
# Refactor Single Spec Execution

Refactor `cmd_work()` function to use the newly extracted modules and ensure it remains under 300 lines.

### Acceptance Criteria

- [ ] `cmd_work()` function refactored to call extracted modules:
  - Uses `commit::get_commits_for_spec()` for commit tracking
  - Uses `finalize::finalize_spec()` for finalization
  - Uses `finalize::re_finalize_spec()` for re-finalization
  - Uses `git_ops::{create_or_switch_branch, push_branch}()` for branch operations
  - Uses `model::get_model_name()` for model retrieval
- [ ] Flow remains intact:
  - Check for silent mode conflicts with PR/branch flags
  - Resolve spec by ID
  - Handle re-finalization mode if --finalize flag set
  - Execute agent if spec is ready
  - Append agent output to spec
  - Finalize spec on success
  - Handle errors and report to user
- [ ] Silent mode warning still shown for branches in silent mode
- [ ] Error handling and user feedback preserved
- [ ] `cmd_work()` function is under 300 lines
- [ ] All imports are correct from extracted modules
- [ ] `just check` passes
- [ ] No clippy warnings in refactored code

### Edge Cases

- Silent mode conflicts: --pr with silent mode must still error
- Branch warning in silent mode should be shown but not block execution
- Spec resolution with invalid ID must return proper error
- Agent invocation on blocked spec must be skipped
- Output appending must handle concurrent modifications (though single-threaded in this code)
- Finalization must not occur if spec not ready or agent failed

### Example Test Cases

For this refactoring, verify:
- `cmd_work` with --pr in silent mode returns error
- `cmd_work` with --branch in silent mode shows warning but continues
- `cmd_work` with valid ID executes agent and finalizes
- `cmd_work` with --finalize on completed spec re-finalizes
- `cmd_work` with --finalize on pending spec fails
- Error from finalization properly propagates to user