---
type: code
status: in_progress
depends_on:
- 2026-01-24-01y-73b.1
target_files:
- src/config.rs
- src/main.rs
- tests/
model: claude-haiku-4-5-20251001
---
# Add merge configuration and status validation

Implement the configuration loading and spec status verification logic.

### Acceptance Criteria

- [x] Add `defaults.main_branch` to Config struct in src/config.rs (string, defaults to "main")
- [x] Implement function to load main_branch from config with fallback to "main"
- [x] Implement `get_specs_to_merge(args, all_specs)` that:
  - Returns list of (spec_id, Spec) tuples based on arguments
  - If `--all` flag: collect all specs with `status == Completed` that have branches
  - If specific IDs: resolve each ID and collect matching specs
  - Validates all targeted specs exist (error if not found)
- [x] Implement validation function `validate_spec_can_merge(spec, branch_exists)` that:
  - Checks `spec.status == Completed` (error if not)
  - Checks branch exists for this spec
  - Returns error with helpful message if validation fails
- [x] For driver specs, implement `collect_member_specs(driver_spec, all_specs)` that:
  - Returns all member specs in order (by sequence number)
  - Used later for batch merge of groups
- [x] Add unit tests for status validation and member collection
- [x] Code compiles and existing tests still pass

### Edge Cases

- Edge case 1: Spec with `in_progress` status attempted → Error: "Spec must be completed before merging"
- Edge case 2: Spec with `failed` status attempted → Error: "Cannot merge failed spec"
- Edge case 3: Spec ID not found → Error: "Spec not found: {id}"
- Edge case 4: Driver spec where only some members completed → Error listing incomplete members
- Edge case 5: `--all` used but no completed specs exist → Show informative message

### Example Test Cases

For this feature, verify:
- Case 1: Load main_branch from config defaults to "main"
- Case 2: Validate completed spec passes validation
- Case 3: Validate pending spec fails with appropriate error
- Case 4: Get all completed specs with `--all` returns correct list
- Case 5: Collect members of driver spec returns them in correct order