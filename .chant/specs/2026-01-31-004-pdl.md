---
type: code
status: completed
target_files:
- src/cmd/lifecycle.rs
- src/cmd/list.rs
- src/cmd/finalize.rs
commits:
- 685f950
completed_at: 2026-01-31T14:47:29Z
model: sonnet
---
# Group spec lifecycle improvements

Three targeted changes to improve group spec handling throughout their lifecycle.

## Problem

After `chant split`, group specs appear in `chant_ready` alongside their members, which is confusing. The parent group should:
1. Be blocked until all members complete
2. Not appear as actionable work (it's a container)
3. Auto-complete when all members are finalized

## Changes

### 1. Split: Add depends_on to parent

When splitting a spec into members, add `depends_on` to the parent listing all member IDs.

```yaml
# After split, parent becomes:
type: group
status: pending
depends_on:
  - 2026-01-30-00h-f77.1
  - 2026-01-30-00h-f77.2
  # ... all members
```

This ensures the parent is explicitly blocked until all members complete.

**Location**: `src/cmd/lifecycle.rs` in `execute_split`

### 2. Ready: Filter out group specs

`chant_ready` should exclude `type: group` specs from results. Groups are containers, not actionable work items.

**Location**: `src/cmd/list.rs` in ready query logic

### 3. Finalize: Auto-complete parent groups

When finalizing a member spec, check if it's the last pending/in_progress member of a group. If so, auto-complete the parent group.

Logic:
1. After finalizing member X, find parent group (if any)
2. Query all members of that group
3. If all members are now `completed`, mark parent as `completed`

**Location**: `src/cmd/finalize.rs` or `src/cmd/lifecycle.rs`

## Acceptance Criteria

- [x] `chant split` adds `depends_on` to parent with all member IDs
- [x] `chant_ready` (MCP tool) excludes `type: group` specs
- [x] `chant finalize` auto-completes parent group when last member finalized
- [x] Parallel work on members unaffected (members still appear in ready)
- [x] Manual `chant finalize <group-id>` still works if needed

## Edge Cases

- Split with single member: Parent depends on that one member
- Nested groups: Each level auto-completes when its direct children complete
- Member cancelled: Treat as "not blocking" parent completion
- Member failed: Parent should NOT auto-complete (needs attention)

## Agent Output

2026-01-31T14:47:29Z

```
I'll implement the three targeted changes to improve group spec lifecycle handling. Let me start by creating a todo list and then examining the relevant code.
Now let me read the relevant files to understand the current implementation:
The lifecycle.rs file is too large. Let me search for the specific functions I need to modify:
Let me search more broadly for split-related code:
Let me look at the cmd directory structure to understand the organization:
Let me look at the spec subdirectory:
Now let me search for where split is called and where ready functionality exists:
Let me read the spec/list.rs file which likely contains the ready functionality:
Now let me look for where the split functionality is in lifecycle.rs. Let me read it in sections:
Let me read the finalize.rs file:
Now let me update my todo status and start implementing the changes:
Now let me look at the section where the parent spec is updated to type: group in lifecycle.rs to understand the complete context:
Perfect! Now I can see where to make Change 1. Let me implement it by adding the `depends_on` field to the parent spec after splitting:
Let me read that section again:
Great! It looks like Change 1 has already been implemented. Let me verify this is the correct implementation and move on to Change 2. Let me update the todo list:
Now let me implement Change 2: Filter group specs from the ready query. Looking at the list.rs file, I need to find where the ready filtering happens. Let me review the relevant section:
Excellent! Change 2 has also already been implemented. I can see at line 402 that group specs are filtered out when `ready_only` is true. Let me move on to Change 3: Auto-complete parent groups on finalize. Let me update the todo list:
Now let me implement Change 3. I need to add logic to the `finalize_spec` function to check if a spec is a member of a group, and if it's the last member to complete, auto-complete the parent. Let me first search for how to identify if a spec is a member:
Let me check the spec_group.rs file to understand how to identify the parent and check member status:
Perfect! I can see there's already a function `auto_complete_driver_if_ready` in spec_group.rs. Let me read that function:
I see there's already an `auto_complete_driver_if_ready` function, but according to the spec requirements and looking at line 283, it only auto-completes if the driver is in `InProgress` status. However, based on the spec's requirement, we need to also handle when the driver is in `Pending` status (which it will be after a split with the `depends_on` field set). Let me check what the status should be:

Looking at the spec again:
- After split, the parent is `type: group` with `status: pending` and `depends_on` listing all members
- The spec says "Auto-complete when last member finalized" 

But the current `auto_complete_driver_if_ready` only works when driver is `InProgress`. This seems like it needs updating. However, let me check if the driver should be marked as in_progress when the first member starts. Let me search for this:
Good! So when a member starts work, `mark_driver_in_progress` is called which sets the driver to `InProgress`. This means the existing `auto_complete_driver_if_ready` function should work fine - it checks if driver is `InProgress` and all members are `Completed`, then auto-completes the driver.

Now I need to check if `finalize_spec` calls this function. Looking back at finalize.rs, I didn't see it. Let me search for where it should be called:
So `auto_complete_driver_if_ready` is not called in finalize.rs. Let me check where it is called in the work.rs file to understand the pattern, then add it to finalize.rs. Looking at my earlier grep results, I saw it was called in work.rs. However, according to the spec requirements for Change 3, I need to add this to the finalize logic.

Let me add the call to `auto_complete_driver_if_ready` at the end of the `finalize_spec` function, after checking for dependent specs:
Great! I can see that Change 3 has also already been implemented at lines 181-183. Let me check if the helper functions exist:
Perfect! All three changes have already been implemented. Let me verify this by reading a bit more of the auto_complete_parent_group function:
Excellent! All three changes have been implemented, and the implementation even handles nested groups (line 507-509). Now let me update my todo list and proceed with testing:
Now let me run cargo fmt:
Now let me run cargo clippy:
There's a clippy warning about the `config` parameter only being used in recursion. Let me fix this by removing the unused parameter:
I can see the config parameter is not being used except in the recursive call. Let me remove it from the function signature and update all call sites:
Now let me find the other call site where config is passed:
Now let me run cargo clippy again:
Great! Now let me update the todo list and run tests:
Great! All tests passed. Let me update my todo list and verify the acceptan

... (output truncated, 10163 chars total)```
