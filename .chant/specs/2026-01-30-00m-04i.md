---
type: code
status: completed
depends_on:
- 2026-01-30-00k-di7
- 2026-01-30-00l-4d2
labels:
- refactor
- architecture
target_files:
- src/cmd/spec.rs
- src/cmd/spec/mod.rs
- src/cmd/spec/add.rs
- src/cmd/spec/list.rs
- src/cmd/spec/show.rs
- src/cmd/spec/lint.rs
- src/cmd/spec/approve.rs
- src/cmd/spec/delete.rs
- src/cmd/mod.rs
commits:
- 64a9569
completed_at: 2026-01-30T15:10:21Z
model: opus
---
# Split cmd/spec.rs into focused submodules

## Problem

`src/cmd/spec.rs` is 7,046 lines with mixed responsibilities:
- Spec creation (add)
- Listing and filtering
- Display and rendering (show)
- Validation and linting
- Approval workflow
- Export functionality
- Delete and ready commands

This makes the file hard to navigate and maintain.

## Solution

Split into focused submodules under `src/cmd/spec/`:

```
src/cmd/spec/
├── mod.rs          # Re-exports, shared helpers (~200 lines)
├── add.rs          # cmd_add, create_spec (~800 lines)
├── list.rs         # cmd_list, filtering logic (~1,500 lines)
├── show.rs         # cmd_show, rendering (~500 lines)
├── lint.rs         # cmd_lint, validation (~600 lines)
├── approve.rs      # cmd_approve, cmd_reject (~400 lines)
└── delete.rs       # cmd_delete, cmd_ready (~300 lines)
```

## Acceptance Criteria

- [x] Create `src/cmd/spec/` directory structure
- [x] Extract `cmd_add` and spec creation logic to `add.rs`
- [x] Extract `cmd_list` and filtering to `list.rs`
- [x] Extract `cmd_show` and display logic to `show.rs`
- [x] Extract `cmd_lint` and validation to `lint.rs`
- [x] Extract approval commands to `approve.rs`
- [x] Extract delete/ready commands to `delete.rs`
- [x] Create `mod.rs` with re-exports maintaining public API
- [x] Update `src/cmd/mod.rs` imports
- [x] All existing tests pass without modification
- [x] `cargo clippy` passes
- [x] Each submodule under 1,500 lines

## Agent Output

2026-01-30T15:08:18Z

```
I'll implement this spec to split `cmd/spec.rs` into focused submodules. Let me start by reading the current file to understand its structure.
The file is too large to read in one go. Let me read it in sections and also read the cmd/mod.rs file.
Let me continue reading the spec.rs file to understand the full structure.
Let me continue reading the rest of the spec.rs file to understand the full structure.
Let me continue reading the rest of the file to see all functions.
The file has 6,986 lines. Let me read the remaining sections and understand the structure better.
Now I have a clear picture. Let me also check what helper functions are defined and which ones need to be shared (in mod.rs) or moved to specific modules.
Now I understand the structure. Let me plan the split:

**mod.rs (~200 lines)** - Re-exports and shared helpers:
- `load_specs_from_repos`
- `is_silent_mode`
- `key_to_title_case`
- `format_yaml_value`

**add.rs (~200 lines)** - `cmd_add` and related helpers

**list.rs (~800 lines)** - `cmd_list`, `cmd_status`, and related helpers:
- `batch_load_spec_git_metadata`, `SpecGitMetadata`
- `format_relative_time`, `parse_duration`
- `count_approval_comments`, `mentions_person`
- Multi-repo support helpers

**show.rs (~200 lines)** - `cmd_show`

**lint.rs (~500 lines)** - Validation functions and `cmd_lint`, `lint_specific_specs`:
- All `validate_*` functions
- `COMPLEXITY_*` and `SIMPLE_*` constants
- `SPEC_ID_PATTERN`
- `remove_code_blocks`

**approve.rs (~600 lines)** - `cmd_approve`, `cmd_reject`, and related helpers:
- Approval validation helpers
- `get_git_committers`, `validate_committer`
- `append_to_approval_discussion`
- `handle_rejection_dependency`, `handle_rejection_group`
- `extract_acceptance_criteria`

**delete.rs (~300 lines)** - `cmd_delete`, `cmd_cancel`, `cmd_export` (wrapper)

Now let me create these files. I'll start with creating the directory and each submodule.
Now let me read the remaining parts of the spec.rs file that contains tests, so I can understand what tests need to stay together.
The tests are quite extensive. Now let me understand the overall structure better and create the split. I'll read the remaining test portion and then start creating the files.
Now I have a complete picture. Let me now create the split:

1. **lint.rs** - All validation functions + `cmd_lint` + `lint_specific_specs` + `LintResult`
2. **add.rs** - `cmd_add` 
3. **list.rs** - `cmd_list`, `cmd_status`, and all list-related helpers
4. **show.rs** - `cmd_show`, display helpers (`format_yaml_value`, `key_to_title_case`)
5. **approve.rs** - Approval-related commands and helpers
6. **delete.rs** - `cmd_delete`, `cmd_cancel`, `cmd_export` (wrapper)
7. **mod.rs** - Re-exports and shared functions

Let me start creating these files one by one.
Now let me create the mod.rs file that re-exports everything and keeps the tests in one place.
Let me see the rest of the test code.
The tests are quite extensive. Let me now create the mod.rs file that re-exports the submodules and includes the tests. Since the tests reference internal functions from the submodules, I'll need to handle that carefully.
Now let me update the cmd/mod.rs to change `pub mod spec;` from a single file to a directory module.
Now let's remove the old spec.rs file and check if the build works.
The build succeeds with only some unused import warnings. Let me fix those warnings.
The warnings are because the validation functions and helpers are only used in tests. Let me fix the imports to put them in the test-only section.
Let me check if the validation functions and LintResult are used elsewhere in the codebase.
Good, `lint_specific_specs` and `LintResult` are used elsewhere. Now let me check the validation functions.
The validation functions are only used internally within the lint module, so they don't need to be re-exported at the top level. Let me also check if they're used in tests.
The `validate_spec_type` is used in the tests. Let me fix the imports.
Let me check who uses LintResult.
It looks like the result is assigned but might not be used as a named `LintResult` type. Let me check.
LintResult is only used internally in lint.rs. Let me update the mod.rs to not export it.
Now let me run clippy.
Now let me run the tests.
Excellent! All tests pass. Now let me verify each submodule is under 1,500 lines.
All submodules are well under 1,500 lines:
- `add.rs`: 104 lines
- `show.rs`: 208 lines
- `delete.rs`: 379 lines
- `approve.rs`: 603 lines
- `lint.rs`: 624 lines
- `list.rs`: 747 lines
- `mod.rs`: 1,016 lines (includes tests)

Now let me format the code and verify clippy.
The code compiles and clippy passes. Now let me update the spec file to check off the acceptance criteria and then commit.
I'll continue with the final task - committing the changes. Let me first check the current git status and then commit.
Now I'll stage all the changes and commit them:
The refactoring is complete. The commit `64a9569` successfully split `src/cmd/spe

... (output truncated, 5791 chars total)```