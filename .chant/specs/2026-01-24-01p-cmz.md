---
type: code
status: in_progress
target_files:
- src/main.rs
model: claude-haiku-4-5-20251001
---
# Fix subtask parser to preserve section headers from split output

## Problem

When `chant split` runs, the split prompt tells the model to output subtasks with this structure:

```markdown
## Subtask N: <title>

<description>

### Acceptance Criteria

- [ ] Specific criterion 1
- [ ] Specific criterion 2

### Edge Cases

- Edge case 1: ...
- Edge case 2: ...

### Example Test Cases

- Case 1: Input X should produce Y
- Case 2: ...

**Affected Files:**
- file1.rs
```

But `parse_subtasks_from_agent_output()` treats everything between `## Subtask` headers as a flat "description" string, stripping the `###` structure.

Then when creating the subtask spec file, it appends a generic:

```markdown
## Acceptance Criteria

- [ ] Implement as described
- [ ] All tests pass
```

This loses all the detailed acceptance criteria, edge cases, and test cases that the splitter model generated.

## Solution

1. Preserve the `###` headers in the description field
2. Don't append generic acceptance criteria if the description already contains `### Acceptance Criteria`
3. The subtask body should use the structured content directly

## Current Code

`parse_subtasks_from_agent_output()` at ~line 1794 collects lines into a description string but doesn't preserve markdown structure.

The subtask spec creation at ~line 1755 formats:
```rust
let body = format!(
    "# {}\n\n{}\n\n## Acceptance Criteria\n\n- [ ] Implement as described\n- [ ] All tests pass",
    subtask.title,
    subtask.description
);
```

## Acceptance Criteria

- [x] Parser preserves `###` headers (Acceptance Criteria, Edge Cases, Example Test Cases) in description
- [x] Subtask spec creation detects if description already has `### Acceptance Criteria`
- [x] If description has criteria, don't append generic "Implement as described" section
- [x] If description lacks criteria, still append the generic section (backward compat)
- [x] Generated subtask files have proper markdown structure with ### headers
- [x] Test: split output with ### headers produces subtask with those headers preserved
- [x] Chant binary builds successfully
- [x] All tests pass