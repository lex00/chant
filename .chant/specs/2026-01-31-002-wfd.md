---
type: code
status: in_progress
labels:
- bugfix
target_files:
- src/cmd/lifecycle.rs
---
# Fix split dependency parsing - extract member references from Requires section to build DAG

## Problem

The split command generates a dependency analysis phase with correct DAG structure, and member specs include "### Requires" sections with member references like "Uses `WatchConfig` from Member 1". However, the parsing code in `src/cmd/lifecycle.rs` **skips** the Requires section (lines 772-773) instead of parsing it to extract dependencies.

Result: All member specs get linear dependencies (1→2→3→...→N) instead of the correct DAG.

## Current Behavior

Model outputs:
```markdown
### Requires
- Uses `WatchConfig` from Member 1 for retry settings
```

Code at line 772-773:
```rust
if line.contains("### Provides") || line.contains("### Requires") {
    // Skip this section
    continue;
}
```

The code only looks for explicit `**Dependencies:** Member 1, Member 3` lines.

## Solution

Parse the "### Requires" section to extract member references and populate the `dependencies` field.

1. When encountering `### Requires`, enter a "collecting requires" mode
2. Parse lines like `- Uses X from Member N` or `- Requires Member N`
3. Extract member numbers and add to dependencies list
4. Support formats: "Member 1", "Member 2", etc.

## Acceptance Criteria

- [x] Parse `### Requires` section for member references
- [x] Extract member numbers from patterns like "from Member N", "Member N", "(Member N)"
- [x] Populate `member.dependencies` with extracted member IDs
- [x] Preserve existing `**Dependencies:**` parsing as fallback
- [x] Add unit test for Requires section parsing

## Edge Cases

- "Requires" section with no member references: Empty dependencies (infrastructure spec)
- Multiple members referenced: "Uses X from Member 1 and Y from Member 3" → [1, 3]
- Mixed formats: Both `### Requires` and `**Dependencies:**` present → merge both
- No Requires section: Fall back to linear dependencies (existing behavior)

## Integration Test

Add or update integration test for split command that verifies:
1. Split a spec with known DAG structure (e.g., 4 members where 2+3 are parallel after 1, and 4 depends on 2+3)
2. Verify resulting member specs have correct `depends_on` reflecting DAG, not linear chain
3. Test that "### Requires" section is parsed correctly
4. Test that infrastructure specs (no dependencies) have empty `depends_on`