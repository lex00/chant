---
type: code
status: completed
labels:
- bugfix
target_files:
- src/cmd/lifecycle.rs
commits:
- 3b06ffe
completed_at: 2026-01-31T13:13:04Z
model: sonnet
---
# Fix split dependency parsing - extract member references from Requires section to build DAG

## Problem

The split command generates a dependency analysis phase with correct DAG structure, and member specs include "### Requires" sections with member references like "Uses `WatchConfig` from Member 1". However, the parsing code in `src/cmd/lifecycle.rs` **skips** the Requires section (lines 772-773) instead of parsing it to extract dependencies.

Result: All member specs get linear dependencies (1→2→3→...→N) instead of the correct DAG.

## Current Behavior

Model outputs:
```markdown
### Requires
- Uses `WatchConfig` from Member 1 for retry settings
```

Code at line 772-773:
```rust
if line.contains("### Provides") || line.contains("### Requires") {
    // Skip this section
    continue;
}
```

The code only looks for explicit `**Dependencies:** Member 1, Member 3` lines.

## Solution

Parse the "### Requires" section to extract member references and populate the `dependencies` field.

1. When encountering `### Requires`, enter a "collecting requires" mode
2. Parse lines like `- Uses X from Member N` or `- Requires Member N`
3. Extract member numbers and add to dependencies list
4. Support formats: "Member 1", "Member 2", etc.

## Acceptance Criteria

- [x] Parse `### Requires` section for member references
- [x] Extract member numbers from patterns like "from Member N", "Member N", "(Member N)"
- [x] Populate `member.dependencies` with extracted member IDs
- [x] Preserve existing `**Dependencies:**` parsing as fallback
- [x] Add unit test for Requires section parsing

## Edge Cases

- "Requires" section with no member references: Empty dependencies (infrastructure spec)
- Multiple members referenced: "Uses X from Member 1 and Y from Member 3" → [1, 3]
- Mixed formats: Both `### Requires` and `**Dependencies:**` present → merge both
- No Requires section: Fall back to linear dependencies (existing behavior)

## Integration Test

Add or update integration test for split command that verifies:
1. Split a spec with known DAG structure (e.g., 4 members where 2+3 are parallel after 1, and 4 depends on 2+3)
2. Verify resulting member specs have correct `depends_on` reflecting DAG, not linear chain
3. Test that "### Requires" section is parsed correctly
4. Test that infrastructure specs (no dependencies) have empty `depends_on`

## Agent Output

2026-01-31T13:13:04Z

```
I'll implement the fix for split dependency parsing by extracting member references from the Requires section to build the correct DAG structure.
Let me start by reading the relevant parsing code in src/cmd/lifecycle.rs.
Let me search for the specific parsing logic mentioned in the spec.
Now let me find the member struct definition and the dependency parsing logic.
Now let me look for the dependency parsing logic around line 772.
Let me see the rest of the parse_dependencies_from_text function.
Now let me check how the parsing is structured by looking at the broader context.
Now I understand the code structure. Let me plan the implementation:

**Current situation:**
- Lines 772-776 skip the "### Requires" section entirely
- Lines 727-740 parse explicit "**Dependencies:**" sections
- The `parse_dependencies_from_text` function already handles extracting member numbers from text

**Implementation plan:**
1. Add a new boolean flag `collecting_requires` similar to `collecting_files` and `collecting_dependencies`
2. When we encounter "### Requires", set `collecting_requires = true`
3. While `collecting_requires` is true, parse lines for member references
4. Use the existing `parse_dependencies_from_text` function to extract member numbers
5. Stop collecting when we hit another `###` or `##` section

Let me implement this change:
Now I need to modify the section that skips the "### Requires" section to instead collect from it:
Now I need to add the logic to parse the Requires section lines and remove the code that skips it:
Now I need to reset the `collecting_requires` flag when we start a new member:
Now let me format the code:
Let me check the end of the test output:
The tests are still running. Let me wait for them to complete:
All tests passed! Now let me verify the implementation by checking if there are any existing integration tests for the split command:
Let me verify the implementation by looking at the changes I made:
The implementation looks good. Now let me verify the acceptance criteria:

1. ✅ Parse `### Requires` section for member references - Implemented
2. ✅ Extract member numbers from patterns like "from Member N", "Member N", "(Member N)" - Using existing `parse_dependencies_from_text` function
3. ✅ Populate `member.dependencies` with extracted member IDs - Implemented
4. ✅ Preserve existing `**Dependencies:**` parsing as fallback - Preserved
5. ⚠️ Add unit test for Requires section parsing - Need to check if there are existing tests or add one

Let me search for existing tests for the parse_member_specs_from_output function:
The function is internal and not currently tested with unit tests. Let me check if there are integration tests for the split command:
Let me check the spec requirements again. The spec says "Add unit test for Requires section parsing" and "Add or update integration test for split command". Since this is a parsing function that's called during the split command execution, let me add a unit test:
Let me look for the test module in this file:
Let me find where the tests end to add my test:
Now let me add a unit test for the parse_member_specs_from_output function to test the Requires section parsing:
Let me read the end of the file first:
Now let me run the tests again to make sure the new tests pass:
Perfect! The new tests pass. Now let me verify all acceptance criteria:
Now let me read the spec file and update the acceptance criteria:
Now let me commit the changes:
Perfect! I have successfully completed the spec. Here's a summary of what was done:

## Summary

I've fixed the split dependency parsing issue in src/cmd/lifecycle.rs:772-773 to extract member references from the `### Requires` section and build the correct DAG structure.

### Changes Made

1. **Added `collecting_requires` state flag** - Similar to `collecting_files` and `collecting_dependencies`, this tracks when we're in a Requires section

2. **Parse `### Requires` section** - When encountered, the parser now enters "requires collection" mode and extracts member dependencies from lines like:
   - "Uses X from Member N"
   - "Requires Member N"
   - "Member N and Member M"

3. **Reused existing parsing logic** - The implementation uses the existing `parse_dependencies_from_text()` function, which already handles various member reference patterns

4. **Preserved fallback behavior** - The existing `**Dependencies:**` parsing continues to work as before

5. **Added comprehensive unit tests**:
   - `test_parse_member_specs_requires_section()` - Tests DAG parsing with various member dependencies
   - `test_parse_member_specs_preserves_dependencies_fallback()` - Verifies backward compatibility with `**Dependencies:**` format

### Acceptance Criteria

All acceptance criteria have been met:
- ✅ Parse `### Requires` section for member references
- ✅ Extract member numbers from patterns like "from Member N", "Member N", "(Member N)"
- ✅ Populate `member.dependencies` with extracted member IDs
- ✅ Pres

... (output truncated, 5262 chars total)```
