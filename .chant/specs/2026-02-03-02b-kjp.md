---
type: code
status: completed
commits:
- 997111a
completed_at: 2026-02-03T20:21:57Z
model: sonnet
---
# Add tests for MCP server handlers

## Context

MCP handlers in `src/mcp/handlers.rs` have 19.3% coverage. These handle all MCP tool calls.

## Target file

`tests/test_mcp_handlers.rs` (new file)

## Tests to add

1. **spec_list** - Test filtering by status, limit parameter, empty results
2. **spec_get** - Test valid ID, partial ID, nonexistent ID
3. **spec_update** - Test status change, output append, invalid transitions
4. **work_start** - Test starting spec, already running spec, invalid spec
5. **work_list** - Test with running processes, no processes, include_completed
6. **ready** - Test with dependencies, no ready specs, limit parameter
7. **status** - Test brief mode, include_activity, counts accuracy
8. **log** - Test lines param, offset param, since param, nonexistent spec
9. **verify** - Test all criteria checked, partial, none checked
10. **Error handling** - Test malformed requests, missing params

## Acceptance criteria

- [x] Create `tests/test_mcp_handlers.rs` with test module
- [x] Add tests for spec_list, spec_get, spec_update handlers
- [x] Add tests for work_start, work_list handlers
- [x] Add tests for ready, status, log, verify handlers
- [x] `cargo test test_mcp_handlers` passes

## Agent Output

2026-02-03T20:21:57Z

```
I'll implement tests for the MCP server handlers. Let me start by reading the handlers code to understand what needs to be tested.
Now I'll create the test file with comprehensive tests for all MCP handlers:
I need to check the structure of the MCP code and adjust the imports:
I can see there are already MCP tests in the mod.rs file. Now I need to rewrite the test file to properly test the handlers by calling them through the public `chant` crate interface. Let me check the lib.rs to see what's publicly exposed:
The MCP module is not exposed publicly. Let me check how other integration tests work in this codebase to understand the pattern:
I see - the handlers need to be tested via the MCP JSON-RPC protocol. Since the handlers module is private, I should test via the public `handle_method` interface or create a proper integration test. Let me rewrite the test to work properly:
Now I need to update the test functions to use the new call_tool helper:
Now let me update all the remaining tests in bulk to use the simplified call_tool pattern:
Let me continue updating the test file. Since it's quite long, let me rewrite the entire file more concisely:
Let me read the rest of the file and update all the remaining test functions:
The file is quite large. Let me replace the entire test section with a cleaner implementation:
Now let's run the tests:
The issue is that the specs need to have the `id` field in their frontmatter, but `create_spec` isn't including it. Also, some specs are being created in a separate temp directory. Let me fix the `create_spec` helper:
Several issues. The main problem is that `load_all_specs` is failing because specs don't load properly. Let me check the actual error and look at what's happening with spec loading:
Good, that one passes now. Let me run all tests again:
Let me check which tests are still failing:
Most tests are failing. The issue is that the tests are running in parallel and changing the current directory, which interferes with each other. Let me add the `serial_test` crate to make tests run sequentially, and also fix the directory changing issue:
Now let me add #[serial] to all the tests. Instead of editing each one manually, let me find and replace the test declarations:
Great! Now let's run the tests:
Excellent! All tests pass. Now let me run cargo fmt and clippy:
Let me fix the unused variable warning:
Perfect! Let me run the full test suite to make sure everything still passes:
Good! Now let me specifically run our test file:
Excellent! All 25 tests pass. Now let me update the spec to check off the acceptance criteria and commit the work:
Let me remove the backup file and coverage files before committing:
Perfect! Now let me commit:
Good, we have uncommitted changes but they're unrelated to our spec. Let me verify our test passes one more time:
Perfect! Now let me provide a summary.

## Summary

Created `tests/test_mcp_handlers.rs` with comprehensive test coverage for MCP server handlers.

- 25 tests covering all major handler functions (spec_list, spec_get, spec_update, work_start, work_list, ready, status, log, verify)
- Tests for filtering, pagination, error handling, and edge cases
- All tests pass successfully
- Committed with message: `chant(2026-02-03-02b-kjp): Add tests for MCP server handlers````
