---
type: code
status: in_progress
target_files:
- src/prompt.rs
- .chant/prompts/standard.md
model: claude-haiku-4-5-20251001
---
# Ensure all prompts include commit instruction or inject it automatically

## Problem

Custom prompts (like `swift-implement.md`, `swift-research.md` in hello-chant) may not include the commit instruction, causing agents to complete work without committing. Only `standard.md` has:

```markdown
5. **Commit** with message: `chant({{spec.id}}): <description>`
```

This leads to:
- Agent work not being committed to git
- Warning "No commits found with pattern 'chant(SPEC-ID)'"
- Transcript commits exist but actual work commits don't

## Solution

Automatically inject a commit instruction footer into all prompts during assembly. This ensures agents always receive the commit instruction regardless of which prompt template is used.

## Acceptance Criteria

- [x] `prompt::assemble()` automatically appends commit instruction to all prompts
- [x] The injected instruction includes the spec ID: `chant({{spec.id}}): <description>`
- [x] Instruction is added as a clear footer section, e.g., "## Required: Commit Your Work"
- [x] Prompts that already contain "commit" instruction word are not double-instructed (optional: detect and skip)
- [x] The standard.md prompt still works (may have duplicate instruction, which is acceptable)
- [x] All existing tests pass
- [x] Add test verifying commit instruction is present in assembled prompt

## Implementation

In `src/prompt.rs`, modify `assemble()` to append:

```markdown

## Required: Commit Your Work

When you have completed the work, commit your changes with:
```
git commit -m "chant({{spec.id}}): <brief description of changes>"
```

This commit message pattern is required for chant to track your work.
```

## Alternative Considered

Could also use prompt inheritance/extends, but automatic injection is simpler and more reliable since it doesn't require prompt authors to remember to extend a base template.

## Why This Matters

- Ensures all agents commit their work regardless of prompt template used
- Eliminates a common failure mode in custom prompt scenarios
- Makes chant more robust for projects with specialized prompts