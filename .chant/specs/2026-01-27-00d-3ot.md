---
type: code
status: completed
target_files:
- tests/integration_tests.rs
completed_at: 2026-01-27T20:56:13Z
model: sonnet
---
# Add integration test for env-based derivation

## Problem

Environment variable derivation has no integration test verifying environment variables are captured and used during `chant add`.

**Gap:** Need to verify that when `TEAM_NAME=platform chant add`, the team field is actually derived.

## Solution

Add integration test that:
1. Creates test git repository
2. Sets up enterprise config with env variable derivation
3. Sets environment variable before running `chant add`
4. Verifies spec contains derived value from environment

## Test Implementation

```rust
#[test]
fn test_env_based_derivation_end_to_end() {
    let temp_dir = "/tmp/chant-test-env-deriv";
    setup_test_repo(temp_dir);

    // Create enterprise config
    let config = r#"
enterprise:
  derived:
    team:
      from: env
      pattern: "TEAM_NAME"
    environment:
      from: env
      pattern: "DEPLOY_ENV"
"#;
    write_config(temp_dir, config);

    // Run chant add with environment variables set
    let output = Command::new(env!("CARGO_BIN_EXE_chant"))
        .args(["add", "Test spec"])
        .env("TEAM_NAME", "platform")
        .env("DEPLOY_ENV", "production")
        .current_dir(temp_dir)
        .output()
        .expect("Failed to run chant add");

    assert!(output.status.success());

    // Read created spec and verify derived fields
    let spec_content = read_latest_spec(temp_dir);
    assert!(spec_content.contains("team: platform"));
    assert!(spec_content.contains("environment: production"));
    assert!(spec_content.contains("derived_fields:\n  - team\n  - environment"));
}
```

## Acceptance Criteria

- [ ] Add test to tests/integration_tests.rs
- [ ] Test sets up enterprise config with env derivation
- [ ] Test sets environment variables using .env() on Command
- [ ] Test runs `chant add` command
- [ ] Test verifies spec contains values from environment variables
- [ ] Test verifies derived_fields tracking
- [ ] Test with multiple environment variables
- [ ] Test passes: `cargo test test_env_based_derivation_end_to_end`
- [ ] Cleanup temp directory after test