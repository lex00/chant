---
type: code
status: completed
model: sonnet
---
# Fix branch resolution reading stale branch after merge - auto-delete branch or check merge status

## Problem

When a spec's branch has already been merged into the main branch, the current code doesn't detect this and may attempt to merge it again, causing failures. The `branch_exists` check only verifies that a branch exists, not whether it has been merged.

## Solution

1. Added `is_branch_merged()` function in `src/git.rs` to check if a branch has been merged using `git branch --merged`
2. Updated `handle_completed()` in `src/cmd/lifecycle.rs` to:
   - Check if branch exists
   - Check if branch has been merged
   - Auto-delete merged branches
   - Skip merge if branch doesn't exist
3. Updated `run_merge_wizard()` to filter out already-merged branches
4. Updated `find_completed_specs_with_branches()` to filter out already-merged branches

## Acceptance Criteria

- [x] Add `is_branch_merged(branch_name, target_branch)` function to check if a branch has been merged
- [x] Update `handle_completed()` to check merge status before attempting merge
- [x] Auto-delete merged branches when detected
- [x] Update merge wizard to exclude already-merged branches
- [x] Update `find_completed_specs_with_branches()` to exclude already-merged branches
- [x] Code compiles without errors
- [x] Clippy passes without warnings
- [x] All tests pass

## Files Modified

- `src/git.rs`: Added `is_branch_merged()` function
- `src/cmd/lifecycle.rs`: Updated branch resolution logic in `handle_completed()`, `run_merge_wizard()`, and `find_completed_specs_with_branches()`
