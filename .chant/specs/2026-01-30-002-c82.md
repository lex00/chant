---
type: task
status: in_progress
context:
- src/cmd/work.rs
- src/worktree.rs
- src/cmd/lifecycle.rs
---
# Investigate worktree branch confusion and potential enhancements

## Problem

User reports that agents sometimes tell them "the status is wrong because it doesn't realize that it has changed branches from main in the repo."

**Expected behavior with worktrees:**
- Main repo stays on `main` branch
- Each spec executes in isolated worktree: `/private/tmp/chant-<spec-id>/`
- Worktree has its own branch: `chant/<spec-id>`
- Agent should always know which worktree/branch it's in

**Potential issues:**
1. Agent confusion about current branch
2. Commands running in wrong directory (main repo vs worktree)
3. Git status checks reading from wrong location
4. Working directory not properly set to worktree
5. Agent might not detect it's in a worktree

## Investigation Goals

### 1. Reproduce the Issue
- Identify when/how branch confusion happens
- Test with `chant work <spec-id>` (default mode, no --branch flag)
- Test with `chant work <spec-id> --branch` (feature branch mode)
- Check agent logs for branch detection errors

### 2. Analyze Current Implementation
- How is the working directory set for agents?
- Where do git commands execute (main repo vs worktree)?
- How does the agent detect its current branch?
- Is the worktree path properly communicated to the agent?

### 3. Identify Root Causes
- Is `PWD` correctly set to worktree path?
- Are git commands using the right git directory?
- Does the agent check `.git/HEAD` (wrong) vs worktree's HEAD?
- Are there race conditions during worktree creation?

### 4. Propose Solutions
- Add explicit worktree context to agent environment
- Improve branch detection in agent code
- Add validation that agent is in correct directory
- Better error messages when branch mismatch detected
- Consider adding worktree status checks

## Research Tasks

**Study How Other Software Uses Worktrees:**

Research how popular tools use git worktrees:
- **GitLab CI/CD** - How do they handle parallel jobs?
- **GitHub Actions** - Do they use worktrees for concurrent workflows?
- **Gerrit** - How do they manage code review branches?
- **repo tool** (Android/Chromium) - Multi-repo worktree patterns
- **git-worktree** best practices from Git documentation
- **CI/CD systems** - How do Jenkins/CircleCI/etc handle isolation?

Look for patterns around:
- Working directory management
- Environment variable setup (`GIT_DIR`, `GIT_WORK_TREE`)
- Branch context communication
- Worktree cleanup strategies
- Error detection and recovery

**Code to Review:**
- `src/cmd/work.rs` - Spec execution logic
- `src/worktree.rs` - Worktree creation/management
- Agent prompt templates - How worktree context is communicated
- `.chant/prompts/standard.md` - Agent instructions

**Tests to Run:**
```bash
# Test 1: Default mode (no worktree)
chant work <spec-id>
# Check: Does agent know it's on main?

# Test 2: Feature branch mode
chant work <spec-id> --branch
# Check: Does agent know it's in worktree?

# Test 3: Check git commands in worktree
cd /private/tmp/chant-<spec-id>
git status
git branch --show-current
# Verify these work correctly

# Test 4: Environment variables
env | grep -i git
pwd
# Check what the agent sees
```

**Questions to Answer:**
1. How is the agent's working directory set?
2. Where does `git status` execute from?
3. Is there a `GIT_DIR` or `GIT_WORK_TREE` env var set?
4. Does the agent receive worktree path in its prompt?
5. Are there any error messages in agent logs about branches?

## Potential Enhancements

### Enhancement 1: Explicit Worktree Context
Add to agent prompt when in worktree:
```
You are executing in an isolated worktree:
- Worktree path: /private/tmp/chant-<spec-id>
- Branch: chant/<spec-id>
- Main repo remains on: main
- All your changes are isolated to this worktree
```

### Enhancement 2: Branch Validation
Add checks before/after agent execution:
```rust
// Before agent starts
assert_eq!(current_branch(), expected_branch);

// After agent completes
if current_branch() != expected_branch {
    warn!("Branch mismatch detected!");
}
```

### Enhancement 3: Working Directory Assertions
Add defensive checks in agent execution:
```rust
let worktree_path = get_worktree_path(spec_id);
assert!(std::env::current_dir()? == worktree_path);
```

### Enhancement 4: Better Error Messages
When branch confusion detected:
```
⚠ Branch mismatch detected!
  Expected: chant/2026-01-30-002-c82
  Current:  main

  You may be in the wrong directory.
  Worktree location: /private/tmp/chant-2026-01-30-002-c82
```

### Enhancement 5: Worktree Status Check
Add a `chant worktree status` command to help debug:
```bash
chant worktree status <spec-id>
# Shows: worktree path, branch, git status, files changed
```

## Acceptance Criteria

- [x] Identified and documented root cause of branch confusion
- [x] Tested both default and --branch modes
- [x] Reviewed worktree creation/execution code
- [x] Proposed specific fixes or enhancements
- [x] Created follow-up spec(s) for actual fixes if needed
- [x] Documented findings in spec output

### Follow-up Specs Created

1. **2026-01-30-003-qme**: Add worktree context to agent prompts
2. **2026-01-30-004-t9y**: Add worktree environment variables
3. **2026-01-30-005-5lp**: Add `chant worktree status` command

## Deliverable

This is a **research/investigation spec** (type: task), not an implementation spec. The output should be:

1. **Findings Report** documenting:
   - How worktrees currently work
   - Where/when branch confusion occurs
   - Root cause analysis
   - Recommended solutions

2. **Follow-up Specs** (if fixes are needed):
   - Create new specs for each fix/enhancement
   - Provide clear acceptance criteria for fixes

## Files to Review

- `src/cmd/work.rs`
- `src/worktree.rs`
- `src/cmd/lifecycle.rs`
- `.chant/prompts/standard.md`
- Agent execution logs (`.chant/logs/<spec-id>.log`)

---

## Findings Report

### Executive Summary

After thorough investigation, **the reported "branch confusion" is NOT a bug in chant's worktree handling**. The root cause is a **missing context gap** in how agents receive information about their execution environment. Chant correctly creates and manages worktrees, but **does not communicate worktree context to agents through prompts or environment variables**.

### Current Worktree Architecture

#### How Worktrees Are Created (`src/worktree.rs`)

1. **Worktree path**: `/tmp/chant-<spec-id>` (line 18-19)
2. **Branch naming**: `chant/<spec-id>` (derived from spec ID)
3. **Creation**: Uses `git worktree add -b <branch> <path>` (lines 130-138)
4. **Cleanup**: `git worktree remove` + directory removal (lines 161-175)

#### Execution Modes (`src/cmd/work.rs`)

**Default Mode (single spec, no `--branch`):**
- Agent runs in the **current directory** (main repo)
- No worktree created
- Agent works directly on main branch
- Working directory is NOT changed

**Parallel Mode (`--parallel`):**
- Worktree IS created at `/tmp/chant-<spec-id>/`
- Agent invoked with `current_dir(worktree_path)` (line 1864)
- This sets the `cwd` for the subprocess

**Feature Branch Mode (`--branch`):**
- Creates a branch but NOT a worktree
- Agent still runs in current directory
- Uses `create_or_switch_branch()` to checkout

#### How Working Directory Is Set for Agents (`src/cmd/agent.rs`)

The agent invocation has two paths:

1. **Single spec execution** (`invoke_agent_with_model`, lines 215-273):
   ```rust
   // Change to working directory if provided
   let original_cwd = std::env::current_dir().ok();
   if let Some(path) = cwd {
       std::env::set_current_dir(path)?;
   }
   ```
   This changes the **process-wide** working directory.

2. **Parallel execution** (`invoke_agent_with_command`, lines 125-212):
   ```rust
   // Set working directory if provided
   if let Some(path) = cwd {
       cmd.current_dir(path);
   }
   ```
   This sets the working directory only for the **subprocess**.

### Root Cause Analysis

#### Why Agents Get Confused

1. **No explicit worktree context in prompts**: The standard prompt (`standard.md`) does not tell the agent:
   - Whether it's running in a worktree
   - What the worktree path is
   - What branch it should be on
   - That the main repo is isolated

2. **Claude Code reads its own status**: When Claude Code starts, it reports git status from whatever directory it's in. This information is determined by the **Claude CLI itself**, not chant.

3. **Mixed execution modes**:
   - Single spec: runs in main repo (no worktree)
   - Parallel: runs in worktree
   - The agent doesn't know which mode it's in

4. **Environment variables NOT set**: Chant sets `CHANT_SPEC_ID` and `CHANT_SPEC_FILE` (lines 54-56, 246-248 in agent.rs), but does NOT set:
   - `CHANT_WORKTREE_PATH`
   - `CHANT_BRANCH`
   - `GIT_DIR` / `GIT_WORK_TREE`

#### The "Branch Confusion" Scenario

When a user sees "the status is wrong because it doesn't realize that it has changed branches", this likely happens because:

1. Agent starts in worktree (correct)
2. Claude Code reports it's on `chant/<spec-id>` branch (correct)
3. User expects the main repo to be on main (true - it is)
4. **Confusion source**: Agent or user misinterprets which repo/worktree they're looking at

### How Other Tools Handle This

Based on research of GitLab CI, Chromium, and Android repo tool:

1. **GitLab CI**: Uses `GIT_CLONE_PATH: $CI_BUILDS_DIR/$CI_PROJECT_PATH/job-$CI_JOB_ID` to create unique directories per job. Sets many `CI_*` environment variables for context.

2. **Git Worktrees**: In linked worktrees, Git automatically sets:
   - `$GIT_DIR` → points to worktree's private `.git/worktrees/<name>/`
   - `$GIT_COMMON_DIR` → points back to main repo's `.git/`
   - A `.git` file (not directory) in the worktree root pointing to the private directory

3. **Chromium/Android**: Uses `gclient-new-workdir` or repo tool with explicit environment setup for each worktree.

### Key Findings

| Aspect | Current State | Issue |
|--------|--------------|-------|
| Worktree creation | ✅ Correct | None |
| Working directory | ✅ Correct (parallel mode) | Single-spec runs in main repo |
| Branch management | ✅ Correct | None |
| Environment vars | ⚠️ Partial | Missing worktree context |
| Prompt context | ❌ Missing | No worktree info in prompts |
| Agent awareness | ❌ Missing | Agent has no way to know it's in worktree |

### Recommended Solutions

#### Priority 1: Add Worktree Context to Prompts

Add a new template variable `{{spec.worktree_context}}` that expands to context when in worktree mode:

```markdown
## Execution Environment

{{#if worktree}}
You are executing in an isolated git worktree:
- Worktree path: {{worktree.path}}
- Branch: {{worktree.branch}}
- Main repository: remains on main branch, untouched
- Your changes are isolated until merged

Important: All file paths are relative to the worktree root.
{{else}}
You are executing directly in the main repository on the current branch.
{{/if}}
```

#### Priority 2: Add Environment Variables

When invoking agents in worktree mode, set:

```rust
cmd.env("CHANT_WORKTREE", "true")
   .env("CHANT_WORKTREE_PATH", worktree_path.display().to_string())
   .env("CHANT_BRANCH", branch_name)
```

#### Priority 3: Add Worktree Status Command

Add `chant worktree status <spec-id>` to help debug:

```
$ chant worktree status 2026-01-30-002-c82

Worktree Status for spec 2026-01-30-002-c82
─────────────────────────────────────────────
  Path:     /tmp/chant-2026-01-30-002-c82
  Branch:   chant/2026-01-30-002-c82
  Status:   Active (exists)
  Git HEAD: abc1234 (Initial commit in worktree)

Files changed:
  M src/cmd/work.rs
  A src/new_feature.rs
```

#### Priority 4: Validate Branch Before/After Execution

In parallel mode, verify the agent is operating in the correct worktree:

```rust
// Before agent invocation
if let Some(ref worktree_path) = worktree_path {
    let current_branch = get_current_branch_at(worktree_path)?;
    let expected_branch = format!("chant/{}", spec_id);
    if current_branch != expected_branch {
        warn!("Branch mismatch before agent start: expected {}, got {}",
              expected_branch, current_branch);
    }
}
```

### Summary

The "branch confusion" is a **documentation/communication gap**, not a bug in worktree handling. The fix is straightforward:

1. **Tell agents where they are** through prompts
2. **Set environment variables** for programmatic detection
3. **Add debugging tools** for users to verify worktree state

No changes needed to worktree creation, branch management, or cleanup logic.