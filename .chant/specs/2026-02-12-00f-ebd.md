---
type: code
status: completed
depends_on:
- 2026-02-12-00c-hkq
target_files:
- src/cmd/finalize.rs
- src/operations/finalize.rs
- src/operations/verify.rs
commits:
- 47932c9
completed_at: 2026-02-13T03:59:05Z
model: sonnet
---
# Finalization safety: atomicity and locking



## Problem

- Watch + manual `chant finalize` can race — both load spec, write different frontmatter, last write wins (`watch.rs:849`)
- Partial finalization corruption — status set `Completed` in memory, save fails midway, corrupted state on disk (`finalize.rs:88-184`)
- Verify writes spec without locking — agent and verifier can write concurrently (`verify.rs:251`)
- Operations-layer finalize uses `.force()` bypass with no criteria validation (`operations/finalize.rs:100`)

## Solution

- Acquire spec-level lock (via `lock::create_lock`) during finalization — both watch and manual paths
- Write spec to temp file, atomic rename on success
- Acquire lock during verify write
- Add criteria check to operations-layer finalize path

## Acceptance Criteria

- [x] Finalization acquires spec lock before writing — concurrent finalize calls are serialized
- [x] Spec save uses atomic write (temp file + rename) to prevent partial corruption
- [x] Verify acquires spec lock before writing results
- [x] Operations-layer `finalize_spec()` validates unchecked criteria before completing
- [x] `cargo test` and `cargo clippy` pass