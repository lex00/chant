---
type: code
status: pending
depends_on:
- 2026-01-25-00y-9qp.1
target_files:
- src/cmd/agent.rs
- src/main.rs
---
# Extract agent invocation to src/cmd/agent.rs

Move all agent-related functionality into a dedicated module. This is the most self-contained extraction since these functions are primarily focused on LLM interaction and streaming.

### Acceptance Criteria

- [ ] All agent-related functions moved to `src/cmd/agent.rs`:
  - `get_model_provider()`
  - `invoke_agent_with_prefix()`
  - `invoke_agent()`
  - `invoke_agent_with_model()`
  - `extract_text_from_stream_json()`
  - Any helper functions used only by agent invocation
- [ ] `src/cmd/agent.rs` has proper public API exports (pub use or pub fn)
- [ ] `src/main.rs` imports and calls functions as `cmd::agent::*`
- [ ] All agent invocation in main.rs dispatches to cmd::agent module
- [ ] `just check` passes (no dead code warnings, all tests pass)
- [ ] No functionality changed - agent behavior is identical before/after

### Edge Cases

- **Streaming callbacks**: Ensure streaming output callbacks work correctly when moved to separate module
- **Provider types**: Verify all `provider::ModelProvider` imports work correctly in cmd::agent
- **Error propagation**: Confirm error types and Result<T> chains work across module boundaries
- **Config dependencies**: Check that Config references are properly borrowed through function calls

### Example Test Cases

For agent invocation, verify:
- `invoke_agent()` produces identical output when called before and after refactoring
- Streaming output (callbacks) still displays correctly
- Error messages from failed agent calls are unchanged
- Model provider selection logic still works for all supported providers (claude, cursor, amazonq, etc.)