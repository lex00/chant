---
type: code
status: completed
depends_on:
- 2026-01-25-00y-9qp.1
target_files:
- src/cmd/agent.rs
- src/main.rs
commits:
- ee41ff3
- fe1acf8
completed_at: 2026-01-25T14:50:51Z
model: haiku
---
# Extract agent invocation to src/cmd/agent.rs

Move all agent-related functionality into a dedicated module. This is the most self-contained extraction since these functions are primarily focused on LLM interaction and streaming.

### Acceptance Criteria

- [x] All agent-related functions moved to `src/cmd/agent.rs`:
  - `get_model_provider()`
  - `invoke_agent_with_prefix()`
  - `invoke_agent()`
  - `invoke_agent_with_model()`
  - `extract_text_from_stream_json()`
  - Any helper functions used only by agent invocation
- [x] `src/cmd/agent.rs` has proper public API exports (pub use or pub fn)
- [x] `src/main.rs` imports and calls functions as `cmd::agent::*`
- [x] All agent invocation in main.rs dispatches to cmd::agent module
- [x] `just check` passes (no dead code warnings, all tests pass)
- [x] No functionality changed - agent behavior is identical before/after

### Edge Cases

- **Streaming callbacks**: Ensure streaming output callbacks work correctly when moved to separate module
- **Provider types**: Verify all `provider::ModelProvider` imports work correctly in cmd::agent
- **Error propagation**: Confirm error types and Result<T> chains work across module boundaries
- **Config dependencies**: Check that Config references are properly borrowed through function calls

### Example Test Cases

For agent invocation, verify:
- `invoke_agent()` produces identical output when called before and after refactoring
- Streaming output (callbacks) still displays correctly
- Error messages from failed agent calls are unchanged
- Model provider selection logic still works for all supported providers (claude, cursor, amazonq, etc.)

## Agent Output

2026-01-25T14:50:51Z

```
I'll start by reading the relevant code to understand the current structure and identify what needs to be moved to `src/cmd/agent.rs`.
Let me check what's already in the cmd module and then look at the relevant functions in main.rs:
Good! The `src/cmd/agent.rs` file already exists but is just a stub. Let me search for the agent functions in main.rs more carefully:
Now let me read these functions from main.rs to understand what needs to be moved:
Let me continue reading the functions and also look for `get_model_for_invocation`:
Let me read these functions:
Now let me check the imports and look for where these functions are called:
Now let me use the Explore agent to understand the overall structure and where these functions are called:
Now I have a clear understanding. Let me create a todo list and start implementing the extraction:
Now let me read the full functions I need to move and check what types/imports are needed:
Now I need to check the StreamingLogWriter structure and the helper functions to understand all the dependencies:
Perfect! Now I understand the scope. Let me write the new `src/cmd/agent.rs` file with all the agent-related functions:
Good! Now I need to update main.rs to remove these functions and import them from the cmd::agent module. Let me first find all the lines where these functions and helper structures are defined and remove them:
Now let me remove all the agent-related functions from main.rs. I'll need to find the exact line range. Let me use bash to identify where each function ends:
Now let me check what comes after parse_model_from_claude_version to know where to end the deletion:
Good, so I need to remove from line 2162 to 2895. Let me identify the exact range for deletion. Let me check what's before line 2162:
I need to remove lines 2161-2895 (including the doc comment). Let me do this with an Edit:
Perfect. Now I'll remove all the agent-related functions from main.rs using one Edit. I need to keep the "Get the model to use for split" comment and get_model_for_split function. So I'll delete from line 2161 to 2895:
Now I need to remove the other agent-related functions. Let me remove the streaming log writer and helper functions. I'll do this carefully to keep get_model_for_split intact:
Now let me remove all the streaming log writer and model-related functions that were in the agent module:
Good! Now let me update main.rs to use the cmd::agent module. I need to find and replace all the function calls. Let me first search for where these functions are called:
Now I'll update main.rs to use the cmd::agent module. First, let me update the function calls to use the module path:
Now let me update all the function calls to use the cmd::agent module:
Now let me update the second call to invoke_agent_with_prefix:
Now let me find and update the invoke_agent_with_model call:
Now let me update the todo list and compile to check for any issues:
Now let me build and test:
I see the issues. I need to check what functions are used elsewhere and need to be kept in main.rs. Let me look at what's still being used:
I see. These functions are still being used in finalization and other parts of main.rs, so they can't be moved to cmd::agent. Also, MAX_AGENT_OUTPUT_CHARS is used in main.rs. Let me check what's actually part of the agent module - I need to only move the functions that are ONLY used for agent invocation. Let me look at the spec again to understand what should be moved:

Looking back at the spec, it says:
- `get_model_provider()` ✓
- `invoke_agent_with_prefix()` ✓
- `invoke_agent()` ✓
- `invoke_agent_with_model()` ✓
- `extract_text_from_stream_json()` ✓
- Any helper functions used only by agent invocation

The functions I removed that are still needed in main.rs are:
- `get_model_name()` - used in finalization
- `get_model_name_with_default()` - used in finalization and parallel execution
- `MAX_AGENT_OUTPUT_CHARS` - used for output formatting
- `parse_model_from_claude_version()` - helper for get_model_name
- `get_model_for_split()` - used for split operations, not agent invocation

Let me restore these functions that are NOT part of the agent module:
Now I need to add back the functions that should stay in main.rs. Let me insert them before get_model_for_split:
Now I need to remove the unused import and rebuild:
Now let me rebuild:
Good! There's just a warning about DEFAULT_MODEL not being used. This is because it's only used inside the cmd::agent module now. Since the build succeeds, let me now format and lint:
Good, the code was formatted. Now let me run clippy:
I need to remove the DEFAULT_MODEL constant from main.rs since it's now only used in cmd::agent. Let me check if there are any other issues. Actually, I should remove it from main.rs since it's not needed there anymore:
Let me read the file first:
Now let me run clippy again:
Excellent! Now let me run the tests:
I see. The tests in main.rs are using these helper functions. I need to make them public in the cmd::

... (output truncated, 11712 chars total)```
