---
type: code
status: pending
target_files:
- src/main.rs
- src/config.rs
---

# Fix model tagging - detect from Claude CLI or config

Spec 00z-87n claimed to implement model tagging but it only works if `CHANT_MODEL` or `ANTHROPIC_MODEL` env vars are set. Recent completed specs have no model field because no env var is set.

## Problem

```rust
fn get_model_name() -> Option<String> {
    std::env::var("CHANT_MODEL")
        .ok()
        .or_else(|| std::env::var("ANTHROPIC_MODEL").ok())
        .filter(|s| !s.is_empty())
}
```

This returns `None` when env vars aren't set, so model is never saved.

## Acceptance Criteria

- [ ] Add `defaults.model` to config schema
- [ ] Fall back to config default when env vars not set
- [ ] Parse model from Claude CLI `--version` output as last resort
- [ ] Verify recent specs get model field populated
- [ ] Update tests

## Solution

Priority order for model detection:
1. `CHANT_MODEL` env var (explicit override)
2. `ANTHROPIC_MODEL` env var (Claude CLI default)
3. `defaults.model` in config.md
4. Parse from `claude --version` output (e.g., "claude-code 1.0.0 (claude-sonnet-4)")

## Example Config

```yaml
defaults:
  model: claude-sonnet-4  # Default model for this project
```

## Implementation Notes

- Add `model: Option<String>` to `DefaultsConfig` in config.rs
- Update `get_model_name()` to accept config and check fallbacks
- Claude CLI version parsing: `claude --version` outputs model info
