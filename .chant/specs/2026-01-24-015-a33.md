---
type: code
status: completed
target_files:
- src/main.rs
- src/config.rs
commit: e8f0a83
completed_at: 2026-01-24T14:21:02Z
model: claude-opus-4-5
---
# Fix model tagging - detect from Claude CLI or config

Spec 00z-87n claimed to implement model tagging but it only works if `CHANT_MODEL` or `ANTHROPIC_MODEL` env vars are set. Recent completed specs have no model field because no env var is set.

## Problem

```rust
fn get_model_name() -> Option<String> {
    std::env::var("CHANT_MODEL")
        .ok()
        .or_else(|| std::env::var("ANTHROPIC_MODEL").ok())
        .filter(|s| !s.is_empty())
}
```

This returns `None` when env vars aren't set, so model is never saved.

## Acceptance Criteria

- [x] Add `defaults.model` to config schema
- [x] Fall back to config default when env vars not set
- [x] Parse model from Claude CLI `--version` output as last resort
- [x] Verify recent specs get model field populated
- [x] Update tests

## Solution

Priority order for model detection:
1. `CHANT_MODEL` env var (explicit override)
2. `ANTHROPIC_MODEL` env var (Claude CLI default)
3. `defaults.model` in config.md
4. Parse from `claude --version` output (e.g., "claude-code 1.0.0 (claude-sonnet-4)")

## Example Config

```yaml
defaults:
  model: claude-sonnet-4  # Default model for this project
```

## Implementation Notes

- Add `model: Option<String>` to `DefaultsConfig` in config.rs
- Update `get_model_name()` to accept config and check fallbacks
- Claude CLI version parsing: `claude --version` outputs model info

## Agent Output

2026-01-24T14:21:02Z

```
I've completed the spec implementation. Here's a summary of what was done:

## Summary

### Changes Made

**1. Added `defaults.model` to config schema (`src/config.rs`)**
- Added `model: Option<String>` to `DefaultsConfig` struct
- Added `model: Option<String>` to `PartialDefaultsConfig` struct
- Updated the merge logic to handle model field

**2. Updated model detection in `src/main.rs`**
- Modified `get_model_name()` to accept `Option<&Config>` parameter
- Created `get_model_name_with_default()` helper for parallel execution
- Model detection now follows this priority:
  1. `CHANT_MODEL` env var (explicit override)
  2. `ANTHROPIC_MODEL` env var (Claude CLI default)
  3. `defaults.model` in config
  4. Parse from `claude --version` output (last resort)

**3. Added `parse_model_from_claude_version()` function**
- Attempts to extract model name from parentheses in version output
- Checks for keywords like "claude", "sonnet", "opus", "haiku"

**4. Added tests**
- Tests for config model parsing and merging
- Tests for model detection priority chain
- Tests for env var precedence over config

**5. Updated project config**
- Added `model: claude-opus-4-5` to `.chant/config.md` defaults

The implementation ensures that completed specs will now have their model field populated even when no environment variables are set, by falling back to the config default or attempting to parse from the Claude CLI version output.```