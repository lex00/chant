---
type: code
status: pending
labels:
- safety
- cleanup
target_files:
- src/spec/parse.rs
- src/cmd/work/single.rs.bak
---
# Make Spec::save atomic via write-then-rename, clean up dead code

## Context

### Non-atomic save

`src/spec/parse.rs:172-177` uses `fs::write` to save specs:

```rust
pub fn save(&self, path: &Path) -> Result<()> {
    let frontmatter = serde_yaml::to_string(&self.frontmatter)?;
    let content = format!("---\n{}---\n{}", frontmatter, self.body);
    fs::write(path, content)?;
    Ok(())
}
```

`fs::write` truncates the file before writing. If the process is killed (exit 137 from SIGKILL is a known issue — memory pressure from too many Claude processes), the spec file may be partially written or empty. This is the single save path used everywhere.

### Dead code

`src/cmd/work/single.rs.bak` is a backup file from refactoring that's checked into the repo. It contains stale code with `force_status` calls that show up in grep results and cause confusion.

## Task

1. **Atomic save**: Modify `Spec::save()` to write to a temporary file in the same directory, then `std::fs::rename()` to the target path. `rename` is atomic on POSIX filesystems when source and target are on the same filesystem (which they will be, since the temp file is in the same directory):
   ```rust
   pub fn save(&self, path: &Path) -> Result<()> {
       let frontmatter = serde_yaml::to_string(&self.frontmatter)?;
       let content = format!("---\n{}---\n{}", frontmatter, self.body);
       let tmp_path = path.with_extension("md.tmp");
       fs::write(&tmp_path, &content)?;
       fs::rename(&tmp_path, path)?;
       Ok(())
   }
   ```
2. **Also update `SpecRepository::save`** if it has a separate implementation that doesn't go through `Spec::save`
3. **Delete `src/cmd/work/single.rs.bak`** — it's dead code from a previous refactor

## Acceptance Criteria

- [ ] `Spec::save()` writes to a temporary file then renames atomically (grep for `fs::rename` in `parse.rs`)
- [ ] Temp file is in the same directory as target (not `/tmp`) to ensure same-filesystem rename
- [ ] If `SpecRepository::save` exists with separate logic, it also uses atomic write
- [ ] `src/cmd/work/single.rs.bak` is deleted
- [ ] Existing save tests still pass (save → load round-trip)
- [ ] `cargo test` passes
- [ ] `cargo clippy -- -D warnings` passes