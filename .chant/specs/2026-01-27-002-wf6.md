---
type: code
status: completed
depends_on:
- 2026-01-27-001-mkx
target_files:
- src/derivation.rs
- src/lib.rs
model: claude-haiku-4-5-20251001
---
# Implement core derivation engine for all sources

## Problem

Need a derivation engine that can extract values from:
1. **Branch name** - Current git branch (e.g., `sprint/2026-Q1-W4/PROJ-123`)
2. **File path** - Spec file path (e.g., `.chant/specs/teams/platform/...`)
3. **Environment variables** - Shell environment (e.g., `$TEAM_NAME`)
4. **Git user** - Git user.name or user.email from config

The engine must:
- Apply regex patterns to extract first capture group
- Return None if pattern doesn't match (graceful failure)
- Support all four source types
- Be testable in isolation

## Solution

Create new module `src/derivation.rs` with:

```rust
pub struct DerivationEngine {
    config: EnterpriseConfig,
}

impl DerivationEngine {
    pub fn new(config: EnterpriseConfig) -> Self;

    /// Derive all configured fields for a spec
    pub fn derive_fields(&self, context: &DerivationContext) -> HashMap<String, String>;

    /// Derive a single field
    fn derive_field(&self, field_name: &str, config: &DerivedFieldConfig, context: &DerivationContext) -> Option<String>;
}

pub struct DerivationContext {
    pub branch_name: Option<String>,
    pub spec_path: Option<PathBuf>,
    pub env_vars: HashMap<String, String>,
    pub git_user_name: Option<String>,
    pub git_user_email: Option<String>,
}
```

Implementation details:
- Use `regex` crate for pattern matching
- Extract first capture group: `pattern.captures(source)?.get(1)?.as_str()`
- Return empty HashMap if enterprise config is empty (fast path)
- Log warnings (not errors) if pattern fails to match

## Acceptance Criteria

- [x] Create `src/derivation.rs` module
- [x] Add `DerivationEngine` struct with `derive_fields()` method
- [x] Add `DerivationContext` struct with all source data
- [x] Implement branch name extraction with regex first capture group
- [x] Implement file path extraction with regex first capture group
- [x] Implement environment variable extraction with pattern matching
- [x] Implement git user extraction (name and email support)
- [x] Add unit tests for each source type with various patterns
- [x] Add test for graceful failure when pattern doesn't match
- [x] Add test that empty config returns empty results (no-op)
- [x] All tests pass