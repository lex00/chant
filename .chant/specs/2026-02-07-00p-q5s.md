---
type: code
status: failed
depends_on:
- 2026-02-07-00o-hpr
labels:
- tests
- migration
target_files:
- tests/test_takeover.rs
- tests/integration/worktree_test.rs
- tests/integration/watch_recovery_test.rs
- tests/support/harness.rs
---
# Migrate medium test files to TestHarness/SpecFactory

## Context

Three test files need moderate refactoring to migrate. They have domain-specific helpers that need to be preserved or moved into the harness.

1. **`test_takeover.rs`** (355 LOC, 4 tests) — uses `common.rs`, manual `/tmp` paths, custom helpers: `spawn_dummy_process()`, `create_log_file()`, `is_process_running()`. These are takeover-specific and should stay local but use TestHarness for the repo/spec setup.

2. **`integration/worktree_test.rs`** (663 LOC, 9+ tests) — partially migrated (first test uses TestHarness, rest use `common.rs`). Has local helpers `get_branches()`, `branch_exists()`, `worktree_exists()`, `get_commit_count()` which duplicate `spec_lifecycle_test.rs`. Consider adding git helpers to TestHarness.

3. **`integration/watch_recovery_test.rs`** (317 LOC, 4 tests) — uses `common.rs`, manual tempdir, custom `create_test_worktree_with_status()` helper. Should use TestHarness but keep the worktree status helper.

## Task

For each file:
1. Replace `common::setup_test_repo()` / manual tempdir with `TestHarness::new()`
2. Replace hand-written YAML with SpecFactory
3. Replace manual `/tmp` paths with harness-managed paths
4. Keep domain-specific helpers (process spawning, worktree status creation) but refactor them to accept TestHarness
5. Add shared git helpers to `TestHarness` if duplicated across files: `branch_exists()`, `get_branches()`, `get_commit_count()`

## Acceptance Criteria

- [x] `test_takeover.rs` uses TestHarness (no `common.rs`, no manual `/tmp` paths)
- [x] `integration/worktree_test.rs` uses TestHarness consistently across all tests
- [x] `integration/watch_recovery_test.rs` uses TestHarness (no `common.rs`)
- [x] Duplicated git helpers (`branch_exists`, `get_branches`) moved to TestHarness or shared module
- [x] No hand-written YAML strings in any of the 3 files
- [x] All existing tests pass
- [x] `cargo clippy` passes