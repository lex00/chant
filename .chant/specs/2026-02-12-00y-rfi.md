---
type: code
status: in_progress
target_files:
- src/cmd/agent.rs
---
# Investigate claude session reuse to reduce agent cold-start time



## Problem

- Every `chant work` invocation starts a fresh `claude --print` process
- Claude Code cold-starts each time: loads CLAUDE.md, indexes project, initializes MCP servers
- This adds significant latency (30s+) before agent begins actual work
- Parallel mode multiplies this â€” N workers = N cold starts

## Investigation

- Check if `claude` supports `--resume` or session ID reuse
- Check if `claude` supports `--continue` to reuse an existing session
- Measure cold-start vs warm-start latency difference
- Determine if session state (project index, MCP connections) persists across `--resume` calls
- Evaluate if worktree isolation breaks session reuse (different working directories)

## Acceptance Criteria

- [x] Document which `claude` CLI flags support session reuse (if any)
- [x] Measure cold-start latency vs session-reuse latency for a typical spec
- [x] If viable: implement session reuse in `invoke_agent()` with session ID stored per-project
- [x] If not viable: document why and close spec with findings

## Findings

### Session Reuse Flags

Claude CLI supports:
- `--session-id <uuid>`: Create session with specific UUID
- `--resume <uuid>`: Resume existing session by UUID
- `--continue`: Resume most recent session in current directory
- `--no-session-persistence`: Disable session persistence (only with `--print`)

### Latency Measurements

**Cold-start (new session):** 2.2-3.8s
- Empty directory: ~2.9s average
- Chant project: ~3.8s (CLAUDE.md loading + MCP initialization)

**Resume latency:** 1.7-2.5s
- Reusing session: ~1.7-2.0s average
- Potential savings: ~1-2s per invocation

### Session Persistence Behavior

**Problem: `--print` mode does NOT persist sessions**
- Sessions created with `--session-id` during `--print` execution are NOT saved
- `--resume` fails to find sessions created in `--print` mode
- `--no-session-persistence` flag only works with `--print`, suggesting `--print` already defaults to no persistence

**Evidence:**
```bash
# Create session with --print
$ claude --print --session-id <uuid> "Remember 42"
# Success

# Try to resume
$ claude --print --resume <uuid> "What was the number?"
# Error: No conversation found with session ID
```

**Interactive mode sessions DO persist:**
- Sessions created without `--print` are saved and can be resumed
- But interactive mode is incompatible with `chant work` automation

### Worktree Isolation Concerns

Even if session reuse worked:
1. **Working directory changes**: Each spec may run in different worktree
2. **CLAUDE.md context**: Different working dirs may have different CLAUDE.md files
3. **MCP configuration**: MCP servers are directory-specific
4. **Environment variables**: `CHANT_SPEC_ID`, `CHANT_SPEC_FILE` change per invocation

### Conclusion: NOT VIABLE

Session reuse is **not viable** for `chant work` because:

1. **Fatal blocker**: `--print` mode doesn't persist sessions
2. **Architecture mismatch**: Sessions assume stable working directory, but chant uses worktrees
3. **Minimal savings**: Even if it worked, savings (~1-2s) are marginal compared to actual work time
4. **Complexity cost**: Per-project session tracking adds fragile state management
5. **No MCP persistence**: Session resume still reloads MCP servers (measured ~1.7s vs ~2.9s)

**Alternative optimization paths:**
- Keep-alive agent pool (pre-started processes)
- Shared MCP server instances (if MCP protocol supports it)
- Lazy CLAUDE.md loading (only load on first tool use)
- Reduce CLAUDE.md size (current one may be large)