---
type: code
status: in_progress
target_files:
- tests/integration_tests.rs
---
# Add integration test for chant derive --all

## Problem

The `chant derive --all` command has no integration test verifying it processes all specs in the repository.

**Gap:** Need to verify batch derivation across multiple specs.

## Solution

Add integration test that:
1. Creates test git repository
2. Creates multiple specs without derived fields
3. Adds enterprise config
4. Runs `chant derive --all`
5. Verifies ALL specs updated with derived fields

## Test Implementation

```rust
#[test]
fn test_chant_derive_all_specs() {
    let temp_dir = "/tmp/chant-test-derive-all";
    setup_test_repo(temp_dir);

    // Create multiple specs without enterprise config
    let mut spec_ids = vec![];
    for i in 1..=3 {
        let output = Command::new(env!("CARGO_BIN_EXE_chant"))
            .args(["add", &format!("Test spec {}", i)])
            .current_dir(temp_dir)
            .output()
            .expect("Failed to create spec");

        assert!(output.status.success());
        spec_ids.push(extract_spec_id(&output.stdout));
    }

    // Verify none have derived fields
    for spec_id in &spec_ids {
        let spec_path = format!("{temp_dir}/.chant/specs/{spec_id}.md");
        let content = std::fs::read_to_string(&spec_path).unwrap();
        assert!(!content.contains("derived_fields:"));
    }

    // Add enterprise config with branch derivation
    let config = r#"
enterprise:
  derived:
    sprint:
      from: branch
      pattern: "sprint/([^/]+)"
"#;
    write_config(temp_dir, config);

    // Checkout branch with pattern
    Command::new("git")
        .args(["checkout", "-b", "sprint/2026-Q1-W4"])
        .current_dir(temp_dir)
        .output()
        .expect("Failed to create branch");

    // Run chant derive --all
    let derive_output = Command::new(env!("CARGO_BIN_EXE_chant"))
        .args(["derive", "--all"])
        .current_dir(temp_dir)
        .output()
        .expect("Failed to run chant derive --all");

    assert!(derive_output.status.success());
    let stdout = String::from_utf8_lossy(&derive_output.stdout);

    // Verify all specs were updated
    for spec_id in &spec_ids {
        assert!(stdout.contains(&format!("Updated {}", spec_id)));

        let spec_path = format!("{temp_dir}/.chant/specs/{spec_id}.md");
        let content = std::fs::read_to_string(&spec_path).unwrap();
        assert!(content.contains("sprint: 2026-Q1-W4"));
        assert!(content.contains("derived_fields:\n  - sprint"));
    }
}
```

## Acceptance Criteria

- [ ] Add test to tests/integration_tests.rs
- [ ] Test creates 3+ specs without enterprise config
- [ ] Test adds enterprise config after spec creation
- [ ] Test runs `chant derive --all` command
- [ ] Test verifies ALL spec files are updated
- [ ] Test verifies success messages for each spec in stdout
- [ ] Test verifies derived fields in all specs
- [ ] Test passes: `cargo test test_chant_derive_all_specs`
- [ ] Cleanup temp directory after test